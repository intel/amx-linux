
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Mounting root file system via SMB (cifs.ko) &#8212; The Linux Kernel 6.2.0-rc4+ documentation</title>
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Ceph Distributed File System" href="../ceph.html" />
    <link rel="prev" title="KSMBD - SMB3 Kernel Server" href="ksmbd.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="mounting-root-file-system-via-smb-cifs-ko">
<h1>Mounting root file system via SMB (cifs.ko)<a class="headerlink" href="#mounting-root-file-system-via-smb-cifs-ko" title="Permalink to this headline">¶</a></h1>
<p>Written 2019 by Paulo Alcantara &lt;<a class="reference external" href="mailto:palcantara&#37;&#52;&#48;suse&#46;de">palcantara<span>&#64;</span>suse<span>&#46;</span>de</a>&gt;</p>
<p>Written 2019 by Aurelien Aptel &lt;<a class="reference external" href="mailto:aaptel&#37;&#52;&#48;suse&#46;com">aaptel<span>&#64;</span>suse<span>&#46;</span>com</a>&gt;</p>
<p>The CONFIG_CIFS_ROOT option enables experimental root file system
support over the SMB protocol via cifs.ko.</p>
<p>It introduces a new kernel command-line option called ‘cifsroot=’
which will tell the kernel to mount the root file system over the
network by utilizing SMB or CIFS protocol.</p>
<p>In order to mount, the network stack will also need to be set up by
using ‘ip=’ config option. For more details, see
<a class="reference internal" href="../../admin-guide/nfs/nfsroot.html"><span class="doc">Mounting the root filesystem via NFS (nfsroot)</span></a>.</p>
<p>A CIFS root mount currently requires the use of SMB1+UNIX Extensions
which is only supported by the Samba server. SMB1 is the older
deprecated version of the protocol but it has been extended to support
POSIX features (See [1]). The equivalent extensions for the newer
recommended version of the protocol (SMB3) have not been fully
implemented yet which means SMB3 doesn’t support some required POSIX
file system objects (e.g. block devices, pipes, sockets).</p>
<p>As a result, a CIFS root will default to SMB1 for now but the version
to use can nonetheless be changed via the ‘vers=’ mount option.  This
default will change once the SMB3 POSIX extensions are fully
implemented.</p>
<section id="server-configuration">
<h2>Server configuration<a class="headerlink" href="#server-configuration" title="Permalink to this headline">¶</a></h2>
<p>To enable SMB1+UNIX extensions you will need to set these global
settings in Samba smb.conf:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[global]
server min protocol = NT1
unix extension = yes        # default
</pre></div>
</div>
</section>
<section id="kernel-command-line">
<h2>Kernel command line<a class="headerlink" href="#kernel-command-line" title="Permalink to this headline">¶</a></h2>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>root=/dev/cifs
</pre></div>
</div>
<p>This is just a virtual device that basically tells the kernel to mount
the root file system via SMB protocol.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>cifsroot=//&lt;server-ip&gt;/&lt;share&gt;[,options]
</pre></div>
</div>
<p>Enables the kernel to mount the root file system via SMB that are
located in the &lt;server-ip&gt; and &lt;share&gt; specified in this option.</p>
<p>The default mount options are set in fs/cifs/cifsroot.c.</p>
<dl class="simple">
<dt>server-ip</dt><dd><p>IPv4 address of the server.</p>
</dd>
<dt>share</dt><dd><p>Path to SMB share (rootfs).</p>
</dd>
<dt>options</dt><dd><p>Optional mount options. For more information, see mount.cifs(8).</p>
</dd>
</dl>
</section>
<section id="examples">
<h2>Examples<a class="headerlink" href="#examples" title="Permalink to this headline">¶</a></h2>
<p>Export root file system as a Samba share in smb.conf file:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>...
[linux]
        path = /path/to/rootfs
        read only = no
        guest ok = yes
        force user = root
        force group = root
        browseable = yes
        writeable = yes
        admin users = root
        public = yes
        create mask = 0777
        directory mask = 0777
...
</pre></div>
</div>
<p>Restart smb service:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># systemctl restart smb
</pre></div>
</div>
<p>Test it under QEMU on a kernel built with CONFIG_CIFS_ROOT and
CONFIG_IP_PNP options enabled:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># qemu-system-x86_64 -enable-kvm -cpu host -m 1024 \
-kernel /path/to/linux/arch/x86/boot/bzImage -nographic \
-append &quot;root=/dev/cifs rw ip=dhcp cifsroot=//10.0.2.2/linux,username=foo,password=bar console=ttyS0 3&quot;
</pre></div>
</div>
<p>1: <a class="reference external" href="https://wiki.samba.org/index.php/UNIX_Extensions">https://wiki.samba.org/index.php/UNIX_Extensions</a></p>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">The Linux Kernel</a></h1>



<p class="blurb">6.2.0-rc4-6.2.0-rc4+</p>







<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
  <h3><a href="../../index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Mounting root file system via SMB (cifs.ko)</a><ul>
<li><a class="reference internal" href="#server-configuration">Server configuration</a></li>
<li><a class="reference internal" href="#kernel-command-line">Kernel command line</a></li>
<li><a class="reference internal" href="#examples">Examples</a></li>
</ul>
</li>
</ul>

  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../../_sources/filesystems/cifs/cifsroot.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;The kernel development community.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 2.4.4</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="../../_sources/filesystems/cifs/cifsroot.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>