
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Squashfs 4.0 Filesystem &#8212; The Linux Kernel 6.2.0-rc4+ documentation</title>
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="sysfs - _The_ filesystem for exporting kernel objects" href="sysfs.html" />
    <link rel="prev" title="spu_run" href="spufs/spu_run.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="squashfs-4-0-filesystem">
<h1>Squashfs 4.0 Filesystem<a class="headerlink" href="#squashfs-4-0-filesystem" title="Permalink to this headline">¶</a></h1>
<p>Squashfs is a compressed read-only filesystem for Linux.</p>
<p>It uses zlib, lz4, lzo, or xz compression to compress files, inodes and
directories.  Inodes in the system are very small and all blocks are packed to
minimise data overhead. Block sizes greater than 4K are supported up to a
maximum of 1Mbytes (default block size 128K).</p>
<p>Squashfs is intended for general read-only filesystem use, for archival
use (i.e. in cases where a .tar.gz file may be used), and in constrained
block device/memory systems (e.g. embedded systems) where low overhead is
needed.</p>
<p>Mailing list: <a class="reference external" href="mailto:squashfs-devel&#37;&#52;&#48;lists&#46;sourceforge&#46;net">squashfs-devel<span>&#64;</span>lists<span>&#46;</span>sourceforge<span>&#46;</span>net</a>
Web site: www.squashfs.org</p>
<section id="filesystem-features">
<h2>1. Filesystem Features<a class="headerlink" href="#filesystem-features" title="Permalink to this headline">¶</a></h2>
<p>Squashfs filesystem features versus Cramfs:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 61%" />
<col style="width: 18%" />
<col style="width: 20%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"></th>
<th class="head"></th>
<th class="head"></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Max filesystem size</p></td>
<td><p>2^64</p></td>
<td><p>256 MiB</p></td>
</tr>
<tr class="row-odd"><td><p>Max file size</p></td>
<td><p>~ 2 TiB</p></td>
<td><p>16 MiB</p></td>
</tr>
<tr class="row-even"><td><p>Max files</p></td>
<td><p>unlimited</p></td>
<td><p>unlimited</p></td>
</tr>
<tr class="row-odd"><td><p>Max directories</p></td>
<td><p>unlimited</p></td>
<td><p>unlimited</p></td>
</tr>
<tr class="row-even"><td><p>Max entries per directory</p></td>
<td><p>unlimited</p></td>
<td><p>unlimited</p></td>
</tr>
<tr class="row-odd"><td><p>Max block size</p></td>
<td><p>1 MiB</p></td>
<td><p>4 KiB</p></td>
</tr>
<tr class="row-even"><td><p>Metadata compression</p></td>
<td><p>yes</p></td>
<td><p>no</p></td>
</tr>
<tr class="row-odd"><td><p>Directory indexes</p></td>
<td><p>yes</p></td>
<td><p>no</p></td>
</tr>
<tr class="row-even"><td><p>Sparse file support</p></td>
<td><p>yes</p></td>
<td><p>no</p></td>
</tr>
<tr class="row-odd"><td><p>Tail-end packing (fragments)</p></td>
<td><p>yes</p></td>
<td><p>no</p></td>
</tr>
<tr class="row-even"><td><p>Exportable (NFS etc.)</p></td>
<td><p>yes</p></td>
<td><p>no</p></td>
</tr>
<tr class="row-odd"><td><p>Hard link support</p></td>
<td><p>yes</p></td>
<td><p>no</p></td>
</tr>
<tr class="row-even"><td><p>“.” and “..” in readdir</p></td>
<td><p>yes</p></td>
<td><p>no</p></td>
</tr>
<tr class="row-odd"><td><p>Real inode numbers</p></td>
<td><p>yes</p></td>
<td><p>no</p></td>
</tr>
<tr class="row-even"><td><p>32-bit uids/gids</p></td>
<td><p>yes</p></td>
<td><p>no</p></td>
</tr>
<tr class="row-odd"><td><p>File creation time</p></td>
<td><p>yes</p></td>
<td><p>no</p></td>
</tr>
<tr class="row-even"><td><p>Xattr support</p></td>
<td><p>yes</p></td>
<td><p>no</p></td>
</tr>
<tr class="row-odd"><td><p>ACL support</p></td>
<td><p>no</p></td>
<td><p>no</p></td>
</tr>
</tbody>
</table>
<p>Squashfs compresses data, inodes and directories.  In addition, inode and
directory data are highly compacted, and packed on byte boundaries.  Each
compressed inode is on average 8 bytes in length (the exact length varies on
file type, i.e. regular file, directory, symbolic link, and block/char device
inodes have different sizes).</p>
</section>
<section id="using-squashfs">
<h2>2. Using Squashfs<a class="headerlink" href="#using-squashfs" title="Permalink to this headline">¶</a></h2>
<p>As squashfs is a read-only filesystem, the mksquashfs program must be used to
create populated squashfs filesystems.  This and other squashfs utilities
can be obtained from <a class="reference external" href="http://www.squashfs.org">http://www.squashfs.org</a>.  Usage instructions can be
obtained from this site also.</p>
<dl class="simple">
<dt>The squashfs-tools development tree is now located on kernel.org</dt><dd><p>git://git.kernel.org/pub/scm/fs/squashfs/squashfs-tools.git</p>
</dd>
</dl>
</section>
<section id="squashfs-filesystem-design">
<h2>3. Squashfs Filesystem Design<a class="headerlink" href="#squashfs-filesystem-design" title="Permalink to this headline">¶</a></h2>
<p>A squashfs filesystem consists of a maximum of nine parts, packed together on a
byte alignment:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span> ---------------
|  superblock   |
|---------------|
|  compression  |
|    options    |
|---------------|
|  datablocks   |
|  &amp; fragments  |
|---------------|
|  inode table  |
|---------------|
|   directory   |
|     table     |
|---------------|
|   fragment    |
|    table      |
|---------------|
|    export     |
|    table      |
|---------------|
|    uid/gid    |
|  lookup table |
|---------------|
|     xattr     |
|     table     |
 ---------------
</pre></div>
</div>
<p>Compressed data blocks are written to the filesystem as files are read from
the source directory, and checked for duplicates.  Once all file data has been
written the completed inode, directory, fragment, export, uid/gid lookup and
xattr tables are written.</p>
</section>
<section id="compression-options">
<h2>3.1 Compression options<a class="headerlink" href="#compression-options" title="Permalink to this headline">¶</a></h2>
<p>Compressors can optionally support compression specific options (e.g.
dictionary size).  If non-default compression options have been used, then
these are stored here.</p>
</section>
<section id="inodes">
<h2>3.2 Inodes<a class="headerlink" href="#inodes" title="Permalink to this headline">¶</a></h2>
<p>Metadata (inodes and directories) are compressed in 8Kbyte blocks.  Each
compressed block is prefixed by a two byte length, the top bit is set if the
block is uncompressed.  A block will be uncompressed if the -noI option is set,
or if the compressed block was larger than the uncompressed block.</p>
<p>Inodes are packed into the metadata blocks, and are not aligned to block
boundaries, therefore inodes overlap compressed blocks.  Inodes are identified
by a 48-bit number which encodes the location of the compressed metadata block
containing the inode, and the byte offset into that block where the inode is
placed (&lt;block, offset&gt;).</p>
<p>To maximise compression there are different inodes for each file type
(regular file, directory, device, etc.), the inode contents and length
varying with the type.</p>
<p>To further maximise compression, two types of regular file inode and
directory inode are defined: inodes optimised for frequently occurring
regular files and directories, and extended types where extra
information has to be stored.</p>
</section>
<section id="directories">
<h2>3.3 Directories<a class="headerlink" href="#directories" title="Permalink to this headline">¶</a></h2>
<p>Like inodes, directories are packed into compressed metadata blocks, stored
in a directory table.  Directories are accessed using the start address of
the metablock containing the directory and the offset into the
decompressed block (&lt;block, offset&gt;).</p>
<p>Directories are organised in a slightly complex way, and are not simply
a list of file names.  The organisation takes advantage of the
fact that (in most cases) the inodes of the files will be in the same
compressed metadata block, and therefore, can share the start block.
Directories are therefore organised in a two level list, a directory
header containing the shared start block value, and a sequence of directory
entries, each of which share the shared start block.  A new directory header
is written once/if the inode start block changes.  The directory
header/directory entry list is repeated as many times as necessary.</p>
<p>Directories are sorted, and can contain a directory index to speed up
file lookup.  Directory indexes store one entry per metablock, each entry
storing the index/filename mapping to the first directory header
in each metadata block.  Directories are sorted in alphabetical order,
and at lookup the index is scanned linearly looking for the first filename
alphabetically larger than the filename being looked up.  At this point the
location of the metadata block the filename is in has been found.
The general idea of the index is to ensure only one metadata block needs to be
decompressed to do a lookup irrespective of the length of the directory.
This scheme has the advantage that it doesn’t require extra memory overhead
and doesn’t require much extra storage on disk.</p>
</section>
<section id="file-data">
<h2>3.4 File data<a class="headerlink" href="#file-data" title="Permalink to this headline">¶</a></h2>
<p>Regular files consist of a sequence of contiguous compressed blocks, and/or a
compressed fragment block (tail-end packed block).   The compressed size
of each datablock is stored in a block list contained within the
file inode.</p>
<p>To speed up access to datablocks when reading ‘large’ files (256 Mbytes or
larger), the code implements an index cache that caches the mapping from
block index to datablock location on disk.</p>
<p>The index cache allows Squashfs to handle large files (up to 1.75 TiB) while
retaining a simple and space-efficient block list on disk.  The cache
is split into slots, caching up to eight 224 GiB files (128 KiB blocks).
Larger files use multiple slots, with 1.75 TiB files using all 8 slots.
The index cache is designed to be memory efficient, and by default uses
16 KiB.</p>
</section>
<section id="fragment-lookup-table">
<h2>3.5 Fragment lookup table<a class="headerlink" href="#fragment-lookup-table" title="Permalink to this headline">¶</a></h2>
<p>Regular files can contain a fragment index which is mapped to a fragment
location on disk and compressed size using a fragment lookup table.  This
fragment lookup table is itself stored compressed into metadata blocks.
A second index table is used to locate these.  This second index table for
speed of access (and because it is small) is read at mount time and cached
in memory.</p>
</section>
<section id="uid-gid-lookup-table">
<h2>3.6 Uid/gid lookup table<a class="headerlink" href="#uid-gid-lookup-table" title="Permalink to this headline">¶</a></h2>
<p>For space efficiency regular files store uid and gid indexes, which are
converted to 32-bit uids/gids using an id look up table.  This table is
stored compressed into metadata blocks.  A second index table is used to
locate these.  This second index table for speed of access (and because it
is small) is read at mount time and cached in memory.</p>
</section>
<section id="export-table">
<h2>3.7 Export table<a class="headerlink" href="#export-table" title="Permalink to this headline">¶</a></h2>
<p>To enable Squashfs filesystems to be exportable (via NFS etc.) filesystems
can optionally (disabled with the -no-exports Mksquashfs option) contain
an inode number to inode disk location lookup table.  This is required to
enable Squashfs to map inode numbers passed in filehandles to the inode
location on disk, which is necessary when the export code reinstantiates
expired/flushed inodes.</p>
<p>This table is stored compressed into metadata blocks.  A second index table is
used to locate these.  This second index table for speed of access (and because
it is small) is read at mount time and cached in memory.</p>
</section>
<section id="xattr-table">
<h2>3.8 Xattr table<a class="headerlink" href="#xattr-table" title="Permalink to this headline">¶</a></h2>
<p>The xattr table contains extended attributes for each inode.  The xattrs
for each inode are stored in a list, each list entry containing a type,
name and value field.  The type field encodes the xattr prefix
(“user.”, “trusted.” etc) and it also encodes how the name/value fields
should be interpreted.  Currently the type indicates whether the value
is stored inline (in which case the value field contains the xattr value),
or if it is stored out of line (in which case the value field stores a
reference to where the actual value is stored).  This allows large values
to be stored out of line improving scanning and lookup performance and it
also allows values to be de-duplicated, the value being stored once, and
all other occurrences holding an out of line reference to that value.</p>
<p>The xattr lists are packed into compressed 8K metadata blocks.
To reduce overhead in inodes, rather than storing the on-disk
location of the xattr list inside each inode, a 32-bit xattr id
is stored.  This xattr id is mapped into the location of the xattr
list using a second xattr id lookup table.</p>
</section>
<section id="todos-and-outstanding-issues">
<h2>4. TODOs and Outstanding Issues<a class="headerlink" href="#todos-and-outstanding-issues" title="Permalink to this headline">¶</a></h2>
</section>
<section id="todo-list">
<h2>4.1 TODO list<a class="headerlink" href="#todo-list" title="Permalink to this headline">¶</a></h2>
<p>Implement ACL support.</p>
</section>
<section id="squashfs-internal-cache">
<h2>4.2 Squashfs Internal Cache<a class="headerlink" href="#squashfs-internal-cache" title="Permalink to this headline">¶</a></h2>
<p>Blocks in Squashfs are compressed.  To avoid repeatedly decompressing
recently accessed data Squashfs uses two small metadata and fragment caches.</p>
<p>The cache is not used for file datablocks, these are decompressed and cached in
the page-cache in the normal way.  The cache is used to temporarily cache
fragment and metadata blocks which have been read as a result of a metadata
(i.e. inode or directory) or fragment access.  Because metadata and fragments
are packed together into blocks (to gain greater compression) the read of a
particular piece of metadata or fragment will retrieve other metadata/fragments
which have been packed with it, these because of locality-of-reference may be
read in the near future. Temporarily caching them ensures they are available
for near future access without requiring an additional read and decompress.</p>
<p>In the future this internal cache may be replaced with an implementation which
uses the kernel page cache.  Because the page cache operates on page sized
units this may introduce additional complexity in terms of locking and
associated race conditions.</p>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../index.html">The Linux Kernel</a></h1>



<p class="blurb">6.2.0-rc4-6.2.0-rc4+</p>







<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
  <h3><a href="../index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Squashfs 4.0 Filesystem</a><ul>
<li><a class="reference internal" href="#filesystem-features">1. Filesystem Features</a></li>
<li><a class="reference internal" href="#using-squashfs">2. Using Squashfs</a></li>
<li><a class="reference internal" href="#squashfs-filesystem-design">3. Squashfs Filesystem Design</a></li>
<li><a class="reference internal" href="#compression-options">3.1 Compression options</a></li>
<li><a class="reference internal" href="#inodes">3.2 Inodes</a></li>
<li><a class="reference internal" href="#directories">3.3 Directories</a></li>
<li><a class="reference internal" href="#file-data">3.4 File data</a></li>
<li><a class="reference internal" href="#fragment-lookup-table">3.5 Fragment lookup table</a></li>
<li><a class="reference internal" href="#uid-gid-lookup-table">3.6 Uid/gid lookup table</a></li>
<li><a class="reference internal" href="#export-table">3.7 Export table</a></li>
<li><a class="reference internal" href="#xattr-table">3.8 Xattr table</a></li>
<li><a class="reference internal" href="#todos-and-outstanding-issues">4. TODOs and Outstanding Issues</a></li>
<li><a class="reference internal" href="#todo-list">4.1 TODO list</a></li>
<li><a class="reference internal" href="#squashfs-internal-cache">4.2 Squashfs Internal Cache</a></li>
</ul>
</li>
</ul>

  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/filesystems/squashfs.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;The kernel development community.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 2.4.4</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="../_sources/filesystems/squashfs.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>