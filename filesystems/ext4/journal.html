
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Journal (jbd2) &#8212; The Linux Kernel 6.2.0-rc4+ documentation</title>
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="journal-jbd2">
<h1>Journal (jbd2)<a class="headerlink" href="#journal-jbd2" title="Permalink to this headline">¶</a></h1>
<p>Introduced in ext3, the ext4 filesystem employs a journal to protect the
filesystem against metadata inconsistencies in the case of a system crash. Up
to 10,240,000 file system blocks (see man mke2fs(8) for more details on journal
size limits) can be reserved inside the filesystem as a place to land
“important” data writes on-disk as quickly as possible. Once the important
data transaction is fully written to the disk and flushed from the disk write
cache, a record of the data being committed is also written to the journal. At
some later point in time, the journal code writes the transactions to their
final locations on disk (this could involve a lot of seeking or a lot of small
read-write-erases) before erasing the commit record. Should the system
crash during the second slow write, the journal can be replayed all the
way to the latest commit record, guaranteeing the atomicity of whatever
gets written through the journal to the disk. The effect of this is to
guarantee that the filesystem does not become stuck midway through a
metadata update.</p>
<p>For performance reasons, ext4 by default only writes filesystem metadata
through the journal. This means that file data blocks are /not/
guaranteed to be in any consistent state after a crash. If this default
guarantee level (<code class="docutils literal notranslate"><span class="pre">data=ordered</span></code>) is not satisfactory, there is a mount
option to control journal behavior. If <code class="docutils literal notranslate"><span class="pre">data=journal</span></code>, all data and
metadata are written to disk through the journal. This is slower but
safest. If <code class="docutils literal notranslate"><span class="pre">data=writeback</span></code>, dirty data blocks are not flushed to the
disk before the metadata are written to disk through the journal.</p>
<p>In case of <code class="docutils literal notranslate"><span class="pre">data=ordered</span></code> mode, Ext4 also supports fast commits which
help reduce commit latency significantly. The default <code class="docutils literal notranslate"><span class="pre">data=ordered</span></code>
mode works by logging metadata blocks to the journal. In fast commit
mode, Ext4 only stores the minimal delta needed to recreate the
affected metadata in fast commit space that is shared with JBD2.
Once the fast commit area fills in or if fast commit is not possible
or if JBD2 commit timer goes off, Ext4 performs a traditional full commit.
A full commit invalidates all the fast commits that happened before
it and thus it makes the fast commit area empty for further fast
commits. This feature needs to be enabled at mkfs time.</p>
<p>The journal inode is typically inode 8. The first 68 bytes of the
journal inode are replicated in the ext4 superblock. The journal itself
is normal (but hidden) file within the filesystem. The file usually
consumes an entire block group, though mke2fs tries to put it in the
middle of the disk.</p>
<p>All fields in jbd2 are written to disk in big-endian order. This is the
opposite of ext4.</p>
<p>NOTE: Both ext4 and ocfs2 use jbd2.</p>
<p>The maximum size of a journal embedded in an ext4 filesystem is 2^32
blocks. jbd2 itself does not seem to care.</p>
<section id="layout">
<h2>Layout<a class="headerlink" href="#layout" title="Permalink to this headline">¶</a></h2>
<p>Generally speaking, the journal has this format:</p>
<table class="colwidths-given docutils align-default">
<colgroup>
<col style="width: 20%" />
<col style="width: 60%" />
<col style="width: 20%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Superblock</p></th>
<th class="head"><p>descriptor_block (data_blocks or revocation_block) [more data or
revocations] commmit_block</p></th>
<th class="head"><p>[more transactions…]</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
<td><p>One transaction</p></td>
<td></td>
</tr>
</tbody>
</table>
<p>Notice that a transaction begins with either a descriptor and some data,
or a block revocation list. A finished transaction always ends with a
commit. If there is no commit record (or the checksums don’t match), the
transaction will be discarded during replay.</p>
</section>
<section id="external-journal">
<h2>External Journal<a class="headerlink" href="#external-journal" title="Permalink to this headline">¶</a></h2>
<p>Optionally, an ext4 filesystem can be created with an external journal
device (as opposed to an internal journal, which uses a reserved inode).
In this case, on the filesystem device, <code class="docutils literal notranslate"><span class="pre">s_journal_inum</span></code> should be
zero and <code class="docutils literal notranslate"><span class="pre">s_journal_uuid</span></code> should be set. On the journal device there
will be an ext4 super block in the usual place, with a matching UUID.
The journal superblock will be in the next full block after the
superblock.</p>
<table class="colwidths-given docutils align-default">
<colgroup>
<col style="width: 15%" />
<col style="width: 15%" />
<col style="width: 15%" />
<col style="width: 40%" />
<col style="width: 15%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>1024 bytes of padding</p></th>
<th class="head"><p>ext4 Superblock</p></th>
<th class="head"><p>Journal Superblock</p></th>
<th class="head"><p>descriptor_block (data_blocks or revocation_block) [more data or
revocations] commmit_block</p></th>
<th class="head"><p>[more transactions…]</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
<td></td>
<td></td>
<td><p>One transaction</p></td>
<td></td>
</tr>
</tbody>
</table>
</section>
<section id="block-header">
<h2>Block Header<a class="headerlink" href="#block-header" title="Permalink to this headline">¶</a></h2>
<p>Every block in the journal starts with a common 12-byte header
<code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">journal_header_s</span></code>:</p>
<table class="colwidths-given docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 10%" />
<col style="width: 30%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Offset</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Name</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>0x0</p></td>
<td><p>__be32</p></td>
<td><p>h_magic</p></td>
<td><p>jbd2 magic number, 0xC03B3998.</p></td>
</tr>
<tr class="row-odd"><td><p>0x4</p></td>
<td><p>__be32</p></td>
<td><p>h_blocktype</p></td>
<td><p>Description of what this block contains. See the <a class="reference internal" href="#jbd2-blocktype">jbd2_blocktype</a> table
below.</p></td>
</tr>
<tr class="row-even"><td><p>0x8</p></td>
<td><p>__be32</p></td>
<td><p>h_sequence</p></td>
<td><p>The transaction ID that goes with this block.</p></td>
</tr>
</tbody>
</table>
<p id="jbd2-blocktype">The journal block type can be any one of:</p>
<table class="colwidths-given docutils align-default">
<colgroup>
<col style="width: 20%" />
<col style="width: 80%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Value</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>1</p></td>
<td><p>Descriptor. This block precedes a series of data blocks that were
written through the journal during a transaction.</p></td>
</tr>
<tr class="row-odd"><td><p>2</p></td>
<td><p>Block commit record. This block signifies the completion of a
transaction.</p></td>
</tr>
<tr class="row-even"><td><p>3</p></td>
<td><p>Journal superblock, v1.</p></td>
</tr>
<tr class="row-odd"><td><p>4</p></td>
<td><p>Journal superblock, v2.</p></td>
</tr>
<tr class="row-even"><td><p>5</p></td>
<td><p>Block revocation records. This speeds up recovery by enabling the
journal to skip writing blocks that were subsequently rewritten.</p></td>
</tr>
</tbody>
</table>
</section>
<section id="super-block">
<h2>Super Block<a class="headerlink" href="#super-block" title="Permalink to this headline">¶</a></h2>
<p>The super block for the journal is much simpler as compared to ext4’s.
The key data kept within are size of the journal, and where to find the
start of the log of transactions.</p>
<p>The journal superblock is recorded as <code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">journal_superblock_s</span></code>,
which is 1024 bytes long:</p>
<table class="colwidths-given docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 10%" />
<col style="width: 30%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Offset</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Name</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
<td></td>
<td></td>
<td><p>Static information describing the journal.</p></td>
</tr>
<tr class="row-odd"><td><p>0x0</p></td>
<td><p>journal_header_t (12 bytes)</p></td>
<td><p>s_header</p></td>
<td><p>Common header identifying this as a superblock.</p></td>
</tr>
<tr class="row-even"><td><p>0xC</p></td>
<td><p>__be32</p></td>
<td><p>s_blocksize</p></td>
<td><p>Journal device block size.</p></td>
</tr>
<tr class="row-odd"><td><p>0x10</p></td>
<td><p>__be32</p></td>
<td><p>s_maxlen</p></td>
<td><p>Total number of blocks in this journal.</p></td>
</tr>
<tr class="row-even"><td><p>0x14</p></td>
<td><p>__be32</p></td>
<td><p>s_first</p></td>
<td><p>First block of log information.</p></td>
</tr>
<tr class="row-odd"><td></td>
<td></td>
<td></td>
<td><p>Dynamic information describing the current state of the log.</p></td>
</tr>
<tr class="row-even"><td><p>0x18</p></td>
<td><p>__be32</p></td>
<td><p>s_sequence</p></td>
<td><p>First commit ID expected in log.</p></td>
</tr>
<tr class="row-odd"><td><p>0x1C</p></td>
<td><p>__be32</p></td>
<td><p>s_start</p></td>
<td><p>Block number of the start of log. Contrary to the comments, this field
being zero does not imply that the journal is clean!</p></td>
</tr>
<tr class="row-even"><td><p>0x20</p></td>
<td><p>__be32</p></td>
<td><p>s_errno</p></td>
<td><p>Error value, as set by <a class="reference internal" href="../journalling.html#c.jbd2_journal_abort" title="jbd2_journal_abort"><code class="xref c c-func docutils literal notranslate"><span class="pre">jbd2_journal_abort()</span></code></a>.</p></td>
</tr>
<tr class="row-odd"><td></td>
<td></td>
<td></td>
<td><p>The remaining fields are only valid in a v2 superblock.</p></td>
</tr>
<tr class="row-even"><td><p>0x24</p></td>
<td><p>__be32</p></td>
<td><p>s_feature_compat;</p></td>
<td><p>Compatible feature set. See the table <a class="reference internal" href="#jbd2-compat">jbd2_compat</a> below.</p></td>
</tr>
<tr class="row-odd"><td><p>0x28</p></td>
<td><p>__be32</p></td>
<td><p>s_feature_incompat</p></td>
<td><p>Incompatible feature set. See the table <a class="reference internal" href="#jbd2-incompat">jbd2_incompat</a> below.</p></td>
</tr>
<tr class="row-even"><td><p>0x2C</p></td>
<td><p>__be32</p></td>
<td><p>s_feature_ro_compat</p></td>
<td><p>Read-only compatible feature set. There aren’t any of these currently.</p></td>
</tr>
<tr class="row-odd"><td><p>0x30</p></td>
<td><p>__u8</p></td>
<td><p>s_uuid[16]</p></td>
<td><p>128-bit uuid for journal. This is compared against the copy in the ext4
super block at mount time.</p></td>
</tr>
<tr class="row-even"><td><p>0x40</p></td>
<td><p>__be32</p></td>
<td><p>s_nr_users</p></td>
<td><p>Number of file systems sharing this journal.</p></td>
</tr>
<tr class="row-odd"><td><p>0x44</p></td>
<td><p>__be32</p></td>
<td><p>s_dynsuper</p></td>
<td><p>Location of dynamic super block copy. (Not used?)</p></td>
</tr>
<tr class="row-even"><td><p>0x48</p></td>
<td><p>__be32</p></td>
<td><p>s_max_transaction</p></td>
<td><p>Limit of journal blocks per transaction. (Not used?)</p></td>
</tr>
<tr class="row-odd"><td><p>0x4C</p></td>
<td><p>__be32</p></td>
<td><p>s_max_trans_data</p></td>
<td><p>Limit of data blocks per transaction. (Not used?)</p></td>
</tr>
<tr class="row-even"><td><p>0x50</p></td>
<td><p>__u8</p></td>
<td><p>s_checksum_type</p></td>
<td><p>Checksum algorithm used for the journal.  See <a class="reference internal" href="#jbd2-checksum-type">jbd2_checksum_type</a> for
more info.</p></td>
</tr>
<tr class="row-odd"><td><p>0x51</p></td>
<td><p>__u8[3]</p></td>
<td><p>s_padding2</p></td>
<td></td>
</tr>
<tr class="row-even"><td><p>0x54</p></td>
<td><p>__be32</p></td>
<td><p>s_num_fc_blocks</p></td>
<td><p>Number of fast commit blocks in the journal.</p></td>
</tr>
<tr class="row-odd"><td><p>0x58</p></td>
<td><p>__u32</p></td>
<td><p>s_padding[42]</p></td>
<td></td>
</tr>
<tr class="row-even"><td><p>0xFC</p></td>
<td><p>__be32</p></td>
<td><p>s_checksum</p></td>
<td><p>Checksum of the entire superblock, with this field set to zero.</p></td>
</tr>
<tr class="row-odd"><td><p>0x100</p></td>
<td><p>__u8</p></td>
<td><p>s_users[16*48]</p></td>
<td><p>ids of all file systems sharing the log. e2fsprogs/Linux don’t allow
shared external journals, but I imagine Lustre (or ocfs2?), which use
the jbd2 code, might.</p></td>
</tr>
</tbody>
</table>
<p id="jbd2-compat">The journal compat features are any combination of the following:</p>
<table class="colwidths-given docutils align-default">
<colgroup>
<col style="width: 20%" />
<col style="width: 80%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Value</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>0x1</p></td>
<td><p>Journal maintains checksums on the data blocks.
(JBD2_FEATURE_COMPAT_CHECKSUM)</p></td>
</tr>
</tbody>
</table>
<p id="jbd2-incompat">The journal incompat features are any combination of the following:</p>
<table class="colwidths-given docutils align-default">
<colgroup>
<col style="width: 20%" />
<col style="width: 80%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Value</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>0x1</p></td>
<td><p>Journal has block revocation records. (JBD2_FEATURE_INCOMPAT_REVOKE)</p></td>
</tr>
<tr class="row-odd"><td><p>0x2</p></td>
<td><p>Journal can deal with 64-bit block numbers.
(JBD2_FEATURE_INCOMPAT_64BIT)</p></td>
</tr>
<tr class="row-even"><td><p>0x4</p></td>
<td><p>Journal commits asynchronously. (JBD2_FEATURE_INCOMPAT_ASYNC_COMMIT)</p></td>
</tr>
<tr class="row-odd"><td><p>0x8</p></td>
<td><p>This journal uses v2 of the checksum on-disk format. Each journal
metadata block gets its own checksum, and the block tags in the
descriptor table contain checksums for each of the data blocks in the
journal. (JBD2_FEATURE_INCOMPAT_CSUM_V2)</p></td>
</tr>
<tr class="row-even"><td><p>0x10</p></td>
<td><p>This journal uses v3 of the checksum on-disk format. This is the same as
v2, but the journal block tag size is fixed regardless of the size of
block numbers. (JBD2_FEATURE_INCOMPAT_CSUM_V3)</p></td>
</tr>
<tr class="row-odd"><td><p>0x20</p></td>
<td><p>Journal has fast commit blocks. (JBD2_FEATURE_INCOMPAT_FAST_COMMIT)</p></td>
</tr>
</tbody>
</table>
<p id="jbd2-checksum-type">Journal checksum type codes are one of the following.  crc32 or crc32c are the
most likely choices.</p>
<table class="colwidths-given docutils align-default">
<colgroup>
<col style="width: 20%" />
<col style="width: 80%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Value</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>1</p></td>
<td><p>CRC32</p></td>
</tr>
<tr class="row-odd"><td><p>2</p></td>
<td><p>MD5</p></td>
</tr>
<tr class="row-even"><td><p>3</p></td>
<td><p>SHA1</p></td>
</tr>
<tr class="row-odd"><td><p>4</p></td>
<td><p>CRC32C</p></td>
</tr>
</tbody>
</table>
</section>
<section id="descriptor-block">
<h2>Descriptor Block<a class="headerlink" href="#descriptor-block" title="Permalink to this headline">¶</a></h2>
<p>The descriptor block contains an array of journal block tags that
describe the final locations of the data blocks that follow in the
journal. Descriptor blocks are open-coded instead of being completely
described by a data structure, but here is the block structure anyway.
Descriptor blocks consume at least 36 bytes, but use a full block:</p>
<table class="colwidths-given docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 10%" />
<col style="width: 30%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Offset</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Name</p></th>
<th class="head"><p>Descriptor</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>0x0</p></td>
<td><p>journal_header_t</p></td>
<td><p>(open coded)</p></td>
<td><p>Common block header.</p></td>
</tr>
<tr class="row-odd"><td><p>0xC</p></td>
<td><p>struct journal_block_tag_s</p></td>
<td><p>open coded array[]</p></td>
<td><p>Enough tags either to fill up the block or to describe all the data
blocks that follow this descriptor block.</p></td>
</tr>
</tbody>
</table>
<p>Journal block tags have any of the following formats, depending on which
journal feature and block tag flags are set.</p>
<p>If JBD2_FEATURE_INCOMPAT_CSUM_V3 is set, the journal block tag is
defined as <code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">journal_block_tag3_s</span></code>, which looks like the
following. The size is 16 or 32 bytes.</p>
<table class="colwidths-given docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 10%" />
<col style="width: 30%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Offset</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Name</p></th>
<th class="head"><p>Descriptor</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>0x0</p></td>
<td><p>__be32</p></td>
<td><p>t_blocknr</p></td>
<td><p>Lower 32-bits of the location of where the corresponding data block
should end up on disk.</p></td>
</tr>
<tr class="row-odd"><td><p>0x4</p></td>
<td><p>__be32</p></td>
<td><p>t_flags</p></td>
<td><p>Flags that go with the descriptor. See the table <a class="reference internal" href="#jbd2-tag-flags">jbd2_tag_flags</a> for
more info.</p></td>
</tr>
<tr class="row-even"><td><p>0x8</p></td>
<td><p>__be32</p></td>
<td><p>t_blocknr_high</p></td>
<td><p>Upper 32-bits of the location of where the corresponding data block
should end up on disk. This is zero if JBD2_FEATURE_INCOMPAT_64BIT is
not enabled.</p></td>
</tr>
<tr class="row-odd"><td><p>0xC</p></td>
<td><p>__be32</p></td>
<td><p>t_checksum</p></td>
<td><p>Checksum of the journal UUID, the sequence number, and the data block.</p></td>
</tr>
<tr class="row-even"><td></td>
<td></td>
<td></td>
<td><p>This field appears to be open coded. It always comes at the end of the
tag, after t_checksum. This field is not present if the “same UUID” flag
is set.</p></td>
</tr>
<tr class="row-odd"><td><p>0x8 or 0xC</p></td>
<td><p>char</p></td>
<td><p>uuid[16]</p></td>
<td><p>A UUID to go with this tag. This field appears to be copied from the
<code class="docutils literal notranslate"><span class="pre">j_uuid</span></code> field in <code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">journal_s</span></code>, but only tune2fs touches that
field.</p></td>
</tr>
</tbody>
</table>
<p id="jbd2-tag-flags">The journal tag flags are any combination of the following:</p>
<table class="colwidths-given docutils align-default">
<colgroup>
<col style="width: 20%" />
<col style="width: 80%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Value</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>0x1</p></td>
<td><p>On-disk block is escaped. The first four bytes of the data block just
happened to match the jbd2 magic number.</p></td>
</tr>
<tr class="row-odd"><td><p>0x2</p></td>
<td><p>This block has the same UUID as previous, therefore the UUID field is
omitted.</p></td>
</tr>
<tr class="row-even"><td><p>0x4</p></td>
<td><p>The data block was deleted by the transaction. (Not used?)</p></td>
</tr>
<tr class="row-odd"><td><p>0x8</p></td>
<td><p>This is the last tag in this descriptor block.</p></td>
</tr>
</tbody>
</table>
<p>If JBD2_FEATURE_INCOMPAT_CSUM_V3 is NOT set, the journal block tag
is defined as <code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">journal_block_tag_s</span></code>, which looks like the
following. The size is 8, 12, 24, or 28 bytes:</p>
<table class="colwidths-given docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 10%" />
<col style="width: 30%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Offset</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Name</p></th>
<th class="head"><p>Descriptor</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>0x0</p></td>
<td><p>__be32</p></td>
<td><p>t_blocknr</p></td>
<td><p>Lower 32-bits of the location of where the corresponding data block
should end up on disk.</p></td>
</tr>
<tr class="row-odd"><td><p>0x4</p></td>
<td><p>__be16</p></td>
<td><p>t_checksum</p></td>
<td><p>Checksum of the journal UUID, the sequence number, and the data block.
Note that only the lower 16 bits are stored.</p></td>
</tr>
<tr class="row-even"><td><p>0x6</p></td>
<td><p>__be16</p></td>
<td><p>t_flags</p></td>
<td><p>Flags that go with the descriptor. See the table <a class="reference internal" href="#jbd2-tag-flags">jbd2_tag_flags</a> for
more info.</p></td>
</tr>
<tr class="row-odd"><td></td>
<td></td>
<td></td>
<td><p>This next field is only present if the super block indicates support for
64-bit block numbers.</p></td>
</tr>
<tr class="row-even"><td><p>0x8</p></td>
<td><p>__be32</p></td>
<td><p>t_blocknr_high</p></td>
<td><p>Upper 32-bits of the location of where the corresponding data block
should end up on disk.</p></td>
</tr>
<tr class="row-odd"><td></td>
<td></td>
<td></td>
<td><p>This field appears to be open coded. It always comes at the end of the
tag, after t_flags or t_blocknr_high. This field is not present if the
“same UUID” flag is set.</p></td>
</tr>
<tr class="row-even"><td><p>0x8 or 0xC</p></td>
<td><p>char</p></td>
<td><p>uuid[16]</p></td>
<td><p>A UUID to go with this tag. This field appears to be copied from the
<code class="docutils literal notranslate"><span class="pre">j_uuid</span></code> field in <code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">journal_s</span></code>, but only tune2fs touches that
field.</p></td>
</tr>
</tbody>
</table>
<p>If JBD2_FEATURE_INCOMPAT_CSUM_V2 or
JBD2_FEATURE_INCOMPAT_CSUM_V3 are set, the end of the block is a
<code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">jbd2_journal_block_tail</span></code>, which looks like this:</p>
<table class="colwidths-given docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 10%" />
<col style="width: 30%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Offset</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Name</p></th>
<th class="head"><p>Descriptor</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>0x0</p></td>
<td><p>__be32</p></td>
<td><p>t_checksum</p></td>
<td><p>Checksum of the journal UUID + the descriptor block, with this field set
to zero.</p></td>
</tr>
</tbody>
</table>
</section>
<section id="data-block">
<h2>Data Block<a class="headerlink" href="#data-block" title="Permalink to this headline">¶</a></h2>
<p>In general, the data blocks being written to disk through the journal
are written verbatim into the journal file after the descriptor block.
However, if the first four bytes of the block match the jbd2 magic
number then those four bytes are replaced with zeroes and the “escaped”
flag is set in the descriptor block tag.</p>
</section>
<section id="revocation-block">
<h2>Revocation Block<a class="headerlink" href="#revocation-block" title="Permalink to this headline">¶</a></h2>
<p>A revocation block is used to prevent replay of a block in an earlier
transaction. This is used to mark blocks that were journalled at one
time but are no longer journalled. Typically this happens if a metadata
block is freed and re-allocated as a file data block; in this case, a
journal replay after the file block was written to disk will cause
corruption.</p>
<p><strong>NOTE</strong>: This mechanism is NOT used to express “this journal block is
superseded by this other journal block”, as the author (djwong)
mistakenly thought. Any block being added to a transaction will cause
the removal of all existing revocation records for that block.</p>
<p>Revocation blocks are described in
<code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">jbd2_journal_revoke_header_s</span></code>, are at least 16 bytes in
length, but use a full block:</p>
<table class="colwidths-given docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 10%" />
<col style="width: 30%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Offset</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Name</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>0x0</p></td>
<td><p>journal_header_t</p></td>
<td><p>r_header</p></td>
<td><p>Common block header.</p></td>
</tr>
<tr class="row-odd"><td><p>0xC</p></td>
<td><p>__be32</p></td>
<td><p>r_count</p></td>
<td><p>Number of bytes used in this block.</p></td>
</tr>
<tr class="row-even"><td><p>0x10</p></td>
<td><p>__be32 or __be64</p></td>
<td><p>blocks[0]</p></td>
<td><p>Blocks to revoke.</p></td>
</tr>
</tbody>
</table>
<p>After r_count is a linear array of block numbers that are effectively
revoked by this transaction. The size of each block number is 8 bytes if
the superblock advertises 64-bit block number support, or 4 bytes
otherwise.</p>
<p>If JBD2_FEATURE_INCOMPAT_CSUM_V2 or
JBD2_FEATURE_INCOMPAT_CSUM_V3 are set, the end of the revocation
block is a <code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">jbd2_journal_revoke_tail</span></code>, which has this format:</p>
<table class="colwidths-given docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 10%" />
<col style="width: 30%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Offset</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Name</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>0x0</p></td>
<td><p>__be32</p></td>
<td><p>r_checksum</p></td>
<td><p>Checksum of the journal UUID + revocation block</p></td>
</tr>
</tbody>
</table>
</section>
<section id="commit-block">
<h2>Commit Block<a class="headerlink" href="#commit-block" title="Permalink to this headline">¶</a></h2>
<p>The commit block is a sentry that indicates that a transaction has been
completely written to the journal. Once this commit block reaches the
journal, the data stored with this transaction can be written to their
final locations on disk.</p>
<p>The commit block is described by <code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">commit_header</span></code>, which is 32
bytes long (but uses a full block):</p>
<table class="colwidths-given docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 10%" />
<col style="width: 30%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Offset</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Name</p></th>
<th class="head"><p>Descriptor</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>0x0</p></td>
<td><p>journal_header_s</p></td>
<td><p>(open coded)</p></td>
<td><p>Common block header.</p></td>
</tr>
<tr class="row-odd"><td><p>0xC</p></td>
<td><p>unsigned char</p></td>
<td><p>h_chksum_type</p></td>
<td><p>The type of checksum to use to verify the integrity of the data blocks
in the transaction. See <a class="reference internal" href="#jbd2-checksum-type">jbd2_checksum_type</a> for more info.</p></td>
</tr>
<tr class="row-even"><td><p>0xD</p></td>
<td><p>unsigned char</p></td>
<td><p>h_chksum_size</p></td>
<td><p>The number of bytes used by the checksum. Most likely 4.</p></td>
</tr>
<tr class="row-odd"><td><p>0xE</p></td>
<td><p>unsigned char</p></td>
<td><p>h_padding[2]</p></td>
<td></td>
</tr>
<tr class="row-even"><td><p>0x10</p></td>
<td><p>__be32</p></td>
<td><p>h_chksum[JBD2_CHECKSUM_BYTES]</p></td>
<td><p>32 bytes of space to store checksums. If
JBD2_FEATURE_INCOMPAT_CSUM_V2 or JBD2_FEATURE_INCOMPAT_CSUM_V3
are set, the first <code class="docutils literal notranslate"><span class="pre">__be32</span></code> is the checksum of the journal UUID and
the entire commit block, with this field zeroed. If
JBD2_FEATURE_COMPAT_CHECKSUM is set, the first <code class="docutils literal notranslate"><span class="pre">__be32</span></code> is the
crc32 of all the blocks already written to the transaction.</p></td>
</tr>
<tr class="row-odd"><td><p>0x30</p></td>
<td><p>__be64</p></td>
<td><p>h_commit_sec</p></td>
<td><p>The time that the transaction was committed, in seconds since the epoch.</p></td>
</tr>
<tr class="row-even"><td><p>0x38</p></td>
<td><p>__be32</p></td>
<td><p>h_commit_nsec</p></td>
<td><p>Nanoseconds component of the above timestamp.</p></td>
</tr>
</tbody>
</table>
</section>
<section id="fast-commits">
<h2>Fast commits<a class="headerlink" href="#fast-commits" title="Permalink to this headline">¶</a></h2>
<p>Fast commit area is organized as a log of tag length values. Each TLV has
a <code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">ext4_fc_tl</span></code> in the beginning which stores the tag and the length
of the entire field. It is followed by variable length tag specific value.
Here is the list of supported tags and their meanings:</p>
<table class="colwidths-given docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 25%" />
<col style="width: 25%" />
<col style="width: 40%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Tag</p></th>
<th class="head"><p>Meaning</p></th>
<th class="head"><p>Value struct</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>EXT4_FC_TAG_HEAD</p></td>
<td><p>Fast commit area header</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">ext4_fc_head</span></code></p></td>
<td><p>Stores the TID of the transaction after which these fast commits should
be applied.</p></td>
</tr>
<tr class="row-odd"><td><p>EXT4_FC_TAG_ADD_RANGE</p></td>
<td><p>Add extent to inode</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">ext4_fc_add_range</span></code></p></td>
<td><p>Stores the inode number and extent to be added in this inode</p></td>
</tr>
<tr class="row-even"><td><p>EXT4_FC_TAG_DEL_RANGE</p></td>
<td><p>Remove logical offsets to inode</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">ext4_fc_del_range</span></code></p></td>
<td><p>Stores the inode number and the logical offset range that needs to be
removed</p></td>
</tr>
<tr class="row-odd"><td><p>EXT4_FC_TAG_CREAT</p></td>
<td><p>Create directory entry for a newly created file</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">ext4_fc_dentry_info</span></code></p></td>
<td><p>Stores the parent inode number, inode number and directory entry of the
newly created file</p></td>
</tr>
<tr class="row-even"><td><p>EXT4_FC_TAG_LINK</p></td>
<td><p>Link a directory entry to an inode</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">ext4_fc_dentry_info</span></code></p></td>
<td><p>Stores the parent inode number, inode number and directory entry</p></td>
</tr>
<tr class="row-odd"><td><p>EXT4_FC_TAG_UNLINK</p></td>
<td><p>Unlink a directory entry of an inode</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">ext4_fc_dentry_info</span></code></p></td>
<td><p>Stores the parent inode number, inode number and directory entry</p></td>
</tr>
<tr class="row-even"><td><p>EXT4_FC_TAG_PAD</p></td>
<td><p>Padding (unused area)</p></td>
<td><p>None</p></td>
<td><p>Unused bytes in the fast commit area.</p></td>
</tr>
<tr class="row-odd"><td><p>EXT4_FC_TAG_TAIL</p></td>
<td><p>Mark the end of a fast commit</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">ext4_fc_tail</span></code></p></td>
<td><p>Stores the TID of the commit, CRC of the fast commit of which this tag
represents the end of</p></td>
</tr>
</tbody>
</table>
</section>
<section id="fast-commit-replay-idempotence">
<h2>Fast Commit Replay Idempotence<a class="headerlink" href="#fast-commit-replay-idempotence" title="Permalink to this headline">¶</a></h2>
<p>Fast commits tags are idempotent in nature provided the recovery code follows
certain rules. The guiding principle that the commit path follows while
committing is that it stores the result of a particular operation instead of
storing the procedure.</p>
<p>Let’s consider this rename operation: ‘mv /a /b’. Let’s assume dirent ‘/a’
was associated with inode 10. During fast commit, instead of storing this
operation as a procedure “rename a to b”, we store the resulting file system
state as a “series” of outcomes:</p>
<ul class="simple">
<li><p>Link dirent b to inode 10</p></li>
<li><p>Unlink dirent a</p></li>
<li><p>Inode 10 with valid refcount</p></li>
</ul>
<p>Now when recovery code runs, it needs “enforce” this state on the file
system. This is what guarantees idempotence of fast commit replay.</p>
<p>Let’s take an example of a procedure that is not idempotent and see how fast
commits make it idempotent. Consider following sequence of operations:</p>
<ol class="arabic simple">
<li><p>rm A</p></li>
<li><p>mv B A</p></li>
<li><p>read A</p></li>
</ol>
<p>If we store this sequence of operations as is then the replay is not idempotent.
Let’s say while in replay, we crash after (2). During the second replay,
file A (which was actually created as a result of “mv B A” operation) would get
deleted. Thus, file named A would be absent when we try to read A. So, this
sequence of operations is not idempotent. However, as mentioned above, instead
of storing the procedure fast commits store the outcome of each procedure. Thus
the fast commit log for above procedure would be as follows:</p>
<p>(Let’s assume dirent A was linked to inode 10 and dirent B was linked to
inode 11 before the replay)</p>
<ol class="arabic simple">
<li><p>Unlink A</p></li>
<li><p>Link A to inode 11</p></li>
<li><p>Unlink B</p></li>
<li><p>Inode 11</p></li>
</ol>
<p>If we crash after (3) we will have file A linked to inode 11. During the second
replay, we will remove file A (inode 11). But we will create it back and make
it point to inode 11. We won’t find B, so we’ll just skip that step. At this
point, the refcount for inode 11 is not reliable, but that gets fixed by the
replay of last inode 11 tag. Thus, by converting a non-idempotent procedure
into a series of idempotent outcomes, fast commits ensured idempotence during
the replay.</p>
</section>
<section id="journal-checkpoint">
<h2>Journal Checkpoint<a class="headerlink" href="#journal-checkpoint" title="Permalink to this headline">¶</a></h2>
<p>Checkpointing the journal ensures all transactions and their associated buffers
are submitted to the disk. In-progress transactions are waited upon and included
in the checkpoint. Checkpointing is used internally during critical updates to
the filesystem including journal recovery, filesystem resizing, and freeing of
the journal_t structure.</p>
<p>A journal checkpoint can be triggered from userspace via the ioctl
EXT4_IOC_CHECKPOINT. This ioctl takes a single, u64 argument for flags.
Currently, three flags are supported. First, EXT4_IOC_CHECKPOINT_FLAG_DRY_RUN
can be used to verify input to the ioctl. It returns error if there is any
invalid input, otherwise it returns success without performing
any checkpointing. This can be used to check whether the ioctl exists on a
system and to verify there are no issues with arguments or flags. The
other two flags are EXT4_IOC_CHECKPOINT_FLAG_DISCARD and
EXT4_IOC_CHECKPOINT_FLAG_ZEROOUT. These flags cause the journal blocks to be
discarded or zero-filled, respectively, after the journal checkpoint is
complete. EXT4_IOC_CHECKPOINT_FLAG_DISCARD and EXT4_IOC_CHECKPOINT_FLAG_ZEROOUT
cannot both be set. The ioctl may be useful when snapshotting a system or for
complying with content deletion SLOs.</p>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">The Linux Kernel</a></h1>



<p class="blurb">6.2.0-rc4-6.2.0-rc4+</p>







<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
  <h3><a href="../../index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Journal (jbd2)</a><ul>
<li><a class="reference internal" href="#layout">Layout</a></li>
<li><a class="reference internal" href="#external-journal">External Journal</a></li>
<li><a class="reference internal" href="#block-header">Block Header</a></li>
<li><a class="reference internal" href="#super-block">Super Block</a></li>
<li><a class="reference internal" href="#descriptor-block">Descriptor Block</a></li>
<li><a class="reference internal" href="#data-block">Data Block</a></li>
<li><a class="reference internal" href="#revocation-block">Revocation Block</a></li>
<li><a class="reference internal" href="#commit-block">Commit Block</a></li>
<li><a class="reference internal" href="#fast-commits">Fast commits</a></li>
<li><a class="reference internal" href="#fast-commit-replay-idempotence">Fast Commit Replay Idempotence</a></li>
<li><a class="reference internal" href="#journal-checkpoint">Journal Checkpoint</a></li>
</ul>
</li>
</ul>

  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../../_sources/filesystems/ext4/journal.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;The kernel development community.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 2.4.4</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="../../_sources/filesystems/ext4/journal.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>