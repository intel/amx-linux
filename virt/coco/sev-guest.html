
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>The Definitive SEV Guest API Documentation &#8212; The Linux Kernel 6.2.0-rc4+ documentation</title>
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="TDX Guest API Documentation" href="tdx-guest.html" />
    <link rel="prev" title="ACRN CPUID bits" href="../acrn/cpuid.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="the-definitive-sev-guest-api-documentation">
<h1>The Definitive SEV Guest API Documentation<a class="headerlink" href="#the-definitive-sev-guest-api-documentation" title="Permalink to this headline">¶</a></h1>
<section id="general-description">
<h2>1. General description<a class="headerlink" href="#general-description" title="Permalink to this headline">¶</a></h2>
<p>The SEV API is a set of ioctls that are used by the guest or hypervisor
to get or set a certain aspect of the SEV virtual machine. The ioctls belong
to the following classes:</p>
<blockquote>
<div><ul class="simple">
<li><p>Hypervisor ioctls: These query and set global attributes which affect the
whole SEV firmware.  These ioctl are used by platform provisioning tools.</p></li>
<li><p>Guest ioctls: These query and set attributes of the SEV virtual machine.</p></li>
</ul>
</div></blockquote>
</section>
<section id="api-description">
<h2>2. API description<a class="headerlink" href="#api-description" title="Permalink to this headline">¶</a></h2>
<p>This section describes ioctls that is used for querying the SEV guest report
from the SEV firmware. For each ioctl, the following information is provided
along with a description:</p>
<blockquote>
<div><dl class="simple">
<dt>Technology:</dt><dd><p>which SEV technology provides this ioctl. SEV, SEV-ES, SEV-SNP or all.</p>
</dd>
<dt>Type:</dt><dd><p>hypervisor or guest. The ioctl can be used inside the guest or the
hypervisor.</p>
</dd>
<dt>Parameters:</dt><dd><p>what parameters are accepted by the ioctl.</p>
</dd>
<dt>Returns:</dt><dd><p>the return value.  General error numbers (-ENOMEM, -EINVAL)
are not detailed, but errors with specific meanings are.</p>
</dd>
</dl>
</div></blockquote>
<p>The guest ioctl should be issued on a file descriptor of the /dev/sev-guest device.
The ioctl accepts struct snp_user_guest_request. The input and output structure is
specified through the req_data and resp_data field respectively. If the ioctl fails
to execute due to a firmware error, then fw_err code will be set otherwise the
fw_err will be set to 0x00000000000000ff.</p>
<p>The firmware checks that the message sequence counter is one greater than
the guests message sequence counter. If guest driver fails to increment message
counter (e.g. counter overflow), then -EIO will be returned.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>struct snp_guest_request_ioctl {
        /* Message version number */
        __u32 msg_version;

        /* Request and response structure address */
        __u64 req_data;
        __u64 resp_data;

        /* firmware error code on failure (see psp-sev.h) */
        __u64 fw_err;
};
</pre></div>
</div>
<section id="snp-get-report">
<h3>2.1 SNP_GET_REPORT<a class="headerlink" href="#snp-get-report" title="Permalink to this headline">¶</a></h3>
<dl class="field-list simple">
<dt class="field-odd">Technology</dt>
<dd class="field-odd"><p>sev-snp</p>
</dd>
<dt class="field-even">Type</dt>
<dd class="field-even"><p>guest ioctl</p>
</dd>
<dt class="field-odd">Parameters (in)</dt>
<dd class="field-odd"><p>struct snp_report_req</p>
</dd>
<dt class="field-even">Returns (out)</dt>
<dd class="field-even"><p>struct snp_report_resp on success, -negative on error</p>
</dd>
</dl>
<p>The SNP_GET_REPORT ioctl can be used to query the attestation report from the
SEV-SNP firmware. The ioctl uses the SNP_GUEST_REQUEST (MSG_REPORT_REQ) command
provided by the SEV-SNP firmware to query the attestation report.</p>
<p>On success, the snp_report_resp.data will contains the report. The report
contain the format described in the SEV-SNP specification. See the SEV-SNP
specification for further details.</p>
</section>
<section id="snp-get-derived-key">
<h3>2.2 SNP_GET_DERIVED_KEY<a class="headerlink" href="#snp-get-derived-key" title="Permalink to this headline">¶</a></h3>
<dl class="field-list simple">
<dt class="field-odd">Technology</dt>
<dd class="field-odd"><p>sev-snp</p>
</dd>
<dt class="field-even">Type</dt>
<dd class="field-even"><p>guest ioctl</p>
</dd>
<dt class="field-odd">Parameters (in)</dt>
<dd class="field-odd"><p>struct snp_derived_key_req</p>
</dd>
<dt class="field-even">Returns (out)</dt>
<dd class="field-even"><p>struct snp_derived_key_resp on success, -negative on error</p>
</dd>
</dl>
<p>The SNP_GET_DERIVED_KEY ioctl can be used to get a key derive from a root key.
The derived key can be used by the guest for any purpose, such as sealing keys
or communicating with external entities.</p>
<p>The ioctl uses the SNP_GUEST_REQUEST (MSG_KEY_REQ) command provided by the
SEV-SNP firmware to derive the key. See SEV-SNP specification for further details
on the various fields passed in the key derivation request.</p>
<p>On success, the snp_derived_key_resp.data contains the derived key value. See
the SEV-SNP specification for further details.</p>
</section>
<section id="snp-get-ext-report">
<h3>2.3 SNP_GET_EXT_REPORT<a class="headerlink" href="#snp-get-ext-report" title="Permalink to this headline">¶</a></h3>
<dl class="field-list simple">
<dt class="field-odd">Technology</dt>
<dd class="field-odd"><p>sev-snp</p>
</dd>
<dt class="field-even">Type</dt>
<dd class="field-even"><p>guest ioctl</p>
</dd>
<dt class="field-odd">Parameters (in/out)</dt>
<dd class="field-odd"><p>struct snp_ext_report_req</p>
</dd>
<dt class="field-even">Returns (out)</dt>
<dd class="field-even"><p>struct snp_report_resp on success, -negative on error</p>
</dd>
</dl>
<p>The SNP_GET_EXT_REPORT ioctl is similar to the SNP_GET_REPORT. The difference is
related to the additional certificate data that is returned with the report.
The certificate data returned is being provided by the hypervisor through the
SNP_SET_EXT_CONFIG.</p>
<p>The ioctl uses the SNP_GUEST_REQUEST (MSG_REPORT_REQ) command provided by the SEV-SNP
firmware to get the attestation report.</p>
<p>On success, the snp_ext_report_resp.data will contain the attestation report
and snp_ext_report_req.certs_address will contain the certificate blob. If the
length of the blob is smaller than expected then snp_ext_report_req.certs_len will
be updated with the expected value.</p>
<p>See GHCB specification for further detail on how to parse the certificate blob.</p>
</section>
</section>
<section id="sev-snp-cpuid-enforcement">
<h2>3. SEV-SNP CPUID Enforcement<a class="headerlink" href="#sev-snp-cpuid-enforcement" title="Permalink to this headline">¶</a></h2>
<p>SEV-SNP guests can access a special page that contains a table of CPUID values
that have been validated by the PSP as part of the SNP_LAUNCH_UPDATE firmware
command. It provides the following assurances regarding the validity of CPUID
values:</p>
<blockquote>
<div><ul class="simple">
<li><p>Its address is obtained via bootloader/firmware (via CC blob), and those
binaries will be measured as part of the SEV-SNP attestation report.</p></li>
<li><p>Its initial state will be encrypted/pvalidated, so attempts to modify
it during run-time will result in garbage being written, or #VC exceptions
being generated due to changes in validation state if the hypervisor tries
to swap the backing page.</p></li>
<li><p>Attempts to bypass PSP checks by the hypervisor by using a normal page, or
a non-CPUID encrypted page will change the measurement provided by the
SEV-SNP attestation report.</p></li>
<li><p>The CPUID page contents are <em>not</em> measured, but attempts to modify the
expected contents of a CPUID page as part of guest initialization will be
gated by the PSP CPUID enforcement policy checks performed on the page
during SNP_LAUNCH_UPDATE, and noticeable later if the guest owner
implements their own checks of the CPUID values.</p></li>
</ul>
</div></blockquote>
<p>It is important to note that this last assurance is only useful if the kernel
has taken care to make use of the SEV-SNP CPUID throughout all stages of boot.
Otherwise, guest owner attestation provides no assurance that the kernel wasn’t
fed incorrect values at some point during boot.</p>
<section id="reference">
<h3>Reference<a class="headerlink" href="#reference" title="Permalink to this headline">¶</a></h3>
<p>SEV-SNP and GHCB specification: developer.amd.com/sev</p>
<p>The driver is based on SEV-SNP firmware spec 0.9 and GHCB spec version 2.0.</p>
</section>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">The Linux Kernel</a></h1>



<p class="blurb">6.2.0-rc4-6.2.0-rc4+</p>







<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
  <h3><a href="../../index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">The Definitive SEV Guest API Documentation</a><ul>
<li><a class="reference internal" href="#general-description">1. General description</a></li>
<li><a class="reference internal" href="#api-description">2. API description</a><ul>
<li><a class="reference internal" href="#snp-get-report">2.1 SNP_GET_REPORT</a></li>
<li><a class="reference internal" href="#snp-get-derived-key">2.2 SNP_GET_DERIVED_KEY</a></li>
<li><a class="reference internal" href="#snp-get-ext-report">2.3 SNP_GET_EXT_REPORT</a></li>
</ul>
</li>
<li><a class="reference internal" href="#sev-snp-cpuid-enforcement">3. SEV-SNP CPUID Enforcement</a><ul>
<li><a class="reference internal" href="#reference">Reference</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../../_sources/virt/coco/sev-guest.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;The kernel development community.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 2.4.4</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="../../_sources/virt/coco/sev-guest.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>