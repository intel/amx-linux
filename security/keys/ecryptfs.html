
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Encrypted keys for the eCryptfs filesystem &#8212; The Linux Kernel 6.2.0-rc4+ documentation</title>
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Key Request Service" href="request-key.html" />
    <link rel="prev" title="Kernel Key Retention Service" href="core.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="encrypted-keys-for-the-ecryptfs-filesystem">
<h1>Encrypted keys for the eCryptfs filesystem<a class="headerlink" href="#encrypted-keys-for-the-ecryptfs-filesystem" title="Permalink to this headline">¶</a></h1>
<p>ECryptfs is a stacked filesystem which transparently encrypts and decrypts each
file using a randomly generated File Encryption Key (FEK).</p>
<p>Each FEK is in turn encrypted with a File Encryption Key Encryption Key (FEKEK)
either in kernel space or in user space with a daemon called ‘ecryptfsd’.  In
the former case the operation is performed directly by the kernel CryptoAPI
using a key, the FEKEK, derived from a user prompted passphrase;  in the latter
the FEK is encrypted by ‘ecryptfsd’ with the help of external libraries in order
to support other mechanisms like public key cryptography, PKCS#11 and TPM based
operations.</p>
<p>The data structure defined by eCryptfs to contain information required for the
FEK decryption is called authentication token and, currently, can be stored in a
kernel key of the ‘user’ type, inserted in the user’s session specific keyring
by the userspace utility ‘mount.ecryptfs’ shipped with the package
‘ecryptfs-utils’.</p>
<p>The ‘encrypted’ key type has been extended with the introduction of the new
format ‘ecryptfs’ in order to be used in conjunction with the eCryptfs
filesystem.  Encrypted keys of the newly introduced format store an
authentication token in its payload with a FEKEK randomly generated by the
kernel and protected by the parent master key.</p>
<p>In order to avoid known-plaintext attacks, the datablob obtained through
commands ‘keyctl print’ or ‘keyctl pipe’ does not contain the overall
authentication token, which content is well known, but only the FEKEK in
encrypted form.</p>
<p>The eCryptfs filesystem may really benefit from using encrypted keys in that the
required key can be securely generated by an Administrator and provided at boot
time after the unsealing of a ‘trusted’ key in order to perform the mount in a
controlled environment.  Another advantage is that the key is not exposed to
threats of malicious software, because it is available in clear form only at
kernel level.</p>
<p>Usage:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>keyctl add encrypted name &quot;new ecryptfs key-type:master-key-name keylen&quot; ring
keyctl add encrypted name &quot;load hex_blob&quot; ring
keyctl update keyid &quot;update key-type:master-key-name&quot;
</pre></div>
</div>
<p>Where:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>name:= &#39;&lt;16 hexadecimal characters&gt;&#39;
key-type:= &#39;trusted&#39; | &#39;user&#39;
keylen:= 64
</pre></div>
</div>
<p>Example of encrypted key usage with the eCryptfs filesystem:</p>
<p>Create an encrypted key “1000100010001000” of length 64 bytes with format
‘ecryptfs’ and save it using a previously loaded user key “test”:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ keyctl add encrypted 1000100010001000 &quot;new ecryptfs user:test 64&quot; @u
19184530

$ keyctl print 19184530
ecryptfs user:test 64 490045d4bfe48c99f0d465fbbbb79e7500da954178e2de0697
dd85091f5450a0511219e9f7cd70dcd498038181466f78ac8d4c19504fcc72402bfc41c2
f253a41b7507ccaa4b2b03fff19a69d1cc0b16e71746473f023a95488b6edfd86f7fdd40
9d292e4bacded1258880122dd553a661

$ keyctl pipe 19184530 &gt; ecryptfs.blob
</pre></div>
</div>
<p>Mount an eCryptfs filesystem using the created encrypted key “1000100010001000”
into the ‘/secret’ directory:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ mount -i -t ecryptfs -oecryptfs_sig=1000100010001000,\
  ecryptfs_cipher=aes,ecryptfs_key_bytes=32 /secret /secret
</pre></div>
</div>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">The Linux Kernel</a></h1>



<p class="blurb">6.2.0-rc4-6.2.0-rc4+</p>







<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../../_sources/security/keys/ecryptfs.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;The kernel development community.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 2.4.4</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="../../_sources/security/keys/ecryptfs.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>