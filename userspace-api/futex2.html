
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>futex2 &#8212; The Linux Kernel 6.2.0-rc4+ documentation</title>
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="The Linux kernel firmware guide" href="../firmware-guide/index.html" />
    <link rel="prev" title="VDUSE - “vDPA Device in Userspace”" href="vduse.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="futex2">
<h1>futex2<a class="headerlink" href="#futex2" title="Permalink to this headline">¶</a></h1>
<dl class="field-list simple">
<dt class="field-odd">Author</dt>
<dd class="field-odd"><p>André Almeida &lt;<a class="reference external" href="mailto:andrealmeid&#37;&#52;&#48;collabora&#46;com">andrealmeid<span>&#64;</span>collabora<span>&#46;</span>com</a>&gt;</p>
</dd>
</dl>
<p>futex, or fast user mutex, is a set of syscalls to allow userspace to create
performant synchronization mechanisms, such as mutexes, semaphores and
conditional variables in userspace. C standard libraries, like glibc, uses it
as a means to implement more high level interfaces like pthreads.</p>
<p>futex2 is a followup version of the initial futex syscall, designed to overcome
limitations of the original interface.</p>
<section id="user-api">
<h2>User API<a class="headerlink" href="#user-api" title="Permalink to this headline">¶</a></h2>
<section id="futex-waitv">
<h3><code class="docutils literal notranslate"><span class="pre">futex_waitv()</span></code><a class="headerlink" href="#futex-waitv" title="Permalink to this headline">¶</a></h3>
<p>Wait on an array of futexes, wake on any:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>futex_waitv(struct futex_waitv *waiters, unsigned int nr_futexes,
            unsigned int flags, struct timespec *timeout, clockid_t clockid)

struct futex_waitv {
      __u64 val;
      __u64 uaddr;
      __u32 flags;
      __u32 __reserved;
};
</pre></div>
</div>
<p>Userspace sets an array of struct futex_waitv (up to a max of 128 entries),
using <code class="docutils literal notranslate"><span class="pre">uaddr</span></code> for the address to wait for, <code class="docutils literal notranslate"><span class="pre">val</span></code> for the expected value
and <code class="docutils literal notranslate"><span class="pre">flags</span></code> to specify the type (e.g. private) and size of futex.
<code class="docutils literal notranslate"><span class="pre">__reserved</span></code> needs to be 0, but it can be used for future extension. The
pointer for the first item of the array is passed as <code class="docutils literal notranslate"><span class="pre">waiters</span></code>. An invalid
address for <code class="docutils literal notranslate"><span class="pre">waiters</span></code> or for any <code class="docutils literal notranslate"><span class="pre">uaddr</span></code> returns <code class="docutils literal notranslate"><span class="pre">-EFAULT</span></code>.</p>
<p>If userspace has 32-bit pointers, it should do a explicit cast to make sure
the upper bits are zeroed. <code class="docutils literal notranslate"><span class="pre">uintptr_t</span></code> does the tricky and it works for
both 32/64-bit pointers.</p>
<p><code class="docutils literal notranslate"><span class="pre">nr_futexes</span></code> specifies the size of the array. Numbers out of [1, 128]
interval will make the syscall return <code class="docutils literal notranslate"><span class="pre">-EINVAL</span></code>.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">flags</span></code> argument of the syscall needs to be 0, but it can be used for
future extension.</p>
<p>For each entry in <code class="docutils literal notranslate"><span class="pre">waiters</span></code> array, the current value at <code class="docutils literal notranslate"><span class="pre">uaddr</span></code> is compared
to <code class="docutils literal notranslate"><span class="pre">val</span></code>. If it’s different, the syscall undo all the work done so far and
return <code class="docutils literal notranslate"><span class="pre">-EAGAIN</span></code>. If all tests and verifications succeeds, syscall waits until
one of the following happens:</p>
<ul class="simple">
<li><p>The timeout expires, returning <code class="docutils literal notranslate"><span class="pre">-ETIMEOUT</span></code>.</p></li>
<li><p>A signal was sent to the sleeping task, returning <code class="docutils literal notranslate"><span class="pre">-ERESTARTSYS</span></code>.</p></li>
<li><p>Some futex at the list was woken, returning the index of some waked futex.</p></li>
</ul>
<p>An example of how to use the interface can be found at <code class="docutils literal notranslate"><span class="pre">tools/testing/selftests/futex/functional/futex_waitv.c</span></code>.</p>
</section>
<section id="timeout">
<h3>Timeout<a class="headerlink" href="#timeout" title="Permalink to this headline">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">timespec</span> <span class="pre">*timeout</span></code> argument is an optional argument that points to an
absolute timeout. You need to specify the type of clock being used at
<code class="docutils literal notranslate"><span class="pre">clockid</span></code> argument. <code class="docutils literal notranslate"><span class="pre">CLOCK_MONOTONIC</span></code> and <code class="docutils literal notranslate"><span class="pre">CLOCK_REALTIME</span></code> are supported.
This syscall accepts only 64bit timespec structs.</p>
</section>
<section id="types-of-futex">
<h3>Types of futex<a class="headerlink" href="#types-of-futex" title="Permalink to this headline">¶</a></h3>
<p>A futex can be either private or shared. Private is used for processes that
shares the same memory space and the virtual address of the futex will be the
same for all processes. This allows for optimizations in the kernel. To use
private futexes, it’s necessary to specify <code class="docutils literal notranslate"><span class="pre">FUTEX_PRIVATE_FLAG</span></code> in the futex
flag. For processes that doesn’t share the same memory space and therefore can
have different virtual addresses for the same futex (using, for instance, a
file-backed shared memory) requires different internal mechanisms to be get
properly enqueued. This is the default behavior, and it works with both private
and shared futexes.</p>
<p>Futexes can be of different sizes: 8, 16, 32 or 64 bits. Currently, the only
supported one is 32 bit sized futex, and it need to be specified using
<code class="docutils literal notranslate"><span class="pre">FUTEX_32</span></code> flag.</p>
</section>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../index.html">The Linux Kernel</a></h1>



<p class="blurb">6.2.0-rc4-6.2.0-rc4+</p>







<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
  <h3><a href="../index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">futex2</a><ul>
<li><a class="reference internal" href="#user-api">User API</a><ul>
<li><a class="reference internal" href="#futex-waitv"><code class="docutils literal notranslate"><span class="pre">futex_waitv()</span></code></a></li>
<li><a class="reference internal" href="#timeout">Timeout</a></li>
<li><a class="reference internal" href="#types-of-futex">Types of futex</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/userspace-api/futex2.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;The kernel development community.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 2.4.4</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="../_sources/userspace-api/futex2.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>