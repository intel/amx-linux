
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>DAWR issues on POWER9 &#8212; The Linux Kernel 6.2.0-rc4+ documentation</title>
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="DSCR (Data Stream Control Register)" href="dscr.html" />
    <link rel="prev" title="Coherent Accelerator (CXL) Flash" href="cxlflash.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="dawr-issues-on-power9">
<h1>DAWR issues on POWER9<a class="headerlink" href="#dawr-issues-on-power9" title="Permalink to this headline">¶</a></h1>
<p>On older POWER9 processors, the Data Address Watchpoint Register (DAWR) can
cause a checkstop if it points to cache inhibited (CI) memory. Currently Linux
has no way to distinguish CI memory when configuring the DAWR, so on affected
systems, the DAWR is disabled.</p>
<section id="affected-processor-revisions">
<h2>Affected processor revisions<a class="headerlink" href="#affected-processor-revisions" title="Permalink to this headline">¶</a></h2>
<p>This issue is only present on processors prior to v2.3. The revision can be
found in /proc/cpuinfo:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>processor       : 0
cpu             : POWER9, altivec supported
clock           : 3800.000000MHz
revision        : 2.3 (pvr 004e 1203)
</pre></div>
</div>
<p>On a system with the issue, the DAWR is disabled as detailed below.</p>
</section>
<section id="technical-details">
<h2>Technical Details:<a class="headerlink" href="#technical-details" title="Permalink to this headline">¶</a></h2>
<p>DAWR has 6 different ways of being set.
1) ptrace
2) h_set_mode(DAWR)
3) h_set_dabr()
4) kvmppc_set_one_reg()
5) xmon</p>
<p>For ptrace, we now advertise zero breakpoints on POWER9 via the
PPC_PTRACE_GETHWDBGINFO call. This results in GDB falling back to
software emulation of the watchpoint (which is slow).</p>
<p>h_set_mode(DAWR) and h_set_dabr() will now return an error to the
guest on a POWER9 host. Current Linux guests ignore this error, so
they will silently not get the DAWR.</p>
<p>kvmppc_set_one_reg() will store the value in the vcpu but won’t
actually set it on POWER9 hardware. This is done so we don’t break
migration from POWER8 to POWER9, at the cost of silently losing the
DAWR on the migration.</p>
<p>For xmon, the ‘bd’ command will return an error on P9.</p>
</section>
<section id="consequences-for-users">
<h2>Consequences for users<a class="headerlink" href="#consequences-for-users" title="Permalink to this headline">¶</a></h2>
<p>For GDB watchpoints (ie ‘watch’ command) on POWER9 bare metal , GDB
will accept the command. Unfortunately since there is no hardware
support for the watchpoint, GDB will software emulate the watchpoint
making it run very slowly.</p>
<p>The same will also be true for any guests started on a POWER9
host. The watchpoint will fail and GDB will fall back to software
emulation.</p>
<p>If a guest is started on a POWER8 host, GDB will accept the watchpoint
and configure the hardware to use the DAWR. This will run at full
speed since it can use the hardware emulation. Unfortunately if this
guest is migrated to a POWER9 host, the watchpoint will be lost on the
POWER9. Loads and stores to the watchpoint locations will not be
trapped in GDB. The watchpoint is remembered, so if the guest is
migrated back to the POWER8 host, it will start working again.</p>
</section>
<section id="force-enabling-the-dawr">
<h2>Force enabling the DAWR<a class="headerlink" href="#force-enabling-the-dawr" title="Permalink to this headline">¶</a></h2>
<p>Kernels (since ~v5.2) have an option to force enable the DAWR via:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>echo Y &gt; /sys/kernel/debug/powerpc/dawr_enable_dangerous
</pre></div>
</div>
<p>This enables the DAWR even on POWER9.</p>
<p>This is a dangerous setting, USE AT YOUR OWN RISK.</p>
<p>Some users may not care about a bad user crashing their box
(ie. single user/desktop systems) and really want the DAWR.  This
allows them to force enable DAWR.</p>
<p>This flag can also be used to disable DAWR access. Once this is
cleared, all DAWR access should be cleared immediately and your
machine once again safe from crashing.</p>
<p>Userspace may get confused by toggling this. If DAWR is force
enabled/disabled between getting the number of breakpoints (via
PTRACE_GETHWDBGINFO) and setting the breakpoint, userspace will get an
inconsistent view of what’s available. Similarly for guests.</p>
<p>For the DAWR to be enabled in a KVM guest, the DAWR needs to be force
enabled in the host AND the guest. For this reason, this won’t work on
POWERVM as it doesn’t allow the HCALL to work. Writes of ‘Y’ to the
dawr_enable_dangerous file will fail if the hypervisor doesn’t support
writing the DAWR.</p>
<p>To double check the DAWR is working, run this kernel selftest:</p>
<blockquote>
<div><p>tools/testing/selftests/powerpc/ptrace/ptrace-hwbreak.c</p>
</div></blockquote>
<p>Any errors/failures/skips mean something is wrong.</p>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../index.html">The Linux Kernel</a></h1>



<p class="blurb">6.2.0-rc4-6.2.0-rc4+</p>







<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
  <h3><a href="../index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">DAWR issues on POWER9</a><ul>
<li><a class="reference internal" href="#affected-processor-revisions">Affected processor revisions</a></li>
<li><a class="reference internal" href="#technical-details">Technical Details:</a></li>
<li><a class="reference internal" href="#consequences-for-users">Consequences for users</a></li>
<li><a class="reference internal" href="#force-enabling-the-dawr">Force enabling the DAWR</a></li>
</ul>
</li>
</ul>

  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/powerpc/dawr-power9.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;The kernel development community.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 2.4.4</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="../_sources/powerpc/dawr-power9.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>