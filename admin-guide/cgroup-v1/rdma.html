
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>RDMA Controller &#8212; The Linux Kernel 6.2.0-rc4+ documentation</title>
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Control Group v2" href="../cgroup-v2.html" />
    <link rel="prev" title="Process Number Controller" href="pids.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="rdma-controller">
<h1>RDMA Controller<a class="headerlink" href="#rdma-controller" title="Permalink to this headline">¶</a></h1>
<section id="overview">
<h2>1. Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<section id="what-is-rdma-controller">
<h3>1-1. What is RDMA controller?<a class="headerlink" href="#what-is-rdma-controller" title="Permalink to this headline">¶</a></h3>
<p>RDMA controller allows user to limit RDMA/IB specific resources that a given
set of processes can use. These processes are grouped using RDMA controller.</p>
<p>RDMA controller defines two resources which can be limited for processes of a
cgroup.</p>
</section>
<section id="why-rdma-controller-needed">
<h3>1-2. Why RDMA controller needed?<a class="headerlink" href="#why-rdma-controller-needed" title="Permalink to this headline">¶</a></h3>
<p>Currently user space applications can easily take away all the rdma verb
specific resources such as AH, CQ, QP, MR etc. Due to which other applications
in other cgroup or kernel space ULPs may not even get chance to allocate any
rdma resources. This can lead to service unavailability.</p>
<p>Therefore RDMA controller is needed through which resource consumption
of processes can be limited. Through this controller different rdma
resources can be accounted.</p>
</section>
<section id="how-is-rdma-controller-implemented">
<h3>1-3. How is RDMA controller implemented?<a class="headerlink" href="#how-is-rdma-controller-implemented" title="Permalink to this headline">¶</a></h3>
<p>RDMA cgroup allows limit configuration of resources. Rdma cgroup maintains
resource accounting per cgroup, per device using resource pool structure.
Each such resource pool is limited up to 64 resources in given resource pool
by rdma cgroup, which can be extended later if required.</p>
<p>This resource pool object is linked to the cgroup css. Typically there
are 0 to 4 resource pool instances per cgroup, per device in most use cases.
But nothing limits to have it more. At present hundreds of RDMA devices per
single cgroup may not be handled optimally, however there is no
known use case or requirement for such configuration either.</p>
<p>Since RDMA resources can be allocated from any process and can be freed by any
of the child processes which shares the address space, rdma resources are
always owned by the creator cgroup css. This allows process migration from one
to other cgroup without major complexity of transferring resource ownership;
because such ownership is not really present due to shared nature of
rdma resources. Linking resources around css also ensures that cgroups can be
deleted after processes migrated. This allow progress migration as well with
active resources, even though that is not a primary use case.</p>
<p>Whenever RDMA resource charging occurs, owner rdma cgroup is returned to
the caller. Same rdma cgroup should be passed while uncharging the resource.
This also allows process migrated with active RDMA resource to charge
to new owner cgroup for new resource. It also allows to uncharge resource of
a process from previously charged cgroup which is migrated to new cgroup,
even though that is not a primary use case.</p>
<p>Resource pool object is created in following situations.
(a) User sets the limit and no previous resource pool exist for the device
of interest for the cgroup.
(b) No resource limits were configured, but IB/RDMA stack tries to
charge the resource. So that it correctly uncharge them when applications are
running without limits and later on when limits are enforced during uncharging,
otherwise usage count will drop to negative.</p>
<p>Resource pool is destroyed if all the resource limits are set to max and
it is the last resource getting deallocated.</p>
<p>User should set all the limit to max value if it intents to remove/unconfigure
the resource pool for a particular device.</p>
<p>IB stack honors limits enforced by the rdma controller. When application
query about maximum resource limits of IB device, it returns minimum of
what is configured by user for a given cgroup and what is supported by
IB device.</p>
<p>Following resources can be accounted by rdma controller.</p>
<blockquote>
<div><table class="docutils align-default">
<colgroup>
<col style="width: 26%" />
<col style="width: 74%" />
</colgroup>
<tbody>
<tr class="row-odd"><td><p>hca_handle</p></td>
<td><p>Maximum number of HCA Handles</p></td>
</tr>
<tr class="row-even"><td><p>hca_object</p></td>
<td><p>Maximum number of HCA Objects</p></td>
</tr>
</tbody>
</table>
</div></blockquote>
</section>
</section>
<section id="usage-examples">
<h2>2. Usage Examples<a class="headerlink" href="#usage-examples" title="Permalink to this headline">¶</a></h2>
<ol class="loweralpha">
<li><p>Configure resource limit:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>echo mlx4_0 hca_handle=2 hca_object=2000 &gt; /sys/fs/cgroup/rdma/1/rdma.max
echo ocrdma1 hca_handle=3 &gt; /sys/fs/cgroup/rdma/2/rdma.max
</pre></div>
</div>
</li>
<li><p>Query resource limit:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>cat /sys/fs/cgroup/rdma/2/rdma.max
#Output:
mlx4_0 hca_handle=2 hca_object=2000
ocrdma1 hca_handle=3 hca_object=max
</pre></div>
</div>
</li>
<li><p>Query current usage:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>cat /sys/fs/cgroup/rdma/2/rdma.current
#Output:
mlx4_0 hca_handle=1 hca_object=20
ocrdma1 hca_handle=1 hca_object=23
</pre></div>
</div>
</li>
<li><p>Delete resource limit:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>echo mlx4_0 hca_handle=max hca_object=max &gt; /sys/fs/cgroup/rdma/1/rdma.max
</pre></div>
</div>
</li>
</ol>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">The Linux Kernel</a></h1>



<p class="blurb">6.2.0-rc4-6.2.0-rc4+</p>







<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
  <h3><a href="../../index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">RDMA Controller</a><ul>
<li><a class="reference internal" href="#overview">1. Overview</a><ul>
<li><a class="reference internal" href="#what-is-rdma-controller">1-1. What is RDMA controller?</a></li>
<li><a class="reference internal" href="#why-rdma-controller-needed">1-2. Why RDMA controller needed?</a></li>
<li><a class="reference internal" href="#how-is-rdma-controller-implemented">1-3. How is RDMA controller implemented?</a></li>
</ul>
</li>
<li><a class="reference internal" href="#usage-examples">2. Usage Examples</a></li>
</ul>
</li>
</ul>

  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../../_sources/admin-guide/cgroup-v1/rdma.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;The kernel development community.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 2.4.4</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="../../_sources/admin-guide/cgroup-v1/rdma.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>