
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Device-mapper “unstriped” target &#8212; The Linux Kernel 6.2.0-rc4+ documentation</title>
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="dm-verity" href="verity.html" />
    <link rel="prev" title="Thin provisioning" href="thin-provisioning.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="device-mapper-unstriped-target">
<h1>Device-mapper “unstriped” target<a class="headerlink" href="#device-mapper-unstriped-target" title="Permalink to this headline">¶</a></h1>
<section id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p>The device-mapper “unstriped” target provides a transparent mechanism to
unstripe a device-mapper “striped” target to access the underlying disks
without having to touch the true backing block-device.  It can also be
used to unstripe a hardware RAID-0 to access backing disks.</p>
<p>Parameters:
&lt;number of stripes&gt; &lt;chunk size&gt; &lt;stripe #&gt; &lt;dev_path&gt; &lt;offset&gt;</p>
<dl class="simple">
<dt>&lt;number of stripes&gt;</dt><dd><p>The number of stripes in the RAID 0.</p>
</dd>
<dt>&lt;chunk size&gt;</dt><dd><p>The amount of 512B sectors in the chunk striping.</p>
</dd>
<dt>&lt;dev_path&gt;</dt><dd><p>The block device you wish to unstripe.</p>
</dd>
<dt>&lt;stripe #&gt;</dt><dd><p>The stripe number within the device that corresponds to physical
drive you wish to unstripe.  This must be 0 indexed.</p>
</dd>
</dl>
</section>
<section id="why-use-this-module">
<h2>Why use this module?<a class="headerlink" href="#why-use-this-module" title="Permalink to this headline">¶</a></h2>
<section id="an-example-of-undoing-an-existing-dm-stripe">
<h3>An example of undoing an existing dm-stripe<a class="headerlink" href="#an-example-of-undoing-an-existing-dm-stripe" title="Permalink to this headline">¶</a></h3>
<p>This small bash script will setup 4 loop devices and use the existing
striped target to combine the 4 devices into one.  It then will use
the unstriped target ontop of the striped device to access the
individual backing loop devices.  We write data to the newly exposed
unstriped devices and verify the data written matches the correct
underlying device on the striped array:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>#!/bin/bash

MEMBER_SIZE=$((128 * 1024 * 1024))
NUM=4
SEQ_END=$((${NUM}-1))
CHUNK=256
BS=4096

RAID_SIZE=$((${MEMBER_SIZE}*${NUM}/512))
DM_PARMS=&quot;0 ${RAID_SIZE} striped ${NUM} ${CHUNK}&quot;
COUNT=$((${MEMBER_SIZE} / ${BS}))

for i in $(seq 0 ${SEQ_END}); do
  dd if=/dev/zero of=member-${i} bs=${MEMBER_SIZE} count=1 oflag=direct
  losetup /dev/loop${i} member-${i}
  DM_PARMS+=&quot; /dev/loop${i} 0&quot;
done

echo $DM_PARMS | dmsetup create raid0
for i in $(seq 0 ${SEQ_END}); do
  echo &quot;0 1 unstriped ${NUM} ${CHUNK} ${i} /dev/mapper/raid0 0&quot; | dmsetup create set-${i}
done;

for i in $(seq 0 ${SEQ_END}); do
  dd if=/dev/urandom of=/dev/mapper/set-${i} bs=${BS} count=${COUNT} oflag=direct
  diff /dev/mapper/set-${i} member-${i}
done;

for i in $(seq 0 ${SEQ_END}); do
  dmsetup remove set-${i}
done

dmsetup remove raid0

for i in $(seq 0 ${SEQ_END}); do
  losetup -d /dev/loop${i}
  rm -f member-${i}
done
</pre></div>
</div>
</section>
<section id="another-example">
<h3>Another example<a class="headerlink" href="#another-example" title="Permalink to this headline">¶</a></h3>
<p>Intel NVMe drives contain two cores on the physical device.
Each core of the drive has segregated access to its LBA range.
The current LBA model has a RAID 0 128k chunk on each core, resulting
in a 256k stripe across the two cores:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span> Core 0:       Core 1:
__________    __________
| LBA 512|    | LBA 768|
| LBA 0  |    | LBA 256|
----------    ----------
</pre></div>
</div>
<p>The purpose of this unstriping is to provide better QoS in noisy
neighbor environments. When two partitions are created on the
aggregate drive without this unstriping, reads on one partition
can affect writes on another partition.  This is because the partitions
are striped across the two cores.  When we unstripe this hardware RAID 0
and make partitions on each new exposed device the two partitions are now
physically separated.</p>
<p>With the dm-unstriped target we’re able to segregate an fio script that
has read and write jobs that are independent of each other.  Compared to
when we run the test on a combined drive with partitions, we were able
to get a 92% reduction in read latency using this device mapper target.</p>
</section>
</section>
<section id="example-dmsetup-usage">
<h2>Example dmsetup usage<a class="headerlink" href="#example-dmsetup-usage" title="Permalink to this headline">¶</a></h2>
<section id="unstriped-ontop-of-intel-nvme-device-that-has-2-cores">
<h3>unstriped ontop of Intel NVMe device that has 2 cores<a class="headerlink" href="#unstriped-ontop-of-intel-nvme-device-that-has-2-cores" title="Permalink to this headline">¶</a></h3>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>dmsetup create nvmset0 --table &#39;0 512 unstriped 2 256 0 /dev/nvme0n1 0&#39;
dmsetup create nvmset1 --table &#39;0 512 unstriped 2 256 1 /dev/nvme0n1 0&#39;
</pre></div>
</div>
<p>There will now be two devices that expose Intel NVMe core 0 and 1
respectively:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>/dev/mapper/nvmset0
/dev/mapper/nvmset1
</pre></div>
</div>
</section>
<section id="unstriped-ontop-of-striped-with-4-drives-using-128k-chunk-size">
<h3>unstriped ontop of striped with 4 drives using 128K chunk size<a class="headerlink" href="#unstriped-ontop-of-striped-with-4-drives-using-128k-chunk-size" title="Permalink to this headline">¶</a></h3>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>dmsetup create raid_disk0 --table &#39;0 512 unstriped 4 256 0 /dev/mapper/striped 0&#39;
dmsetup create raid_disk1 --table &#39;0 512 unstriped 4 256 1 /dev/mapper/striped 0&#39;
dmsetup create raid_disk2 --table &#39;0 512 unstriped 4 256 2 /dev/mapper/striped 0&#39;
dmsetup create raid_disk3 --table &#39;0 512 unstriped 4 256 3 /dev/mapper/striped 0&#39;
</pre></div>
</div>
</section>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">The Linux Kernel</a></h1>



<p class="blurb">6.2.0-rc4-6.2.0-rc4+</p>







<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
  <h3><a href="../../index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Device-mapper “unstriped” target</a><ul>
<li><a class="reference internal" href="#introduction">Introduction</a></li>
<li><a class="reference internal" href="#why-use-this-module">Why use this module?</a><ul>
<li><a class="reference internal" href="#an-example-of-undoing-an-existing-dm-stripe">An example of undoing an existing dm-stripe</a></li>
<li><a class="reference internal" href="#another-example">Another example</a></li>
</ul>
</li>
<li><a class="reference internal" href="#example-dmsetup-usage">Example dmsetup usage</a><ul>
<li><a class="reference internal" href="#unstriped-ontop-of-intel-nvme-device-that-has-2-cores">unstriped ontop of Intel NVMe device that has 2 cores</a></li>
<li><a class="reference internal" href="#unstriped-ontop-of-striped-with-4-drives-using-128k-chunk-size">unstriped ontop of striped with 4 drives using 128K chunk size</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../../_sources/admin-guide/device-mapper/unstriped.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;The kernel development community.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 2.4.4</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="../../_sources/admin-guide/device-mapper/unstriped.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>