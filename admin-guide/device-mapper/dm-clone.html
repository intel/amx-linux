
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>dm-clone &#8212; The Linux Kernel 6.2.0-rc4+ documentation</title>
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="dm-crypt" href="dm-crypt.html" />
    <link rel="prev" title="dm-delay" href="delay.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="dm-clone">
<h1>dm-clone<a class="headerlink" href="#dm-clone" title="Permalink to this headline">¶</a></h1>
<section id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p>dm-clone is a device mapper target which produces a one-to-one copy of an
existing, read-only source device into a writable destination device: It
presents a virtual block device which makes all data appear immediately, and
redirects reads and writes accordingly.</p>
<p>The main use case of dm-clone is to clone a potentially remote, high-latency,
read-only, archival-type block device into a writable, fast, primary-type device
for fast, low-latency I/O. The cloned device is visible/mountable immediately
and the copy of the source device to the destination device happens in the
background, in parallel with user I/O.</p>
<p>For example, one could restore an application backup from a read-only copy,
accessible through a network storage protocol (NBD, Fibre Channel, iSCSI, AoE,
etc.), into a local SSD or NVMe device, and start using the device immediately,
without waiting for the restore to complete.</p>
<p>When the cloning completes, the dm-clone table can be removed altogether and be
replaced, e.g., by a linear table, mapping directly to the destination device.</p>
<p>The dm-clone target reuses the metadata library used by the thin-provisioning
target.</p>
</section>
<section id="glossary">
<h2>Glossary<a class="headerlink" href="#glossary" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><dl class="simple">
<dt>Hydration</dt><dd><p>The process of filling a region of the destination device with data from
the same region of the source device, i.e., copying the region from the
source to the destination device.</p>
</dd>
</dl>
</div></blockquote>
<p>Once a region gets hydrated we redirect all I/O regarding it to the destination
device.</p>
</section>
<section id="design">
<h2>Design<a class="headerlink" href="#design" title="Permalink to this headline">¶</a></h2>
<section id="sub-devices">
<h3>Sub-devices<a class="headerlink" href="#sub-devices" title="Permalink to this headline">¶</a></h3>
<p>The target is constructed by passing three devices to it (along with other
parameters detailed later):</p>
<ol class="arabic simple">
<li><p>A source device - the read-only device that gets cloned and source of the
hydration.</p></li>
<li><p>A destination device - the destination of the hydration, which will become a
clone of the source device.</p></li>
<li><p>A small metadata device - it records which regions are already valid in the
destination device, i.e., which regions have already been hydrated, or have
been written to directly, via user I/O.</p></li>
</ol>
<p>The size of the destination device must be at least equal to the size of the
source device.</p>
</section>
<section id="regions">
<h3>Regions<a class="headerlink" href="#regions" title="Permalink to this headline">¶</a></h3>
<p>dm-clone divides the source and destination devices in fixed sized regions.
Regions are the unit of hydration, i.e., the minimum amount of data copied from
the source to the destination device.</p>
<p>The region size is configurable when you first create the dm-clone device. The
recommended region size is the same as the file system block size, which usually
is 4KB. The region size must be between 8 sectors (4KB) and 2097152 sectors
(1GB) and a power of two.</p>
<p>Reads and writes from/to hydrated regions are serviced from the destination
device.</p>
<p>A read to a not yet hydrated region is serviced directly from the source device.</p>
<p>A write to a not yet hydrated region will be delayed until the corresponding
region has been hydrated and the hydration of the region starts immediately.</p>
<p>Note that a write request with size equal to region size will skip copying of
the corresponding region from the source device and overwrite the region of the
destination device directly.</p>
</section>
<section id="discards">
<h3>Discards<a class="headerlink" href="#discards" title="Permalink to this headline">¶</a></h3>
<p>dm-clone interprets a discard request to a range that hasn’t been hydrated yet
as a hint to skip hydration of the regions covered by the request, i.e., it
skips copying the region’s data from the source to the destination device, and
only updates its metadata.</p>
<p>If the destination device supports discards, then by default dm-clone will pass
down discard requests to it.</p>
</section>
<section id="background-hydration">
<h3>Background Hydration<a class="headerlink" href="#background-hydration" title="Permalink to this headline">¶</a></h3>
<p>dm-clone copies continuously from the source to the destination device, until
all of the device has been copied.</p>
<p>Copying data from the source to the destination device uses bandwidth. The user
can set a throttle to prevent more than a certain amount of copying occurring at
any one time. Moreover, dm-clone takes into account user I/O traffic going to
the devices and pauses the background hydration when there is I/O in-flight.</p>
<p>A message <cite>hydration_threshold &lt;#regions&gt;</cite> can be used to set the maximum number
of regions being copied, the default being 1 region.</p>
<p>dm-clone employs dm-kcopyd for copying portions of the source device to the
destination device. By default, we issue copy requests of size equal to the
region size. A message <cite>hydration_batch_size &lt;#regions&gt;</cite> can be used to tune the
size of these copy requests. Increasing the hydration batch size results in
dm-clone trying to batch together contiguous regions, so we copy the data in
batches of this many regions.</p>
<p>When the hydration of the destination device finishes, a dm event will be sent
to user space.</p>
</section>
<section id="updating-on-disk-metadata">
<h3>Updating on-disk metadata<a class="headerlink" href="#updating-on-disk-metadata" title="Permalink to this headline">¶</a></h3>
<p>On-disk metadata is committed every time a FLUSH or FUA bio is written. If no
such requests are made then commits will occur every second. This means the
dm-clone device behaves like a physical disk that has a volatile write cache. If
power is lost you may lose some recent writes. The metadata should always be
consistent in spite of any crash.</p>
</section>
</section>
<section id="target-interface">
<h2>Target Interface<a class="headerlink" href="#target-interface" title="Permalink to this headline">¶</a></h2>
<section id="constructor">
<h3>Constructor<a class="headerlink" href="#constructor" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><blockquote>
<div><div class="highlight-none notranslate"><div class="highlight"><pre><span></span>clone &lt;metadata dev&gt; &lt;destination dev&gt; &lt;source dev&gt; &lt;region size&gt;
      [&lt;#feature args&gt; [&lt;feature arg&gt;]* [&lt;#core args&gt; [&lt;core arg&gt;]*]]
</pre></div>
</div>
</div></blockquote>
<table class="docutils align-default">
<colgroup>
<col style="width: 21%" />
<col style="width: 79%" />
</colgroup>
<tbody>
<tr class="row-odd"><td><p>metadata dev</p></td>
<td><p>Fast device holding the persistent metadata</p></td>
</tr>
<tr class="row-even"><td><p>destination dev</p></td>
<td><p>The destination device, where the source will be cloned</p></td>
</tr>
<tr class="row-odd"><td><p>source dev</p></td>
<td><p>Read only device containing the data that gets cloned</p></td>
</tr>
<tr class="row-even"><td><p>region size</p></td>
<td><p>The size of a region in sectors</p></td>
</tr>
<tr class="row-odd"><td><p>#feature args</p></td>
<td><p>Number of feature arguments passed</p></td>
</tr>
<tr class="row-even"><td><p>feature args</p></td>
<td><p>no_hydration or no_discard_passdown</p></td>
</tr>
<tr class="row-odd"><td><p>#core args</p></td>
<td><p>An even number of arguments corresponding to key/value pairs
passed to dm-clone</p></td>
</tr>
<tr class="row-even"><td><p>core args</p></td>
<td><p>Key/value pairs passed to dm-clone, e.g. <cite>hydration_threshold
256</cite></p></td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>Optional feature arguments are:</p>
<blockquote>
<div><table class="docutils align-default">
<colgroup>
<col style="width: 26%" />
<col style="width: 74%" />
</colgroup>
<tbody>
<tr class="row-odd"><td><p>no_hydration</p></td>
<td><p>Create a dm-clone instance with background hydration
disabled</p></td>
</tr>
<tr class="row-even"><td><p>no_discard_passdown</p></td>
<td><p>Disable passing down discards to the destination device</p></td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>Optional core arguments are:</p>
<blockquote>
<div><table class="docutils align-default">
<colgroup>
<col style="width: 41%" />
<col style="width: 59%" />
</colgroup>
<tbody>
<tr class="row-odd"><td><p>hydration_threshold &lt;#regions&gt;</p></td>
<td><p>Maximum number of regions being copied from
the source to the destination device at any
one time, during background hydration.</p></td>
</tr>
<tr class="row-even"><td><p>hydration_batch_size &lt;#regions&gt;</p></td>
<td><p>During background hydration, try to batch
together contiguous regions, so we copy data
from the source to the destination device in
batches of this many regions.</p></td>
</tr>
</tbody>
</table>
</div></blockquote>
</section>
<section id="status">
<h3>Status<a class="headerlink" href="#status" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><blockquote>
<div><div class="highlight-none notranslate"><div class="highlight"><pre><span></span>&lt;metadata block size&gt; &lt;#used metadata blocks&gt;/&lt;#total metadata blocks&gt;
&lt;region size&gt; &lt;#hydrated regions&gt;/&lt;#total regions&gt; &lt;#hydrating regions&gt;
&lt;#feature args&gt; &lt;feature args&gt;* &lt;#core args&gt; &lt;core args&gt;*
&lt;clone metadata mode&gt;
</pre></div>
</div>
</div></blockquote>
<table class="docutils align-default">
<colgroup>
<col style="width: 29%" />
<col style="width: 71%" />
</colgroup>
<tbody>
<tr class="row-odd"><td><p>metadata block size</p></td>
<td><p>Fixed block size for each metadata block in sectors</p></td>
</tr>
<tr class="row-even"><td><p>#used metadata blocks</p></td>
<td><p>Number of metadata blocks used</p></td>
</tr>
<tr class="row-odd"><td><p>#total metadata blocks</p></td>
<td><p>Total number of metadata blocks</p></td>
</tr>
<tr class="row-even"><td><p>region size</p></td>
<td><p>Configurable region size for the device in sectors</p></td>
</tr>
<tr class="row-odd"><td><p>#hydrated regions</p></td>
<td><p>Number of regions that have finished hydrating</p></td>
</tr>
<tr class="row-even"><td><p>#total regions</p></td>
<td><p>Total number of regions to hydrate</p></td>
</tr>
<tr class="row-odd"><td><p>#hydrating regions</p></td>
<td><p>Number of regions currently hydrating</p></td>
</tr>
<tr class="row-even"><td><p>#feature args</p></td>
<td><p>Number of feature arguments to follow</p></td>
</tr>
<tr class="row-odd"><td><p>feature args</p></td>
<td><p>Feature arguments, e.g. <cite>no_hydration</cite></p></td>
</tr>
<tr class="row-even"><td><p>#core args</p></td>
<td><p>Even number of core arguments to follow</p></td>
</tr>
<tr class="row-odd"><td><p>core args</p></td>
<td><p>Key/value pairs for tuning the core, e.g.
<cite>hydration_threshold 256</cite></p></td>
</tr>
<tr class="row-even"><td><p>clone metadata mode</p></td>
<td><p>ro if read-only, rw if read-write</p>
<p>In serious cases where even a read-only mode is deemed
unsafe no further I/O will be permitted and the status
will just contain the string ‘Fail’. If the metadata
mode changes, a dm event will be sent to user space.</p>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</section>
<section id="messages">
<h3>Messages<a class="headerlink" href="#messages" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><dl class="simple">
<dt><cite>disable_hydration</cite></dt><dd><p>Disable the background hydration of the destination device.</p>
</dd>
<dt><cite>enable_hydration</cite></dt><dd><p>Enable the background hydration of the destination device.</p>
</dd>
<dt><cite>hydration_threshold &lt;#regions&gt;</cite></dt><dd><p>Set background hydration threshold.</p>
</dd>
<dt><cite>hydration_batch_size &lt;#regions&gt;</cite></dt><dd><p>Set background hydration batch size.</p>
</dd>
</dl>
</div></blockquote>
</section>
</section>
<section id="examples">
<h2>Examples<a class="headerlink" href="#examples" title="Permalink to this headline">¶</a></h2>
<section id="clone-a-device-containing-a-file-system">
<h3>Clone a device containing a file system<a class="headerlink" href="#clone-a-device-containing-a-file-system" title="Permalink to this headline">¶</a></h3>
<ol class="arabic">
<li><p>Create the dm-clone device.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>dmsetup create clone --table &quot;0 1048576000 clone $metadata_dev $dest_dev \
  $source_dev 8 1 no_hydration&quot;
</pre></div>
</div>
</li>
<li><p>Mount the device and trim the file system. dm-clone interprets the discards
sent by the file system and it will not hydrate the unused space.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>mount /dev/mapper/clone /mnt/cloned-fs
fstrim /mnt/cloned-fs
</pre></div>
</div>
</li>
<li><p>Enable background hydration of the destination device.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>dmsetup message clone 0 enable_hydration
</pre></div>
</div>
</li>
<li><p>When the hydration finishes, we can replace the dm-clone table with a linear
table.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>dmsetup suspend clone
dmsetup load clone --table &quot;0 1048576000 linear $dest_dev 0&quot;
dmsetup resume clone
</pre></div>
</div>
<p>The metadata device is no longer needed and can be safely discarded or reused
for other purposes.</p>
</li>
</ol>
</section>
</section>
<section id="known-issues">
<h2>Known issues<a class="headerlink" href="#known-issues" title="Permalink to this headline">¶</a></h2>
<ol class="arabic simple">
<li><p>We redirect reads, to not-yet-hydrated regions, to the source device. If
reading the source device has high latency and the user repeatedly reads from
the same regions, this behaviour could degrade performance. We should use
these reads as hints to hydrate the relevant regions sooner. Currently, we
rely on the page cache to cache these regions, so we hopefully don’t end up
reading them multiple times from the source device.</p></li>
<li><p>Release in-core resources, i.e., the bitmaps tracking which regions are
hydrated, after the hydration has finished.</p></li>
<li><p>During background hydration, if we fail to read the source or write to the
destination device, we print an error message, but the hydration process
continues indefinitely, until it succeeds. We should stop the background
hydration after a number of failures and emit a dm event for user space to
notice.</p></li>
</ol>
</section>
<section id="why-not">
<h2>Why not…?<a class="headerlink" href="#why-not" title="Permalink to this headline">¶</a></h2>
<p>We explored the following alternatives before implementing dm-clone:</p>
<ol class="arabic">
<li><p>Use dm-cache with cache size equal to the source device and implement a new
cloning policy:</p>
<ul class="simple">
<li><p>The resulting cache device is not a one-to-one mirror of the source device
and thus we cannot remove the cache device once cloning completes.</p></li>
<li><p>dm-cache writes to the source device, which violates our requirement that
the source device must be treated as read-only.</p></li>
<li><p>Caching is semantically different from cloning.</p></li>
</ul>
</li>
<li><p>Use dm-snapshot with a COW device equal to the source device:</p>
<ul class="simple">
<li><p>dm-snapshot stores its metadata in the COW device, so the resulting device
is not a one-to-one mirror of the source device.</p></li>
<li><p>No background copying mechanism.</p></li>
<li><p>dm-snapshot needs to commit its metadata whenever a pending exception
completes, to ensure snapshot consistency. In the case of cloning, we don’t
need to be so strict and can rely on committing metadata every time a FLUSH
or FUA bio is written, or periodically, like dm-thin and dm-cache do. This
improves the performance significantly.</p></li>
</ul>
</li>
<li><p>Use dm-mirror: The mirror target has a background copying/mirroring
mechanism, but it writes to all mirrors, thus violating our requirement that
the source device must be treated as read-only.</p></li>
<li><p>Use dm-thin’s external snapshot functionality. This approach is the most
promising among all alternatives, as the thinly-provisioned volume is a
one-to-one mirror of the source device and handles reads and writes to
un-provisioned/not-yet-cloned areas the same way as dm-clone does.</p>
<p>Still:</p>
<ul class="simple">
<li><p>There is no background copying mechanism, though one could be implemented.</p></li>
<li><p>Most importantly, we want to support arbitrary block devices as the
destination of the cloning process and not restrict ourselves to
thinly-provisioned volumes. Thin-provisioning has an inherent metadata
overhead, for maintaining the thin volume mappings, which significantly
degrades performance.</p></li>
</ul>
<p>Moreover, cloning a device shouldn’t force the use of thin-provisioning. On
the other hand, if we wish to use thin provisioning, we can just use a thin
LV as dm-clone’s destination device.</p>
</li>
</ol>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">The Linux Kernel</a></h1>



<p class="blurb">6.2.0-rc4-6.2.0-rc4+</p>







<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
  <h3><a href="../../index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">dm-clone</a><ul>
<li><a class="reference internal" href="#introduction">Introduction</a></li>
<li><a class="reference internal" href="#glossary">Glossary</a></li>
<li><a class="reference internal" href="#design">Design</a><ul>
<li><a class="reference internal" href="#sub-devices">Sub-devices</a></li>
<li><a class="reference internal" href="#regions">Regions</a></li>
<li><a class="reference internal" href="#discards">Discards</a></li>
<li><a class="reference internal" href="#background-hydration">Background Hydration</a></li>
<li><a class="reference internal" href="#updating-on-disk-metadata">Updating on-disk metadata</a></li>
</ul>
</li>
<li><a class="reference internal" href="#target-interface">Target Interface</a><ul>
<li><a class="reference internal" href="#constructor">Constructor</a></li>
<li><a class="reference internal" href="#status">Status</a></li>
<li><a class="reference internal" href="#messages">Messages</a></li>
</ul>
</li>
<li><a class="reference internal" href="#examples">Examples</a><ul>
<li><a class="reference internal" href="#clone-a-device-containing-a-file-system">Clone a device containing a file system</a></li>
</ul>
</li>
<li><a class="reference internal" href="#known-issues">Known issues</a></li>
<li><a class="reference internal" href="#why-not">Why not…?</a></li>
</ul>
</li>
</ul>

  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../../_sources/admin-guide/device-mapper/dm-clone.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;The kernel development community.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 2.4.4</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="../../_sources/admin-guide/device-mapper/dm-clone.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>