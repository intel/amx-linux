
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>7.17. Rockchip Image Signal Processor (rkisp1) &#8212; The Linux Kernel 6.2.0-rc4+ documentation</title>
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="7.18. The saa7134 driver" href="saa7134.html" />
    <link rel="prev" title="7.16. Renesas R-Car Fine Display Processor (FDP1) Driver" href="rcar-fdp1.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="rockchip-image-signal-processor-rkisp1">
<h1><span class="section-number">7.17. </span>Rockchip Image Signal Processor (rkisp1)<a class="headerlink" href="#rockchip-image-signal-processor-rkisp1" title="Permalink to this headline">¶</a></h1>
<section id="introduction">
<h2><span class="section-number">7.17.1. </span>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p>This file documents the driver for the Rockchip ISP1 that is part of RK3288
and RK3399 SoCs. The driver is located under drivers/staging/media/rkisp1
and uses the Media-Controller API.</p>
</section>
<section id="revisions">
<h2><span class="section-number">7.17.2. </span>Revisions<a class="headerlink" href="#revisions" title="Permalink to this headline">¶</a></h2>
<p>There exist multiple smaller revisions to this ISP that got introduced in
later SoCs. Revisions can be found in the enum <a class="reference internal" href="../../userspace-api/media/v4l/pixfmt-meta-rkisp1.html#c.rkisp1_cif_isp_version" title="rkisp1_cif_isp_version"><code class="xref c c-type docutils literal notranslate"><span class="pre">rkisp1_cif_isp_version</span></code></a>
in the UAPI and the revision of the ISP inside the running SoC can be read
in the field hw_revision of struct media_device_info as returned by
ioctl MEDIA_IOC_DEVICE_INFO.</p>
<p>Versions in use are:</p>
<ul class="simple">
<li><p>RKISP1_V10: used at least in rk3288 and rk3399</p></li>
<li><p>RKISP1_V11: declared in the original vendor code, but not used</p></li>
<li><p>RKISP1_V12: used at least in rk3326 and px30</p></li>
<li><p>RKISP1_V13: used at least in rk1808</p></li>
</ul>
</section>
<section id="topology">
<h2><span class="section-number">7.17.3. </span>Topology<a class="headerlink" href="#topology" title="Permalink to this headline">¶</a></h2>
<figure class="align-center">
<img alt="Diagram of the default media pipeline topology" src="../../_images/rkisp1.svg" /></figure>
<p>The driver has 4 video devices:</p>
<ul class="simple">
<li><p>rkisp1_mainpath: capture device for retrieving images, usually in higher
resolution.</p></li>
<li><p>rkisp1_selfpath: capture device for retrieving images.</p></li>
<li><p>rkisp1_stats: a metadata capture device that sends statistics.</p></li>
<li><p>rkisp1_params: a metadata output device that receives parameters
configurations from userspace.</p></li>
</ul>
<p>The driver has 3 subdevices:</p>
<ul class="simple">
<li><p>rkisp1_resizer_mainpath: used to resize and downsample frames for the
mainpath capture device.</p></li>
<li><p>rkisp1_resizer_selfpath: used to resize and downsample frames for the
selfpath capture device.</p></li>
<li><p>rkisp1_isp: is connected to the sensor and is responsible for all the isp
operations.</p></li>
</ul>
<section id="rkisp1-mainpath-rkisp1-selfpath-frames-capture-video-nodes">
<h3><span class="section-number">7.17.3.1. </span>rkisp1_mainpath, rkisp1_selfpath - Frames Capture Video Nodes<a class="headerlink" href="#rkisp1-mainpath-rkisp1-selfpath-frames-capture-video-nodes" title="Permalink to this headline">¶</a></h3>
<p>Those are the <cite>mainpath</cite> and <cite>selfpath</cite> capture devices to capture frames.
Those entities are the DMA engines that write the frames to memory.
The selfpath video device can capture YUV/RGB formats. Its input is YUV encoded
stream and it is able to convert it to RGB. The selfpath is not able to
capture bayer formats.
The mainpath can capture both bayer and YUV formats but it is not able to
capture RGB formats.
Both capture videos support
the <code class="docutils literal notranslate"><span class="pre">V4L2_CAP_IO_MC</span></code> <a class="reference internal" href="../../userspace-api/media/v4l/vidioc-querycap.html#device-capabilities"><span class="std std-ref">capability</span></a>.</p>
</section>
<section id="rkisp1-resizer-mainpath-rkisp1-resizer-selfpath-resizers-subdevices-nodes">
<h3><span class="section-number">7.17.3.2. </span>rkisp1_resizer_mainpath, rkisp1_resizer_selfpath - Resizers Subdevices Nodes<a class="headerlink" href="#rkisp1-resizer-mainpath-rkisp1-resizer-selfpath-resizers-subdevices-nodes" title="Permalink to this headline">¶</a></h3>
<p>Those are resizer entities for the mainpath and the selfpath. Those entities
can scale the frames up and down and also change the YUV sampling (for example
YUV4:2:2 -&gt; YUV4:2:0). They also have cropping capability on the sink pad.
The resizers entities can only operate on YUV:4:2:2 format
(MEDIA_BUS_FMT_YUYV8_2X8).
The mainpath capture device supports capturing video in bayer formats. In that
case the resizer of the mainpath is set to ‘bypass’ mode - it just forward the
frame without operating on it.</p>
</section>
<section id="rkisp1-isp-image-signal-processing-subdevice-node">
<h3><span class="section-number">7.17.3.3. </span>rkisp1_isp - Image Signal Processing Subdevice Node<a class="headerlink" href="#rkisp1-isp-image-signal-processing-subdevice-node" title="Permalink to this headline">¶</a></h3>
<p>This is the isp entity. It is connected to the sensor on sink pad 0 and
receives the frames using the CSI-2 protocol. It is responsible of configuring
the CSI-2 protocol. It has a cropping capability on sink pad 0 that is
connected to the sensor and on source pad 2 connected to the resizer entities.
Cropping on sink pad 0 defines the image region from the sensor.
Cropping on source pad 2 defines the region for the Image Stabilizer (IS).</p>
</section>
<section id="rkisp1-stats-statistics-video-node">
<span id="rkisp1-stats"></span><h3><span class="section-number">7.17.3.4. </span>rkisp1_stats - Statistics Video Node<a class="headerlink" href="#rkisp1-stats-statistics-video-node" title="Permalink to this headline">¶</a></h3>
<p>The statistics video node outputs the 3A (auto focus, auto exposure and auto
white balance) statistics, and also histogram statistics for the frames that
are being processed by the rkisp1 to userspace applications.
Using these data, applications can implement algorithms and re-parameterize
the driver through the rkisp_params node to improve image quality during a
video stream.
The buffer format is defined by struct <a class="reference internal" href="../../userspace-api/media/v4l/pixfmt-meta-rkisp1.html#c.rkisp1_stat_buffer" title="rkisp1_stat_buffer"><code class="xref c c-type docutils literal notranslate"><span class="pre">rkisp1_stat_buffer</span></code></a>, and
userspace should set
<a class="reference internal" href="../../userspace-api/media/v4l/pixfmt-meta-rkisp1.html#v4l2-meta-fmt-rk-isp1-stat-3a"><span class="std std-ref">V4L2_META_FMT_RK_ISP1_STAT_3A</span></a> as the
dataformat.</p>
</section>
<section id="rkisp1-params-parameters-video-node">
<span id="rkisp1-params"></span><h3><span class="section-number">7.17.3.5. </span>rkisp1_params - Parameters Video Node<a class="headerlink" href="#rkisp1-params-parameters-video-node" title="Permalink to this headline">¶</a></h3>
<p>The rkisp1_params video node receives a set of parameters from userspace
to be applied to the hardware during a video stream, allowing userspace
to dynamically modify values such as black level, cross talk corrections
and others.</p>
<p>The buffer format is defined by struct <a class="reference internal" href="../../userspace-api/media/v4l/pixfmt-meta-rkisp1.html#c.rkisp1_params_cfg" title="rkisp1_params_cfg"><code class="xref c c-type docutils literal notranslate"><span class="pre">rkisp1_params_cfg</span></code></a>, and
userspace should set
<a class="reference internal" href="../../userspace-api/media/v4l/pixfmt-meta-rkisp1.html#v4l2-meta-fmt-rk-isp1-params"><span class="std std-ref">V4L2_META_FMT_RK_ISP1_PARAMS</span></a> as the
dataformat.</p>
</section>
</section>
<section id="capturing-video-frames-example">
<h2><span class="section-number">7.17.4. </span>Capturing Video Frames Example<a class="headerlink" href="#capturing-video-frames-example" title="Permalink to this headline">¶</a></h2>
<p>In the following example, the sensor connected to pad 0 of ‘rkisp1_isp’ is
imx219.</p>
<p>The following commands can be used to capture video from the selfpath video
node with dimension 900x800 planar format YUV 4:2:2. It uses all cropping
capabilities possible, (see explanation right below)</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># set the links</span>
<span class="s2">&quot;media-ctl&quot;</span> <span class="s2">&quot;-d&quot;</span> <span class="s2">&quot;platform:rkisp1&quot;</span> <span class="s2">&quot;-r&quot;</span>
<span class="s2">&quot;media-ctl&quot;</span> <span class="s2">&quot;-d&quot;</span> <span class="s2">&quot;platform:rkisp1&quot;</span> <span class="s2">&quot;-l&quot;</span> <span class="s2">&quot;&#39;imx219 4-0010&#39;:0 -&gt; &#39;rkisp1_isp&#39;:0 [1]&quot;</span>
<span class="s2">&quot;media-ctl&quot;</span> <span class="s2">&quot;-d&quot;</span> <span class="s2">&quot;platform:rkisp1&quot;</span> <span class="s2">&quot;-l&quot;</span> <span class="s2">&quot;&#39;rkisp1_isp&#39;:2 -&gt; &#39;rkisp1_resizer_selfpath&#39;:0 [1]&quot;</span>
<span class="s2">&quot;media-ctl&quot;</span> <span class="s2">&quot;-d&quot;</span> <span class="s2">&quot;platform:rkisp1&quot;</span> <span class="s2">&quot;-l&quot;</span> <span class="s2">&quot;&#39;rkisp1_isp&#39;:2 -&gt; &#39;rkisp1_resizer_mainpath&#39;:0 [0]&quot;</span>

<span class="c1"># set format for imx219 4-0010:0</span>
<span class="s2">&quot;media-ctl&quot;</span> <span class="s2">&quot;-d&quot;</span> <span class="s2">&quot;platform:rkisp1&quot;</span> <span class="s2">&quot;--set-v4l2&quot;</span> <span class="s1">&#39;&quot;imx219 4-0010&quot;:0 [fmt:SRGGB10_1X10/1640x1232]&#39;</span>

<span class="c1"># set format for rkisp1_isp pads:</span>
<span class="s2">&quot;media-ctl&quot;</span> <span class="s2">&quot;-d&quot;</span> <span class="s2">&quot;platform:rkisp1&quot;</span> <span class="s2">&quot;--set-v4l2&quot;</span> <span class="s1">&#39;&quot;rkisp1_isp&quot;:0 [fmt:SRGGB10_1X10/1640x1232 crop: (0,0)/1600x1200]&#39;</span>
<span class="s2">&quot;media-ctl&quot;</span> <span class="s2">&quot;-d&quot;</span> <span class="s2">&quot;platform:rkisp1&quot;</span> <span class="s2">&quot;--set-v4l2&quot;</span> <span class="s1">&#39;&quot;rkisp1_isp&quot;:2 [fmt:YUYV8_2X8/1600x1200 crop: (0,0)/1500x1100]&#39;</span>

<span class="c1"># set format for rkisp1_resizer_selfpath pads:</span>
<span class="s2">&quot;media-ctl&quot;</span> <span class="s2">&quot;-d&quot;</span> <span class="s2">&quot;platform:rkisp1&quot;</span> <span class="s2">&quot;--set-v4l2&quot;</span> <span class="s1">&#39;&quot;rkisp1_resizer_selfpath&quot;:0 [fmt:YUYV8_2X8/1500x1100 crop: (300,400)/1400x1000]&#39;</span>
<span class="s2">&quot;media-ctl&quot;</span> <span class="s2">&quot;-d&quot;</span> <span class="s2">&quot;platform:rkisp1&quot;</span> <span class="s2">&quot;--set-v4l2&quot;</span> <span class="s1">&#39;&quot;rkisp1_resizer_selfpath&quot;:1 [fmt:YUYV8_2X8/900x800]&#39;</span>

<span class="c1"># set format for rkisp1_selfpath:</span>
<span class="s2">&quot;v4l2-ctl&quot;</span> <span class="s2">&quot;-z&quot;</span> <span class="s2">&quot;platform:rkisp1&quot;</span> <span class="s2">&quot;-d&quot;</span> <span class="s2">&quot;rkisp1_selfpath&quot;</span> <span class="s2">&quot;-v&quot;</span> <span class="s2">&quot;width=900,height=800,&quot;</span>
<span class="s2">&quot;v4l2-ctl&quot;</span> <span class="s2">&quot;-z&quot;</span> <span class="s2">&quot;platform:rkisp1&quot;</span> <span class="s2">&quot;-d&quot;</span> <span class="s2">&quot;rkisp1_selfpath&quot;</span> <span class="s2">&quot;-v&quot;</span> <span class="s2">&quot;pixelformat=422P&quot;</span>

<span class="c1"># start streaming:</span>
v4l2-ctl <span class="s2">&quot;-z&quot;</span> <span class="s2">&quot;platform:rkisp1&quot;</span> <span class="s2">&quot;-d&quot;</span> <span class="s2">&quot;rkisp1_selfpath&quot;</span> <span class="s2">&quot;--stream-mmap&quot;</span> <span class="s2">&quot;--stream-count&quot;</span> <span class="s2">&quot;10&quot;</span>
</pre></div>
</div>
<p>In the above example the sensor is configured to bayer format:
<cite>SRGGB10_1X10/1640x1232</cite>. The rkisp1_isp:0 pad should be configured to the
same mbus format and dimensions as the sensor, otherwise streaming will fail
with ‘EPIPE’ error. So it is also configured to <cite>SRGGB10_1X10/1640x1232</cite>.
In addition, the rkisp1_isp:0 pad is configured to cropping <cite>(0,0)/1600x1200</cite>.</p>
<p>The cropping dimensions are automatically propagated to be the format of the
isp source pad <cite>rkisp1_isp:2</cite>. Another cropping operation is configured on
the isp source pad: <cite>(0,0)/1500x1100</cite>.</p>
<p>The resizer’s sink pad <cite>rkisp1_resizer_selfpath</cite> should be configured to format
<cite>YUYV8_2X8/1500x1100</cite> in order to match the format on the other side of the
link. In addition a cropping <cite>(300,400)/1400x1000</cite> is configured on it.</p>
<p>The source pad of the resizer, <cite>rkisp1_resizer_selfpath:1</cite> is configured to
format <cite>YUYV8_2X8/900x800</cite>. That means that the resizer first crop a window
of <cite>(300,400)/1400x100</cite> from the received frame and then scales this window
to dimension <cite>900x800</cite>.</p>
<p>Note that the above example does not uses the stats-params control loop.
Therefore the capture frames will not go through the 3A algorithms and
probably won’t have a good quality, and can even look dark and greenish.</p>
</section>
<section id="configuring-quantization">
<h2><span class="section-number">7.17.5. </span>Configuring Quantization<a class="headerlink" href="#configuring-quantization" title="Permalink to this headline">¶</a></h2>
<p>The driver supports limited and full range quantization on YUV formats,
where limited is the default.
To switch between one or the other, userspace should use the Colorspace
Conversion API (CSC) for subdevices on source pad 2 of the
isp (<cite>rkisp1_isp:2</cite>). The quantization configured on this pad is the
quantization of the captured video frames on the mainpath and selfpath
video nodes.
Note that the resizer and capture entities will always report
<code class="docutils literal notranslate"><span class="pre">V4L2_QUANTIZATION_DEFAULT</span></code> even if the quantization is configured to full
range on <cite>rkisp1_isp:2</cite>. So in order to get the configured quantization,
application should get it from pad <cite>rkisp1_isp:2</cite>.</p>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">The Linux Kernel</a></h1>



<p class="blurb">6.2.0-rc4-6.2.0-rc4+</p>







<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
  <h3><a href="../../index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">7.17. Rockchip Image Signal Processor (rkisp1)</a><ul>
<li><a class="reference internal" href="#introduction">7.17.1. Introduction</a></li>
<li><a class="reference internal" href="#revisions">7.17.2. Revisions</a></li>
<li><a class="reference internal" href="#topology">7.17.3. Topology</a><ul>
<li><a class="reference internal" href="#rkisp1-mainpath-rkisp1-selfpath-frames-capture-video-nodes">7.17.3.1. rkisp1_mainpath, rkisp1_selfpath - Frames Capture Video Nodes</a></li>
<li><a class="reference internal" href="#rkisp1-resizer-mainpath-rkisp1-resizer-selfpath-resizers-subdevices-nodes">7.17.3.2. rkisp1_resizer_mainpath, rkisp1_resizer_selfpath - Resizers Subdevices Nodes</a></li>
<li><a class="reference internal" href="#rkisp1-isp-image-signal-processing-subdevice-node">7.17.3.3. rkisp1_isp - Image Signal Processing Subdevice Node</a></li>
<li><a class="reference internal" href="#rkisp1-stats-statistics-video-node">7.17.3.4. rkisp1_stats - Statistics Video Node</a></li>
<li><a class="reference internal" href="#rkisp1-params-parameters-video-node">7.17.3.5. rkisp1_params - Parameters Video Node</a></li>
</ul>
</li>
<li><a class="reference internal" href="#capturing-video-frames-example">7.17.4. Capturing Video Frames Example</a></li>
<li><a class="reference internal" href="#configuring-quantization">7.17.5. Configuring Quantization</a></li>
</ul>
</li>
</ul>

  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../../_sources/admin-guide/media/rkisp1.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;The kernel development community.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 2.4.4</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="../../_sources/admin-guide/media/rkisp1.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>