
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>7.23. The Virtual Stateless Decoder Driver (visl) &#8212; The Linux Kernel 6.2.0-rc4+ documentation</title>
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="7.24. The Virtual Video Test Driver (vivid)" href="vivid.html" />
    <link rel="prev" title="7.22. The Virtual Media Controller Driver (vimc)" href="vimc.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="the-virtual-stateless-decoder-driver-visl">
<h1><span class="section-number">7.23. </span>The Virtual Stateless Decoder Driver (visl)<a class="headerlink" href="#the-virtual-stateless-decoder-driver-visl" title="Permalink to this headline">¶</a></h1>
<p>A virtual stateless decoder device for stateless uAPI development
purposes.</p>
<p>This tool’s objective is to help the development and testing of
userspace applications that use the V4L2 stateless API to decode media.</p>
<p>A userspace implementation can use visl to run a decoding loop even when
no hardware is available or when the kernel uAPI for the codec has not
been upstreamed yet. This can reveal bugs at an early stage.</p>
<p>This driver can also trace the contents of the V4L2 controls submitted
to it.  It can also dump the contents of the vb2 buffers through a
debugfs interface. This is in many ways similar to the tracing
infrastructure available for other popular encode/decode APIs out there
and can help develop a userspace application by using another (working)
one as a reference.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>No actual decoding of video frames is performed by visl. The
V4L2 test pattern generator is used to write various debug information
to the capture buffers instead.</p>
</div>
<section id="module-parameters">
<h2><span class="section-number">7.23.1. </span>Module parameters<a class="headerlink" href="#module-parameters" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>visl_debug: Activates debug info, printing various debug messages through
dprintk. Also controls whether per-frame debug info is shown. Defaults to off.
Note that enabling this feature can result in slow performance through serial.</p></li>
<li><p>visl_transtime_ms: Simulated process time in milliseconds. Slowing down the
decoding speed can be useful for debugging.</p></li>
<li><p>visl_dprintk_frame_start, visl_dprintk_frame_nframes: Dictates a range of
frames where dprintk is activated. This only controls the dprintk tracing on a
per-frame basis. Note that printing a lot of data can be slow through serial.</p></li>
<li><p>keep_bitstream_buffers: Controls whether bitstream (i.e. OUTPUT) buffers are
kept after a decoding session. Defaults to false so as to reduce the amount of
clutter. keep_bitstream_buffers == false works well when live debugging the
client program with GDB.</p></li>
<li><p>bitstream_trace_frame_start, bitstream_trace_nframes: Similar to
visl_dprintk_frame_start, visl_dprintk_nframes, but controls the dumping of
buffer data through debugfs instead.</p></li>
</ul>
</section>
<section id="what-is-the-default-use-case-for-this-driver">
<h2><span class="section-number">7.23.2. </span>What is the default use case for this driver?<a class="headerlink" href="#what-is-the-default-use-case-for-this-driver" title="Permalink to this headline">¶</a></h2>
<p>This driver can be used as a way to compare different userspace implementations.
This assumes that a working client is run against visl and that the ftrace and
OUTPUT buffer data is subsequently used to debug a work-in-progress
implementation.</p>
<p>Information on reference frames, their timestamps, the status of the OUTPUT and
CAPTURE queues and more can be read directly from the CAPTURE buffers.</p>
</section>
<section id="supported-codecs">
<h2><span class="section-number">7.23.3. </span>Supported codecs<a class="headerlink" href="#supported-codecs" title="Permalink to this headline">¶</a></h2>
<p>The following codecs are supported:</p>
<ul class="simple">
<li><p>FWHT</p></li>
<li><p>MPEG2</p></li>
<li><p>VP8</p></li>
<li><p>VP9</p></li>
<li><p>H.264</p></li>
<li><p>HEVC</p></li>
</ul>
</section>
<section id="visl-trace-events">
<h2><span class="section-number">7.23.4. </span>visl trace events<a class="headerlink" href="#visl-trace-events" title="Permalink to this headline">¶</a></h2>
<p>The trace events are defined on a per-codec basis, e.g.:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ ls /sys/kernel/debug/tracing/events/ <span class="p">|</span> grep visl
visl_fwht_controls
visl_h264_controls
visl_hevc_controls
visl_mpeg2_controls
visl_vp8_controls
visl_vp9_controls
</pre></div>
</div>
<p>For example, in order to dump HEVC SPS data:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ <span class="nb">echo</span> <span class="m">1</span> &gt;  /sys/kernel/debug/tracing/events/visl_hevc_controls/v4l2_ctrl_hevc_sps/enable
</pre></div>
</div>
<p>The SPS data will be dumped to the trace buffer, i.e.:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ cat /sys/kernel/debug/tracing/trace
video_parameter_set_id <span class="m">0</span>
seq_parameter_set_id <span class="m">0</span>
pic_width_in_luma_samples <span class="m">1920</span>
pic_height_in_luma_samples <span class="m">1080</span>
bit_depth_luma_minus8 <span class="m">0</span>
bit_depth_chroma_minus8 <span class="m">0</span>
log2_max_pic_order_cnt_lsb_minus4 <span class="m">4</span>
sps_max_dec_pic_buffering_minus1 <span class="m">6</span>
sps_max_num_reorder_pics <span class="m">2</span>
sps_max_latency_increase_plus1 <span class="m">0</span>
log2_min_luma_coding_block_size_minus3 <span class="m">0</span>
log2_diff_max_min_luma_coding_block_size <span class="m">3</span>
log2_min_luma_transform_block_size_minus2 <span class="m">0</span>
log2_diff_max_min_luma_transform_block_size <span class="m">3</span>
max_transform_hierarchy_depth_inter <span class="m">2</span>
max_transform_hierarchy_depth_intra <span class="m">2</span>
pcm_sample_bit_depth_luma_minus1 <span class="m">0</span>
pcm_sample_bit_depth_chroma_minus1 <span class="m">0</span>
log2_min_pcm_luma_coding_block_size_minus3 <span class="m">0</span>
log2_diff_max_min_pcm_luma_coding_block_size <span class="m">0</span>
num_short_term_ref_pic_sets <span class="m">0</span>
num_long_term_ref_pics_sps <span class="m">0</span>
chroma_format_idc <span class="m">1</span>
sps_max_sub_layers_minus1 <span class="m">0</span>
flags AMP_ENABLED<span class="p">|</span>SAMPLE_ADAPTIVE_OFFSET<span class="p">|</span>TEMPORAL_MVP_ENABLED<span class="p">|</span>STRONG_INTRA_SMOOTHING_ENABLED
</pre></div>
</div>
</section>
<section id="dumping-output-buffer-data-through-debugfs">
<h2><span class="section-number">7.23.5. </span>Dumping OUTPUT buffer data through debugfs<a class="headerlink" href="#dumping-output-buffer-data-through-debugfs" title="Permalink to this headline">¶</a></h2>
<p>If the <strong>VISL_DEBUGFS</strong> Kconfig is enabled, visl will populate
<strong>/sys/kernel/debug/visl/bitstream</strong> with OUTPUT buffer data according to the
values of bitstream_trace_frame_start and bitstream_trace_nframes. This can
highlight errors as broken clients may fail to fill the buffers properly.</p>
<p>A single file is created for each processed OUTPUT buffer. Its name contains an
integer that denotes the buffer sequence, i.e.:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">snprintf</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;bitstream%d&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">run</span><span class="o">-&gt;</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">sequence</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<p>Dumping the values is simply a matter of reading from the file, i.e.:</p>
<p>For the buffer with sequence == 0:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ xxd /sys/kernel/debug/visl/bitstream/bitstream0
<span class="m">00000000</span>: <span class="m">2601</span> af04 d088 bc25 a173 0e41 a4f2 <span class="m">3274</span>  <span class="p">&amp;</span>......%.s.A..2t
<span class="m">00000010</span>: c668 cb28 e775 b4ac f53a ba60 f8fd 3aa1  .h.<span class="o">(</span>.u...:.<span class="sb">`</span>..:.
<span class="m">00000020</span>: 46b4 bcfc 506c e227 <span class="m">2372</span> e5f5 d7ea 579f  F...Pl.<span class="s1">&#39;#r....W.</span>
<span class="s1">00000030: 6371 5eb5 0eb8 23b5 ca6a 5de5 983a 19e4  cq^...#..j]..:..</span>
<span class="s1">00000040: e8c3 4320 b4ba a226 cbc1 4138 3a12 32d6  ..C ...&amp;..A8:.2.</span>
<span class="s1">00000050: fef3 247b 3523 4e90 9682 ac8e eb0c a389  ..${5#N.........</span>
<span class="s1">00000060: ddd0 6cfc 0187 0e20 7aae b15b 1812 3d33  ..l.... z..[..=3</span>
<span class="s1">00000070: e1c5 f425 a83a 00b7 4f18 8127 3c4c aefb  ...%.:..O..&#39;</span>&lt;L..
</pre></div>
</div>
<p>For the buffer with sequence == 1:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ xxd /sys/kernel/debug/visl/bitstream/bitstream1
<span class="m">00000000</span>: <span class="m">0201</span> d021 49e1 0c40 aa11 <span class="m">1449</span> 14a6 01dc  ...!I..@...I....
<span class="m">00000010</span>: <span class="m">7023</span> 889a c8cd 2cd0 13b4 dab0 e8ca 21fe  p#....,.......!.
<span class="m">00000020</span>: c4c8 ab4c 486e 4e2f b0df 96cc c74e 8dde  ...LHnN/.....N..
<span class="m">00000030</span>: 8ce7 ee36 d880 <span class="m">4095</span> 4d64 30a0 ff4f 0c5e  ...6..@.Md0..O.^
<span class="m">00000040</span>: f16b a6a1 d806 ca2a 0ece a673 7bea 1f37  .k.....*...s<span class="o">{</span>..7
<span class="m">00000050</span>: 370f 5bb9 1dc4 ba21 <span class="m">6434</span> bc53 <span class="m">0173</span> cba0  <span class="m">7</span>.<span class="o">[</span>....!d4.S.s..
<span class="m">00000060</span>: dfe6 bc99 01ea b6e0 346b 92b5 c8de 9f5d  ........4k.....<span class="o">]</span>
<span class="m">00000070</span>: e7cc <span class="m">3484</span> <span class="m">1769</span> fef2 a693 a945 2c8b 31da  ..4..i.....E,.1.
</pre></div>
</div>
<p>And so on.</p>
<p>By default, the files are removed during STREAMOFF. This is to reduce the amount
of clutter.</p>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">The Linux Kernel</a></h1>



<p class="blurb">6.2.0-rc4-6.2.0-rc4+</p>







<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
  <h3><a href="../../index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">7.23. The Virtual Stateless Decoder Driver (visl)</a><ul>
<li><a class="reference internal" href="#module-parameters">7.23.1. Module parameters</a></li>
<li><a class="reference internal" href="#what-is-the-default-use-case-for-this-driver">7.23.2. What is the default use case for this driver?</a></li>
<li><a class="reference internal" href="#supported-codecs">7.23.3. Supported codecs</a></li>
<li><a class="reference internal" href="#visl-trace-events">7.23.4. visl trace events</a></li>
<li><a class="reference internal" href="#dumping-output-buffer-data-through-debugfs">7.23.5. Dumping OUTPUT buffer data through debugfs</a></li>
</ul>
</li>
</ul>

  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../../_sources/admin-guide/media/visl.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;The kernel development community.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 2.4.4</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="../../_sources/admin-guide/media/visl.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>