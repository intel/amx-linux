
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Userspace verbs access &#8212; The Linux Kernel 6.2.0-rc4+ documentation</title>
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="LEDs" href="../leds/index.html" />
    <link rel="prev" title="Userspace MAD access" href="user_mad.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="userspace-verbs-access">
<h1>Userspace verbs access<a class="headerlink" href="#userspace-verbs-access" title="Permalink to this headline">¶</a></h1>
<blockquote>
<div><p>The ib_uverbs module, built by enabling CONFIG_INFINIBAND_USER_VERBS,
enables direct userspace access to IB hardware via “verbs,” as
described in chapter 11 of the InfiniBand Architecture Specification.</p>
<p>To use the verbs, the libibverbs library, available from
<a class="reference external" href="https://github.com/linux-rdma/rdma-core">https://github.com/linux-rdma/rdma-core</a>, is required. libibverbs contains a
device-independent API for using the ib_uverbs interface.
libibverbs also requires appropriate device-dependent kernel and
userspace driver for your InfiniBand hardware.  For example, to use
a Mellanox HCA, you will need the ib_mthca kernel module and the
libmthca userspace driver be installed.</p>
</div></blockquote>
<section id="user-kernel-communication">
<h2>User-kernel communication<a class="headerlink" href="#user-kernel-communication" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><p>Userspace communicates with the kernel for slow path, resource
management operations via the /dev/infiniband/uverbsN character
devices.  Fast path operations are typically performed by writing
directly to hardware registers mmap()ed into userspace, with no
system call or context switch into the kernel.</p>
<p>Commands are sent to the kernel via write()s on these device files.
The ABI is defined in drivers/infiniband/include/ib_user_verbs.h.
The structs for commands that require a response from the kernel
contain a 64-bit field used to pass a pointer to an output buffer.
Status is returned to userspace as the return value of the write()
system call.</p>
</div></blockquote>
</section>
<section id="resource-management">
<h2>Resource management<a class="headerlink" href="#resource-management" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><p>Since creation and destruction of all IB resources is done by
commands passed through a file descriptor, the kernel can keep track
of which resources are attached to a given userspace context.  The
ib_uverbs module maintains idr tables that are used to translate
between kernel pointers and opaque userspace handles, so that kernel
pointers are never exposed to userspace and userspace cannot trick
the kernel into following a bogus pointer.</p>
<p>This also allows the kernel to clean up when a process exits and
prevent one process from touching another process’s resources.</p>
</div></blockquote>
</section>
<section id="memory-pinning">
<h2>Memory pinning<a class="headerlink" href="#memory-pinning" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><p>Direct userspace I/O requires that memory regions that are potential
I/O targets be kept resident at the same physical address.  The
ib_uverbs module manages pinning and unpinning memory regions via
get_user_pages() and put_page() calls.  It also accounts for the
amount of memory pinned in the process’s pinned_vm, and checks that
unprivileged processes do not exceed their RLIMIT_MEMLOCK limit.</p>
<p>Pages that are pinned multiple times are counted each time they are
pinned, so the value of pinned_vm may be an overestimate of the
number of pages pinned by a process.</p>
</div></blockquote>
</section>
<section id="dev-files">
<h2>/dev files<a class="headerlink" href="#dev-files" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><p>To create the appropriate character device files automatically with
udev, a rule like:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>KERNEL==&quot;uverbs*&quot;, NAME=&quot;infiniband/%k&quot;
</pre></div>
</div>
<p>can be used.  This will create device nodes named:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>/dev/infiniband/uverbs0
</pre></div>
</div>
<p>and so on.  Since the InfiniBand userspace verbs should be safe for
use by non-privileged processes, it may be useful to add an
appropriate MODE or GROUP to the udev rule.</p>
</div></blockquote>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../index.html">The Linux Kernel</a></h1>



<p class="blurb">6.2.0-rc4-6.2.0-rc4+</p>







<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
  <h3><a href="../index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Userspace verbs access</a><ul>
<li><a class="reference internal" href="#user-kernel-communication">User-kernel communication</a></li>
<li><a class="reference internal" href="#resource-management">Resource management</a></li>
<li><a class="reference internal" href="#memory-pinning">Memory pinning</a></li>
<li><a class="reference internal" href="#dev-files">/dev files</a></li>
</ul>
</li>
</ul>

  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/infiniband/user_verbs.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;The kernel development community.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 2.4.4</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="../_sources/infiniband/user_verbs.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>