
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>内核测试指南 &#8212; The Linux Kernel 6.2.0-rc4+ documentation</title>
    <link rel="stylesheet" href="../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <script id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="Sparse" href="sparse.html" />
    <link rel="prev" title="内核开发工具" href="index.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>此文件的目的是为让中文读者更容易阅读和理解，而不是作为一个分支。 因此，
如果您对此文件有任何意见或更新，请先尝试更新原始英文文件。</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>如果您发现本文档与原始文件有任何不同或者有翻译问题，请联系该文件的译者，
或者请求时奎亮的帮助：&lt;<a class="reference external" href="mailto:alexs&#37;&#52;&#48;kernel&#46;org">alexs<span>&#64;</span>kernel<span>&#46;</span>org</a>&gt;。</p>
</div>
<dl class="field-list simple">
<dt class="field-odd">Original</dt>
<dd class="field-odd"><p><a class="reference internal" href="../../../dev-tools/testing-overview.html"><span class="doc">Kernel Testing Guide</span></a></p>
</dd>
<dt class="field-even">Translator</dt>
<dd class="field-even"><p>胡皓文 Hu Haowen &lt;<a class="reference external" href="mailto:src&#46;res&#37;&#52;&#48;email&#46;cn">src<span>&#46;</span>res<span>&#64;</span>email<span>&#46;</span>cn</a>&gt;</p>
</dd>
</dl>
<section id="id1">
<h1>内核测试指南<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h1>
<p>有许多不同的工具可以用于测试Linux内核，因此了解什么时候使用它们可能
很困难。本文档粗略概述了它们之间的区别，并阐释了它们是怎样糅合在一起
的。</p>
<section id="id2">
<h2>编写和运行测试<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h2>
<p>大多数内核测试都是用kselftest或KUnit框架之一编写的。它们都让运行测试
更加简化，并为编写新测试提供帮助。</p>
<p>如果你想验证内核的行为——尤其是内核的特定部分——那你就要使用kUnit或
kselftest。</p>
<section id="kunitkselftest">
<h3>KUnit和kselftest的区别<a class="headerlink" href="#kunitkselftest" title="Permalink to this headline">¶</a></h3>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>由于本文段中部分术语尚无较好的对应中文释义，可能导致与原文含义
存在些许差异，因此建议读者结合原文
（<a class="reference internal" href="../../../dev-tools/testing-overview.html"><span class="doc">Kernel Testing Guide</span></a>）辅助阅读。
如对部分翻译有异议或有更好的翻译意见，欢迎联系译者进行修订。</p>
</div>
<p>KUnit（<a class="reference internal" href="../../../dev-tools/kunit/index.html"><span class="doc">KUnit - Linux Kernel Unit Testing</span></a>）是用于“白箱”测
试的一个完整的内核内部系统：因为测试代码是内核的一部分，所以它能够访
问用户空间不能访问到的内部结构和功能。</p>
<p>因此，KUnit测试最好针对内核中较小的、自包含的部分，以便能够独立地测
试。“单元”测试的概念亦是如此。</p>
<p>比如，一个KUnit测试可能测试一个单独的内核功能（甚至通过一个函数测试
一个单一的代码路径，例如一个错误处理案例），而不是整个地测试一个特性。</p>
<p>这也使得KUnit测试构建和运行非常地快，从而能够作为开发流程的一部分被
频繁地运行。</p>
<p>有关更详细的介绍，请参阅KUnit测试代码风格指南
<a class="reference internal" href="../../../dev-tools/kunit/style.html"><span class="doc">Test Style and Nomenclature</span></a></p>
<p>kselftest（<a class="reference internal" href="../../../dev-tools/kselftest.html"><span class="doc">Linux Kernel Selftests</span></a>），相对来说，大量用
于用户空间，并且通常测试用户空间的脚本或程序。</p>
<p>这使得编写复杂的测试，或者需要操作更多全局系统状态的测试更加容易（诸
如生成进程之类）。然而，从kselftest直接调用内核函数是不行的。这也就
意味着只有通过某种方式（如系统调用、驱动设备、文件系统等）导出到了用
户空间的内核功能才能使用kselftest来测试。为此，有些测试包含了一个伴
生的内核模块用于导出更多的信息和功能。不过，对于基本上或者完全在内核
中运行的测试，KUnit可能是更佳工具。</p>
<p>kselftest也因此非常适合于全部功能的测试，因为这些功能会将接口暴露到
用户空间，从而能够被测试，而不是展现实现细节。“system”测试和
“end-to-end”测试亦是如此。</p>
<p>比如，一个新的系统调用应该伴随有新的kselftest测试。</p>
</section>
</section>
<section id="id3">
<h2>代码覆盖率工具<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h2>
<p>支持两种不同代码之间的覆盖率测量工具。它们可以用来验证一项测试执行的
确切函数或代码行。这有助于决定内核被测试了多少，或用来查找合适的测试
中没有覆盖到的极端情况。</p>
<p><a class="reference internal" href="gcov.html"><span class="doc">在Linux内核里使用gcov做代码覆盖率检查</span></a> 是GCC的覆盖率测试
工具，能用于获取内核的全局或每个模块的覆盖率。与KCOV不同的是，这个工具
不记录每个任务的覆盖率。覆盖率数据可以通过debugfs读取，并通过常规的
gcov工具进行解释。</p>
<p><a class="reference internal" href="../../../dev-tools/kcov.html"><span class="doc">kcov: code coverage for fuzzing</span></a> 是能够构建在内核之中，用于在每个任务
的层面捕捉覆盖率的一个功能。因此，它对于模糊测试和关于代码执行期间信
息的其它情况非常有用，比如在一个单一系统调用里使用它就很有用。</p>
</section>
<section id="id4">
<h2>动态分析工具<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h2>
<p>内核也支持许多动态分析工具，用以检测正在运行的内核中出现的多种类型的
问题。这些工具通常每个去寻找一类不同的缺陷，比如非法内存访问，数据竞
争等并发问题，或整型溢出等其他未定义行为。</p>
<p>如下所示：</p>
<ul class="simple">
<li><p>kmemleak检测可能的内存泄漏。参阅
<a class="reference internal" href="../../../dev-tools/kmemleak.html"><span class="doc">Kernel Memory Leak Detector</span></a></p></li>
<li><p>KASAN检测非法内存访问，如数组越界和释放后重用（UAF）。参阅
<a class="reference internal" href="../../../dev-tools/kasan.html"><span class="doc">The Kernel Address Sanitizer (KASAN)</span></a></p></li>
<li><p>UBSAN检测C标准中未定义的行为，如整型溢出。参阅
<a class="reference internal" href="../../../dev-tools/ubsan.html"><span class="doc">The Undefined Behavior Sanitizer - UBSAN</span></a></p></li>
<li><p>KCSAN检测数据竞争。参阅 <a class="reference internal" href="../../../dev-tools/kcsan.html"><span class="doc">The Kernel Concurrency Sanitizer (KCSAN)</span></a></p></li>
<li><p>KFENCE是一个低开销的内存问题检测器，比KASAN更快且能被用于批量构建。
参阅 <a class="reference internal" href="../../../dev-tools/kfence.html"><span class="doc">Kernel Electric-Fence (KFENCE)</span></a></p></li>
<li><p>lockdep是一个锁定正确性检测器。参阅
<a class="reference internal" href="../../../locking/lockdep-design.html"><span class="doc">Runtime locking correctness validator</span></a></p></li>
<li><p>除此以外，在内核中还有一些其它的调试工具，大多数能在
lib/Kconfig.debug 中找到。</p></li>
</ul>
<p>这些工具倾向于对内核进行整体测试，并且不像kselftest和KUnit一样“传递”。
它们可以通过在启用这些工具时运行内核测试以与kselftest或KUnit结合起来：
之后你就能确保这些错误在测试过程中都不会发生了。</p>
<p>一些工具与KUnit和kselftest集成，并且在检测到问题时会自动打断测试。</p>
</section>
<section id="id5">
<h2>静态分析工具<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h2>
<p>除了测试运行中的内核，我们还可以使用**静态分析**工具直接分析内核的源代
码（<strong>在编译时</strong>）。内核中常用的工具允许人们检查整个源代码树或其中的特
定文件。它们使得在开发过程中更容易发现和修复问题。</p>
<blockquote>
<div><p>Sparse可以通过执行类型检查、锁检查、值范围检查来帮助测试内核，此外还
可以在检查代码时报告各种错误和警告。关于如何使用它的细节，请参阅
<a class="reference internal" href="sparse.html"><span class="doc">Sparse</span></a>。</p>
<p>Smatch扩展了Sparse，并提供了对编程逻辑错误的额外检查，如开关语句中
缺少断点，错误检查中未使用的返回值，忘记在错误路径的返回中设置错误代
码等。Smatch也有针对更严重问题的测试，如整数溢出、空指针解除引用和内
存泄漏。见项目页面http://smatch.sourceforge.net/。</p>
<p>Coccinelle是我们可以使用的另一个静态分析器。Coccinelle经常被用来
帮助源代码的重构和并行演化，但它也可以帮助避免常见代码模式中出现的某
些错误。可用的测试类型包括API测试、内核迭代器的正确使用测试、自由操
作的合理性检查、锁定行为的分析，以及已知的有助于保持内核使用一致性的
进一步测试。详情请见Documentation/dev-tools/coccinelle.rst。</p>
<p>不过要注意的是，静态分析工具存在**假阳性**的问题。在试图修复错误和警
告之前，需要仔细评估它们。</p>
</div></blockquote>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../index.html">The Linux Kernel</a></h1>



<p class="blurb">6.2.0-rc4-6.2.0-rc4+</p>







<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
  <h3><a href="../../../index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">内核测试指南</a><ul>
<li><a class="reference internal" href="#id2">编写和运行测试</a><ul>
<li><a class="reference internal" href="#kunitkselftest">KUnit和kselftest的区别</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id3">代码覆盖率工具</a></li>
<li><a class="reference internal" href="#id4">动态分析工具</a></li>
<li><a class="reference internal" href="#id5">静态分析工具</a></li>
</ul>
</li>
</ul>

  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../../../_sources/translations/zh_CN/dev-tools/testing-overview.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;The kernel development community.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 2.4.4</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="../../../_sources/translations/zh_CN/dev-tools/testing-overview.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>