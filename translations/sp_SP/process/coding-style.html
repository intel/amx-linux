
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Estilo en el código del kernel Linux &#8212; The Linux Kernel 6.2.0-rc4+ documentation</title>
    <link rel="stylesheet" href="../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <script id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="Barreras de Memoria del kernel Linux" href="../wrappers/memory-barriers.html" />
    <link rel="prev" title="Índice de documentación adicional del kernel" href="kernel-docs.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Si tiene alguna duda sobre la exactitud del contenido de esta
traducción, la única referencia válida es la documentación oficial en
inglés.</p>
</div>
<dl class="field-list simple">
<dt class="field-odd">Original</dt>
<dd class="field-odd"><p><a class="reference internal" href="../../../process/submitting-patches.html#submittingpatches"><span class="std std-ref">Documentation/process/coding-style.rst</span></a></p>
</dd>
<dt class="field-even">Translator</dt>
<dd class="field-even"><p>Carlos Bilbao &lt;<a class="reference external" href="mailto:carlos&#46;bilbao&#37;&#52;&#48;amd&#46;com">carlos<span>&#46;</span>bilbao<span>&#64;</span>amd<span>&#46;</span>com</a>&gt;</p>
</dd>
</dl>
<section id="estilo-en-el-codigo-del-kernel-linux">
<span id="sp-codingstyle"></span><h1>Estilo en el código del kernel Linux<a class="headerlink" href="#estilo-en-el-codigo-del-kernel-linux" title="Permalink to this headline">¶</a></h1>
<p>Este es un breve documento que describe el estilo preferido en el código
del kernel Linux. El estilo de código es muy personal y no <strong>forzaré</strong> mi
puntos de vista sobre nadie, pero esto vale para todo lo que tengo que
mantener, y preferiría que para la mayoría de otras cosas también. Por
favor, por lo menos considere los argumentos expuestos aquí.</p>
<p>En primer lugar, sugeriría imprimir una copia de los estándares de código
GNU, y NO leerlo. Quémelos, es un gran gesto simbólico.</p>
<p>De todos modos, aquí va:</p>
<section id="sangria">
<h2>1) Sangría<a class="headerlink" href="#sangria" title="Permalink to this headline">¶</a></h2>
<p>Las tabulaciones tienen 8 caracteres y, por lo tanto, las sangrías también
tienen 8 caracteres. Hay movimientos heréticos que intentan hacer sangría
de 4 (¡o incluso 2!) caracteres de longitud, y eso es similar a tratar de
definir el valor de PI como 3.</p>
<p>Justificación: La idea detrás de la sangría es definir claramente dónde
comienza y termina un bloque de control. Especialmente, cuando ha estado
buscando en su pantalla durante 20 horas seguidas, le resultará mucho más
fácil ver cómo funciona la sangría si tiene sangrías grandes.</p>
<p>Bueno, algunas personas dirán que tener sangrías de 8 caracteres hace que
el código se mueva demasiado a la derecha y dificulta la lectura en una
pantalla de terminal de 80 caracteres. La respuesta a eso es que si
necesita más de 3 niveles de sangría, está en apuros de todos modos y
debería arreglar su programa.</p>
<p>En resumen, las sangrías de 8 caracteres facilitan la lectura y tienen la
ventaja añadida de advertirle cuando está anidando sus funciones demasiado
profundo. Preste atención a esa advertencia.</p>
<p>La forma preferida de facilitar múltiples niveles de sangría en una
declaración de switch es para alinear el <code class="docutils literal notranslate"><span class="pre">switch</span></code> y sus etiquetas
<code class="docutils literal notranslate"><span class="pre">case</span></code> subordinadas en la misma columna, en lugar de hacer <code class="docutils literal notranslate"><span class="pre">doble</span>
<span class="pre">sangría</span></code> (<code class="docutils literal notranslate"><span class="pre">double-indenting</span></code>) en etiquetas <code class="docutils literal notranslate"><span class="pre">case</span></code>. Por ejemplo:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">suffix</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="k">case</span><span class="w"> </span><span class="sc">&#39;G&#39;</span><span class="o">:</span><span class="w"></span>
<span class="k">case</span><span class="w"> </span><span class="sc">&#39;g&#39;</span><span class="o">:</span><span class="w"></span>
<span class="w">        </span><span class="n">mem</span><span class="w"> </span><span class="o">&lt;&lt;=</span><span class="w"> </span><span class="mi">30</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="k">case</span><span class="w"> </span><span class="sc">&#39;M&#39;</span><span class="o">:</span><span class="w"></span>
<span class="k">case</span><span class="w"> </span><span class="sc">&#39;m&#39;</span><span class="o">:</span><span class="w"></span>
<span class="w">        </span><span class="n">mem</span><span class="w"> </span><span class="o">&lt;&lt;=</span><span class="w"> </span><span class="mi">20</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="k">case</span><span class="w"> </span><span class="sc">&#39;K&#39;</span><span class="o">:</span><span class="w"></span>
<span class="k">case</span><span class="w"> </span><span class="sc">&#39;k&#39;</span><span class="o">:</span><span class="w"></span>
<span class="w">        </span><span class="n">mem</span><span class="w"> </span><span class="o">&lt;&lt;=</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">fallthrough</span><span class="p">;</span><span class="w"></span>
<span class="k">default</span><span class="o">:</span><span class="w"></span>
<span class="w">        </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>No ponga varias declaraciones en una sola línea a menos que tenga algo que
ocultar:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">condición</span><span class="p">)</span><span class="w"> </span><span class="n">haz_esto</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">haz_otra_cosa</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
<p>No use comas para evitar el uso de llaves:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">condición</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">haz_esto</span><span class="p">(),</span><span class="w"> </span><span class="n">haz_eso</span><span class="p">();</span><span class="w"></span>
</pre></div>
</div>
<p>Siempre use llaves para múltiples declaraciones:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">condición</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">haz_esto</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="n">haz_eso</span><span class="p">();</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>Tampoco ponga varias asignaciones en una sola línea. El estilo de código
del kernel es súper simple. Evite las expresiones engañosas.</p>
<p>Aparte de los comentarios, la documentación y excepto en Kconfig, los
espacios nunca se utilizan para la sangría, y el ejemplo anterior se rompe
deliberadamente.</p>
<p>Consiga un editor decente y no deje espacios en blanco al final de las
líneas.</p>
</section>
<section id="rompiendo-lineas-y-strings-largos">
<h2>2) Rompiendo líneas y strings largos<a class="headerlink" href="#rompiendo-lineas-y-strings-largos" title="Permalink to this headline">¶</a></h2>
<p>El estilo de código tiene todo que ver con la legibilidad y la
mantenibilidad usando herramientas disponibles comúnmente.</p>
<p>El límite preferido en la longitud de una sola línea es de 80 columnas.</p>
<p>Las declaraciones de más de 80 columnas deben dividirse en partes, a menos
que exceder las 80 columnas aumente significativamente la legibilidad y no
oculte información.</p>
<p>Los descendientes siempre son sustancialmente más cortos que el padre y
se colocan sustancialmente a la derecha. Un estilo muy usado es alinear
descendientes a un paréntesis de función abierto.</p>
<p>Estas mismas reglas se aplican a los encabezados de funciones con una larga
lista de argumentos.</p>
<p>Sin embargo, nunca rompa los strings visibles para el usuario, como los
mensajes printk, porque eso rompe la capacidad de grep a estos.</p>
</section>
<section id="colocacion-de-llaves-y-espacios">
<h2>3) Colocación de llaves y espacios<a class="headerlink" href="#colocacion-de-llaves-y-espacios" title="Permalink to this headline">¶</a></h2>
<p>El otro problema que siempre surge en el estilo C es la colocación de
llaves. A diferencia del tamaño de la sangría, existen pocas razones
técnicas para elegir una estrategia de ubicación sobre la otra, pero la
forma preferida, como mostraron los profetas Kernighan y Ritchie, es poner
la llave de apertura en la línea, y colocar la llave de cierre primero,
así:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">es</span><span class="w"> </span><span class="n">verdad</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">hacemos</span><span class="w"> </span><span class="n">y</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>Esto se aplica a todos los bloques de declaraciones que no son funciones
(if, switch, for, while, do). Por ejemplo:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">action</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="k">case</span><span class="w"> </span><span class="nl">KOBJ_ADD</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="s">&quot;add&quot;</span><span class="p">;</span><span class="w"></span>
<span class="k">case</span><span class="w"> </span><span class="nl">KOBJ_REMOVE</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="s">&quot;remove&quot;</span><span class="p">;</span><span class="w"></span>
<span class="k">case</span><span class="w"> </span><span class="nl">KOBJ_CHANGE</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="s">&quot;change&quot;</span><span class="p">;</span><span class="w"></span>
<span class="k">default</span><span class="o">:</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>Sin embargo, hay un caso especial, a saber, las funciones: tienen la llave
de apertura al comienzo de la siguiente línea, así:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="nf">funcion</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">cuerpo</span><span class="w"> </span><span class="n">de</span><span class="w"> </span><span class="n">la</span><span class="w"> </span><span class="n">función</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>Gente hereje de todo el mundo ha afirmado que esta inconsistencia es…
bueno… inconsistente, pero todas las personas sensatas saben que
(a) K&amp;R tienen <strong>razón</strong> y (b) K&amp;R tienen razón. Además, las funciones son
especiales de todos modos (no puede anidarlas en C).</p>
<p>Tenga en cuenta que la llave de cierre está vacía en su línea propia,
<strong>excepto</strong> en los casos en que es seguida por una continuación de la misma
declaración, es decir, un <code class="docutils literal notranslate"><span class="pre">while</span></code> en una sentencia do o un <code class="docutils literal notranslate"><span class="pre">else</span></code> en
una sentencia if, como en:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">do</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">cuerpo</span><span class="w"> </span><span class="n">del</span><span class="w"> </span><span class="n">bucle</span><span class="w"> </span><span class="k">do</span><span class="w"></span>
<span class="p">}</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">condition</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<p>y</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="p">..</span><span class="w"></span>
<span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="p">...</span><span class="w"></span>
<span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="p">....</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>Justificación: K&amp;R.</p>
<p>Además, tenga en cuenta que esta colocación de llaves también minimiza el
número de líneas vacías (o casi vacías), sin pérdida de legibilidad. Así,
como el suministro de nuevas líneas en su pantalla no es un recurso
renovable (piense en pantallas de terminal de 25 líneas), tienes más líneas
vacías para poner comentarios.</p>
<p>No use llaves innecesariamente donde una sola declaración sea suficiente.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">condition</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">accion</span><span class="p">();</span><span class="w"></span>
</pre></div>
</div>
<p>y</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>if (condición)
        haz_esto();
else
        haz_eso();
</pre></div>
</div>
<p>Esto no aplica si solo una rama de una declaración condicional es una sola
declaración; en este último caso utilice llaves en ambas ramas:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">condición</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">haz_esto</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="n">haz_eso</span><span class="p">();</span><span class="w"></span>
<span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">en_otro_caso</span><span class="p">();</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>Además, use llaves cuando un bucle contenga más de una declaración simple:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">condición</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">test</span><span class="p">)</span><span class="w"></span>
<span class="w">                </span><span class="n">haz_eso</span><span class="p">();</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<section id="espacios">
<h3>3.1) Espacios<a class="headerlink" href="#espacios" title="Permalink to this headline">¶</a></h3>
<p>El estilo del kernel Linux para el uso de espacios depende (principalmente)
del uso de función versus uso de palabra clave. Utilice un espacio después
de (la mayoría de) las palabras clave. Las excepciones notables son sizeof,
typeof, alignof y __attribute__, que parecen algo así como funciones (y
generalmente se usan con paréntesis en Linux, aunque no son requeridos en
el idioma, como en: <code class="docutils literal notranslate"><span class="pre">sizeof</span> <span class="pre">info</span></code> después de que <code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">fileinfo</span> <span class="pre">info;</span></code>
se declare).</p>
<p>Así que use un espacio después de estas palabras clave:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>if, switch, case, for, do, while
</pre></div>
</div>
<p>pero no con sizeof, typeof, alignof, o __attribute__. Por ejemplo,</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="nc">file</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<p>No agregue espacios alrededor (dentro) de expresiones entre paréntesis.
Este ejemplo es <strong>malo</strong>:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="w"> </span><span class="k">struct</span> <span class="nc">file</span><span class="w"> </span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<p>Al declarar datos de puntero o una función que devuelve un tipo de puntero,
el uso preferido de <code class="docutils literal notranslate"><span class="pre">*</span></code> es adyacente al nombre del dato o nombre de la
función y no junto al nombre del tipo. Ejemplos:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">linux_banner</span><span class="p">;</span><span class="w"></span>
<span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">memparse</span><span class="p">(</span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">ptr</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">**</span><span class="n">retptr</span><span class="p">);</span><span class="w"></span>
<span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="nf">match_strdup</span><span class="p">(</span><span class="n">substring_t</span><span class="w"> </span><span class="o">*</span><span class="n">s</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<p>Use un espacio alrededor (a cada lado de) la mayoría de los operadores
binarios y ternarios, como cualquiera de estos:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>=  +  -  &lt;  &gt;  *  /  %  |  &amp;  ^  &lt;=  &gt;=  ==  !=  ?  :
</pre></div>
</div>
<p>pero sin espacio después de los operadores unarios:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>&amp;  *  +  -  ~  !  sizeof  typeof  alignof  __attribute__  defined
</pre></div>
</div>
<p>sin espacio antes de los operadores unarios de incremento y decremento del
sufijo:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>++  --
</pre></div>
</div>
<p>y sin espacio alrededor de los operadores de miembros de estructura <code class="docutils literal notranslate"><span class="pre">.</span></code> y
<code class="docutils literal notranslate"><span class="pre">-&gt;</span></code>.</p>
<p>No deje espacios en blanco al final de las líneas. Algunos editores con
<code class="docutils literal notranslate"><span class="pre">inteligente</span></code> sangría insertarán espacios en blanco al comienzo de las
nuevas líneas como sea apropiado, para que pueda comenzar a escribir la
siguiente línea de código de inmediato. Sin embargo, algunos de estos
editores no eliminan los espacios en blanco si finalmente no termina
poniendo una línea de código allí, como si dejara una línea en blanco. Como
resultado, termina con líneas que contienen espacios en blanco al final.</p>
<p>Git le advertirá sobre los parches que introducen espacios en blanco al
final y puede, opcionalmente, eliminar los espacios en blanco finales por
usted; sin embargo, si se aplica una serie de parches, esto puede hacer que
los parches posteriores de la serie fallen al cambiar sus líneas de
contexto.</p>
</section>
</section>
<section id="nomenclatura">
<h2>4) Nomenclatura<a class="headerlink" href="#nomenclatura" title="Permalink to this headline">¶</a></h2>
<p>C es un lenguaje espartano, y sus convenciones de nomenclatura deberían
seguir su ejemplo. A diferencia de los programadores de Modula-2 y Pascal,
los programadores de C no usan nombres cuquis como
EstaVariableEsUnContadorTemporal. Un programador de C lo llamaría
variable <code class="docutils literal notranslate"><span class="pre">tmp</span></code>, que es mucho más fácil de escribir, y no es mas difícil
de comprender.</p>
<p>SIN EMBARGO, mientras que los nombres de mayúsculas y minúsculas están mal
vistos, los nombres descriptivos para las variables globales son
imprescindibles. Llamar a una función global <code class="docutils literal notranslate"><span class="pre">foo</span></code> es un delito.</p>
<p>Una variable GLOBAL (para usar solo si <strong>realmente</strong> las necesita) necesita
tener un nombre descriptivo, al igual que las funciones globales. Si tiene
una función que cuenta el número de usuarios activos, debe llamar a esta
<code class="docutils literal notranslate"><span class="pre">contar_usuarios_activos()</span></code> o similar, <strong>no</strong> debe llamarlo <code class="docutils literal notranslate"><span class="pre">cntusr()</span></code>.</p>
<p>Codificar el tipo de una función en el nombre (lo llamado notación húngara)
es estúpido: el compilador conoce los tipos de todos modos y puede
verificar estos, y solo confunde al programador.</p>
<p>Los nombres de las variables LOCALES deben ser breves y directos. Si usted
tiene algún contador aleatorio de tipo entero, probablemente debería
llamarse <code class="docutils literal notranslate"><span class="pre">i</span></code>. Llamarlo <code class="docutils literal notranslate"><span class="pre">loop_counter</span></code> no es productivo, si no hay
posibilidad de ser mal entendido. De manera similar, <code class="docutils literal notranslate"><span class="pre">tmp</span></code> puede ser casi
cualquier tipo de variable que se utiliza para contener un valor temporal.</p>
<p>Si tiene miedo de mezclar los nombres de las variables locales, tiene otro
problema, que se denomina síndrome de
función-crecimiento-desequilibrio-de-hormona. Vea el capítulo 6 (Funciones).</p>
<p>Para nombres de símbolos y documentación, evite introducir nuevos usos de
‘master / slave’ (maestro / esclavo) (o ‘slave’ independientemente de
‘master’) y ‘lista negra / lista blanca’ (backlist / whitelist).</p>
<dl class="simple">
<dt>Los reemplazos recomendados para ‘maestro / esclavo’ son:</dt><dd><p>‘{primary,main} / {secondary,replica,subordinate}’
‘{initiator,requester} / {target,responder}’
‘{controller,host} / {device,worker,proxy}’
‘leader / follower’
‘director / performer’</p>
</dd>
<dt>Los reemplazos recomendados para ‘backlist / whitelist’ son:</dt><dd><p>‘denylist / allowlist’
‘blocklist / passlist’</p>
</dd>
</dl>
<p>Las excepciones para la introducción de nuevos usos son mantener en espacio
de usuario una ABI/API, o al actualizar la especificación del código de un
hardware o protocolo existente (a partir de 2020) que requiere esos
términos. Para nuevas especificaciones, traduzca el uso de la terminología
de la especificación al estándar de código del kernel donde sea posible.</p>
</section>
<section id="typedefs">
<h2>5) Typedefs<a class="headerlink" href="#typedefs" title="Permalink to this headline">¶</a></h2>
<p>Por favor no use cosas como <code class="docutils literal notranslate"><span class="pre">vps_t</span></code>.
Es un <strong>error</strong> usar typedef para estructuras y punteros. cuando ve un</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">vps_t</span><span class="w"> </span><span class="n">a</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
<p>en el código fuente, ¿qué significa?
En cambio, si dice</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">struct</span> <span class="nc">virtual_container</span><span class="w"> </span><span class="o">*</span><span class="n">a</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
<p>puede decir qué es <code class="docutils literal notranslate"><span class="pre">a</span></code> en realidad.</p>
<p>Mucha gente piensa que  los typedefs <code class="docutils literal notranslate"><span class="pre">ayudan</span> <span class="pre">a</span> <span class="pre">la</span> <span class="pre">legibilidad</span></code>. No. Son
útiles solamente para:</p>
<blockquote>
<div><ol class="loweralpha">
<li><p>objetos totalmente opacos (donde el typedef se usa activamente para
<strong>ocultar</strong> cuál es el objeto).</p>
<p>Ejemplo: <code class="docutils literal notranslate"><span class="pre">pte_t</span></code> etc. objetos opacos a los que solo puede acceder
usando las funciones de acceso adecuadas.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>La opacidad y las <code class="docutils literal notranslate"><span class="pre">funciones</span> <span class="pre">de</span> <span class="pre">acceso</span></code> no son buenas por sí
mismas. La razón por la que los tenemos para cosas como pte_t, etc.
es que hay real y absolutamente <strong>cero</strong> información accesible de
forma portátil allí.</p>
</div>
</li>
<li><p>Tipos enteros claros, donde la abstracción <strong>ayuda</strong> a evitar
confusiones, ya sea <code class="docutils literal notranslate"><span class="pre">int</span></code> o <code class="docutils literal notranslate"><span class="pre">long</span></code>.</p>
<p>u8/u16/u32 son definiciones tipográficas perfectamente correctas
aunque encajan en la categoría (d) mejor que aquí.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>De nuevo - debe haber una <strong>razón</strong> para esto. si algo es
<code class="docutils literal notranslate"><span class="pre">unsigned</span> <span class="pre">long</span></code>, entonces no hay razón para hacerlo</p>
<blockquote>
<div><p>typedef unsigned long mis_flags_t;</p>
</div></blockquote>
</div>
<p>pero si hay una razón clara de por qué bajo ciertas circunstancias
podría ser un <code class="docutils literal notranslate"><span class="pre">unsigned</span> <span class="pre">int</span></code> y bajo otras configuraciones podría
ser <code class="docutils literal notranslate"><span class="pre">unsigned</span> <span class="pre">long</span></code>, entonces, sin duda, adelante y use un typedef.</p>
</li>
<li><p>cuando lo use para crear literalmente un tipo <strong>nuevo</strong> para
comprobación de tipos.</p></li>
<li><p>Nuevos tipos que son idénticos a los tipos estándar C99, en ciertas
circunstancias excepcionales.</p>
<p>Aunque sólo costaría un corto período de tiempo para los ojos y
cerebro para acostumbrarse a los tipos estándar como <code class="docutils literal notranslate"><span class="pre">uint32_t</span></code>,
algunas personas se oponen a su uso de todos modos.</p>
<p>Por lo tanto, los tipos <code class="docutils literal notranslate"><span class="pre">u8/u16/u32/u64</span></code> específicos de Linux y sus
equivalentes con signo, que son idénticos a los tipos estándar son
permitidos, aunque no son obligatorios en el nuevo código de su
elección.</p>
<p>Al editar código existente que ya usa uno u otro conjunto de tipos,
debe ajustarse a las opciones existentes en ese código.</p>
</li>
<li><p>Tipos seguros para usar en el espacio de usuario.</p>
<p>En ciertas estructuras que son visibles para el espacio de usuario, no
podemos requerir tipos C99 y o utilizat el <code class="docutils literal notranslate"><span class="pre">u32</span></code> anterior. Por lo
tanto, usamos __u32 y tipos similares en todas las estructuras que se
comparten con espacio de usuario.</p>
</li>
</ol>
</div></blockquote>
<p>Tal vez también haya otros casos, pero la regla básicamente debería ser
NUNCA JAMÁS use un typedef a menos que pueda coincidir claramente con una
de estas reglas.</p>
<p>En general, un puntero o una estructura que tiene elementos que pueden
ser razonablemente accedidos directamente, <strong>nunca</strong> deben ser un typedef.</p>
</section>
<section id="funciones">
<h2>6) Funciones<a class="headerlink" href="#funciones" title="Permalink to this headline">¶</a></h2>
<p>Las funciones deben ser cortas y dulces, y hacer una sola cosa. Deberían
caber en una o dos pantallas de texto (el tamaño de pantalla ISO/ANSI es
80x24, como todos sabemos), y hacer una cosa y hacerla bien.</p>
<p>La longitud máxima de una función es inversamente proporcional a la
complejidad y el nivel de sangría de esa función. Entonces, si tiene una
función conceptualmente simple que es solo una larga (pero simple)
declaración de case, donde tiene que hacer un montón de pequeñas cosas para
un montón de diferentes casos, está bien tener una función más larga.</p>
<p>Sin embargo, si tiene una función compleja y sospecha que un estudiante de
primer año de secundaria menos que dotado podría no comprender de qué se
trata la función, debe adherirse a los límites máximos tanto más de
cerca. Use funciones auxiliares con nombres descriptivos (puede pedirle al
compilador que los alinee si cree que es crítico para el rendimiento, y
probablemente lo hará mejor de lo que usted hubiera hecho).</p>
<p>Otra medida de la función es el número de variables locales. Estas no deben
exceder de 5 a 10, o está haciendo algo mal. Piense de nuevo en la función
y divida en partes más pequeñas. Un cerebro humano puede generalmente
realiza un seguimiento de aproximadamente 7 cosas diferentes, cualquier
elemento más y se confunde. Usted sabe que es brillante, pero tal vez le
gustaría entender lo que hizo dentro de 2 semanas.</p>
<p>En los archivos fuente, separe las funciones con una línea en blanco. Si la
función es exportada, la macro <strong>EXPORT</strong> debería ponerse inmediatamente
después de la función de cierre de línea de llave. Por ejemplo:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="nf">sistema_corriendo</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">estado_sistema</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">SISTEMA_CORRIENDO</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">sistema_corriendo</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<section id="prototipos-de-funciones">
<h3>6.1) Prototipos de funciones<a class="headerlink" href="#prototipos-de-funciones" title="Permalink to this headline">¶</a></h3>
<p>En los prototipos de funciones, incluya nombres de parámetros con sus tipos
de datos. Aunque esto no es requerido por el lenguaje C, se prefiere en
Linux porque es una forma sencilla de añadir información valiosa para el
lector.</p>
<p>No utilice la palabra clave <code class="docutils literal notranslate"><span class="pre">extern</span></code> con declaraciones de función ya que
esto hace las líneas más largas y no es estrictamente necesario.</p>
<p>Al escribir prototipos de funciones, mantenga el <a class="reference external" href="https://lore.kernel.org/mm-commits/CAHk-=wiOCLRny5aifWNhr621kYrJwhfURsa0vFPeUEm8mF0ufg&#64;mail.gmail.com/">orden de los elementos regular</a>.
Por ejemplo, usando este ejemplo de declaración de función:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>__init void * __must_check action(enum magic value, size_t size, u8 count,
                                  char *fmt, ...) __printf(4, 5) __malloc;
</pre></div>
</div>
<p>El orden preferido de elementos para un prototipo de función es:</p>
<ul class="simple">
<li><p>clase de almacenamiento (a continuación, <code class="docutils literal notranslate"><span class="pre">static</span> <span class="pre">__always_inline</span></code>,
teniendo en cuenta que <code class="docutils literal notranslate"><span class="pre">__always_inline</span></code> es técnicamente un atributo
pero se trata como <code class="docutils literal notranslate"><span class="pre">inline</span></code>)</p></li>
<li><p>atributos de clase de almacenamiento (aquí, <code class="docutils literal notranslate"><span class="pre">__init</span></code> – es decir,
declaraciones de sección, pero también cosas como <code class="docutils literal notranslate"><span class="pre">__cold</span></code>)</p></li>
<li><p>tipo de retorno (aquí, <code class="docutils literal notranslate"><span class="pre">void</span> <span class="pre">*</span></code>)</p></li>
<li><p>atributos de tipo de retorno (aquí, <code class="docutils literal notranslate"><span class="pre">__must_check</span></code>)</p></li>
<li><p>nombre de la función (aquí, <code class="docutils literal notranslate"><span class="pre">action</span></code>)</p></li>
<li><p>parámetros de la función (aquí, <code class="docutils literal notranslate"><span class="pre">(enum</span> <span class="pre">magic</span> <span class="pre">value,</span> <span class="pre">size_t</span> <span class="pre">size,</span> <span class="pre">u8</span> <span class="pre">count,</span> <span class="pre">char</span> <span class="pre">*fmt,</span> <span class="pre">...)</span></code>,
teniendo en cuenta que los nombres de los parámetros siempre deben
incluirse)</p></li>
<li><p>atributos de parámetros de función (aquí, <code class="docutils literal notranslate"><span class="pre">__printf(4,</span> <span class="pre">5)</span></code>)</p></li>
<li><p>atributos de comportamiento de la función (aquí, <code class="docutils literal notranslate"><span class="pre">__malloc</span></code>)</p></li>
</ul>
<p>Tenga en cuenta que para una <strong>definición</strong> de función (es decir, el cuerpo
real de la función), el compilador no permite atributos de parámetros de
función después de parámetros de la función. En estos casos, deberán ir
tras los atributos de clase (por ejemplo, tenga en cuenta el cambio de
posición de <code class="docutils literal notranslate"><span class="pre">__printf(4,</span> <span class="pre">5)</span></code> a continuación, en comparación con el
ejemplo de <strong>declaración</strong> anterior):</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>static __always_inline __init __printf(4, 5) void * __must_check action(enum magic value,
               size_t size, u8 count, char *fmt, ...) __malloc
{
       ...
}
</pre></div>
</div>
</section>
</section>
<section id="salida-centralizada-de-funciones">
<h2>7) Salida centralizada de funciones<a class="headerlink" href="#salida-centralizada-de-funciones" title="Permalink to this headline">¶</a></h2>
<p>Aunque desaprobado por algunas personas, el equivalente de la instrucción
goto es utilizado con frecuencia por los compiladores, en forma de
instrucción de salto incondicional.</p>
<p>La declaración goto es útil cuando una función sale desde múltiples
ubicaciones y se deben realizar algunos trabajos comunes, como la limpieza.
Si no se necesita limpieza, entonces simplemente haga return directamente.</p>
<p>Elija nombres de etiquetas que digan qué hace el goto o por qué existe el
goto. Un ejemplo de un buen nombre podría ser <code class="docutils literal notranslate"><span class="pre">out_free_buffer:</span></code>
(<code class="docutils literal notranslate"><span class="pre">salida_liberar_buffer</span></code>) si al irse libera <code class="docutils literal notranslate"><span class="pre">buffer</span></code>. Evite usar
nombres GW-BASIC como <code class="docutils literal notranslate"><span class="pre">err1:</span></code> y <code class="docutils literal notranslate"><span class="pre">err2:</span></code>, ya que tendría que volver a
numerarlos si alguna vez agrega o elimina rutas de salida, y hacen que sea
difícil de verificar que sean correctos, de todos modos.</p>
<p>La razón para usar gotos es:</p>
<ul class="simple">
<li><p>Las declaraciones incondicionales son más fáciles de entender y seguir.</p></li>
<li><p>se reduce el anidamiento</p></li>
<li><p>errores al no actualizar los puntos de salida individuales al hacer
modificaciones son evitados</p></li>
<li><p>ahorra el trabajo del compilador de optimizar código redundante ;)</p></li>
</ul>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="nf">fun</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">a</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">buffer</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="n">buffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kmalloc</span><span class="p">(</span><span class="n">SIZE</span><span class="p">,</span><span class="w"> </span><span class="n">GFP_KERNEL</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">buffer</span><span class="p">)</span><span class="w"></span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">condition1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">loop1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                        </span><span class="p">...</span><span class="w"></span>
<span class="w">                </span><span class="p">}</span><span class="w"></span>
<span class="w">                </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="w">                </span><span class="k">goto</span><span class="w"> </span><span class="n">out_free_buffer</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">...</span><span class="w"></span>
<span class="nl">out_free_buffer</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="n">kfree</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">result</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>Un tipo común de error a tener en cuenta es “un error de error” que es algo
así:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="nl">err</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="n">kfree</span><span class="p">(</span><span class="n">foo</span><span class="o">-&gt;</span><span class="n">bar</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">kfree</span><span class="p">(</span><span class="n">foo</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
<p>El error en este código es que en algunas rutas de salida, <code class="docutils literal notranslate"><span class="pre">foo</span></code> es NULL.
Normalmente la solución para esto es dividirlo en dos etiquetas de error
<code class="docutils literal notranslate"><span class="pre">err_free_bar:</span></code> y <code class="docutils literal notranslate"><span class="pre">err_free_foo:</span></code>:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="nl">err_free_bar</span><span class="p">:</span><span class="w"></span>
<span class="w">       </span><span class="n">kfree</span><span class="p">(</span><span class="n">foo</span><span class="o">-&gt;</span><span class="n">bar</span><span class="p">);</span><span class="w"></span>
<span class="nl">err_free_foo</span><span class="p">:</span><span class="w"></span>
<span class="w">       </span><span class="n">kfree</span><span class="p">(</span><span class="n">foo</span><span class="p">);</span><span class="w"></span>
<span class="w">       </span><span class="k">return</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
<p>Idealmente, debería simular errores para probar todas las rutas de salida.</p>
</section>
<section id="comentarios">
<h2>8) Comentarios<a class="headerlink" href="#comentarios" title="Permalink to this headline">¶</a></h2>
<p>Los comentarios son buenos, pero también existe el peligro de comentar
demasiado. NUNCA trate de explicar CÓMO funciona su código en un
comentario: es mucho mejor escribir el código para que el
<strong>funcionamiento</strong> sea obvio y es una pérdida de tiempo explicar código mal
escrito.</p>
<p>Generalmente, desea que sus comentarios digan QUÉ hace su código, no CÓMO.
Además, trate de evitar poner comentarios dentro del cuerpo de una función:
si la función es tan compleja que necesita comentar por separado partes de
esta, probablemente debería volver al capítulo 6 una temporada. Puede
hacer pequeños comentarios para notar o advertir sobre algo particularmente
inteligente (o feo), pero trate de evitar el exceso. En su lugar, ponga los
comentarios al principio de la función, diga a la gente lo que hace y
posiblemente POR QUÉ hace esto.</p>
<p>Al comentar las funciones de la API del kernel, utilice el formato
kernel-doc. Consulte los archivos en <a class="reference internal" href="../../../doc-guide/index.html#doc-guide"><span class="std std-ref">Documentation/doc-guide/</span></a>
y <code class="docutils literal notranslate"><span class="pre">scripts/kernel-doc</span></code> para más detalles.</p>
<p>El estilo preferido para comentarios largos (de varias líneas) es:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cm">/*</span>
<span class="cm">* Este es el estilo preferido para comentarios</span>
<span class="cm">* multilínea en el código fuente del kernel Linux.</span>
<span class="cm">* Por favor, utilícelo constantemente.</span>
<span class="cm">*</span>
<span class="cm">* Descripción: Una columna de asteriscos en el lado izquierdo,</span>
<span class="cm">* con líneas iniciales y finales casi en blanco.</span>
<span class="cm">*/</span><span class="w"></span>
</pre></div>
</div>
<p>Para archivos en net/ y drivers/net/, el estilo preferido para comentarios
largos (multi-linea) es un poco diferente.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cm">/* El estilo de comentario preferido para archivos en net/ y drivers/net</span>
<span class="cm">* se asemeja a esto.</span>
<span class="cm">*</span>
<span class="cm">* Es casi lo mismo que el estilo de comentario generalmente preferido,</span>
<span class="cm">* pero no hay una línea inicial casi en blanco.</span>
<span class="cm">*/</span><span class="w"></span>
</pre></div>
</div>
<p>También es importante comentar los datos, ya sean tipos básicos o
derivados. Para este fin, use solo una declaración de datos por línea (sin
comas para múltiples declaraciones de datos). Esto le deja espacio para un
pequeño comentario sobre cada elemento, explicando su uso.</p>
</section>
<section id="has-hecho-un-desastre">
<h2>9) Has hecho un desastre<a class="headerlink" href="#has-hecho-un-desastre" title="Permalink to this headline">¶</a></h2>
<p>Está bien, todos lo hacemos. Probablemente un antiguo usuario de Unix le
haya dicho que <code class="docutils literal notranslate"><span class="pre">GNU</span> <span class="pre">emacs</span></code> formatea automáticamente las fuentes C por
usted, y ha notado que sí, lo hace, pero los por defecto que tiene son
menos que deseables (de hecho, son peores que los aleatorios) escribiendo -
un número infinito de monos escribiendo en GNU emacs nunca harán un buen
programa).</p>
<p>Por lo tanto, puede deshacerse de GNU emacs o cambiarlo y usar valores más
sanos. Para hacer esto último, puede pegar lo siguiente en su archivo
.emacs:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>(defun c-lineup-arglist-tabs-only (ignored)
  &quot;Line up argument lists by tabs, not spaces&quot;
  (let* ((anchor (c-langelem-pos c-syntactic-element))
         (column (c-langelem-2nd-pos c-syntactic-element))
         (offset (- (1+ column) anchor))
         (steps (floor offset c-basic-offset)))
    (* (max steps 1)
       c-basic-offset)))

(dir-locals-set-class-variables
 &#39;linux-kernel
 &#39;((c-mode . (
        (c-basic-offset . 8)
        (c-label-minimum-indentation . 0)
        (c-offsets-alist . (
                (arglist-close         . c-lineup-arglist-tabs-only)
                (arglist-cont-nonempty .
                    (c-lineup-gcc-asm-reg c-lineup-arglist-tabs-only))
                (arglist-intro         . +)
                (brace-list-intro      . +)
                (c                     . c-lineup-C-comments)
                (case-label            . 0)
                (comment-intro         . c-lineup-comment)
                (cpp-define-intro      . +)
                (cpp-macro             . -1000)
                (cpp-macro-cont        . +)
                (defun-block-intro     . +)
                (else-clause           . 0)
                (func-decl-cont        . +)
                (inclass               . +)
                (inher-cont            . c-lineup-multi-inher)
                (knr-argdecl-intro     . 0)
                (label                 . -1000)
                (statement             . 0)
                (statement-block-intro . +)
                (statement-case-intro  . +)
                (statement-cont        . +)
                (substatement          . +)
                ))
        (indent-tabs-mode . t)
        (show-trailing-whitespace . t)
        ))))

(dir-locals-set-directory-class
 (expand-file-name &quot;~/src/linux-trees&quot;)
 &#39;linux-kernel)
</pre></div>
</div>
<p>Esto hará que emacs funcione mejor con el estilo de código del kernel para
C en archivos bajo <code class="docutils literal notranslate"><span class="pre">~/src/linux-trees</span></code>.</p>
<p>Pero incluso si no logra que emacs realice un formateo correcto, no todo
está perdido: use <code class="docutils literal notranslate"><span class="pre">indent</span></code>.</p>
<p>Ahora bien, de nuevo, la sangría de GNU tiene la misma configuración de
muerte cerebral que GNU emacs tiene, por lo que necesita darle algunas
opciones de línea de comando. Sin embargo, eso no es tan malo, porque
incluso los creadores de GNU indent reconocen la autoridad de K&amp;R (la gente
de GNU no es mala, solo están gravemente equivocados en este asunto), por
lo que simplemente de a la sangría las opciones <code class="docutils literal notranslate"><span class="pre">-kr</span> <span class="pre">-i8</span></code> (significa
<code class="docutils literal notranslate"><span class="pre">K&amp;R,</span> <span class="pre">guiones</span> <span class="pre">de</span> <span class="pre">8</span> <span class="pre">caracteres</span></code>), o use <code class="docutils literal notranslate"><span class="pre">scripts/Lindent</span></code>, que indenta
con ese estilo.</p>
<p><code class="docutils literal notranslate"><span class="pre">indent</span></code> tiene muchas opciones, y especialmente cuando se trata de
comentar reformateos, es posible que desee echar un vistazo a la página del
manual. Pero recuerde: <code class="docutils literal notranslate"><span class="pre">indent</span></code> no es la solución para una mala
programación.</p>
<p>Tenga en cuenta que también puede usar la herramienta <code class="docutils literal notranslate"><span class="pre">clang-format</span></code> para
ayudarlo con estas reglas, para volver a formatear rápidamente partes de su
código automáticamente, y revisar archivos completos para detectar errores
de estilo del código, errores tipográficos y posibles mejoras. También es
útil para ordenar <code class="docutils literal notranslate"><span class="pre">#includes</span></code>, para alinear variables/macros, para
redistribuir texto y otras tareas similares. Vea el archivo
<a class="reference internal" href="../../../process/clang-format.html#clangformat"><span class="std std-ref">Documentation/process/clang-format.rst</span></a> para más
detalles.</p>
</section>
<section id="archivos-de-configuracion-de-kconfig">
<h2>10) Archivos de configuración de Kconfig<a class="headerlink" href="#archivos-de-configuracion-de-kconfig" title="Permalink to this headline">¶</a></h2>
<p>Para todos los archivos de configuración de Kconfig* en todo el árbol
fuente, la sangría es algo diferente. Las líneas bajo una definición
<code class="docutils literal notranslate"><span class="pre">config</span></code> están indentadas con una tabulación, mientras que el texto de
ayuda tiene una sangría adicional de dos espacios. Ejemplo:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>config AUDIT
      bool &quot;Soporte para auditar&quot;
      depends on NET
      help
        Habilita la infraestructura de auditoría que se puede usar con otro
        subsistema kernel, como SELinux (que requiere esto para
        registro de salida de mensajes avc). No hace auditoría de llamadas al
  sistema sin CONFIG_AUDITSYSCALL.
</pre></div>
</div>
<p>Características seriamente peligrosas (como soporte de escritura para
ciertos filesystems) deben anunciar esto de forma destacada en su cadena de
solicitud:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>config ADFS_FS_RW
      bool &quot;ADFS write support (DANGEROUS)&quot;
      depends on ADFS_FS
      ...
</pre></div>
</div>
<p>Para obtener la documentación completa sobre los archivos de configuración,
consulte el archivo <a class="reference internal" href="../../../kbuild/kconfig-language.html"><span class="doc">Kconfig Language</span></a>.</p>
</section>
<section id="estructuras-de-datos">
<h2>11) Estructuras de datos<a class="headerlink" href="#estructuras-de-datos" title="Permalink to this headline">¶</a></h2>
<p>Las estructuras de datos que tienen visibilidad fuera del contexto de un
solo subproceso en el que son creadas y destruidas, siempre debe tener
contadores de referencia. En el kernel, la recolección de basura no existe
(y fuera, la recolección de basura del kernel es lenta e ineficiente), lo
que significa que absolutamente <strong>tiene</strong> para hacer referencia y contar
todos sus usos.</p>
<p>El conteo de referencias significa que puede evitar el bloqueo y permite
que múltiples usuarios tengan acceso a la estructura de datos en paralelo -
y no tengan que preocuparse de que la estructura, de repente, desaparezca
debajo de su control, solo porque durmieron o hicieron otra cosa por un
tiempo.</p>
<p>Tenga en cuenta que el bloqueo <strong>no</strong> reemplaza el recuento de referencia.
El bloqueo se utiliza para mantener la coherencia de las estructuras de
datos, mientras que la referencia y contar es una técnica de gestión de
memoria. Por lo general, ambos son necesarios, y no deben confundirse entre
sí.</p>
<p>De hecho, muchas estructuras de datos pueden tener dos niveles de conteo de
referencias, cuando hay usuarios de diferentes <code class="docutils literal notranslate"><span class="pre">clases</span></code>. El conteo de
subclases cuenta el número de usuarios de la subclase y disminuye el conteo
global solo una vez, cuando el recuento de subclases llega a cero.</p>
<p>Se pueden encontrar ejemplos de este tipo de <code class="docutils literal notranslate"><span class="pre">recuento</span> <span class="pre">de</span> <span class="pre">referencias</span> <span class="pre">de</span>
<span class="pre">niveles</span> <span class="pre">múltiples</span></code> en la gestión de memoria (<code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">mm_struct</span></code>:
mm_users y mm_count), y en código del sistema de archivos
(<code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">super_block</span></code>: s_count y s_active).</p>
<p>Recuerde: si otro hilo puede encontrar su estructura de datos y usted no
tiene un recuento de referencias, es casi seguro que tiene un error.</p>
</section>
<section id="macros-enums-y-rtl">
<h2>12) Macros, Enums y RTL<a class="headerlink" href="#macros-enums-y-rtl" title="Permalink to this headline">¶</a></h2>
<p>Los nombres de macros que definen constantes y etiquetas en enumeraciones
(enums) están en mayúsculas.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#define CONSTANTE 0x12345</span>
</pre></div>
</div>
<p>Se prefieren los enums cuando se definen varias constantes relacionadas.</p>
<p>Se aprecian los nombres de macro en MAYÚSCULAS, pero las macros que se
asemejan a funciones puede ser nombradas en minúscula.</p>
<p>Generalmente, las funciones en línea son preferibles a las macros que se
asemejan a funciones.</p>
<p>Las macros con varias instrucciones deben contenerse en un bloque do-while:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#define macrofun(a, b, c)                       \</span>
<span class="cp">        do {                                    \</span>
<span class="cp">                if (a == 5)                     \</span>
<span class="cp">                        haz_esto(b, c);         \</span>
<span class="cp">        } while (0)</span>
</pre></div>
</div>
<p>Cosas a evitar al usar macros:</p>
<ol class="arabic simple">
<li><p>macros que afectan el flujo de control:</p></li>
</ol>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#define FOO(x)                                  \</span>
<span class="cp">        do {                                    \</span>
<span class="cp">                if (blah(x) &lt; 0)                \</span>
<span class="cp">                        return -EBUGGERED;      \</span>
<span class="cp">        } while (0)</span>
</pre></div>
</div>
<p>es una <strong>muy</strong> mala idea. Parece una llamada de función pero sale de la
función de <code class="docutils literal notranslate"><span class="pre">llamada</span></code>; no rompa los analizadores internos de aquellos que
leerán el código.</p>
<ol class="arabic simple" start="2">
<li><p>macros que dependen de tener una variable local con un nombre mágico:</p></li>
</ol>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#define FOO(val) bar(index, val)</span>
</pre></div>
</div>
<p>puede parecer algo bueno, pero es confuso como el infierno cuando uno lee
el código, y es propenso a romperse por cambios aparentemente inocentes.</p>
<p>3) macros con argumentos que se usan como valores l: FOO(x) = y; le van
a morder si alguien, por ejemplo, convierte FOO en una función en línea.</p>
<p>4) olvidarse de la precedencia: las macros que definen constantes usando
expresiones deben encerrar la expresión entre paréntesis. Tenga cuidado con
problemas similares con macros usando parámetros.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#define CONSTANTE 0x4000</span>
<span class="cp">#define CONSTEXP (CONSTANTE | 3)</span>
</pre></div>
</div>
<p>5) colisiones de espacio de nombres (“namespace”) al definir variables
locales en macros que se asemejan a funciones:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#define FOO(x)                          \</span>
<span class="cp">({                                      \</span>
<span class="cp">        typeof(x) ret;                  \</span>
<span class="cp">        ret = calc_ret(x);              \</span>
<span class="cp">        (ret);                          \</span>
<span class="cp">})</span>
</pre></div>
</div>
<p>ret es un nombre común para una variable local -es menos probable que
__foo_ret colisione (coincida) con una variable existente.</p>
<p>El manual de cpp trata las macros de forma exhaustiva. El manual interno de
gcc también cubre RTL, que se usa frecuentemente con lenguaje ensamblador
en el kernel.</p>
</section>
<section id="imprimir-mensajes-del-kernel">
<h2>13) Imprimir mensajes del kernel<a class="headerlink" href="#imprimir-mensajes-del-kernel" title="Permalink to this headline">¶</a></h2>
<p>A los desarrolladores del kernel les gusta ser vistos como alfabetizados.
Cuide la ortografía de los mensajes del kernel para causar una buena
impresión. No utilice contracciones incorrectas como <code class="docutils literal notranslate"><span class="pre">dont</span></code>; use
<code class="docutils literal notranslate"><span class="pre">do</span> <span class="pre">not</span></code> o <code class="docutils literal notranslate"><span class="pre">don't</span></code> en su lugar. Haga sus mensajes concisos, claros e
inequívocos.</p>
<p>Los mensajes del kernel no tienen que terminar con un punto.</p>
<p>Imprimir números entre paréntesis (%d) no agrega valor y debe evitarse.</p>
<p>Hay varias modelos de macros de diagnóstico de driver en &lt;linux/dev_printk.h&gt;
que debe usar para asegurarse de que los mensajes coincidan con el
dispositivo correcto y driver, y están etiquetados con el nivel correcto:
dev_err(), dev_warn(), dev_info(), y así sucesivamente. Para mensajes que
no están asociados con un dispositivo particular, &lt;linux/printk.h&gt; define
<a class="reference internal" href="../../../core-api/printk-basics.html#c.pr_notice" title="pr_notice"><code class="xref c c-func docutils literal notranslate"><span class="pre">pr_notice()</span></code></a>, <a class="reference internal" href="../../../core-api/printk-basics.html#c.pr_info" title="pr_info"><code class="xref c c-func docutils literal notranslate"><span class="pre">pr_info()</span></code></a>, <a class="reference internal" href="../../../core-api/printk-basics.html#c.pr_warn" title="pr_warn"><code class="xref c c-func docutils literal notranslate"><span class="pre">pr_warn()</span></code></a>, <a class="reference internal" href="../../../core-api/printk-basics.html#c.pr_err" title="pr_err"><code class="xref c c-func docutils literal notranslate"><span class="pre">pr_err()</span></code></a>, etc.</p>
<p>Crear buenos mensajes de depuración puede ser todo un desafío; y una vez
los tiene, pueden ser de gran ayuda para la resolución remota de problemas.
Sin embargo, la impresión de mensajes de depuración se maneja de manera
diferente a la impresión de otros mensajes que no son de depuración.
Mientras que las otras funciones pr_XXX() se imprimen incondicionalmente,
<a class="reference internal" href="../../../core-api/printk-basics.html#c.pr_debug" title="pr_debug"><code class="xref c c-func docutils literal notranslate"><span class="pre">pr_debug()</span></code></a> no lo hace; se compila fuera por defecto, a menos que DEBUG sea
definido o se establezca CONFIG_DYNAMIC_DEBUG. Eso es cierto para dev_dbg()
también, y una convención relacionada usa VERBOSE_DEBUG para agregar
mensajes dev_vdbg() a los ya habilitados por DEBUG.</p>
<p>Muchos subsistemas tienen opciones de depuración de Kconfig para activar
-DDEBUG en el Makefile correspondiente; en otros casos, los archivos
usan #define DEBUG. Y cuando un mensaje de depuración debe imprimirse
incondicionalmente, por ejemplo si es ya dentro de una sección #ifdef
relacionada con la depuración, printk(KERN_DEBUG …) puede ser usado.</p>
</section>
<section id="reservando-memoria">
<h2>14) Reservando memoria<a class="headerlink" href="#reservando-memoria" title="Permalink to this headline">¶</a></h2>
<p>El kernel proporciona los siguientes asignadores de memoria de propósito
general: <a class="reference internal" href="../../../core-api/mm-api.html#c.kmalloc" title="kmalloc"><code class="xref c c-func docutils literal notranslate"><span class="pre">kmalloc()</span></code></a>, <a class="reference internal" href="../../../core-api/mm-api.html#c.kzalloc" title="kzalloc"><code class="xref c c-func docutils literal notranslate"><span class="pre">kzalloc()</span></code></a>, <a class="reference internal" href="../../../core-api/mm-api.html#c.kmalloc_array" title="kmalloc_array"><code class="xref c c-func docutils literal notranslate"><span class="pre">kmalloc_array()</span></code></a>, <a class="reference internal" href="../../../core-api/mm-api.html#c.kcalloc" title="kcalloc"><code class="xref c c-func docutils literal notranslate"><span class="pre">kcalloc()</span></code></a>, <a class="reference internal" href="../../../core-api/mm-api.html#c.vmalloc" title="vmalloc"><code class="xref c c-func docutils literal notranslate"><span class="pre">vmalloc()</span></code></a> y
<a class="reference internal" href="../../../core-api/mm-api.html#c.vzalloc" title="vzalloc"><code class="xref c c-func docutils literal notranslate"><span class="pre">vzalloc()</span></code></a>. Consulte la documentación de la API para obtener más información.
a cerca de ellos. <a class="reference internal" href="../../../core-api/memory-allocation.html#memory-allocation"><span class="std std-ref">Documentation/core-api/memory-allocation.rst</span></a></p>
<p>La forma preferida para pasar el tamaño de una estructura es la siguiente:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">),</span><span class="w"> </span><span class="p">...);</span><span class="w"></span>
</pre></div>
</div>
<p>La forma alternativa donde se deletrea el nombre de la estructura perjudica
la legibilidad, y presenta una oportunidad para un error cuando se cambia
el tipo de variable de puntero, pero el tamaño correspondiente de eso que
se pasa a un asignador de memoria no.</p>
<p>Convertir el valor devuelto, que es un puntero vacío, es redundante. La
conversión desde el puntero vacío a cualquier otro tipo de puntero está
garantizado por la programación en idioma C.</p>
<p>La forma preferida para asignar una matriz es la siguiente:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kmalloc_array</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(...),</span><span class="w"> </span><span class="p">...);</span><span class="w"></span>
</pre></div>
</div>
<p>La forma preferida para asignar una matriz a cero es la siguiente:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kcalloc</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(...),</span><span class="w"> </span><span class="p">...);</span><span class="w"></span>
</pre></div>
</div>
<p>Ambos casos verifican el desbordamiento en el tamaño de asignación n *
sizeof (…), y devuelven NULL si esto ocurrió.</p>
<p>Todas estas funciones de asignación genéricas emiten un volcado de pila
(” stack dump”) en caso de fallo cuando se usan sin __GFP_NOWARN, por lo
que no sirve de nada emitir un mensaje de fallo adicional cuando se
devuelva NULL.</p>
</section>
<section id="la-enfermedad-de-inline">
<h2>15) La enfermedad de inline<a class="headerlink" href="#la-enfermedad-de-inline" title="Permalink to this headline">¶</a></h2>
<p>Parece haber una común percepción errónea de que gcc tiene una magica
opción “hazme más rápido” de aceleración, llamada <code class="docutils literal notranslate"><span class="pre">inline</span></code> (en línea).
Mientras que el uso de inlines puede ser apropiado (por ejemplo, como un
medio para reemplazar macros, consulte el Capítulo 12), muy a menudo no lo
es. El uso abundante de la palabra clave inline conduce a una mayor kernel,
que a su vez ralentiza el sistema en su conjunto, debido a una mayor huella
de icache para la CPU, y sencillamente porque hay menos memoria disponible
para el pagecache. Solo piense en esto; un fallo en la memoria caché de la
página provoca una búsqueda de disco, que tarda fácilmente 5 milisegundos.
Hay MUCHOS ciclos de CPU que puede entrar en estos 5 milisegundos.</p>
<p>Una razonable regla general es no poner funciones inline que tengan más de
3 líneas de código en ellas. Una excepción a esta regla son los casos en
que se sabe que un parámetro es una constante en tiempo de compilación, y
como resultado de esto, usted <em>sabe</em>, el compilador podrá optimizar la
mayor parte de su función en tiempo de compilación. Para un buen ejemplo de
este último caso, véase la función en línea <a class="reference internal" href="../../../core-api/mm-api.html#c.kmalloc" title="kmalloc"><code class="xref c c-func docutils literal notranslate"><span class="pre">kmalloc()</span></code></a>.</p>
<p>A menudo, la gente argumenta que agregar funciones en línea que son
estáticas y se usan solo una vez, es siempre una victoria ya que no hay
perdida de espacio. Mientras esto es técnicamente correcto, gcc es capaz de
incorporarlos automáticamente sin ayuda, y esta el problema de
mantenimiento de eliminar el inline, cuando un segundo usuario supera el
valor potencial de la pista que le dice a gcc que haga algo que habría
hecho de todos modos.</p>
</section>
<section id="valores-devueltos-por-funcion-y-sus-nombres">
<h2>16) Valores devueltos por función y sus nombres<a class="headerlink" href="#valores-devueltos-por-funcion-y-sus-nombres" title="Permalink to this headline">¶</a></h2>
<p>Las funciones pueden devolver valores de muchos tipos diferentes, y uno de
lo más común es un valor que indica si la función tuvo éxito o ha fallado.
Dicho valor se puede representar como un número entero de código de error
(-Exxx = falla, 0 = éxito) o un booleano <code class="docutils literal notranslate"><span class="pre">con</span> <span class="pre">éxito</span></code> (0 = falla, distinto
de cero = éxito).</p>
<p>La mezcla de estos dos tipos de representaciones es una fuente fértil de
errores difíciles de encontrar. Si el lenguaje C incluyera una fuerte
distinción entre enteros y booleanos, el compilador encontraría estos
errores por nosotros… pero no lo hace. Para ayudar a prevenir tales
errores, siga siempre esta convención:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Si el nombre de una función es una acción o un comando imperativo,
la función debe devolver un número entero de código de error. si el nombre
es un predicado, la función debe devolver un valor booleano &quot;exitoso&quot;.
</pre></div>
</div>
<p>Por ejemplo, <code class="docutils literal notranslate"><span class="pre">agregar</span> <span class="pre">trabajo</span></code> es un comando, y la función
agregar_trabajo() devuelve 0 en caso de éxito o -EBUSY en caso de fracaso.
De la misma manera, <code class="docutils literal notranslate"><span class="pre">dispositivo</span> <span class="pre">PCI</span> <span class="pre">presente</span></code> es un predicado, y la
función <a class="reference internal" href="../../../driver-api/pci/pci.html#c.pci_dev_present" title="pci_dev_present"><code class="xref c c-func docutils literal notranslate"><span class="pre">pci_dev_present()</span></code></a> devuelve 1 si tiene éxito en encontrar un
dispositivo coincidente o 0 si no es así.</p>
<p>Todas las funciones EXPORTed (exportadas) deben respetar esta convención,
al igual que todas las funciones publicas. Las funciones privadas
(estáticas) no lo necesitan, pero es recomendado que lo hagan.</p>
<p>Las funciones cuyo valor devuelto es el resultado real de un cálculo, en
lugar de una indicación de si el cómputo tuvo éxito, no están sujetas a
esta regla. Generalmente indican fallo al devolver valores fuera del rango
de resultados. Los ejemplos típicos serían funciones que devuelven
punteros; estos usan NULL o el mecanismo ERR_PTR para informar de fallos.</p>
</section>
<section id="usando-bool">
<h2>17) Usando bool<a class="headerlink" href="#usando-bool" title="Permalink to this headline">¶</a></h2>
<p>El tipo bool del kernel Linux es un alias para el tipo C99 _Bool. Los
valores booleanos pueden solo evaluar a 0 o 1, y la conversión implícita o
explícita a bool convierte automáticamente el valor en verdadero o falso.
Cuando se utilizan tipos booleanos,
!! no se necesita construcción, lo que elimina una clase de errores.</p>
<p>Cuando se trabaja con valores booleanos, se deben usar las definiciones
verdadera y falsa, en lugar de 1 y 0.</p>
<p>Los tipos de devolución de función bool y las variables de pila siempre
se pueden usar cuando esto sea adecuado. Se recomienda el uso de bool para
mejorar la legibilidad y, a menudo, es una mejor opción que ‘int’ para
almacenar valores booleanos.</p>
<p>No use bool si el diseño de la línea de caché o el tamaño del valor son
importantes, ya que su tamaño y la alineación varía según la arquitectura
compilada. Las estructuras que son optimizadas para la alineación y el
tamaño no debe usar bool.</p>
<p>Si una estructura tiene muchos valores verdadero/falso, considere
consolidarlos en un bitfield con miembros de 1 bit, o usando un tipo de
ancho fijo apropiado, como u8.</p>
<p>De manera similar, para los argumentos de función, se pueden consolidar
muchos valores verdaderos/falsos en un solo argumento bit a bit ‘flags’ y
‘flags’ a menudo, puede ser una alternativa de argumento más legible si los
sitios de llamada tienen constantes desnudas de tipo verdaderas/falsas.</p>
<p>De lo contrario, el uso limitado de bool en estructuras y argumentos puede
mejorar la legibilidad.</p>
</section>
<section id="no-reinvente-las-macros-del-kernel">
<h2>18) No reinvente las macros del kernel<a class="headerlink" href="#no-reinvente-las-macros-del-kernel" title="Permalink to this headline">¶</a></h2>
<p>El archivo de cabecera include/linux/kernel.h contiene una serie de macros
que debe usar, en lugar de programar explícitamente alguna variante de
estos por usted mismo. Por ejemplo, si necesita calcular la longitud de una
matriz, aproveche la macro</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#define ARRAY_SIZE(x) (sizeof(x) / sizeof((x)[0]))</span>
</pre></div>
</div>
<p>De manera similar, si necesita calcular el tamaño de algún miembro de la
estructura, use</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#define sizeof_field(t, f) (sizeof(((t*)0)-&gt;f))</span>
</pre></div>
</div>
<p>También hay macros min() y max() que realizan una verificación estricta de
tipos si lo necesita. Siéntase libre de leer detenidamente ese archivo de
encabezado para ver qué más ya está definido y que no debe reproducir en su
código.</p>
</section>
<section id="editores-modeline-y-otros-desastres">
<h2>19) Editores modeline y otros desastres<a class="headerlink" href="#editores-modeline-y-otros-desastres" title="Permalink to this headline">¶</a></h2>
<p>Algunos editores pueden interpretar la información de configuración
incrustada en los archivos fuente, indicado con marcadores especiales. Por
ejemplo, emacs interpreta las líneas marcadas como esto:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="o">-*-</span><span class="w"> </span><span class="nl">mode</span><span class="p">:</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">-*-</span><span class="w"></span>
</pre></div>
</div>
<p>O así:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cm">/*</span>
<span class="cm">Local Variables:</span>
<span class="cm">compile-command: &quot;gcc -DMAGIC_DEBUG_FLAG foo.c&quot;</span>
<span class="cm">End:</span>
<span class="cm">*/</span><span class="w"></span>
</pre></div>
</div>
<p>Vim interpreta los marcadores que se ven así:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cm">/* vim:set sw=8 noet */</span><span class="w"></span>
</pre></div>
</div>
<p>No incluya ninguno de estos en los archivos fuente. La gente tiene sus
propias configuraciones del editor, y sus archivos de origen no deben
anularlos. Esto incluye marcadores para sangría y configuración de modo.
La gente puede usar su propio modo personalizado, o puede tener algún otro
método mágico para que la sangría funcione correctamente.</p>
</section>
<section id="ensamblador-inline">
<h2>20) Ensamblador inline<a class="headerlink" href="#ensamblador-inline" title="Permalink to this headline">¶</a></h2>
<p>En el código específico de arquitectura, es posible que deba usar
ensamblador en línea para interactuar con funcionalidades de CPU o
plataforma. No dude en hacerlo cuando sea necesario. Sin embargo, no use
ensamblador en línea de forma gratuita cuando C puede hacer el trabajo.
Puede y debe empujar el hardware desde C cuando sea posible.</p>
<p>Considere escribir funciones auxiliares simples que envuelvan bits comunes
de ensamblador, en lugar de escribirlos repetidamente con ligeras
variaciones. Recuerde que el ensamblador en línea puede usar parámetros C.</p>
<p>Las funciones de ensamblador grandes y no triviales deben ir en archivos .S,
con su correspondientes prototipos de C definidos en archivos de encabezado
en C. Los prototipos de C para el ensamblador deben usar <code class="docutils literal notranslate"><span class="pre">asmlinkage</span></code>.</p>
<p>Es posible que deba marcar su declaración asm como volátil, para evitar que
GCC la elimine si GCC no nota ningún efecto secundario. No siempre es
necesario hacerlo, sin embargo, y hacerlo innecesariamente puede limitar la
optimización.</p>
<p>Al escribir una sola declaración de ensamblador en línea que contiene
múltiples instrucciones, ponga cada instrucción en una línea separada en
una string separada, y termine cada string excepto la última con <code class="docutils literal notranslate"><span class="pre">\n\t</span></code>
para indentar correctamente la siguiente instrucción en la salida en
ensamblador:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">asm</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;magic %reg1, #42</span><span class="se">\n\t</span><span class="s">&quot;</span><span class="w"></span>
<span class="w">     </span><span class="s">&quot;more_magic %reg2, %reg3&quot;</span><span class="w"></span>
<span class="w">     </span><span class="o">:</span><span class="w"> </span><span class="cm">/* outputs */</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="cm">/* inputs */</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="cm">/* clobbers */</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="compilacion-condicional">
<h2>21) Compilación condicional<a class="headerlink" href="#compilacion-condicional" title="Permalink to this headline">¶</a></h2>
<p>Siempre que sea posible, no use condicionales de preprocesador (#if,
#ifdef) en archivos .c; de lo contrario, el código es más difícil de leer y
la lógica más difícil de seguir. En cambio, use dichos condicionales en un
archivo de encabezado que defina funciones para usar en esos archivos .c,
proporcionando versiones de código auxiliar sin operación en el caso #else,
y luego llame a estas funciones incondicionalmente desde archivos .c. El
compilador evitará generar cualquier código para las llamadas restantes,
produciendo resultados idénticos, pero la lógica es fácil de seguir.</p>
<p>Prefiera compilar funciones completas, en lugar de porciones de funciones o
porciones de expresiones. En lugar de poner un ifdef en una expresión,
divida la totalidad de la expresión con una función de ayuda independiente
y aplique el condicional a esa función.</p>
<p>Si tiene una función o variable que puede potencialmente quedar sin usar en
una configuración en particular, y el compilador advertiría sobre su
definición sin usar, marque la definición como __maybe_unused en lugar de
envolverla en un preprocesador condicional. (Sin embargo, si una función o
variable <em>siempre</em> acaba sin ser usada, bórrela.)</p>
<p>Dentro del código, cuando sea posible, use la macro IS_ENABLED para
convertir un símbolo Kconfig en una expresión booleana de C, y utilícelo en
un condicional de C normal:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">IS_ENABLED</span><span class="p">(</span><span class="n">CONFIG_SOMETHING</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="p">...</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>El compilador “doblará”” constantemente el condicional e incluirá o
excluirá el bloque de código al igual que con un #ifdef, por lo que esto no
agregará ningún tiempo de gastos generales en ejecución. Sin embargo, este
enfoque todavía permite que el compilador de C vea el código dentro del
bloque, y verifique que sea correcto (sintaxis, tipos, símbolo, referencias,
etc.). Por lo tanto, aún debe usar un #ifdef si el código dentro del bloque
hace referencia a símbolos que no existirán si no se cumple la condición.</p>
<p>Al final de cualquier bloque #if o #ifdef no trivial (más de unas pocas
líneas), incluya un comentario después de #endif en la misma línea,
anotando la expresión condicional utilizada. Por ejemplo:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#ifdef CONFIG_SOMETHING</span>
<span class="p">...</span><span class="w"></span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_SOMETHING */</span><span class="cp"></span>
</pre></div>
</div>
</section>
<section id="no-rompa-el-kernel">
<h2>22) No rompa el kernel<a class="headerlink" href="#no-rompa-el-kernel" title="Permalink to this headline">¶</a></h2>
<p>En general, la decisión de romper el kernel pertenece al usuario, más que
al desarrollador del kernel.</p>
<section id="evite-el-panic">
<h3>Evite el panic()<a class="headerlink" href="#evite-el-panic" title="Permalink to this headline">¶</a></h3>
<p><a class="reference internal" href="../../../driver-api/basics.html#c.panic" title="panic"><code class="xref c c-func docutils literal notranslate"><span class="pre">panic()</span></code></a> debe usarse con cuidado y principalmente solo durante el arranque
del sistema. <a class="reference internal" href="../../../driver-api/basics.html#c.panic" title="panic"><code class="xref c c-func docutils literal notranslate"><span class="pre">panic()</span></code></a> es, por ejemplo, aceptable cuando se queda sin memoria
durante el arranque y no puede continuar.</p>
</section>
<section id="use-warn-en-lugar-de-bug">
<h3>Use WARN() en lugar de BUG()<a class="headerlink" href="#use-warn-en-lugar-de-bug" title="Permalink to this headline">¶</a></h3>
<p>No agregue código nuevo que use cualquiera de las variantes BUG(), como
BUG(), BUG_ON() o VM_BUG_ON(). En su lugar, use una variante WARN*(),
preferiblemente WARN_ON_ONCE(), y posiblemente con código de recuperación.
El código de recuperación no es requerido si no hay una forma razonable de
recuperar, al menos parcialmente.</p>
<p>“Soy demasiado perezoso para tener en cuenta los errores” no es una excusa
para usar BUG(). Importantes corrupciones internas sin forma de continuar
aún pueden usar BUG(), pero necesitan una buena justificación.</p>
</section>
<section id="use-warn-on-once-en-lugar-de-warn-o-warn-on">
<h3>Use WARN_ON_ONCE() en lugar de WARN() o WARN_ON()<a class="headerlink" href="#use-warn-on-once-en-lugar-de-warn-o-warn-on" title="Permalink to this headline">¶</a></h3>
<p>Generalmente, se prefiere WARN_ON_ONCE() a WARN() o WARN_ON(), porque es
común que una condición de advertencia dada, si ocurre, ocurra varias
veces. Esto puede llenar el registro del kernel, e incluso puede ralentizar
el sistema lo suficiente como para que el registro excesivo se convierta en
su propio, adicional problema.</p>
</section>
<section id="no-haga-warn-a-la-ligera">
<h3>No haga WARN a la ligera<a class="headerlink" href="#no-haga-warn-a-la-ligera" title="Permalink to this headline">¶</a></h3>
<p>WARN*() está diseñado para situaciones inesperadas que nunca deberían
suceder. Las macros WARN*() no deben usarse para nada que se espera que
suceda durante un funcionamiento normal. No hay “checkeos” previos o
posteriores a la condición, por ejemplo. De nuevo: WARN*() no debe usarse
para una condición esperada que vaya a activarse fácilmente, por ejemplo,
mediante acciones en el espacio del usuario. pr_warn_once() es una
alternativa posible, si necesita notificar al usuario de un problema.</p>
</section>
<section id="no-se-preocupe-sobre-panic-on-warn-de-usuarios">
<h3>No se preocupe sobre panic_on_warn de usuarios<a class="headerlink" href="#no-se-preocupe-sobre-panic-on-warn-de-usuarios" title="Permalink to this headline">¶</a></h3>
<p>Algunas palabras más sobre panic_on_warn: Recuerde que <code class="docutils literal notranslate"><span class="pre">panic_on_warn</span></code> es
una opción disponible del kernel, y que muchos usuarios configuran esta
opción. Esta es la razón por la que hay un artículo de “No haga WARN a la
ligera”, arriba. Sin embargo, la existencia de panic_on_warn de usuarios no
es una razón válida para evitar el uso juicioso de WARN*(). Esto se debe a
que quien habilita panic_on_warn, explícitamente pidió al kernel que
fallara si se dispara un WARN*(), y tales usuarios deben estar preparados
para afrontar las consecuencias de un sistema que es algo más probable que
se rompa.</p>
</section>
<section id="use-build-bug-on-para-aserciones-en-tiempo-de-compilacion">
<h3>Use BUILD_BUG_ON() para aserciones en tiempo de compilación<a class="headerlink" href="#use-build-bug-on-para-aserciones-en-tiempo-de-compilacion" title="Permalink to this headline">¶</a></h3>
<p>El uso de BUILD_BUG_ON() es aceptable y recomendado, porque es una aserción
en tiempo de compilación, que no tiene efecto en tiempo de ejecución.</p>
</section>
</section>
<section id="apendice-i-referencias">
<h2>Apéndice I) Referencias<a class="headerlink" href="#apendice-i-referencias" title="Permalink to this headline">¶</a></h2>
<p>The C Programming Language, Segunda edicion
por Brian W. Kernighan and Dennis M. Ritchie.
Prentice Hall, Inc., 1988.
ISBN 0-13-110362-8 (paperback), 0-13-110370-9 (hardback).</p>
<p>The Practice of Programming
por Brian W. Kernighan and Rob Pike.
Addison-Wesley, Inc., 1999.
ISBN 0-201-61586-X.</p>
<p>manuales GCC - en cumplimiento con K&amp;R y este texto - para cpp, gcc,
detalles de gcc y sangría, todo disponible en <a class="reference external" href="https://www.gnu.org/manual/">https://www.gnu.org/manual/</a></p>
<p>WG14 es el grupo de trabajo de estandarización internacional de la
programación en lenguaje C, URL: <a class="reference external" href="http://www.open-std.org/JTC1/SC22/WG14/">http://www.open-std.org/JTC1/SC22/WG14/</a></p>
<p><a class="reference internal" href="../../../process/coding-style.html#codingstyle"><span class="std std-ref">process/coding-style.rst</span></a> del kernel, por <a class="reference external" href="mailto:greg&#37;&#52;&#48;kroah&#46;com">greg<span>&#64;</span>kroah<span>&#46;</span>com</a> at OLS 2002:
<a class="reference external" href="http://www.kroah.com/linux/talks/ols_2002_kernel_codingstyle_talk/html/">http://www.kroah.com/linux/talks/ols_2002_kernel_codingstyle_talk/html/</a></p>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../index.html">The Linux Kernel</a></h1>



<p class="blurb">6.2.0-rc4-6.2.0-rc4+</p>







<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
  <h3><a href="../../../index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Estilo en el código del kernel Linux</a><ul>
<li><a class="reference internal" href="#sangria">1) Sangría</a></li>
<li><a class="reference internal" href="#rompiendo-lineas-y-strings-largos">2) Rompiendo líneas y strings largos</a></li>
<li><a class="reference internal" href="#colocacion-de-llaves-y-espacios">3) Colocación de llaves y espacios</a><ul>
<li><a class="reference internal" href="#espacios">3.1) Espacios</a></li>
</ul>
</li>
<li><a class="reference internal" href="#nomenclatura">4) Nomenclatura</a></li>
<li><a class="reference internal" href="#typedefs">5) Typedefs</a></li>
<li><a class="reference internal" href="#funciones">6) Funciones</a><ul>
<li><a class="reference internal" href="#prototipos-de-funciones">6.1) Prototipos de funciones</a></li>
</ul>
</li>
<li><a class="reference internal" href="#salida-centralizada-de-funciones">7) Salida centralizada de funciones</a></li>
<li><a class="reference internal" href="#comentarios">8) Comentarios</a></li>
<li><a class="reference internal" href="#has-hecho-un-desastre">9) Has hecho un desastre</a></li>
<li><a class="reference internal" href="#archivos-de-configuracion-de-kconfig">10) Archivos de configuración de Kconfig</a></li>
<li><a class="reference internal" href="#estructuras-de-datos">11) Estructuras de datos</a></li>
<li><a class="reference internal" href="#macros-enums-y-rtl">12) Macros, Enums y RTL</a></li>
<li><a class="reference internal" href="#imprimir-mensajes-del-kernel">13) Imprimir mensajes del kernel</a></li>
<li><a class="reference internal" href="#reservando-memoria">14) Reservando memoria</a></li>
<li><a class="reference internal" href="#la-enfermedad-de-inline">15) La enfermedad de inline</a></li>
<li><a class="reference internal" href="#valores-devueltos-por-funcion-y-sus-nombres">16) Valores devueltos por función y sus nombres</a></li>
<li><a class="reference internal" href="#usando-bool">17) Usando bool</a></li>
<li><a class="reference internal" href="#no-reinvente-las-macros-del-kernel">18) No reinvente las macros del kernel</a></li>
<li><a class="reference internal" href="#editores-modeline-y-otros-desastres">19) Editores modeline y otros desastres</a></li>
<li><a class="reference internal" href="#ensamblador-inline">20) Ensamblador inline</a></li>
<li><a class="reference internal" href="#compilacion-condicional">21) Compilación condicional</a></li>
<li><a class="reference internal" href="#no-rompa-el-kernel">22) No rompa el kernel</a><ul>
<li><a class="reference internal" href="#evite-el-panic">Evite el panic()</a></li>
<li><a class="reference internal" href="#use-warn-en-lugar-de-bug">Use WARN() en lugar de BUG()</a></li>
<li><a class="reference internal" href="#use-warn-on-once-en-lugar-de-warn-o-warn-on">Use WARN_ON_ONCE() en lugar de WARN() o WARN_ON()</a></li>
<li><a class="reference internal" href="#no-haga-warn-a-la-ligera">No haga WARN a la ligera</a></li>
<li><a class="reference internal" href="#no-se-preocupe-sobre-panic-on-warn-de-usuarios">No se preocupe sobre panic_on_warn de usuarios</a></li>
<li><a class="reference internal" href="#use-build-bug-on-para-aserciones-en-tiempo-de-compilacion">Use BUILD_BUG_ON() para aserciones en tiempo de compilación</a></li>
</ul>
</li>
<li><a class="reference internal" href="#apendice-i-referencias">Apéndice I) Referencias</a></li>
</ul>
</li>
</ul>

  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../../../_sources/translations/sp_SP/process/coding-style.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;The kernel development community.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 2.4.4</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="../../../_sources/translations/sp_SP/process/coding-style.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>