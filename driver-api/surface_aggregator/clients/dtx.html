
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>User-Space DTX (Clipboard Detachment System) Interface &#8212; The Linux Kernel 6.2.0-rc4+ documentation</title>
    <link rel="stylesheet" href="../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <script id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="Surface ACPI Notify" href="san.html" />
    <link rel="prev" title="User-Space EC Interface (cdev)" href="cdev.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="user-space-dtx-clipboard-detachment-system-interface">
<h1><a class="toc-backref" href="#id13">User-Space DTX (Clipboard Detachment System) Interface</a><a class="headerlink" href="#user-space-dtx-clipboard-detachment-system-interface" title="Permalink to this headline">¶</a></h1>
<p>The <code class="docutils literal notranslate"><span class="pre">surface_dtx</span></code> driver is responsible for proper clipboard detachment
and re-attachment handling. To this end, it provides the <code class="docutils literal notranslate"><span class="pre">/dev/surface/dtx</span></code>
device file, through which it can interface with a user-space daemon. This
daemon is then ultimately responsible for determining and taking necessary
actions, such as unmounting devices attached to the base,
unloading/reloading the graphics-driver, user-notifications, etc.</p>
<p>There are two basic communication principles used in this driver: Commands
(in other parts of the documentation also referred to as requests) and
events. Commands are sent to the EC and may have a different implications in
different contexts. Events are sent by the EC upon some internal state
change. Commands are always driver-initiated, whereas events are always
initiated by the EC.</p>
<div class="contents topic" id="contents">
<p class="topic-title">Contents</p>
<ul class="simple">
<li><p><a class="reference internal" href="#user-space-dtx-clipboard-detachment-system-interface" id="id13">User-Space DTX (Clipboard Detachment System) Interface</a></p>
<ul>
<li><p><a class="reference internal" href="#nomenclature" id="id14">Nomenclature</a></p></li>
<li><p><a class="reference internal" href="#detachment-process" id="id15">Detachment Process</a></p>
<ul>
<li><p><a class="reference internal" href="#latch-states" id="id16">Latch States</a></p></li>
<li><p><a class="reference internal" href="#detachment-procedure" id="id17">Detachment Procedure</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#user-space-interface-documentation" id="id18">User-Space Interface Documentation</a></p>
<ul>
<li><p><a class="reference internal" href="#error-codes-and-status-values" id="id19">Error Codes and Status Values</a></p></li>
<li><p><a class="reference internal" href="#events" id="id20">Events</a></p>
<ul>
<li><p><a class="reference internal" href="#sdtx-event-request" id="id21"><code class="docutils literal notranslate"><span class="pre">SDTX_EVENT_REQUEST</span></code></a></p></li>
<li><p><a class="reference internal" href="#sdtx-event-cancel" id="id22"><code class="docutils literal notranslate"><span class="pre">SDTX_EVENT_CANCEL</span></code></a></p></li>
<li><p><a class="reference internal" href="#sdtx-event-base-connection" id="id23"><code class="docutils literal notranslate"><span class="pre">SDTX_EVENT_BASE_CONNECTION</span></code></a></p></li>
<li><p><a class="reference internal" href="#sdtx-event-latch-status" id="id24"><code class="docutils literal notranslate"><span class="pre">SDTX_EVENT_LATCH_STATUS</span></code></a></p></li>
<li><p><a class="reference internal" href="#sdtx-event-device-mode" id="id25"><code class="docutils literal notranslate"><span class="pre">SDTX_EVENT_DEVICE_MODE</span></code></a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#ioctls" id="id26">IOCTLs</a></p>
<ul>
<li><p><a class="reference internal" href="#sdtx-ioctl-events-enable" id="id27"><code class="docutils literal notranslate"><span class="pre">SDTX_IOCTL_EVENTS_ENABLE</span></code></a></p></li>
<li><p><a class="reference internal" href="#sdtx-ioctl-events-disable" id="id28"><code class="docutils literal notranslate"><span class="pre">SDTX_IOCTL_EVENTS_DISABLE</span></code></a></p></li>
<li><p><a class="reference internal" href="#sdtx-ioctl-latch-lock" id="id29"><code class="docutils literal notranslate"><span class="pre">SDTX_IOCTL_LATCH_LOCK</span></code></a></p></li>
<li><p><a class="reference internal" href="#sdtx-ioctl-latch-unlock" id="id30"><code class="docutils literal notranslate"><span class="pre">SDTX_IOCTL_LATCH_UNLOCK</span></code></a></p></li>
<li><p><a class="reference internal" href="#sdtx-ioctl-latch-request" id="id31"><code class="docutils literal notranslate"><span class="pre">SDTX_IOCTL_LATCH_REQUEST</span></code></a></p></li>
<li><p><a class="reference internal" href="#sdtx-ioctl-latch-confirm" id="id32"><code class="docutils literal notranslate"><span class="pre">SDTX_IOCTL_LATCH_CONFIRM</span></code></a></p></li>
<li><p><a class="reference internal" href="#sdtx-ioctl-latch-heartbeat" id="id33"><code class="docutils literal notranslate"><span class="pre">SDTX_IOCTL_LATCH_HEARTBEAT</span></code></a></p></li>
<li><p><a class="reference internal" href="#sdtx-ioctl-latch-cancel" id="id34"><code class="docutils literal notranslate"><span class="pre">SDTX_IOCTL_LATCH_CANCEL</span></code></a></p></li>
<li><p><a class="reference internal" href="#sdtx-ioctl-get-base-info" id="id35"><code class="docutils literal notranslate"><span class="pre">SDTX_IOCTL_GET_BASE_INFO</span></code></a></p></li>
<li><p><a class="reference internal" href="#sdtx-ioctl-get-device-mode" id="id36"><code class="docutils literal notranslate"><span class="pre">SDTX_IOCTL_GET_DEVICE_MODE</span></code></a></p></li>
<li><p><a class="reference internal" href="#sdtx-ioctl-get-latch-status" id="id37"><code class="docutils literal notranslate"><span class="pre">SDTX_IOCTL_GET_LATCH_STATUS</span></code></a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#a-note-on-base-ids" id="id38">A Note on Base IDs</a></p></li>
<li><p><a class="reference internal" href="#structures-and-enums" id="id39">Structures and Enums</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#api-users" id="id40">API Users</a></p></li>
</ul>
</li>
</ul>
</div>
<section id="nomenclature">
<h2><a class="toc-backref" href="#id14">Nomenclature</a><a class="headerlink" href="#nomenclature" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p><strong>Clipboard:</strong>
The detachable upper part of the Surface Book, housing the screen and CPU.</p></li>
<li><p><strong>Base:</strong>
The lower part of the Surface Book from which the clipboard can be
detached, optionally (model dependent) housing the discrete GPU (dGPU).</p></li>
<li><p><strong>Latch:</strong>
The mechanism keeping the clipboard attached to the base in normal
operation and allowing it to be detached when requested.</p></li>
<li><p><strong>Silently ignored commands:</strong>
The command is accepted by the EC as a valid command and acknowledged
(following the standard communication protocol), but the EC does not act
upon it, i.e. ignores it.e upper part of the</p></li>
</ul>
</section>
<section id="detachment-process">
<h2><a class="toc-backref" href="#id15">Detachment Process</a><a class="headerlink" href="#detachment-process" title="Permalink to this headline">¶</a></h2>
<p>Warning: This part of the documentation is based on reverse engineering and
testing and thus may contain errors or be incomplete.</p>
<section id="latch-states">
<h3><a class="toc-backref" href="#id16">Latch States</a><a class="headerlink" href="#latch-states" title="Permalink to this headline">¶</a></h3>
<p>The latch mechanism has two major states: <em>open</em> and <em>closed</em>. In the
<em>closed</em> state (default), the clipboard is secured to the base, whereas in
the <em>open</em> state, the clipboard can be removed by a user.</p>
<p>The latch can additionally be locked and, correspondingly, unlocked, which
can influence the detachment procedure. Specifically, this locking mechanism
is intended to prevent the dGPU, positioned in the base of the device, from
being hot-unplugged while in use. More details can be found in the
documentation for the detachment procedure below. By default, the latch is
unlocked.</p>
</section>
<section id="detachment-procedure">
<h3><a class="toc-backref" href="#id17">Detachment Procedure</a><a class="headerlink" href="#detachment-procedure" title="Permalink to this headline">¶</a></h3>
<p>Note that the detachment process is governed fully by the EC. The
<code class="docutils literal notranslate"><span class="pre">surface_dtx</span></code> driver only relays events from the EC to user-space and
commands from user-space to the EC, i.e. it does not influence this process.</p>
<p>The detachment process is started with the user pressing the <em>detach</em> button
on the base of the device or executing the <code class="docutils literal notranslate"><span class="pre">SDTX_IOCTL_LATCH_REQUEST</span></code> IOCTL.
Following that:</p>
<ol class="arabic simple">
<li><p>The EC turns on the indicator led on the detach-button, sends a
<em>detach-request</em> event (<code class="docutils literal notranslate"><span class="pre">SDTX_EVENT_REQUEST</span></code>), and awaits further
instructions/commands. In case the latch is unlocked, the led will flash
green. If the latch has been locked, the led will be solid red</p></li>
<li><p>The event is, via the <code class="docutils literal notranslate"><span class="pre">surface_dtx</span></code> driver, relayed to user-space, where
an appropriate user-space daemon can handle it and send instructions back
to the EC via IOCTLs provided by this driver.</p></li>
<li><p>The EC waits for instructions from user-space and acts according to them.
If the EC does not receive any instructions in a given period, it will
time out and continue as follows:</p>
<ul class="simple">
<li><p>If the latch is unlocked, the EC will open the latch and the clipboard
can be detached from the base. This is the exact behavior as without
this driver or any user-space daemon. See the <code class="docutils literal notranslate"><span class="pre">SDTX_IOCTL_LATCH_CONFIRM</span></code>
description below for more details on the follow-up behavior of the EC.</p></li>
<li><p>If the latch is locked, the EC will <em>not</em> open the latch, meaning the
clipboard cannot be detached from the base. Furthermore, the EC sends
an cancel event (<code class="docutils literal notranslate"><span class="pre">SDTX_EVENT_CANCEL</span></code>) detailing this with the cancel
reason <code class="docutils literal notranslate"><span class="pre">SDTX_DETACH_TIMEDOUT</span></code> (see <a class="reference internal" href="#events"><span class="std std-ref">Events</span></a> for details).</p></li>
</ul>
</li>
</ol>
<p>Valid responses by a user-space daemon to a detachment request event are:</p>
<ul>
<li><p>Execute <code class="docutils literal notranslate"><span class="pre">SDTX_IOCTL_LATCH_REQUEST</span></code>. This will immediately abort the
detachment process. Furthermore, the EC will send a detach-request event,
similar to the user pressing the detach-button to cancel said process (see
below).</p></li>
<li><p>Execute <code class="docutils literal notranslate"><span class="pre">SDTX_IOCTL_LATCH_CONFIRM</span></code>. This will cause the EC to open the
latch, after which the user can separate clipboard and base.</p>
<p>As this changes the latch state, a <em>latch-status</em> event
(<code class="docutils literal notranslate"><span class="pre">SDTX_EVENT_LATCH_STATUS</span></code>) will be sent once the latch has been opened
successfully. If the EC fails to open the latch, e.g. due to hardware
error or low battery, a latch-cancel event (<code class="docutils literal notranslate"><span class="pre">SDTX_EVENT_CANCEL</span></code>) will be
sent with the cancel reason indicating the specific failure.</p>
<p>If the latch is currently locked, the latch will automatically be
unlocked before it is opened.</p>
</li>
<li><p>Execute <code class="docutils literal notranslate"><span class="pre">SDTX_IOCTL_LATCH_HEARTBEAT</span></code>. This will reset the internal timeout.
No other actions will be performed, i.e. the detachment process will neither
be completed nor canceled, and the EC will still be waiting for further
responses.</p></li>
<li><p>Execute <code class="docutils literal notranslate"><span class="pre">SDTX_IOCTL_LATCH_CANCEL</span></code>. This will abort the detachment process,
similar to <code class="docutils literal notranslate"><span class="pre">SDTX_IOCTL_LATCH_REQUEST</span></code>, described above, or the button
press, described below. A <em>generic request</em> event (<code class="docutils literal notranslate"><span class="pre">SDTX_EVENT_REQUEST</span></code>)
is send in response to this. In contrast to those, however, this command
does not trigger a new detachment process if none is currently in
progress.</p></li>
<li><p>Do nothing. The detachment process eventually times out as described in
point 3.</p></li>
</ul>
<p>See <a class="reference internal" href="#ioctls"><span class="std std-ref">IOCTLs</span></a> for more details on these responses.</p>
<p>It is important to note that, if the user presses the detach button at any
point when a detachment operation is in progress (i.e. after the EC has sent
the initial <em>detach-request</em> event (<code class="docutils literal notranslate"><span class="pre">SDTX_EVENT_REQUEST</span></code>) and before it
received the corresponding response concluding the process), the detachment
process is canceled on the EC-level and an identical event is being sent.
Thus a <em>detach-request</em> event, by itself, does not signal the start of the
detachment process.</p>
<p>The detachment process may further be canceled by the EC due to hardware
failures or a low clipboard battery. This is done via a cancel event
(<code class="docutils literal notranslate"><span class="pre">SDTX_EVENT_CANCEL</span></code>) with the corresponding cancel reason.</p>
</section>
</section>
<section id="user-space-interface-documentation">
<h2><a class="toc-backref" href="#id18">User-Space Interface Documentation</a><a class="headerlink" href="#user-space-interface-documentation" title="Permalink to this headline">¶</a></h2>
<section id="error-codes-and-status-values">
<h3><a class="toc-backref" href="#id19">Error Codes and Status Values</a><a class="headerlink" href="#error-codes-and-status-values" title="Permalink to this headline">¶</a></h3>
<p>Error and status codes are divided into different categories, which can be
used to determine if the status code is an error, and, if it is, the
severity and type of that error. The current categories are:</p>
<table class="docutils align-default" id="id3">
<caption><span class="caption-text">Overview of Status/Error Categories.</span><a class="headerlink" href="#id3" title="Permalink to this table">¶</a></caption>
<colgroup>
<col style="width: 33%" />
<col style="width: 17%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Name</p></th>
<th class="head"><p>Value</p></th>
<th class="head"><p>Short Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">STATUS</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">0x0000</span></code></p></td>
<td><p>Non-error status codes.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">RUNTIME_ERROR</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">0x1000</span></code></p></td>
<td><p>Non-critical runtime errors.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">HARDWARE_ERROR</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">0x2000</span></code></p></td>
<td><p>Critical hardware failures.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">UNKNOWN</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">0xF000</span></code></p></td>
<td><p>Unknown error codes.</p></td>
</tr>
</tbody>
</table>
<p>Other categories are reserved for future use. The <code class="docutils literal notranslate"><span class="pre">SDTX_CATEGORY()</span></code> macro
can be used to determine the category of any status value. The
<code class="docutils literal notranslate"><span class="pre">SDTX_SUCCESS()</span></code> macro can be used to check if the status value is a
success value (<code class="docutils literal notranslate"><span class="pre">SDTX_CATEGORY_STATUS</span></code>) or if it indicates a failure.</p>
<p>Unknown status or error codes sent by the EC are assigned to the <code class="docutils literal notranslate"><span class="pre">UNKNOWN</span></code>
category by the driver and may be implemented via their own code in the
future.</p>
<p>Currently used error codes are:</p>
<table class="docutils align-default" id="id4">
<caption><span class="caption-text">Overview of Error Codes.</span><a class="headerlink" href="#id4" title="Permalink to this table">¶</a></caption>
<colgroup>
<col style="width: 29%" />
<col style="width: 14%" />
<col style="width: 14%" />
<col style="width: 43%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Name</p></th>
<th class="head"><p>Category</p></th>
<th class="head"><p>Value</p></th>
<th class="head"><p>Short Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">SDTX_DETACH_NOT_FEASIBLE</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">RUNTIME</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">0x1001</span></code></p></td>
<td><p>Detachment not feasible due to low clipboard battery.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">SDTX_DETACH_TIMEDOUT</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">RUNTIME</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">0x1002</span></code></p></td>
<td><p>Detachment process timed out while the latch was locked.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">SDTX_ERR_FAILED_TO_OPEN</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">HARDWARE</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">0x2001</span></code></p></td>
<td><p>Failed to open latch.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">SDTX_ERR_FAILED_TO_REMAIN_OPEN</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">HARDWARE</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">0x2002</span></code></p></td>
<td><p>Failed to keep latch open.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">SDTX_ERR_FAILED_TO_CLOSE</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">HARDWARE</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">0x2003</span></code></p></td>
<td><p>Failed to close latch.</p></td>
</tr>
</tbody>
</table>
<p>Other error codes are reserved for future use. Non-error status codes may
overlap and are generally only unique within their use-case:</p>
<table class="docutils align-default" id="id5">
<caption><span class="caption-text">Latch Status Codes.</span><a class="headerlink" href="#id5" title="Permalink to this table">¶</a></caption>
<colgroup>
<col style="width: 29%" />
<col style="width: 14%" />
<col style="width: 14%" />
<col style="width: 43%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Name</p></th>
<th class="head"><p>Category</p></th>
<th class="head"><p>Value</p></th>
<th class="head"><p>Short Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">SDTX_LATCH_CLOSED</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">STATUS</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">0x0000</span></code></p></td>
<td><p>Latch is closed/has been closed.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">SDTX_LATCH_OPENED</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">STATUS</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">0x0001</span></code></p></td>
<td><p>Latch is open/has been opened.</p></td>
</tr>
</tbody>
</table>
<table class="docutils align-default" id="id6">
<caption><span class="caption-text">Base State Codes.</span><a class="headerlink" href="#id6" title="Permalink to this table">¶</a></caption>
<colgroup>
<col style="width: 29%" />
<col style="width: 14%" />
<col style="width: 14%" />
<col style="width: 43%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Name</p></th>
<th class="head"><p>Category</p></th>
<th class="head"><p>Value</p></th>
<th class="head"><p>Short Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">SDTX_BASE_DETACHED</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">STATUS</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">0x0000</span></code></p></td>
<td><p>Base has been detached/is not present.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">SDTX_BASE_ATTACHED</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">STATUS</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">0x0001</span></code></p></td>
<td><p>Base has been attached/is present.</p></td>
</tr>
</tbody>
</table>
<p>Again, other codes are reserved for future use.</p>
</section>
<section id="events">
<span id="id1"></span><h3><a class="toc-backref" href="#id20">Events</a><a class="headerlink" href="#events" title="Permalink to this headline">¶</a></h3>
<p>Events can be received by reading from the device file. They are disabled by
default and have to be enabled by executing <code class="docutils literal notranslate"><span class="pre">SDTX_IOCTL_EVENTS_ENABLE</span></code>
first. All events follow the layout prescribed by <a class="reference internal" href="#c.sdtx_event" title="sdtx_event"><code class="xref c c-type docutils literal notranslate"><span class="pre">struct</span> <span class="pre">sdtx_event</span></code></a>. Specific
event types can be identified by their event code, described in
<a class="reference internal" href="#c.sdtx_event_code" title="sdtx_event_code"><code class="xref c c-type docutils literal notranslate"><span class="pre">enum</span> <span class="pre">sdtx_event_code</span></code></a>. Note that other event codes are reserved for future use,
thus an event parser must be able to handle any unknown/unsupported event
types gracefully, by relying on the payload length given in the event header.</p>
<p>Currently provided event types are:</p>
<table class="docutils align-default" id="id7">
<caption><span class="caption-text">Overview of DTX events.</span><a class="headerlink" href="#id7" title="Permalink to this table">¶</a></caption>
<colgroup>
<col style="width: 29%" />
<col style="width: 14%" />
<col style="width: 14%" />
<col style="width: 43%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Name</p></th>
<th class="head"><p>Code</p></th>
<th class="head"><p>Payload</p></th>
<th class="head"><p>Short Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">SDTX_EVENT_REQUEST</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">1</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">0</span></code> bytes</p></td>
<td><p>Detachment process initiated/aborted.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">SDTX_EVENT_CANCEL</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">2</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">2</span></code> bytes</p></td>
<td><p>EC canceled detachment process.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">SDTX_EVENT_BASE_CONNECTION</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">3</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">4</span></code> bytes</p></td>
<td><p>Base connection state changed.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">SDTX_EVENT_LATCH_STATUS</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">4</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">2</span></code> bytes</p></td>
<td><p>Latch status changed.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">SDTX_EVENT_DEVICE_MODE</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">5</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">2</span></code> bytes</p></td>
<td><p>Device mode changed.</p></td>
</tr>
</tbody>
</table>
<p>Individual events in more detail:</p>
<section id="sdtx-event-request">
<h4><a class="toc-backref" href="#id21"><code class="docutils literal notranslate"><span class="pre">SDTX_EVENT_REQUEST</span></code></a><a class="headerlink" href="#sdtx-event-request" title="Permalink to this headline">¶</a></h4>
<p>Sent when a detachment process is started or, if in progress, aborted by the
user, either via a detach button press or a detach request
(<code class="docutils literal notranslate"><span class="pre">SDTX_IOCTL_LATCH_REQUEST</span></code>) being sent from user-space.</p>
<p>Does not have any payload.</p>
</section>
<section id="sdtx-event-cancel">
<h4><a class="toc-backref" href="#id22"><code class="docutils literal notranslate"><span class="pre">SDTX_EVENT_CANCEL</span></code></a><a class="headerlink" href="#sdtx-event-cancel" title="Permalink to this headline">¶</a></h4>
<p>Sent when a detachment process is canceled by the EC due to unfulfilled
preconditions (e.g. clipboard battery too low to detach) or hardware
failure. The reason for cancellation is given in the event payload detailed
below and can be one of</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">SDTX_DETACH_TIMEDOUT</span></code>: Detachment timed out while the latch was locked.
The latch has neither been opened nor unlocked.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">SDTX_DETACH_NOT_FEASIBLE</span></code>: Detachment not feasible due to low clipboard
battery.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">SDTX_ERR_FAILED_TO_OPEN</span></code>: Could not open the latch (hardware failure).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">SDTX_ERR_FAILED_TO_REMAIN_OPEN</span></code>: Could not keep the latch open (hardware
failure).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">SDTX_ERR_FAILED_TO_CLOSE</span></code>: Could not close the latch (hardware failure).</p></li>
</ul>
<p>Other error codes in this context are reserved for future use.</p>
<p>These codes can be classified via the <code class="docutils literal notranslate"><span class="pre">SDTX_CATEGORY()</span></code> macro to discern
between critical hardware errors (<code class="docutils literal notranslate"><span class="pre">SDTX_CATEGORY_HARDWARE_ERROR</span></code>) or
runtime errors (<code class="docutils literal notranslate"><span class="pre">SDTX_CATEGORY_RUNTIME_ERROR</span></code>), the latter of which may
happen during normal operation if certain preconditions for detachment are
not given.</p>
<table class="docutils align-default" id="id8">
<caption><span class="caption-text">Detachment Cancel Event Payload</span><a class="headerlink" href="#id8" title="Permalink to this table">¶</a></caption>
<colgroup>
<col style="width: 17%" />
<col style="width: 17%" />
<col style="width: 67%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Field</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">reason</span></code></p></td>
<td><p><code class="xref c c-type docutils literal notranslate"><span class="pre">__u16</span></code></p></td>
<td><p>Reason for cancellation.</p></td>
</tr>
</tbody>
</table>
</section>
<section id="sdtx-event-base-connection">
<h4><a class="toc-backref" href="#id23"><code class="docutils literal notranslate"><span class="pre">SDTX_EVENT_BASE_CONNECTION</span></code></a><a class="headerlink" href="#sdtx-event-base-connection" title="Permalink to this headline">¶</a></h4>
<p>Sent when the base connection state has changed, i.e. when the base has been
attached, detached, or detachment has become infeasible due to low clipboard
battery. The new state and, if a base is connected, ID of the base is
provided as payload of type <a class="reference internal" href="#c.sdtx_base_info" title="sdtx_base_info"><code class="xref c c-type docutils literal notranslate"><span class="pre">struct</span> <span class="pre">sdtx_base_info</span></code></a> with its layout presented
below:</p>
<table class="docutils align-default" id="id9">
<caption><span class="caption-text">Base-Connection-Change Event Payload</span><a class="headerlink" href="#id9" title="Permalink to this table">¶</a></caption>
<colgroup>
<col style="width: 17%" />
<col style="width: 17%" />
<col style="width: 67%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Field</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">state</span></code></p></td>
<td><p><code class="xref c c-type docutils literal notranslate"><span class="pre">__u16</span></code></p></td>
<td><p>Base connection state.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">base_id</span></code></p></td>
<td><p><code class="xref c c-type docutils literal notranslate"><span class="pre">__u16</span></code></p></td>
<td><p>Type of base connected (zero if none).</p></td>
</tr>
</tbody>
</table>
<p>Possible values for <code class="docutils literal notranslate"><span class="pre">state</span></code> are:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">SDTX_BASE_DETACHED</span></code>,</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">SDTX_BASE_ATTACHED</span></code>, and</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">SDTX_DETACH_NOT_FEASIBLE</span></code>.</p></li>
</ul>
<p>Other values are reserved for future use.</p>
</section>
<section id="sdtx-event-latch-status">
<h4><a class="toc-backref" href="#id24"><code class="docutils literal notranslate"><span class="pre">SDTX_EVENT_LATCH_STATUS</span></code></a><a class="headerlink" href="#sdtx-event-latch-status" title="Permalink to this headline">¶</a></h4>
<p>Sent when the latch status has changed, i.e. when the latch has been opened,
closed, or an error occurred. The current status is provided as payload:</p>
<table class="docutils align-default" id="id10">
<caption><span class="caption-text">Latch-Status-Change Event Payload</span><a class="headerlink" href="#id10" title="Permalink to this table">¶</a></caption>
<colgroup>
<col style="width: 17%" />
<col style="width: 17%" />
<col style="width: 67%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Field</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">status</span></code></p></td>
<td><p><code class="xref c c-type docutils literal notranslate"><span class="pre">__u16</span></code></p></td>
<td><p>Latch status.</p></td>
</tr>
</tbody>
</table>
<p>Possible values for <code class="docutils literal notranslate"><span class="pre">status</span></code> are:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">SDTX_LATCH_CLOSED</span></code>,</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">SDTX_LATCH_OPENED</span></code>,</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">SDTX_ERR_FAILED_TO_OPEN</span></code>,</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">SDTX_ERR_FAILED_TO_REMAIN_OPEN</span></code>, and</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">SDTX_ERR_FAILED_TO_CLOSE</span></code>.</p></li>
</ul>
<p>Other values are reserved for future use.</p>
</section>
<section id="sdtx-event-device-mode">
<h4><a class="toc-backref" href="#id25"><code class="docutils literal notranslate"><span class="pre">SDTX_EVENT_DEVICE_MODE</span></code></a><a class="headerlink" href="#sdtx-event-device-mode" title="Permalink to this headline">¶</a></h4>
<p>Sent when the device mode has changed. The new device mode is provided as
payload:</p>
<table class="docutils align-default" id="id11">
<caption><span class="caption-text">Device-Mode-Change Event Payload</span><a class="headerlink" href="#id11" title="Permalink to this table">¶</a></caption>
<colgroup>
<col style="width: 17%" />
<col style="width: 17%" />
<col style="width: 67%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Field</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">mode</span></code></p></td>
<td><p><code class="xref c c-type docutils literal notranslate"><span class="pre">__u16</span></code></p></td>
<td><p>Device operation mode.</p></td>
</tr>
</tbody>
</table>
<p>Possible values for <code class="docutils literal notranslate"><span class="pre">mode</span></code> are:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">SDTX_DEVICE_MODE_TABLET</span></code>,</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">SDTX_DEVICE_MODE_LAPTOP</span></code>, and</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">SDTX_DEVICE_MODE_STUDIO</span></code>.</p></li>
</ul>
<p>Other values are reserved for future use.</p>
</section>
</section>
<section id="ioctls">
<span id="id2"></span><h3><a class="toc-backref" href="#id26">IOCTLs</a><a class="headerlink" href="#ioctls" title="Permalink to this headline">¶</a></h3>
<p>The following IOCTLs are provided:</p>
<table class="docutils align-default" id="id12">
<caption><span class="caption-text">Overview of DTX IOCTLs</span><a class="headerlink" href="#id12" title="Permalink to this table">¶</a></caption>
<colgroup>
<col style="width: 13%" />
<col style="width: 13%" />
<col style="width: 13%" />
<col style="width: 13%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Type</p></th>
<th class="head"><p>Number</p></th>
<th class="head"><p>Direction</p></th>
<th class="head"><p>Name</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">0xA5</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">0x21</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">-</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">EVENTS_ENABLE</span></code></p></td>
<td><p>Enable events for the current file descriptor.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">0xA5</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">0x22</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">-</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">EVENTS_DISABLE</span></code></p></td>
<td><p>Disable events for the current file descriptor.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">0xA5</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">0x23</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">-</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">LATCH_LOCK</span></code></p></td>
<td><p>Lock the latch.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">0xA5</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">0x24</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">-</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">LATCH_UNLOCK</span></code></p></td>
<td><p>Unlock the latch.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">0xA5</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">0x25</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">-</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">LATCH_REQUEST</span></code></p></td>
<td><p>Request clipboard detachment.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">0xA5</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">0x26</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">-</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">LATCH_CONFIRM</span></code></p></td>
<td><p>Confirm clipboard detachment request.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">0xA5</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">0x27</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">-</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">LATCH_HEARTBEAT</span></code></p></td>
<td><p>Send heartbeat signal to EC.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">0xA5</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">0x28</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">-</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">LATCH_CANCEL</span></code></p></td>
<td><p>Cancel detachment process.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">0xA5</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">0x29</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">R</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">GET_BASE_INFO</span></code></p></td>
<td><p>Get current base/connection information.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">0xA5</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">0x2A</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">R</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">GET_DEVICE_MODE</span></code></p></td>
<td><p>Get current device operation mode.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">0xA5</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">0x2B</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">R</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">GET_LATCH_STATUS</span></code></p></td>
<td><p>Get current device latch status.</p></td>
</tr>
</tbody>
</table>
<section id="sdtx-ioctl-events-enable">
<h4><a class="toc-backref" href="#id27"><code class="docutils literal notranslate"><span class="pre">SDTX_IOCTL_EVENTS_ENABLE</span></code></a><a class="headerlink" href="#sdtx-ioctl-events-enable" title="Permalink to this headline">¶</a></h4>
<p>Defined as <code class="docutils literal notranslate"><span class="pre">_IO(0xA5,</span> <span class="pre">0x22)</span></code>.</p>
<p>Enable events for the current file descriptor. Events can be obtained by
reading from the device, if enabled. Events are disabled by default.</p>
</section>
<section id="sdtx-ioctl-events-disable">
<h4><a class="toc-backref" href="#id28"><code class="docutils literal notranslate"><span class="pre">SDTX_IOCTL_EVENTS_DISABLE</span></code></a><a class="headerlink" href="#sdtx-ioctl-events-disable" title="Permalink to this headline">¶</a></h4>
<p>Defined as <code class="docutils literal notranslate"><span class="pre">_IO(0xA5,</span> <span class="pre">0x22)</span></code>.</p>
<p>Disable events for the current file descriptor. Events can be obtained by
reading from the device, if enabled. Events are disabled by default.</p>
</section>
<section id="sdtx-ioctl-latch-lock">
<h4><a class="toc-backref" href="#id29"><code class="docutils literal notranslate"><span class="pre">SDTX_IOCTL_LATCH_LOCK</span></code></a><a class="headerlink" href="#sdtx-ioctl-latch-lock" title="Permalink to this headline">¶</a></h4>
<p>Defined as <code class="docutils literal notranslate"><span class="pre">_IO(0xA5,</span> <span class="pre">0x23)</span></code>.</p>
<p>Locks the latch, causing the detachment procedure to abort without opening
the latch on timeout. The latch is unlocked by default. This command will be
silently ignored if the latch is already locked.</p>
</section>
<section id="sdtx-ioctl-latch-unlock">
<h4><a class="toc-backref" href="#id30"><code class="docutils literal notranslate"><span class="pre">SDTX_IOCTL_LATCH_UNLOCK</span></code></a><a class="headerlink" href="#sdtx-ioctl-latch-unlock" title="Permalink to this headline">¶</a></h4>
<p>Defined as <code class="docutils literal notranslate"><span class="pre">_IO(0xA5,</span> <span class="pre">0x24)</span></code>.</p>
<p>Unlocks the latch, causing the detachment procedure to open the latch on
timeout. The latch is unlocked by default. This command will not open the
latch when sent during an ongoing detachment process. It will be silently
ignored if the latch is already unlocked.</p>
</section>
<section id="sdtx-ioctl-latch-request">
<h4><a class="toc-backref" href="#id31"><code class="docutils literal notranslate"><span class="pre">SDTX_IOCTL_LATCH_REQUEST</span></code></a><a class="headerlink" href="#sdtx-ioctl-latch-request" title="Permalink to this headline">¶</a></h4>
<p>Defined as <code class="docutils literal notranslate"><span class="pre">_IO(0xA5,</span> <span class="pre">0x25)</span></code>.</p>
<p>Generic latch request. Behavior depends on the context: If no
detachment-process is active, detachment is requested. Otherwise the
currently active detachment-process will be aborted.</p>
<p>If a detachment process is canceled by this operation, a generic detachment
request event (<code class="docutils literal notranslate"><span class="pre">SDTX_EVENT_REQUEST</span></code>) will be sent.</p>
<p>This essentially behaves the same as a detachment button press.</p>
</section>
<section id="sdtx-ioctl-latch-confirm">
<h4><a class="toc-backref" href="#id32"><code class="docutils literal notranslate"><span class="pre">SDTX_IOCTL_LATCH_CONFIRM</span></code></a><a class="headerlink" href="#sdtx-ioctl-latch-confirm" title="Permalink to this headline">¶</a></h4>
<p>Defined as <code class="docutils literal notranslate"><span class="pre">_IO(0xA5,</span> <span class="pre">0x26)</span></code>.</p>
<p>Acknowledges and confirms a latch request. If sent during an ongoing
detachment process, this command causes the latch to be opened immediately.
The latch will also be opened if it has been locked. In this case, the latch
lock is reset to the unlocked state.</p>
<p>This command will be silently ignored if there is currently no detachment
procedure in progress.</p>
</section>
<section id="sdtx-ioctl-latch-heartbeat">
<h4><a class="toc-backref" href="#id33"><code class="docutils literal notranslate"><span class="pre">SDTX_IOCTL_LATCH_HEARTBEAT</span></code></a><a class="headerlink" href="#sdtx-ioctl-latch-heartbeat" title="Permalink to this headline">¶</a></h4>
<p>Defined as <code class="docutils literal notranslate"><span class="pre">_IO(0xA5,</span> <span class="pre">0x27)</span></code>.</p>
<p>Sends a heartbeat, essentially resetting the detachment timeout. This
command can be used to keep the detachment process alive while work required
for the detachment to succeed is still in progress.</p>
<p>This command will be silently ignored if there is currently no detachment
procedure in progress.</p>
</section>
<section id="sdtx-ioctl-latch-cancel">
<h4><a class="toc-backref" href="#id34"><code class="docutils literal notranslate"><span class="pre">SDTX_IOCTL_LATCH_CANCEL</span></code></a><a class="headerlink" href="#sdtx-ioctl-latch-cancel" title="Permalink to this headline">¶</a></h4>
<p>Defined as <code class="docutils literal notranslate"><span class="pre">_IO(0xA5,</span> <span class="pre">0x28)</span></code>.</p>
<p>Cancels detachment in progress (if any). If a detachment process is canceled
by this operation, a generic detachment request event
(<code class="docutils literal notranslate"><span class="pre">SDTX_EVENT_REQUEST</span></code>) will be sent.</p>
<p>This command will be silently ignored if there is currently no detachment
procedure in progress.</p>
</section>
<section id="sdtx-ioctl-get-base-info">
<h4><a class="toc-backref" href="#id35"><code class="docutils literal notranslate"><span class="pre">SDTX_IOCTL_GET_BASE_INFO</span></code></a><a class="headerlink" href="#sdtx-ioctl-get-base-info" title="Permalink to this headline">¶</a></h4>
<p>Defined as <code class="docutils literal notranslate"><span class="pre">_IOR(0xA5,</span> <span class="pre">0x29,</span> <span class="pre">struct</span> <span class="pre">sdtx_base_info)</span></code>.</p>
<p>Get the current base connection state (i.e. attached/detached) and the type
of the base connected to the clipboard. This is command essentially provides
a way to query the information provided by the base connection change event
(<code class="docutils literal notranslate"><span class="pre">SDTX_EVENT_BASE_CONNECTION</span></code>).</p>
<p>Possible values for <code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">sdtx_base_info.state</span></code> are:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">SDTX_BASE_DETACHED</span></code>,</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">SDTX_BASE_ATTACHED</span></code>, and</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">SDTX_DETACH_NOT_FEASIBLE</span></code>.</p></li>
</ul>
<p>Other values are reserved for future use.</p>
</section>
<section id="sdtx-ioctl-get-device-mode">
<h4><a class="toc-backref" href="#id36"><code class="docutils literal notranslate"><span class="pre">SDTX_IOCTL_GET_DEVICE_MODE</span></code></a><a class="headerlink" href="#sdtx-ioctl-get-device-mode" title="Permalink to this headline">¶</a></h4>
<p>Defined as <code class="docutils literal notranslate"><span class="pre">_IOR(0xA5,</span> <span class="pre">0x2A,</span> <span class="pre">__u16)</span></code>.</p>
<p>Returns the device operation mode, indicating if and how the base is
attached to the clipboard. This is command essentially provides a way to
query the information provided by the device mode change event
(<code class="docutils literal notranslate"><span class="pre">SDTX_EVENT_DEVICE_MODE</span></code>).</p>
<p>Returned values are:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">SDTX_DEVICE_MODE_LAPTOP</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">SDTX_DEVICE_MODE_TABLET</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">SDTX_DEVICE_MODE_STUDIO</span></code></p></li>
</ul>
<p>See <a class="reference internal" href="#c.sdtx_device_mode" title="sdtx_device_mode"><code class="xref c c-type docutils literal notranslate"><span class="pre">struct</span> <span class="pre">sdtx_device_mode</span></code></a> for details. Other values are reserved for future
use.</p>
</section>
<section id="sdtx-ioctl-get-latch-status">
<h4><a class="toc-backref" href="#id37"><code class="docutils literal notranslate"><span class="pre">SDTX_IOCTL_GET_LATCH_STATUS</span></code></a><a class="headerlink" href="#sdtx-ioctl-get-latch-status" title="Permalink to this headline">¶</a></h4>
<p>Defined as <code class="docutils literal notranslate"><span class="pre">_IOR(0xA5,</span> <span class="pre">0x2B,</span> <span class="pre">__u16)</span></code>.</p>
<p>Get the current latch status or (presumably) the last error encountered when
trying to open/close the latch. This is command essentially provides a way
to query the information provided by the latch status change event
(<code class="docutils literal notranslate"><span class="pre">SDTX_EVENT_LATCH_STATUS</span></code>).</p>
<p>Returned values are:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">SDTX_LATCH_CLOSED</span></code>,</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">SDTX_LATCH_OPENED</span></code>,</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">SDTX_ERR_FAILED_TO_OPEN</span></code>,</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">SDTX_ERR_FAILED_TO_REMAIN_OPEN</span></code>, and</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">SDTX_ERR_FAILED_TO_CLOSE</span></code>.</p></li>
</ul>
<p>Other values are reserved for future use.</p>
</section>
</section>
<section id="a-note-on-base-ids">
<h3><a class="toc-backref" href="#id38">A Note on Base IDs</a><a class="headerlink" href="#a-note-on-base-ids" title="Permalink to this headline">¶</a></h3>
<p>Base types/IDs provided via <code class="docutils literal notranslate"><span class="pre">SDTX_EVENT_BASE_CONNECTION</span></code> or
<code class="docutils literal notranslate"><span class="pre">SDTX_IOCTL_GET_BASE_INFO</span></code> are directly forwarded from the EC in the lower
byte of the combined <code class="xref c c-type docutils literal notranslate"><span class="pre">__u16</span></code> value, with the driver storing the EC type from
which this ID comes in the high byte (without this, base IDs over different
types of ECs may be overlapping).</p>
<p>The <code class="docutils literal notranslate"><span class="pre">SDTX_DEVICE_TYPE()</span></code> macro can be used to determine the EC device
type. This can be one of</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">SDTX_DEVICE_TYPE_HID</span></code>, for Surface Aggregator Module over HID, and</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">SDTX_DEVICE_TYPE_SSH</span></code>, for Surface Aggregator Module over Surface Serial
Hub.</p></li>
</ul>
<p>Note that currently only the <code class="docutils literal notranslate"><span class="pre">SSH</span></code> type EC is supported, however <code class="docutils literal notranslate"><span class="pre">HID</span></code>
type is reserved for future use.</p>
</section>
<section id="structures-and-enums">
<h3><a class="toc-backref" href="#id39">Structures and Enums</a><a class="headerlink" href="#structures-and-enums" title="Permalink to this headline">¶</a></h3>
<dl class="type">
<dt id="c.sdtx_device_mode">
enum <code class="sig-name descname">sdtx_device_mode</code><a class="headerlink" href="#c.sdtx_device_mode" title="Permalink to this definition">¶</a></dt>
<dd><p>Mode describing how (and if) the clipboard is attached to the base of the device.</p>
</dd></dl>

<div class="kernelindent docutils container">
<p><strong>Constants</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">SDTX_DEVICE_MODE_TABLET</span></code></dt><dd><p>The clipboard is detached from the base and the
device operates as tablet.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">SDTX_DEVICE_MODE_LAPTOP</span></code></dt><dd><p>The clipboard is attached normally to the base
and the device operates as laptop.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">SDTX_DEVICE_MODE_STUDIO</span></code></dt><dd><p>The clipboard is attached to the base in reverse.
The device operates as tablet with keyboard and
touchpad deactivated, however, the base battery
and, if present in the specific device model, dGPU
are available to the system.</p>
</dd>
</dl>
</div>
<dl class="type">
<dt id="c.sdtx_event">
struct <code class="sig-name descname">sdtx_event</code><a class="headerlink" href="#c.sdtx_event" title="Permalink to this definition">¶</a></dt>
<dd><p>Event provided by reading from the DTX device file.</p>
</dd></dl>

<div class="kernelindent docutils container">
<p><strong>Definition</strong>:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>struct sdtx_event {
    __u16 length;
    __u16 code;
    __u8 data[];
};
</pre></div>
</div>
<p><strong>Members</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">length</span></code></dt><dd><p>Length of the event payload, in bytes.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">code</span></code></dt><dd><p>Event code, detailing what type of event this is.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">data</span></code></dt><dd><p>Payload of the event, containing <strong>length</strong> bytes.</p>
</dd>
</dl>
</div>
<p><strong>Description</strong></p>
<p>See <a class="reference internal" href="#c.sdtx_event_code" title="sdtx_event_code"><code class="xref c c-type docutils literal notranslate"><span class="pre">enum</span> <span class="pre">sdtx_event_code</span></code></a> for currently valid event codes.</p>
<dl class="type">
<dt id="c.sdtx_event_code">
enum <code class="sig-name descname">sdtx_event_code</code><a class="headerlink" href="#c.sdtx_event_code" title="Permalink to this definition">¶</a></dt>
<dd><p>Code describing the type of an event.</p>
</dd></dl>

<div class="kernelindent docutils container">
<p><strong>Constants</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">SDTX_EVENT_REQUEST</span></code></dt><dd><p>Detachment request event type.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">SDTX_EVENT_CANCEL</span></code></dt><dd><p>Cancel detachment process event type.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">SDTX_EVENT_BASE_CONNECTION</span></code></dt><dd><p>Base/clipboard connection change event type.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">SDTX_EVENT_LATCH_STATUS</span></code></dt><dd><p>Latch status change event type.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">SDTX_EVENT_DEVICE_MODE</span></code></dt><dd><p>Device mode change event type.</p>
</dd>
</dl>
</div>
<p><strong>Description</strong></p>
<p>Used in <a class="reference internal" href="#c.sdtx_event" title="sdtx_event"><code class="xref c c-type docutils literal notranslate"><span class="pre">struct</span> <span class="pre">sdtx_event</span></code></a> to describe the type of the event. Further event
codes are reserved for future use. Any event parser should be able to
gracefully handle unknown events, i.e. by simply skipping them.</p>
<p>Consult the DTX user-space interface documentation for details regarding
the individual event types.</p>
<dl class="type">
<dt id="c.sdtx_base_info">
struct <code class="sig-name descname">sdtx_base_info</code><a class="headerlink" href="#c.sdtx_base_info" title="Permalink to this definition">¶</a></dt>
<dd><p>Describes if and what type of base is connected.</p>
</dd></dl>

<div class="kernelindent docutils container">
<p><strong>Definition</strong>:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>struct sdtx_base_info {
    __u16 state;
    __u16 base_id;
};
</pre></div>
</div>
<p><strong>Members</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">state</span></code></dt><dd><p>The state of the connection. Valid values are <code class="docutils literal notranslate"><span class="pre">SDTX_BASE_DETACHED</span></code>,
<code class="docutils literal notranslate"><span class="pre">SDTX_BASE_ATTACHED</span></code>, and <code class="docutils literal notranslate"><span class="pre">SDTX_DETACH_NOT_FEASIBLE</span></code> (in case a base
is attached but low clipboard battery prevents detachment). Other
values are currently reserved.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">base_id</span></code></dt><dd><p>The type of base connected. Zero if no base is connected.</p>
</dd>
</dl>
</div>
</section>
</section>
<section id="api-users">
<h2><a class="toc-backref" href="#id40">API Users</a><a class="headerlink" href="#api-users" title="Permalink to this headline">¶</a></h2>
<p>A user-space daemon utilizing this API can be found at
<a class="reference external" href="https://github.com/linux-surface/surface-dtx-daemon">https://github.com/linux-surface/surface-dtx-daemon</a>.</p>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../index.html">The Linux Kernel</a></h1>



<p class="blurb">6.2.0-rc4-6.2.0-rc4+</p>







<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
  <h3><a href="../../../index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">User-Space DTX (Clipboard Detachment System) Interface</a><ul>
<li><a class="reference internal" href="#nomenclature">Nomenclature</a></li>
<li><a class="reference internal" href="#detachment-process">Detachment Process</a><ul>
<li><a class="reference internal" href="#latch-states">Latch States</a></li>
<li><a class="reference internal" href="#detachment-procedure">Detachment Procedure</a></li>
</ul>
</li>
<li><a class="reference internal" href="#user-space-interface-documentation">User-Space Interface Documentation</a><ul>
<li><a class="reference internal" href="#error-codes-and-status-values">Error Codes and Status Values</a></li>
<li><a class="reference internal" href="#events">Events</a><ul>
<li><a class="reference internal" href="#sdtx-event-request"><code class="docutils literal notranslate"><span class="pre">SDTX_EVENT_REQUEST</span></code></a></li>
<li><a class="reference internal" href="#sdtx-event-cancel"><code class="docutils literal notranslate"><span class="pre">SDTX_EVENT_CANCEL</span></code></a></li>
<li><a class="reference internal" href="#sdtx-event-base-connection"><code class="docutils literal notranslate"><span class="pre">SDTX_EVENT_BASE_CONNECTION</span></code></a></li>
<li><a class="reference internal" href="#sdtx-event-latch-status"><code class="docutils literal notranslate"><span class="pre">SDTX_EVENT_LATCH_STATUS</span></code></a></li>
<li><a class="reference internal" href="#sdtx-event-device-mode"><code class="docutils literal notranslate"><span class="pre">SDTX_EVENT_DEVICE_MODE</span></code></a></li>
</ul>
</li>
<li><a class="reference internal" href="#ioctls">IOCTLs</a><ul>
<li><a class="reference internal" href="#sdtx-ioctl-events-enable"><code class="docutils literal notranslate"><span class="pre">SDTX_IOCTL_EVENTS_ENABLE</span></code></a></li>
<li><a class="reference internal" href="#sdtx-ioctl-events-disable"><code class="docutils literal notranslate"><span class="pre">SDTX_IOCTL_EVENTS_DISABLE</span></code></a></li>
<li><a class="reference internal" href="#sdtx-ioctl-latch-lock"><code class="docutils literal notranslate"><span class="pre">SDTX_IOCTL_LATCH_LOCK</span></code></a></li>
<li><a class="reference internal" href="#sdtx-ioctl-latch-unlock"><code class="docutils literal notranslate"><span class="pre">SDTX_IOCTL_LATCH_UNLOCK</span></code></a></li>
<li><a class="reference internal" href="#sdtx-ioctl-latch-request"><code class="docutils literal notranslate"><span class="pre">SDTX_IOCTL_LATCH_REQUEST</span></code></a></li>
<li><a class="reference internal" href="#sdtx-ioctl-latch-confirm"><code class="docutils literal notranslate"><span class="pre">SDTX_IOCTL_LATCH_CONFIRM</span></code></a></li>
<li><a class="reference internal" href="#sdtx-ioctl-latch-heartbeat"><code class="docutils literal notranslate"><span class="pre">SDTX_IOCTL_LATCH_HEARTBEAT</span></code></a></li>
<li><a class="reference internal" href="#sdtx-ioctl-latch-cancel"><code class="docutils literal notranslate"><span class="pre">SDTX_IOCTL_LATCH_CANCEL</span></code></a></li>
<li><a class="reference internal" href="#sdtx-ioctl-get-base-info"><code class="docutils literal notranslate"><span class="pre">SDTX_IOCTL_GET_BASE_INFO</span></code></a></li>
<li><a class="reference internal" href="#sdtx-ioctl-get-device-mode"><code class="docutils literal notranslate"><span class="pre">SDTX_IOCTL_GET_DEVICE_MODE</span></code></a></li>
<li><a class="reference internal" href="#sdtx-ioctl-get-latch-status"><code class="docutils literal notranslate"><span class="pre">SDTX_IOCTL_GET_LATCH_STATUS</span></code></a></li>
</ul>
</li>
<li><a class="reference internal" href="#a-note-on-base-ids">A Note on Base IDs</a></li>
<li><a class="reference internal" href="#structures-and-enums">Structures and Enums</a></li>
</ul>
</li>
<li><a class="reference internal" href="#api-users">API Users</a></li>
</ul>
</li>
</ul>

  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../../../_sources/driver-api/surface_aggregator/clients/dtx.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;The kernel development community.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 2.4.4</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="../../../_sources/driver-api/surface_aggregator/clients/dtx.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>