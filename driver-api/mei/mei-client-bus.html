
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Intel(R) Management Engine (ME) Client bus API &#8212; The Linux Kernel 6.2.0-rc4+ documentation</title>
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="HDCP:" href="hdcp.html" />
    <link rel="prev" title="Introduction" href="mei.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="intel-r-management-engine-me-client-bus-api">
<h1>Intel(R) Management Engine (ME) Client bus API<a class="headerlink" href="#intel-r-management-engine-me-client-bus-api" title="Permalink to this headline">¶</a></h1>
<section id="rationale">
<h2>Rationale<a class="headerlink" href="#rationale" title="Permalink to this headline">¶</a></h2>
<p>The MEI character device is useful for dedicated applications to send and receive
data to the many FW appliance found in Intel’s ME from the user space.
However, for some of the ME functionalities it makes sense to leverage existing software
stack and expose them through existing kernel subsystems.</p>
<p>In order to plug seamlessly into the kernel device driver model we add kernel virtual
bus abstraction on top of the MEI driver. This allows implementing Linux kernel drivers
for the various MEI features as a stand alone entities found in their respective subsystem.
Existing device drivers can even potentially be re-used by adding an MEI CL bus layer to
the existing code.</p>
</section>
<section id="mei-cl-bus-api">
<h2>MEI CL bus API<a class="headerlink" href="#mei-cl-bus-api" title="Permalink to this headline">¶</a></h2>
<p>A driver implementation for an MEI Client is very similar to any other existing bus
based device drivers. The driver registers itself as an MEI CL bus driver through
the <code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">mei_cl_driver</span></code> structure defined in <code class="file docutils literal notranslate"><span class="pre">include/linux/mei_cl_bus.c</span></code></p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="k">struct</span> <span class="nc">mei_cl_driver</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">struct</span> <span class="nc">device_driver</span><span class="w"> </span><span class="n">driver</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">name</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span> <span class="nc">mei_cl_device_id</span><span class="w"> </span><span class="o">*</span><span class="n">id_table</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">probe</span><span class="p">)(</span><span class="k">struct</span> <span class="nc">mei_cl_device</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span> <span class="nc">mei_cl_id</span><span class="w"> </span><span class="o">*</span><span class="n">id</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">remove</span><span class="p">)(</span><span class="k">struct</span> <span class="nc">mei_cl_device</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="p">);</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>
</pre></div>
</div>
<p>The mei_cl_device_id structure defined in <code class="file docutils literal notranslate"><span class="pre">include/linux/mod_devicetable.h</span></code> allows a
driver to bind itself against a device name.</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="k">struct</span> <span class="nc">mei_cl_device_id</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kt">char</span><span class="w"> </span><span class="n">name</span><span class="p">[</span><span class="n">MEI_CL_NAME_SIZE</span><span class="p">];</span><span class="w"></span>
<span class="w">        </span><span class="n">uuid_le</span><span class="w"> </span><span class="n">uuid</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">__u8</span><span class="w">    </span><span class="n">version</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">kernel_ulong_t</span><span class="w"> </span><span class="n">driver_info</span><span class="p">;</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>
</pre></div>
</div>
<p>To actually register a driver on the ME Client bus one must call the <code class="xref c c-func docutils literal notranslate"><span class="pre">mei_cl_add_driver()</span></code>
API. This is typically called at module initialization time.</p>
<p>Once the driver is registered and bound to the device, a driver will typically
try to do some I/O on this bus and this should be done through the <code class="xref c c-func docutils literal notranslate"><span class="pre">mei_cl_send()</span></code>
and <code class="xref c c-func docutils literal notranslate"><span class="pre">mei_cl_recv()</span></code> functions. More detailed information is in <a class="reference internal" href="#api"><span class="std std-ref">API:</span></a> section.</p>
<p>In order for a driver to be notified about pending traffic or event, the driver
should register a callback via <code class="xref c c-func docutils literal notranslate"><span class="pre">mei_cl_devev_register_rx_cb()</span></code> and
<code class="xref c c-func docutils literal notranslate"><span class="pre">mei_cldev_register_notify_cb()</span></code> function respectively.</p>
<section id="api">
<span id="id1"></span><h3>API:<a class="headerlink" href="#api" title="Permalink to this headline">¶</a></h3>
<dl class="function">
<dt id="c.mei_cldev_send_vtag">
ssize_t <code class="sig-name descname">mei_cldev_send_vtag</code><span class="sig-paren">(</span>struct mei_cl_device<em> *cldev</em>, const u8<em> *buf</em>, size_t<em> length</em>, u8<em> vtag</em><span class="sig-paren">)</span><a class="headerlink" href="#c.mei_cldev_send_vtag" title="Permalink to this definition">¶</a></dt>
<dd><p>me device send with vtag (write)</p>
</dd></dl>

<div class="kernelindent docutils container">
<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">mei_cl_device</span> <span class="pre">*cldev</span></code></dt><dd><p>me client device</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">const</span> <span class="pre">u8</span> <span class="pre">*buf</span></code></dt><dd><p>buffer to send</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">size_t</span> <span class="pre">length</span></code></dt><dd><p>buffer length</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">u8</span> <span class="pre">vtag</span></code></dt><dd><p>virtual tag</p>
</dd>
</dl>
<p><strong>Return</strong></p>
<blockquote>
<div><ul class="simple">
<li><p>written size in bytes</p></li>
<li><p>&lt; 0 on error</p></li>
</ul>
</div></blockquote>
</div>
<dl class="function">
<dt id="c.mei_cldev_recv_vtag">
ssize_t <code class="sig-name descname">mei_cldev_recv_vtag</code><span class="sig-paren">(</span>struct mei_cl_device<em> *cldev</em>, u8<em> *buf</em>, size_t<em> length</em>, u8<em> *vtag</em><span class="sig-paren">)</span><a class="headerlink" href="#c.mei_cldev_recv_vtag" title="Permalink to this definition">¶</a></dt>
<dd><p>client receive with vtag (read)</p>
</dd></dl>

<div class="kernelindent docutils container">
<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">mei_cl_device</span> <span class="pre">*cldev</span></code></dt><dd><p>me client device</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">u8</span> <span class="pre">*buf</span></code></dt><dd><p>buffer to receive</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">size_t</span> <span class="pre">length</span></code></dt><dd><p>buffer length</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">u8</span> <span class="pre">*vtag</span></code></dt><dd><p>virtual tag</p>
</dd>
</dl>
<p><strong>Return</strong></p>
<ul class="simple">
<li><p>read size in bytes</p></li>
<li><p>&lt; 0 on error</p></li>
</ul>
</div>
<dl class="function">
<dt id="c.mei_cldev_recv_nonblock_vtag">
ssize_t <code class="sig-name descname">mei_cldev_recv_nonblock_vtag</code><span class="sig-paren">(</span>struct mei_cl_device<em> *cldev</em>, u8<em> *buf</em>, size_t<em> length</em>, u8<em> *vtag</em><span class="sig-paren">)</span><a class="headerlink" href="#c.mei_cldev_recv_nonblock_vtag" title="Permalink to this definition">¶</a></dt>
<dd><p>non block client receive with vtag (read)</p>
</dd></dl>

<div class="kernelindent docutils container">
<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">mei_cl_device</span> <span class="pre">*cldev</span></code></dt><dd><p>me client device</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">u8</span> <span class="pre">*buf</span></code></dt><dd><p>buffer to receive</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">size_t</span> <span class="pre">length</span></code></dt><dd><p>buffer length</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">u8</span> <span class="pre">*vtag</span></code></dt><dd><p>virtual tag</p>
</dd>
</dl>
<p><strong>Return</strong></p>
<ul class="simple">
<li><p>read size in bytes</p></li>
<li><p>-EAGAIN if function will block.</p></li>
<li><p>&lt; 0 on other error</p></li>
</ul>
</div>
<dl class="function">
<dt id="c.mei_cldev_send">
ssize_t <code class="sig-name descname">mei_cldev_send</code><span class="sig-paren">(</span>struct mei_cl_device<em> *cldev</em>, const u8<em> *buf</em>, size_t<em> length</em><span class="sig-paren">)</span><a class="headerlink" href="#c.mei_cldev_send" title="Permalink to this definition">¶</a></dt>
<dd><p>me device send (write)</p>
</dd></dl>

<div class="kernelindent docutils container">
<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">mei_cl_device</span> <span class="pre">*cldev</span></code></dt><dd><p>me client device</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">const</span> <span class="pre">u8</span> <span class="pre">*buf</span></code></dt><dd><p>buffer to send</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">size_t</span> <span class="pre">length</span></code></dt><dd><p>buffer length</p>
</dd>
</dl>
<p><strong>Return</strong></p>
<blockquote>
<div><ul class="simple">
<li><p>written size in bytes</p></li>
<li><p>&lt; 0 on error</p></li>
</ul>
</div></blockquote>
</div>
<dl class="function">
<dt id="c.mei_cldev_recv">
ssize_t <code class="sig-name descname">mei_cldev_recv</code><span class="sig-paren">(</span>struct mei_cl_device<em> *cldev</em>, u8<em> *buf</em>, size_t<em> length</em><span class="sig-paren">)</span><a class="headerlink" href="#c.mei_cldev_recv" title="Permalink to this definition">¶</a></dt>
<dd><p>client receive (read)</p>
</dd></dl>

<div class="kernelindent docutils container">
<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">mei_cl_device</span> <span class="pre">*cldev</span></code></dt><dd><p>me client device</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">u8</span> <span class="pre">*buf</span></code></dt><dd><p>buffer to receive</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">size_t</span> <span class="pre">length</span></code></dt><dd><p>buffer length</p>
</dd>
</dl>
<p><strong>Return</strong></p>
<p>read size in bytes of &lt; 0 on error</p>
</div>
<dl class="function">
<dt id="c.mei_cldev_recv_nonblock">
ssize_t <code class="sig-name descname">mei_cldev_recv_nonblock</code><span class="sig-paren">(</span>struct mei_cl_device<em> *cldev</em>, u8<em> *buf</em>, size_t<em> length</em><span class="sig-paren">)</span><a class="headerlink" href="#c.mei_cldev_recv_nonblock" title="Permalink to this definition">¶</a></dt>
<dd><p>non block client receive (read)</p>
</dd></dl>

<div class="kernelindent docutils container">
<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">mei_cl_device</span> <span class="pre">*cldev</span></code></dt><dd><p>me client device</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">u8</span> <span class="pre">*buf</span></code></dt><dd><p>buffer to receive</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">size_t</span> <span class="pre">length</span></code></dt><dd><p>buffer length</p>
</dd>
</dl>
<p><strong>Return</strong></p>
<dl class="simple">
<dt>read size in bytes of &lt; 0 on error</dt><dd><p>-EAGAIN if function will block.</p>
</dd>
</dl>
</div>
<dl class="function">
<dt id="c.mei_cldev_register_rx_cb">
int <code class="sig-name descname">mei_cldev_register_rx_cb</code><span class="sig-paren">(</span>struct mei_cl_device<em> *cldev</em>, mei_cldev_cb_t<em> rx_cb</em><span class="sig-paren">)</span><a class="headerlink" href="#c.mei_cldev_register_rx_cb" title="Permalink to this definition">¶</a></dt>
<dd><p>register Rx event callback</p>
</dd></dl>

<div class="kernelindent docutils container">
<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">mei_cl_device</span> <span class="pre">*cldev</span></code></dt><dd><p>me client devices</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">mei_cldev_cb_t</span> <span class="pre">rx_cb</span></code></dt><dd><p>callback function</p>
</dd>
</dl>
<p><strong>Return</strong></p>
<dl class="simple">
<dt>0 on success</dt><dd><p>-EALREADY if an callback is already registered
&lt;0 on other errors</p>
</dd>
</dl>
</div>
<dl class="function">
<dt id="c.mei_cldev_register_notif_cb">
int <code class="sig-name descname">mei_cldev_register_notif_cb</code><span class="sig-paren">(</span>struct mei_cl_device<em> *cldev</em>, mei_cldev_cb_t<em> notif_cb</em><span class="sig-paren">)</span><a class="headerlink" href="#c.mei_cldev_register_notif_cb" title="Permalink to this definition">¶</a></dt>
<dd><p>register FW notification event callback</p>
</dd></dl>

<div class="kernelindent docutils container">
<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">mei_cl_device</span> <span class="pre">*cldev</span></code></dt><dd><p>me client devices</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">mei_cldev_cb_t</span> <span class="pre">notif_cb</span></code></dt><dd><p>callback function</p>
</dd>
</dl>
<p><strong>Return</strong></p>
<dl class="simple">
<dt>0 on success</dt><dd><p>-EALREADY if an callback is already registered
&lt;0 on other errors</p>
</dd>
</dl>
</div>
<dl class="function">
<dt id="c.mei_cldev_get_drvdata">
void * <code class="sig-name descname">mei_cldev_get_drvdata</code><span class="sig-paren">(</span>const struct mei_cl_device<em> *cldev</em><span class="sig-paren">)</span><a class="headerlink" href="#c.mei_cldev_get_drvdata" title="Permalink to this definition">¶</a></dt>
<dd><p>driver data getter</p>
</dd></dl>

<div class="kernelindent docutils container">
<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">const</span> <span class="pre">struct</span> <span class="pre">mei_cl_device</span> <span class="pre">*cldev</span></code></dt><dd><p>mei client device</p>
</dd>
</dl>
<p><strong>Return</strong></p>
<p>driver private data</p>
</div>
<dl class="function">
<dt id="c.mei_cldev_set_drvdata">
void <code class="sig-name descname">mei_cldev_set_drvdata</code><span class="sig-paren">(</span>struct mei_cl_device<em> *cldev</em>, void<em> *data</em><span class="sig-paren">)</span><a class="headerlink" href="#c.mei_cldev_set_drvdata" title="Permalink to this definition">¶</a></dt>
<dd><p>driver data setter</p>
</dd></dl>

<div class="kernelindent docutils container">
<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">mei_cl_device</span> <span class="pre">*cldev</span></code></dt><dd><p>mei client device</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">void</span> <span class="pre">*data</span></code></dt><dd><p>data to store</p>
</dd>
</dl>
</div>
<dl class="function">
<dt id="c.mei_cldev_uuid">
const uuid_le * <code class="sig-name descname">mei_cldev_uuid</code><span class="sig-paren">(</span>const struct mei_cl_device<em> *cldev</em><span class="sig-paren">)</span><a class="headerlink" href="#c.mei_cldev_uuid" title="Permalink to this definition">¶</a></dt>
<dd><p>return uuid of the underlying me client</p>
</dd></dl>

<div class="kernelindent docutils container">
<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">const</span> <span class="pre">struct</span> <span class="pre">mei_cl_device</span> <span class="pre">*cldev</span></code></dt><dd><p>mei client device</p>
</dd>
</dl>
<p><strong>Return</strong></p>
<p>me client uuid</p>
</div>
<dl class="function">
<dt id="c.mei_cldev_ver">
u8 <code class="sig-name descname">mei_cldev_ver</code><span class="sig-paren">(</span>const struct mei_cl_device<em> *cldev</em><span class="sig-paren">)</span><a class="headerlink" href="#c.mei_cldev_ver" title="Permalink to this definition">¶</a></dt>
<dd><p>return protocol version of the underlying me client</p>
</dd></dl>

<div class="kernelindent docutils container">
<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">const</span> <span class="pre">struct</span> <span class="pre">mei_cl_device</span> <span class="pre">*cldev</span></code></dt><dd><p>mei client device</p>
</dd>
</dl>
<p><strong>Return</strong></p>
<p>me client protocol version</p>
</div>
<dl class="function">
<dt id="c.mei_cldev_enabled">
bool <code class="sig-name descname">mei_cldev_enabled</code><span class="sig-paren">(</span>const struct mei_cl_device<em> *cldev</em><span class="sig-paren">)</span><a class="headerlink" href="#c.mei_cldev_enabled" title="Permalink to this definition">¶</a></dt>
<dd><p>check whether the device is enabled</p>
</dd></dl>

<div class="kernelindent docutils container">
<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">const</span> <span class="pre">struct</span> <span class="pre">mei_cl_device</span> <span class="pre">*cldev</span></code></dt><dd><p>mei client device</p>
</dd>
</dl>
<p><strong>Return</strong></p>
<p>true if me client is initialized and connected</p>
</div>
<dl class="function">
<dt id="c.mei_cldev_enable">
int <code class="sig-name descname">mei_cldev_enable</code><span class="sig-paren">(</span>struct mei_cl_device<em> *cldev</em><span class="sig-paren">)</span><a class="headerlink" href="#c.mei_cldev_enable" title="Permalink to this definition">¶</a></dt>
<dd><p>enable me client device create connection with me client</p>
</dd></dl>

<div class="kernelindent docutils container">
<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">mei_cl_device</span> <span class="pre">*cldev</span></code></dt><dd><p>me client device</p>
</dd>
</dl>
<p><strong>Return</strong></p>
<p>0 on success and &lt; 0 on error</p>
</div>
<dl class="function">
<dt id="c.mei_cldev_disable">
int <code class="sig-name descname">mei_cldev_disable</code><span class="sig-paren">(</span>struct mei_cl_device<em> *cldev</em><span class="sig-paren">)</span><a class="headerlink" href="#c.mei_cldev_disable" title="Permalink to this definition">¶</a></dt>
<dd><p>disable me client device disconnect form the me client</p>
</dd></dl>

<div class="kernelindent docutils container">
<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">mei_cl_device</span> <span class="pre">*cldev</span></code></dt><dd><p>me client device</p>
</dd>
</dl>
<p><strong>Return</strong></p>
<p>0 on success and &lt; 0 on error</p>
</div>
<dl class="function">
<dt id="c.mei_cldev_send_gsc_command">
ssize_t <code class="sig-name descname">mei_cldev_send_gsc_command</code><span class="sig-paren">(</span>struct mei_cl_device<em> *cldev</em>, u8<em> client_id</em>, u32<em> fence_id</em>, struct scatterlist<em> *sg_in</em>, size_t<em> total_in_len</em>, struct scatterlist<em> *sg_out</em><span class="sig-paren">)</span><a class="headerlink" href="#c.mei_cldev_send_gsc_command" title="Permalink to this definition">¶</a></dt>
<dd><p>sends a gsc command, by sending a gsl mei message to gsc and receiving reply from gsc</p>
</dd></dl>

<div class="kernelindent docutils container">
<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">mei_cl_device</span> <span class="pre">*cldev</span></code></dt><dd><p>me client device</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">u8</span> <span class="pre">client_id</span></code></dt><dd><p>client id to send the command to</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">u32</span> <span class="pre">fence_id</span></code></dt><dd><p>fence id to send the command to</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">scatterlist</span> <span class="pre">*sg_in</span></code></dt><dd><p>scatter gather list containing addresses for rx message buffer</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">size_t</span> <span class="pre">total_in_len</span></code></dt><dd><p>total length of data in ‘in’ sg, can be less than the sum of buffers sizes</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">scatterlist</span> <span class="pre">*sg_out</span></code></dt><dd><p>scatter gather list containing addresses for tx message buffer</p>
</dd>
</dl>
<p><strong>Return</strong></p>
<blockquote>
<div><ul class="simple">
<li><p>written size in bytes</p></li>
<li><p>&lt; 0 on error</p></li>
</ul>
</div></blockquote>
</div>
</section>
</section>
<section id="example">
<h2>Example<a class="headerlink" href="#example" title="Permalink to this headline">¶</a></h2>
<p>As a theoretical example let’s pretend the ME comes with a “contact” NFC IP.
The driver init and exit routines for this device would look like:</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="cp">#define CONTACT_DRIVER_NAME &quot;contact&quot;</span>

<span class="k">static</span><span class="w"> </span><span class="k">struct</span> <span class="nc">mei_cl_device_id</span><span class="w"> </span><span class="n">contact_mei_cl_tbl</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="n">CONTACT_DRIVER_NAME</span><span class="p">,</span><span class="w"> </span><span class="p">},</span><span class="w"></span>

<span class="w">        </span><span class="cm">/* required last entry */</span><span class="w"></span>
<span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">mei_cl</span><span class="p">,</span><span class="w"> </span><span class="n">contact_mei_cl_tbl</span><span class="p">);</span><span class="w"></span>

<span class="k">static</span><span class="w"> </span><span class="k">struct</span> <span class="nc">mei_cl_driver</span><span class="w"> </span><span class="n">contact_driver</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">id_table</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">contact_mei_tbl</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CONTACT_DRIVER_NAME</span><span class="p">,</span><span class="w"></span>

<span class="w">        </span><span class="p">.</span><span class="n">probe</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">contact_probe</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">remove</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">contact_remove</span><span class="p">,</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>

<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">contact_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">r</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mei_cl_driver_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">contact_driver</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">r</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">pr_err</span><span class="p">(</span><span class="n">CONTACT_DRIVER_NAME</span><span class="w"> </span><span class="s">&quot;: driver registration failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="n">r</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">__exit</span><span class="w"> </span><span class="n">contact_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">mei_cl_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">contact_driver</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="n">module_init</span><span class="p">(</span><span class="n">contact_init</span><span class="p">);</span><span class="w"></span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">contact_exit</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<p>And the driver’s simplified probe routine would look like that:</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="nf">contact_probe</span><span class="p">(</span><span class="k">struct</span> <span class="nc">mei_cl_device</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span> <span class="nc">mei_cl_device_id</span><span class="w"> </span><span class="o">*</span><span class="n">id</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="p">[...]</span><span class="w"></span>
<span class="w">        </span><span class="n">mei_cldev_enable</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="n">mei_cldev_register_rx_cb</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="n">contact_rx_cb</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>In the probe routine the driver first enable the MEI device and then registers
an rx handler which is as close as it can get to registering a threaded IRQ handler.
The handler implementation will typically call <a class="reference internal" href="#c.mei_cldev_recv" title="mei_cldev_recv"><code class="xref c c-func docutils literal notranslate"><span class="pre">mei_cldev_recv()</span></code></a> and then
process received data.</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="cp">#define MAX_PAYLOAD 128</span>
<span class="cp">#define HDR_SIZE 4</span>
<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">conntact_rx_cb</span><span class="p">(</span><span class="k">struct</span> <span class="nc">mei_cl_device</span><span class="w"> </span><span class="o">*</span><span class="n">cldev</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">struct</span> <span class="nc">contact</span><span class="w"> </span><span class="o">*</span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mei_cldev_get_drvdata</span><span class="p">(</span><span class="n">cldev</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">payload</span><span class="p">[</span><span class="n">MAX_PAYLOAD</span><span class="p">];</span><span class="w"></span>
<span class="w">        </span><span class="kt">ssize_t</span><span class="w"> </span><span class="n">payload_sz</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="n">payload_sz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mei_cldev_recv</span><span class="p">(</span><span class="n">cldev</span><span class="p">,</span><span class="w"> </span><span class="n">payload</span><span class="p">,</span><span class="w">  </span><span class="n">MAX_PAYLOAD</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">reply_size</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">HDR_SIZE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="n">c</span><span class="o">-&gt;</span><span class="n">process_rx</span><span class="p">(</span><span class="n">payload</span><span class="p">);</span><span class="w"></span>

<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="mei-client-bus-drivers">
<h2>MEI Client Bus Drivers<a class="headerlink" href="#mei-client-bus-drivers" title="Permalink to this headline">¶</a></h2>
<div class="toctree-wrapper compound">
<ul>
<li class="toctree-l1"><a class="reference internal" href="hdcp.html">HDCP:</a><ul>
<li class="toctree-l2"><a class="reference internal" href="hdcp.html#mei-hdcp-driver">mei_hdcp driver</a></li>
<li class="toctree-l2"><a class="reference internal" href="hdcp.html#mei-hdcp-api">mei_hdcp api</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="nfc.html">MEI NFC</a></li>
</ul>
</div>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">The Linux Kernel</a></h1>



<p class="blurb">6.2.0-rc4-6.2.0-rc4+</p>







<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
  <h3><a href="../../index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Intel(R) Management Engine (ME) Client bus API</a><ul>
<li><a class="reference internal" href="#rationale">Rationale</a></li>
<li><a class="reference internal" href="#mei-cl-bus-api">MEI CL bus API</a><ul>
<li><a class="reference internal" href="#api">API:</a></li>
</ul>
</li>
<li><a class="reference internal" href="#example">Example</a></li>
<li><a class="reference internal" href="#mei-client-bus-drivers">MEI Client Bus Drivers</a></li>
</ul>
</li>
</ul>

  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../../_sources/driver-api/mei/mei-client-bus.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;The kernel development community.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 2.4.4</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="../../_sources/driver-api/mei/mei-client-bus.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>