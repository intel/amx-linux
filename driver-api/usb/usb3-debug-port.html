
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>USB3 debug port &#8212; The Linux Kernel 6.2.0-rc4+ documentation</title>
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Firewire (IEEE 1394) driver Interface Guide" href="../firewire.html" />
    <link rel="prev" title="API for USB Type-C Alternate Mode drivers" href="typec_bus.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="usb3-debug-port">
<h1>USB3 debug port<a class="headerlink" href="#usb3-debug-port" title="Permalink to this headline">¶</a></h1>
<dl class="field-list simple">
<dt class="field-odd">Author</dt>
<dd class="field-odd"><p>Lu Baolu &lt;<a class="reference external" href="mailto:baolu&#46;lu&#37;&#52;&#48;linux&#46;intel&#46;com">baolu<span>&#46;</span>lu<span>&#64;</span>linux<span>&#46;</span>intel<span>&#46;</span>com</a>&gt;</p>
</dd>
<dt class="field-even">Date</dt>
<dd class="field-even"><p>March 2017</p>
</dd>
</dl>
<section id="general">
<h2>GENERAL<a class="headerlink" href="#general" title="Permalink to this headline">¶</a></h2>
<p>This is a HOWTO for using the USB3 debug port on x86 systems.</p>
<p>Before using any kernel debugging functionality based on USB3
debug port, you need to:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>1) check whether any USB3 debug port is available in
   your system;
2) check which port is used for debugging purposes;
3) have a USB 3.0 super-speed A-to-A debugging cable.
</pre></div>
</div>
</section>
<section id="introduction">
<h2>INTRODUCTION<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p>The xHCI debug capability (DbC) is an optional but standalone
functionality provided by the xHCI host controller. The xHCI
specification describes DbC in the section 7.6.</p>
<p>When DbC is initialized and enabled, it will present a debug
device through the debug port (normally the first USB3
super-speed port). The debug device is fully compliant with
the USB framework and provides the equivalent of a very high
performance full-duplex serial link between the debug target
(the system under debugging) and a debug host.</p>
</section>
<section id="early-printk">
<h2>EARLY PRINTK<a class="headerlink" href="#early-printk" title="Permalink to this headline">¶</a></h2>
<p>DbC has been designed to log early printk messages. One use for
this feature is kernel debugging. For example, when your machine
crashes very early before the regular console code is initialized.
Other uses include simpler, lockless logging instead of a full-
blown printk console driver and klogd.</p>
<p>On the debug target system, you need to customize a debugging
kernel with CONFIG_EARLY_PRINTK_USB_XDBC enabled. And, add below
kernel boot parameter:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>&quot;earlyprintk=xdbc&quot;
</pre></div>
</div>
<p>If there are multiple xHCI controllers in your system, you can
append a host contoller index to this kernel parameter. This
index starts from 0.</p>
<p>Current design doesn’t support DbC runtime suspend/resume. As
the result, you’d better disable runtime power management for
USB subsystem by adding below kernel boot parameter:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>&quot;usbcore.autosuspend=-1&quot;
</pre></div>
</div>
<p>Before starting the debug target, you should connect the debug
port to a USB port (root port or port of any external hub) on
the debug host. The cable used to connect these two ports
should be a USB 3.0 super-speed A-to-A debugging cable.</p>
<p>During early boot of the debug target, DbC will be detected and
initialized. After initialization, the debug host should be able
to enumerate the debug device in debug target. The debug host
will then bind the debug device with the usb_debug driver module
and create the /dev/ttyUSB device.</p>
<p>If the debug device enumeration goes smoothly, you should be able
to see below kernel messages on the debug host:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># tail -f /var/log/kern.log
[ 1815.983374] usb 4-3: new SuperSpeed USB device number 4 using xhci_hcd
[ 1815.999595] usb 4-3: LPM exit latency is zeroed, disabling LPM.
[ 1815.999899] usb 4-3: New USB device found, idVendor=1d6b, idProduct=0004
[ 1815.999902] usb 4-3: New USB device strings: Mfr=1, Product=2, SerialNumber=3
[ 1815.999903] usb 4-3: Product: Remote GDB
[ 1815.999904] usb 4-3: Manufacturer: Linux
[ 1815.999905] usb 4-3: SerialNumber: 0001
[ 1816.000240] usb_debug 4-3:1.0: xhci_dbc converter detected
[ 1816.000360] usb 4-3: xhci_dbc converter now attached to ttyUSB0
</pre></div>
</div>
<p>You can use any communication program, for example minicom, to
read and view the messages. Below simple bash scripts can help
you to check the sanity of the setup.</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="o">=====</span> start of bash <span class="nv">scripts</span> <span class="o">=============</span>
<span class="c1">#!/bin/bash</span>

<span class="k">while</span> <span class="nb">true</span> <span class="p">;</span> <span class="k">do</span>
        <span class="k">while</span> <span class="o">[</span> ! -d /sys/class/tty/ttyUSB0 <span class="o">]</span> <span class="p">;</span> <span class="k">do</span>
                :
        <span class="k">done</span>
cat /dev/ttyUSB0
<span class="k">done</span>
<span class="o">=====</span> end of bash <span class="nv">scripts</span> <span class="o">===============</span>
</pre></div>
</div>
</section>
<section id="serial-tty">
<h2>Serial TTY<a class="headerlink" href="#serial-tty" title="Permalink to this headline">¶</a></h2>
<p>The DbC support has been added to the xHCI driver. You can get a
debug device provided by the DbC at runtime.</p>
<p>In order to use this, you need to make sure your kernel has been
configured to support USB_XHCI_DBGCAP. A sysfs attribute under
the xHCI device node is used to enable or disable DbC. By default,
DbC is disabled:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>root@target:/sys/bus/pci/devices/0000:00:14.0# cat dbc
disabled
</pre></div>
</div>
<p>Enable DbC with the following command:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>root@target:/sys/bus/pci/devices/0000:00:14.0# echo enable &gt; dbc
</pre></div>
</div>
<p>You can check the DbC state at anytime:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>root@target:/sys/bus/pci/devices/0000:00:14.0# cat dbc
enabled
</pre></div>
</div>
<p>Connect the debug target to the debug host with a USB 3.0 super-
speed A-to-A debugging cable. You can see /dev/ttyDBC0 created
on the debug target. You will see below kernel message lines:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>root@target: tail -f /var/log/kern.log
[  182.730103] xhci_hcd 0000:00:14.0: DbC connected
[  191.169420] xhci_hcd 0000:00:14.0: DbC configured
[  191.169597] xhci_hcd 0000:00:14.0: DbC now attached to /dev/ttyDBC0
</pre></div>
</div>
<p>Accordingly, the DbC state has been brought up to:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>root@target:/sys/bus/pci/devices/0000:00:14.0# cat dbc
configured
</pre></div>
</div>
<p>On the debug host, you will see the debug device has been enumerated.
You will see below kernel message lines:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>root@host: tail -f /var/log/kern.log
[   79.454780] usb 2-2.1: new SuperSpeed USB device number 3 using xhci_hcd
[   79.475003] usb 2-2.1: LPM exit latency is zeroed, disabling LPM.
[   79.475389] usb 2-2.1: New USB device found, idVendor=1d6b, idProduct=0010
[   79.475390] usb 2-2.1: New USB device strings: Mfr=1, Product=2, SerialNumber=3
[   79.475391] usb 2-2.1: Product: Linux USB Debug Target
[   79.475392] usb 2-2.1: Manufacturer: Linux Foundation
[   79.475393] usb 2-2.1: SerialNumber: 0001
</pre></div>
</div>
<p>The debug device works now. You can use any communication or debugging
program to talk between the host and the target.</p>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">The Linux Kernel</a></h1>



<p class="blurb">6.2.0-rc4-6.2.0-rc4+</p>







<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
  <h3><a href="../../index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">USB3 debug port</a><ul>
<li><a class="reference internal" href="#general">GENERAL</a></li>
<li><a class="reference internal" href="#introduction">INTRODUCTION</a></li>
<li><a class="reference internal" href="#early-printk">EARLY PRINTK</a></li>
<li><a class="reference internal" href="#serial-tty">Serial TTY</a></li>
</ul>
</li>
</ul>

  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../../_sources/driver-api/usb/usb3-debug-port.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;The kernel development community.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 2.4.4</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="../../_sources/driver-api/usb/usb3-debug-port.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>