
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Linux Switchtec Support &#8212; The Linux Kernel 6.2.0-rc4+ documentation</title>
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Sync File API Guide" href="sync_file.html" />
    <link rel="prev" title="Internal API Documentation" href="surface_aggregator/internal-api.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="linux-switchtec-support">
<h1>Linux Switchtec Support<a class="headerlink" href="#linux-switchtec-support" title="Permalink to this headline">¶</a></h1>
<p>Microsemi’s “Switchtec” line of PCI switch devices is already
supported by the kernel with standard PCI switch drivers. However, the
Switchtec device advertises a special management endpoint which
enables some additional functionality. This includes:</p>
<ul class="simple">
<li><p>Packet and Byte Counters</p></li>
<li><p>Firmware Upgrades</p></li>
<li><p>Event and Error logs</p></li>
<li><p>Querying port link status</p></li>
<li><p>Custom user firmware commands</p></li>
</ul>
<p>The switchtec kernel module implements this functionality.</p>
<section id="interface">
<h2>Interface<a class="headerlink" href="#interface" title="Permalink to this headline">¶</a></h2>
<p>The primary means of communicating with the Switchtec management firmware is
through the Memory-mapped Remote Procedure Call (MRPC) interface.
Commands are submitted to the interface with a 4-byte command
identifier and up to 1KB of command specific data. The firmware will
respond with a 4-byte return code and up to 1KB of command-specific
data. The interface only processes a single command at a time.</p>
</section>
<section id="userspace-interface">
<h2>Userspace Interface<a class="headerlink" href="#userspace-interface" title="Permalink to this headline">¶</a></h2>
<p>The MRPC interface will be exposed to userspace through a simple char
device: /dev/switchtec#, one for each management endpoint in the system.</p>
<p>The char device has the following semantics:</p>
<ul class="simple">
<li><p>A write must consist of at least 4 bytes and no more than 1028 bytes.
The first 4 bytes will be interpreted as the Command ID and the
remainder will be used as the input data. A write will send the
command to the firmware to begin processing.</p></li>
<li><p>Each write must be followed by exactly one read. Any double write will
produce an error and any read that doesn’t follow a write will
produce an error.</p></li>
<li><p>A read will block until the firmware completes the command and return
the 4-byte Command Return Value plus up to 1024 bytes of output
data. (The length will be specified by the size parameter of the read
call – reading less than 4 bytes will produce an error.)</p></li>
<li><p>The poll call will also be supported for userspace applications that
need to do other things while waiting for the command to complete.</p></li>
</ul>
<p>The following IOCTLs are also supported by the device:</p>
<ul class="simple">
<li><p>SWITCHTEC_IOCTL_FLASH_INFO - Retrieve firmware length and number
of partitions in the device.</p></li>
<li><p>SWITCHTEC_IOCTL_FLASH_PART_INFO - Retrieve address and lengeth for
any specified partition in flash.</p></li>
<li><p>SWITCHTEC_IOCTL_EVENT_SUMMARY - Read a structure of bitmaps
indicating all uncleared events.</p></li>
<li><p>SWITCHTEC_IOCTL_EVENT_CTL - Get the current count, clear and set flags
for any event. This ioctl takes in a switchtec_ioctl_event_ctl struct
with the event_id, index and flags set (index being the partition or PFF
number for non-global events). It returns whether the event has
occurred, the number of times and any event specific data. The flags
can be used to clear the count or enable and disable actions to
happen when the event occurs.
By using the SWITCHTEC_IOCTL_EVENT_FLAG_EN_POLL flag,
you can set an event to trigger a poll command to return with
POLLPRI. In this way, userspace can wait for events to occur.</p></li>
<li><p>SWITCHTEC_IOCTL_PFF_TO_PORT and SWITCHTEC_IOCTL_PORT_TO_PFF convert
between PCI Function Framework number (used by the event system)
and Switchtec Logic Port ID and Partition number (which is more
user friendly).</p></li>
</ul>
</section>
<section id="non-transparent-bridge-ntb-driver">
<h2>Non-Transparent Bridge (NTB) Driver<a class="headerlink" href="#non-transparent-bridge-ntb-driver" title="Permalink to this headline">¶</a></h2>
<p>An NTB hardware driver is provided for the Switchtec hardware in
ntb_hw_switchtec. Currently, it only supports switches configured with
exactly 2 NT partitions and zero or more non-NT partitions. It also requires
the following configuration settings:</p>
<ul class="simple">
<li><p>Both NT partitions must be able to access each other’s GAS spaces.
Thus, the bits in the GAS Access Vector under Management Settings
must be set to support this.</p></li>
<li><p>Kernel configuration MUST include support for NTB (CONFIG_NTB needs
to be set)</p></li>
</ul>
<p>NT EP BAR 2 will be dynamically configured as a Direct Window, and
the configuration file does not need to configure it explicitly.</p>
<p>Please refer to <a class="reference internal" href="ntb.html"><span class="doc">NTB Drivers</span></a> in Linux source tree for an overall
understanding of the Linux NTB stack. ntb_hw_switchtec works as an NTB
Hardware Driver in this stack.</p>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../index.html">The Linux Kernel</a></h1>



<p class="blurb">6.2.0-rc4-6.2.0-rc4+</p>







<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
  <h3><a href="../index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Linux Switchtec Support</a><ul>
<li><a class="reference internal" href="#interface">Interface</a></li>
<li><a class="reference internal" href="#userspace-interface">Userspace Interface</a></li>
<li><a class="reference internal" href="#non-transparent-bridge-ntb-driver">Non-Transparent Bridge (NTB) Driver</a></li>
</ul>
</li>
</ul>

  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/driver-api/switchtec.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;The kernel development community.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 2.4.4</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="../_sources/driver-api/switchtec.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>