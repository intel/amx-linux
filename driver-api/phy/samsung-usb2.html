
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Samsung USB 2.0 PHY adaptation layer &#8212; The Linux Kernel 6.2.0-rc4+ documentation</title>
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Pulse Width Modulation (PWM) interface" href="../pwm.html" />
    <link rel="prev" title="PHY subsystem" href="phy.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="samsung-usb-2-0-phy-adaptation-layer">
<h1>Samsung USB 2.0 PHY adaptation layer<a class="headerlink" href="#samsung-usb-2-0-phy-adaptation-layer" title="Permalink to this headline">¶</a></h1>
<section id="description">
<h2>1. Description<a class="headerlink" href="#description" title="Permalink to this headline">¶</a></h2>
<p>The architecture of the USB 2.0 PHY module in Samsung SoCs is similar
among many SoCs. In spite of the similarities it proved difficult to
create a one driver that would fit all these PHY controllers. Often
the differences were minor and were found in particular bits of the
registers of the PHY. In some rare cases the order of register writes or
the PHY powering up process had to be altered. This adaptation layer is
a compromise between having separate drivers and having a single driver
with added support for many special cases.</p>
</section>
<section id="files-description">
<h2>2. Files description<a class="headerlink" href="#files-description" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><dl class="simple">
<dt>phy-samsung-usb2.c</dt><dd><p>This is the main file of the adaptation layer. This file contains
the probe function and provides two callbacks to the Generic PHY
Framework. This two callbacks are used to power on and power off the
phy. They carry out the common work that has to be done on all version
of the PHY module. Depending on which SoC was chosen they execute SoC
specific callbacks. The specific SoC version is selected by choosing
the appropriate compatible string. In addition, this file contains
struct of_device_id definitions for particular SoCs.</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>phy-samsung-usb2.h</dt><dd><p>This is the include file. It declares the structures used by this
driver. In addition it should contain extern declarations for
structures that describe particular SoCs.</p>
</dd>
</dl>
</li>
</ul>
</section>
<section id="supporting-socs">
<h2>3. Supporting SoCs<a class="headerlink" href="#supporting-socs" title="Permalink to this headline">¶</a></h2>
<p>To support a new SoC a new file should be added to the drivers/phy
directory. Each SoC’s configuration is stored in an instance of the
struct samsung_usb2_phy_config:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>struct samsung_usb2_phy_config {
      const struct samsung_usb2_common_phy *phys;
      int (*rate_to_clk)(unsigned long, u32 *);
      unsigned int num_phys;
      bool has_mode_switch;
};
</pre></div>
</div>
<p>The num_phys is the number of phys handled by the driver. <cite>*phys</cite> is an
array that contains the configuration for each phy. The has_mode_switch
property is a boolean flag that determines whether the SoC has USB host
and device on a single pair of pins. If so, a special register has to
be modified to change the internal routing of these pins between a USB
device or host module.</p>
<p>For example the configuration for Exynos 4210 is following:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>const struct samsung_usb2_phy_config exynos4210_usb2_phy_config = {
      .has_mode_switch        = 0,
      .num_phys               = EXYNOS4210_NUM_PHYS,
      .phys                   = exynos4210_phys,
      .rate_to_clk            = exynos4210_rate_to_clk,
}
</pre></div>
</div>
<ul>
<li><p><cite>int (*rate_to_clk)(unsigned long, u32 *)</cite></p>
<blockquote>
<div><p>The rate_to_clk callback is to convert the rate of the clock
used as the reference clock for the PHY module to the value
that should be written in the hardware register.</p>
</div></blockquote>
</li>
</ul>
<p>The exynos4210_phys configuration array is as follows:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>static const struct samsung_usb2_common_phy exynos4210_phys[] = {
      {
              .label          = &quot;device&quot;,
              .id             = EXYNOS4210_DEVICE,
              .power_on       = exynos4210_power_on,
              .power_off      = exynos4210_power_off,
      },
      {
              .label          = &quot;host&quot;,
              .id             = EXYNOS4210_HOST,
              .power_on       = exynos4210_power_on,
              .power_off      = exynos4210_power_off,
      },
      {
              .label          = &quot;hsic0&quot;,
              .id             = EXYNOS4210_HSIC0,
              .power_on       = exynos4210_power_on,
              .power_off      = exynos4210_power_off,
      },
      {
              .label          = &quot;hsic1&quot;,
              .id             = EXYNOS4210_HSIC1,
              .power_on       = exynos4210_power_on,
              .power_off      = exynos4210_power_off,
      },
      {},
};
</pre></div>
</div>
<ul>
<li><p><cite>int (*power_on)(struct samsung_usb2_phy_instance *);</cite>
<cite>int (*power_off)(struct samsung_usb2_phy_instance *);</cite></p>
<blockquote>
<div><p>These two callbacks are used to power on and power off the phy
by modifying appropriate registers.</p>
</div></blockquote>
</li>
</ul>
<p>Final change to the driver is adding appropriate compatible value to the
phy-samsung-usb2.c file. In case of Exynos 4210 the following lines were
added to the struct of_device_id samsung_usb2_phy_of_match[] array:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>#ifdef CONFIG_PHY_EXYNOS4210_USB2
      {
              .compatible = &quot;samsung,exynos4210-usb2-phy&quot;,
              .data = &amp;exynos4210_usb2_phy_config,
      },
#endif
</pre></div>
</div>
<p>To add further flexibility to the driver the Kconfig file enables to
include support for selected SoCs in the compiled driver. The Kconfig
entry for Exynos 4210 is following:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>config PHY_EXYNOS4210_USB2
      bool &quot;Support for Exynos 4210&quot;
      depends on PHY_SAMSUNG_USB2
      depends on CPU_EXYNOS4210
      help
        Enable USB PHY support for Exynos 4210. This option requires that
        Samsung USB 2.0 PHY driver is enabled and means that support for this
        particular SoC is compiled in the driver. In case of Exynos 4210 four
        phys are available - device, host, HSCI0 and HSCI1.
</pre></div>
</div>
<p>The newly created file that supports the new SoC has to be also added to the
Makefile. In case of Exynos 4210 the added line is following:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>obj-$(CONFIG_PHY_EXYNOS4210_USB2)       += phy-exynos4210-usb2.o
</pre></div>
</div>
<p>After completing these steps the support for the new SoC should be ready.</p>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">The Linux Kernel</a></h1>



<p class="blurb">6.2.0-rc4-6.2.0-rc4+</p>







<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
  <h3><a href="../../index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Samsung USB 2.0 PHY adaptation layer</a><ul>
<li><a class="reference internal" href="#description">1. Description</a></li>
<li><a class="reference internal" href="#files-description">2. Files description</a></li>
<li><a class="reference internal" href="#supporting-socs">3. Supporting SoCs</a></li>
</ul>
</li>
</ul>

  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../../_sources/driver-api/phy/samsung-usb2.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;The kernel development community.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 2.4.4</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="../../_sources/driver-api/phy/samsung-usb2.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>