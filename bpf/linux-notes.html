
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>1 Linux implementation notes &#8212; The Linux Kernel 6.2.0-rc4+ documentation</title>
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Other" href="other.html" />
    <link rel="prev" title="1 Clang implementation notes" href="clang-notes.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <div class="contents topic" id="contents">
<p class="topic-title">Contents</p>
<ul class="auto-toc simple">
<li><p><a class="reference internal" href="#linux-implementation-notes" id="id1"><span class="sectnum">1</span> Linux implementation notes</a></p>
<ul class="auto-toc">
<li><p><a class="reference internal" href="#byte-swap-instructions" id="id2"><span class="sectnum">1.1</span> Byte swap instructions</a></p></li>
<li><p><a class="reference internal" href="#legacy-bpf-packet-access-instructions" id="id3"><span class="sectnum">1.2</span> Legacy BPF Packet access instructions</a></p></li>
</ul>
</li>
</ul>
</div>
<section id="linux-implementation-notes">
<h1><a class="toc-backref" href="#id1"><span class="sectnum">1</span> Linux implementation notes</a><a class="headerlink" href="#linux-implementation-notes" title="Permalink to this headline">¶</a></h1>
<p>This document provides more details specific to the Linux kernel implementation of the eBPF instruction set.</p>
<section id="byte-swap-instructions">
<h2><a class="toc-backref" href="#id2"><span class="sectnum">1.1</span> Byte swap instructions</a><a class="headerlink" href="#byte-swap-instructions" title="Permalink to this headline">¶</a></h2>
<p><code class="docutils literal notranslate"><span class="pre">BPF_FROM_LE</span></code> and <code class="docutils literal notranslate"><span class="pre">BPF_FROM_BE</span></code> exist as aliases for <code class="docutils literal notranslate"><span class="pre">BPF_TO_LE</span></code> and <code class="docutils literal notranslate"><span class="pre">BPF_TO_BE</span></code> respectively.</p>
</section>
<section id="legacy-bpf-packet-access-instructions">
<h2><a class="toc-backref" href="#id3"><span class="sectnum">1.2</span> Legacy BPF Packet access instructions</a><a class="headerlink" href="#legacy-bpf-packet-access-instructions" title="Permalink to this headline">¶</a></h2>
<p>As mentioned in the <a class="reference external" href="instruction-set.rst#legacy-bpf-packet-access-instructions">ISA standard documentation</a>,
Linux has special eBPF instructions for access to packet data that have been
carried over from classic BPF to retain the performance of legacy socket
filters running in the eBPF interpreter.</p>
<p>The instructions come in two forms: <code class="docutils literal notranslate"><span class="pre">BPF_ABS</span> <span class="pre">|</span> <span class="pre">&lt;size&gt;</span> <span class="pre">|</span> <span class="pre">BPF_LD</span></code> and
<code class="docutils literal notranslate"><span class="pre">BPF_IND</span> <span class="pre">|</span> <span class="pre">&lt;size&gt;</span> <span class="pre">|</span> <span class="pre">BPF_LD</span></code>.</p>
<p>These instructions are used to access packet data and can only be used when
the program context is a pointer to a networking packet.  <code class="docutils literal notranslate"><span class="pre">BPF_ABS</span></code>
accesses packet data at an absolute offset specified by the immediate data
and <code class="docutils literal notranslate"><span class="pre">BPF_IND</span></code> access packet data at an offset that includes the value of
a register in addition to the immediate data.</p>
<p>These instructions have seven implicit operands:</p>
<ul class="simple">
<li><p>Register R6 is an implicit input that must contain a pointer to a
<a class="reference internal" href="../networking/kapi.html#c.sk_buff" title="sk_buff"><code class="xref c c-type docutils literal notranslate"><span class="pre">struct</span> <span class="pre">sk_buff</span></code></a>.</p></li>
<li><p>Register R0 is an implicit output which contains the data fetched from
the packet.</p></li>
<li><p>Registers R1-R5 are scratch registers that are clobbered by the
instruction.</p></li>
</ul>
<p>These instructions have an implicit program exit condition as well. If an
eBPF program attempts access data beyond the packet boundary, the
program execution will be aborted.</p>
<p><code class="docutils literal notranslate"><span class="pre">BPF_ABS</span> <span class="pre">|</span> <span class="pre">BPF_W</span> <span class="pre">|</span> <span class="pre">BPF_LD</span></code> (0x20) means:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>R0 = ntohl(*(u32 *) ((struct sk_buff *) R6-&gt;data + imm))
</pre></div>
</div>
<p>where <code class="docutils literal notranslate"><span class="pre">ntohl()</span></code> converts a 32-bit value from network byte order to host byte order.</p>
<p><code class="docutils literal notranslate"><span class="pre">BPF_IND</span> <span class="pre">|</span> <span class="pre">BPF_W</span> <span class="pre">|</span> <span class="pre">BPF_LD</span></code> (0x40) means:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>R0 = ntohl(*(u32 *) ((struct sk_buff *) R6-&gt;data + src + imm))
</pre></div>
</div>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../index.html">The Linux Kernel</a></h1>



<p class="blurb">6.2.0-rc4-6.2.0-rc4+</p>







<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
  <h3><a href="../index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#"><span class="sectnum">1</span> Linux implementation notes</a><ul>
<li><a class="reference internal" href="#byte-swap-instructions"><span class="sectnum">1.1</span> Byte swap instructions</a></li>
<li><a class="reference internal" href="#legacy-bpf-packet-access-instructions"><span class="sectnum">1.2</span> Legacy BPF Packet access instructions</a></li>
</ul>
</li>
</ul>

  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/bpf/linux-notes.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;The kernel development community.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 2.4.4</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="../_sources/bpf/linux-notes.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>