
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>BPF_MAP_TYPE_QUEUE and BPF_MAP_TYPE_STACK &#8212; The Linux Kernel 6.2.0-rc4+ documentation</title>
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="BPF_MAP_TYPE_SK_STORAGE" href="map_sk_storage.html" />
    <link rel="prev" title="BPF_MAP_TYPE_ARRAY_OF_MAPS and BPF_MAP_TYPE_HASH_OF_MAPS" href="map_of_maps.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="bpf-map-type-queue-and-bpf-map-type-stack">
<h1>BPF_MAP_TYPE_QUEUE and BPF_MAP_TYPE_STACK<a class="headerlink" href="#bpf-map-type-queue-and-bpf-map-type-stack" title="Permalink to this headline">¶</a></h1>
<div class="admonition note">
<p class="admonition-title">Note</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">BPF_MAP_TYPE_QUEUE</span></code> and <code class="docutils literal notranslate"><span class="pre">BPF_MAP_TYPE_STACK</span></code> were introduced
in kernel version 4.20</p></li>
</ul>
</div>
<p><code class="docutils literal notranslate"><span class="pre">BPF_MAP_TYPE_QUEUE</span></code> provides FIFO storage and <code class="docutils literal notranslate"><span class="pre">BPF_MAP_TYPE_STACK</span></code>
provides LIFO storage for BPF programs. These maps support peek, pop and
push operations that are exposed to BPF programs through the respective
helpers. These operations are exposed to userspace applications using
the existing <code class="docutils literal notranslate"><span class="pre">bpf</span></code> syscall in the following way:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">BPF_MAP_LOOKUP_ELEM</span></code> -&gt; peek</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">BPF_MAP_LOOKUP_AND_DELETE_ELEM</span></code> -&gt; pop</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">BPF_MAP_UPDATE_ELEM</span></code> -&gt; push</p></li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">BPF_MAP_TYPE_QUEUE</span></code> and <code class="docutils literal notranslate"><span class="pre">BPF_MAP_TYPE_STACK</span></code> do not support
<code class="docutils literal notranslate"><span class="pre">BPF_F_NO_PREALLOC</span></code>.</p>
<section id="usage">
<h2>Usage<a class="headerlink" href="#usage" title="Permalink to this headline">¶</a></h2>
<section id="kernel-bpf">
<h3>Kernel BPF<a class="headerlink" href="#kernel-bpf" title="Permalink to this headline">¶</a></h3>
<section id="bpf-map-push-elem">
<h4>bpf_map_push_elem()<a class="headerlink" href="#bpf-map-push-elem" title="Permalink to this headline">¶</a></h4>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">long</span><span class="w"> </span><span class="n">bpf_map_push_elem</span><span class="p">(</span><span class="k">struct</span> <span class="nc">bpf_map</span><span class="w"> </span><span class="o">*</span><span class="n">map</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="n">u64</span><span class="w"> </span><span class="n">flags</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
<p>An element <code class="docutils literal notranslate"><span class="pre">value</span></code> can be added to a queue or stack using the
<code class="docutils literal notranslate"><span class="pre">bpf_map_push_elem</span></code> helper. The <code class="docutils literal notranslate"><span class="pre">flags</span></code> parameter must be set to
<code class="docutils literal notranslate"><span class="pre">BPF_ANY</span></code> or <code class="docutils literal notranslate"><span class="pre">BPF_EXIST</span></code>. If <code class="docutils literal notranslate"><span class="pre">flags</span></code> is set to <code class="docutils literal notranslate"><span class="pre">BPF_EXIST</span></code> then,
when the queue or stack is full, the oldest element will be removed to
make room for <code class="docutils literal notranslate"><span class="pre">value</span></code> to be added. Returns <code class="docutils literal notranslate"><span class="pre">0</span></code> on success, or
negative error in case of failure.</p>
</section>
<section id="bpf-map-peek-elem">
<h4>bpf_map_peek_elem()<a class="headerlink" href="#bpf-map-peek-elem" title="Permalink to this headline">¶</a></h4>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">long</span><span class="w"> </span><span class="n">bpf_map_peek_elem</span><span class="p">(</span><span class="k">struct</span> <span class="nc">bpf_map</span><span class="w"> </span><span class="o">*</span><span class="n">map</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">value</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
<p>This helper fetches an element <code class="docutils literal notranslate"><span class="pre">value</span></code> from a queue or stack without
removing it. Returns <code class="docutils literal notranslate"><span class="pre">0</span></code> on success, or negative error in case of
failure.</p>
</section>
<section id="bpf-map-pop-elem">
<h4>bpf_map_pop_elem()<a class="headerlink" href="#bpf-map-pop-elem" title="Permalink to this headline">¶</a></h4>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">long</span><span class="w"> </span><span class="n">bpf_map_pop_elem</span><span class="p">(</span><span class="k">struct</span> <span class="nc">bpf_map</span><span class="w"> </span><span class="o">*</span><span class="n">map</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">value</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
<p>This helper removes an element into <code class="docutils literal notranslate"><span class="pre">value</span></code> from a queue or
stack. Returns <code class="docutils literal notranslate"><span class="pre">0</span></code> on success, or negative error in case of failure.</p>
</section>
</section>
<section id="userspace">
<h3>Userspace<a class="headerlink" href="#userspace" title="Permalink to this headline">¶</a></h3>
<section id="bpf-map-update-elem">
<h4>bpf_map_update_elem()<a class="headerlink" href="#bpf-map-update-elem" title="Permalink to this headline">¶</a></h4>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="n">bpf_map_update_elem</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="n">__u64</span><span class="w"> </span><span class="n">flags</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
<p>A userspace program can push <code class="docutils literal notranslate"><span class="pre">value</span></code> onto a queue or stack using libbpf’s
<code class="docutils literal notranslate"><span class="pre">bpf_map_update_elem</span></code> function. The <code class="docutils literal notranslate"><span class="pre">key</span></code> parameter must be set to
<code class="docutils literal notranslate"><span class="pre">NULL</span></code> and <code class="docutils literal notranslate"><span class="pre">flags</span></code> must be set to <code class="docutils literal notranslate"><span class="pre">BPF_ANY</span></code> or <code class="docutils literal notranslate"><span class="pre">BPF_EXIST</span></code>, with the
same semantics as the <code class="docutils literal notranslate"><span class="pre">bpf_map_push_elem</span></code> kernel helper. Returns <code class="docutils literal notranslate"><span class="pre">0</span></code> on
success, or negative error in case of failure.</p>
</section>
<section id="bpf-map-lookup-elem">
<h4>bpf_map_lookup_elem()<a class="headerlink" href="#bpf-map-lookup-elem" title="Permalink to this headline">¶</a></h4>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="n">bpf_map_lookup_elem</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">value</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
<p>A userspace program can peek at the <code class="docutils literal notranslate"><span class="pre">value</span></code> at the head of a queue or stack
using the libbpf <code class="docutils literal notranslate"><span class="pre">bpf_map_lookup_elem</span></code> function. The <code class="docutils literal notranslate"><span class="pre">key</span></code> parameter must be
set to <code class="docutils literal notranslate"><span class="pre">NULL</span></code>.  Returns <code class="docutils literal notranslate"><span class="pre">0</span></code> on success, or negative error in case of
failure.</p>
</section>
<section id="bpf-map-lookup-and-delete-elem">
<h4>bpf_map_lookup_and_delete_elem()<a class="headerlink" href="#bpf-map-lookup-and-delete-elem" title="Permalink to this headline">¶</a></h4>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="n">bpf_map_lookup_and_delete_elem</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">value</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
<p>A userspace program can pop a <code class="docutils literal notranslate"><span class="pre">value</span></code> from the head of a queue or stack using
the libbpf <code class="docutils literal notranslate"><span class="pre">bpf_map_lookup_and_delete_elem</span></code> function. The <code class="docutils literal notranslate"><span class="pre">key</span></code> parameter
must be set to <code class="docutils literal notranslate"><span class="pre">NULL</span></code>. Returns <code class="docutils literal notranslate"><span class="pre">0</span></code> on success, or negative error in case of
failure.</p>
</section>
</section>
</section>
<section id="examples">
<h2>Examples<a class="headerlink" href="#examples" title="Permalink to this headline">¶</a></h2>
<section id="id1">
<h3>Kernel BPF<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<p>This snippet shows how to declare a queue in a BPF program:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">struct</span> <span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">__uint</span><span class="p">(</span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="n">BPF_MAP_TYPE_QUEUE</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">__type</span><span class="p">(</span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="n">__u32</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">__uint</span><span class="p">(</span><span class="n">max_entries</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"> </span><span class="n">queue</span><span class="w"> </span><span class="n">SEC</span><span class="p">(</span><span class="s">&quot;.maps&quot;</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="id2">
<h3>Userspace<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h3>
<p>This snippet shows how to use libbpf’s low-level API to create a queue from
userspace:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="nf">create_queue</span><span class="p">()</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">bpf_map_create</span><span class="p">(</span><span class="n">BPF_MAP_TYPE_QUEUE</span><span class="p">,</span><span class="w"></span>
<span class="w">                              </span><span class="s">&quot;sample_queue&quot;</span><span class="p">,</span><span class="w"> </span><span class="cm">/* name */</span><span class="w"></span>
<span class="w">                              </span><span class="mi">0</span><span class="p">,</span><span class="w">              </span><span class="cm">/* key size, must be zero */</span><span class="w"></span>
<span class="w">                              </span><span class="k">sizeof</span><span class="p">(</span><span class="n">__u32</span><span class="p">),</span><span class="w">  </span><span class="cm">/* value size */</span><span class="w"></span>
<span class="w">                              </span><span class="mi">10</span><span class="p">,</span><span class="w">             </span><span class="cm">/* max entries */</span><span class="w"></span>
<span class="w">                              </span><span class="nb">NULL</span><span class="p">);</span><span class="w">          </span><span class="cm">/* create options */</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
</section>
<section id="references">
<h2>References<a class="headerlink" href="#references" title="Permalink to this headline">¶</a></h2>
<p><a class="reference external" href="https://lwn.net/ml/netdev/153986858555.9127.14517764371945179514.stgit&#64;kernel/">https://lwn.net/ml/netdev/153986858555.9127.14517764371945179514.stgit&#64;kernel/</a></p>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../index.html">The Linux Kernel</a></h1>



<p class="blurb">6.2.0-rc4-6.2.0-rc4+</p>







<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
  <h3><a href="../index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">BPF_MAP_TYPE_QUEUE and BPF_MAP_TYPE_STACK</a><ul>
<li><a class="reference internal" href="#usage">Usage</a><ul>
<li><a class="reference internal" href="#kernel-bpf">Kernel BPF</a><ul>
<li><a class="reference internal" href="#bpf-map-push-elem">bpf_map_push_elem()</a></li>
<li><a class="reference internal" href="#bpf-map-peek-elem">bpf_map_peek_elem()</a></li>
<li><a class="reference internal" href="#bpf-map-pop-elem">bpf_map_pop_elem()</a></li>
</ul>
</li>
<li><a class="reference internal" href="#userspace">Userspace</a><ul>
<li><a class="reference internal" href="#bpf-map-update-elem">bpf_map_update_elem()</a></li>
<li><a class="reference internal" href="#bpf-map-lookup-elem">bpf_map_lookup_elem()</a></li>
<li><a class="reference internal" href="#bpf-map-lookup-and-delete-elem">bpf_map_lookup_and_delete_elem()</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#examples">Examples</a><ul>
<li><a class="reference internal" href="#id1">Kernel BPF</a></li>
<li><a class="reference internal" href="#id2">Userspace</a></li>
</ul>
</li>
<li><a class="reference internal" href="#references">References</a></li>
</ul>
</li>
</ul>

  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/bpf/map_queue_stack.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;The kernel development community.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 2.4.4</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="../_sources/bpf/map_queue_stack.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>