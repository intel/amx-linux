
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>1 eBPF Instruction Set Specification, v1.0 &#8212; The Linux Kernel 6.2.0-rc4+ documentation</title>
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="eBPF verifier" href="verifier.html" />
    <link rel="prev" title="BPF Documentation" href="index.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <div class="contents topic" id="contents">
<p class="topic-title">Contents</p>
<ul class="auto-toc simple">
<li><p><a class="reference internal" href="#ebpf-instruction-set-specification-v1-0" id="id1"><span class="sectnum">1</span> eBPF Instruction Set Specification, v1.0</a></p>
<ul class="auto-toc">
<li><p><a class="reference internal" href="#registers-and-calling-convention" id="id2"><span class="sectnum">1.1</span> Registers and calling convention</a></p></li>
<li><p><a class="reference internal" href="#instruction-encoding" id="id3"><span class="sectnum">1.2</span> Instruction encoding</a></p>
<ul class="auto-toc">
<li><p><a class="reference internal" href="#instruction-classes" id="id4"><span class="sectnum">1.2.1</span> Instruction classes</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#arithmetic-and-jump-instructions" id="id5"><span class="sectnum">1.3</span> Arithmetic and jump instructions</a></p>
<ul class="auto-toc">
<li><p><a class="reference internal" href="#arithmetic-instructions" id="id6"><span class="sectnum">1.3.1</span> Arithmetic instructions</a></p>
<ul class="auto-toc">
<li><p><a class="reference internal" href="#byte-swap-instructions" id="id7"><span class="sectnum">1.3.1.1</span> Byte swap instructions</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#jump-instructions" id="id8"><span class="sectnum">1.3.2</span> Jump instructions</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#load-and-store-instructions" id="id9"><span class="sectnum">1.4</span> Load and store instructions</a></p>
<ul class="auto-toc">
<li><p><a class="reference internal" href="#regular-load-and-store-operations" id="id10"><span class="sectnum">1.4.1</span> Regular load and store operations</a></p></li>
<li><p><a class="reference internal" href="#atomic-operations" id="id11"><span class="sectnum">1.4.2</span> Atomic operations</a></p></li>
<li><p><a class="reference internal" href="#bit-immediate-instructions" id="id12"><span class="sectnum">1.4.3</span> 64-bit immediate instructions</a></p></li>
<li><p><a class="reference internal" href="#legacy-bpf-packet-access-instructions" id="id13"><span class="sectnum">1.4.4</span> Legacy BPF Packet access instructions</a></p></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<section id="ebpf-instruction-set-specification-v1-0">
<h1><a class="toc-backref" href="#id1"><span class="sectnum">1</span> eBPF Instruction Set Specification, v1.0</a><a class="headerlink" href="#ebpf-instruction-set-specification-v1-0" title="Permalink to this headline">¶</a></h1>
<p>This document specifies version 1.0 of the eBPF instruction set.</p>
<section id="registers-and-calling-convention">
<h2><a class="toc-backref" href="#id2"><span class="sectnum">1.1</span> Registers and calling convention</a><a class="headerlink" href="#registers-and-calling-convention" title="Permalink to this headline">¶</a></h2>
<p>eBPF has 10 general purpose registers and a read-only frame pointer register,
all of which are 64-bits wide.</p>
<p>The eBPF calling convention is defined as:</p>
<ul class="simple">
<li><p>R0: return value from function calls, and exit value for eBPF programs</p></li>
<li><p>R1 - R5: arguments for function calls</p></li>
<li><p>R6 - R9: callee saved registers that function calls will preserve</p></li>
<li><p>R10: read-only frame pointer to access stack</p></li>
</ul>
<p>R0 - R5 are scratch registers and eBPF programs needs to spill/fill them if
necessary across calls.</p>
</section>
<section id="instruction-encoding">
<h2><a class="toc-backref" href="#id3"><span class="sectnum">1.2</span> Instruction encoding</a><a class="headerlink" href="#instruction-encoding" title="Permalink to this headline">¶</a></h2>
<p>eBPF has two instruction encodings:</p>
<ul class="simple">
<li><p>the basic instruction encoding, which uses 64 bits to encode an instruction</p></li>
<li><p>the wide instruction encoding, which appends a second 64-bit immediate value
(imm64) after the basic instruction for a total of 128 bits.</p></li>
</ul>
<p>The basic instruction encoding looks as follows:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 19%" />
<col style="width: 10%" />
<col style="width: 22%" />
<col style="width: 30%" />
<col style="width: 18%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>32 bits (MSB)</p></th>
<th class="head"><p>16 bits</p></th>
<th class="head"><p>4 bits</p></th>
<th class="head"><p>4 bits</p></th>
<th class="head"><p>8 bits (LSB)</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>immediate</p></td>
<td><p>offset</p></td>
<td><p>source register</p></td>
<td><p>destination register</p></td>
<td><p>opcode</p></td>
</tr>
</tbody>
</table>
<p>Note that most instructions do not use all of the fields.
Unused fields shall be cleared to zero.</p>
<section id="instruction-classes">
<h3><a class="toc-backref" href="#id4"><span class="sectnum">1.2.1</span> Instruction classes</a><a class="headerlink" href="#instruction-classes" title="Permalink to this headline">¶</a></h3>
<p>The three LSB bits of the ‘opcode’ field store the instruction class:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 11%" />
<col style="width: 6%" />
<col style="width: 39%" />
<col style="width: 44%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>class</p></th>
<th class="head"><p>value</p></th>
<th class="head"><p>description</p></th>
<th class="head"><p>reference</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>BPF_LD</p></td>
<td><p>0x00</p></td>
<td><p>non-standard load operations</p></td>
<td><p><a class="reference internal" href="#load-and-store-instructions">Load and store instructions</a></p></td>
</tr>
<tr class="row-odd"><td><p>BPF_LDX</p></td>
<td><p>0x01</p></td>
<td><p>load into register operations</p></td>
<td><p><a class="reference internal" href="#load-and-store-instructions">Load and store instructions</a></p></td>
</tr>
<tr class="row-even"><td><p>BPF_ST</p></td>
<td><p>0x02</p></td>
<td><p>store from immediate operations</p></td>
<td><p><a class="reference internal" href="#load-and-store-instructions">Load and store instructions</a></p></td>
</tr>
<tr class="row-odd"><td><p>BPF_STX</p></td>
<td><p>0x03</p></td>
<td><p>store from register operations</p></td>
<td><p><a class="reference internal" href="#load-and-store-instructions">Load and store instructions</a></p></td>
</tr>
<tr class="row-even"><td><p>BPF_ALU</p></td>
<td><p>0x04</p></td>
<td><p>32-bit arithmetic operations</p></td>
<td><p><a class="reference internal" href="#arithmetic-and-jump-instructions">Arithmetic and jump instructions</a></p></td>
</tr>
<tr class="row-odd"><td><p>BPF_JMP</p></td>
<td><p>0x05</p></td>
<td><p>64-bit jump operations</p></td>
<td><p><a class="reference internal" href="#arithmetic-and-jump-instructions">Arithmetic and jump instructions</a></p></td>
</tr>
<tr class="row-even"><td><p>BPF_JMP32</p></td>
<td><p>0x06</p></td>
<td><p>32-bit jump operations</p></td>
<td><p><a class="reference internal" href="#arithmetic-and-jump-instructions">Arithmetic and jump instructions</a></p></td>
</tr>
<tr class="row-odd"><td><p>BPF_ALU64</p></td>
<td><p>0x07</p></td>
<td><p>64-bit arithmetic operations</p></td>
<td><p><a class="reference internal" href="#arithmetic-and-jump-instructions">Arithmetic and jump instructions</a></p></td>
</tr>
</tbody>
</table>
</section>
</section>
<section id="arithmetic-and-jump-instructions">
<h2><a class="toc-backref" href="#id5"><span class="sectnum">1.3</span> Arithmetic and jump instructions</a><a class="headerlink" href="#arithmetic-and-jump-instructions" title="Permalink to this headline">¶</a></h2>
<p>For arithmetic and jump instructions (<code class="docutils literal notranslate"><span class="pre">BPF_ALU</span></code>, <code class="docutils literal notranslate"><span class="pre">BPF_ALU64</span></code>, <code class="docutils literal notranslate"><span class="pre">BPF_JMP</span></code> and
<code class="docutils literal notranslate"><span class="pre">BPF_JMP32</span></code>), the 8-bit ‘opcode’ field is divided into three parts:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 38%" />
<col style="width: 16%" />
<col style="width: 46%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>4 bits (MSB)</p></th>
<th class="head"><p>1 bit</p></th>
<th class="head"><p>3 bits (LSB)</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>operation code</p></td>
<td><p>source</p></td>
<td><p>instruction class</p></td>
</tr>
</tbody>
</table>
<p>The 4th bit encodes the source operand:</p>
<blockquote>
<div><table class="docutils align-default">
<colgroup>
<col style="width: 12%" />
<col style="width: 10%" />
<col style="width: 78%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>source</p></th>
<th class="head"><p>value</p></th>
<th class="head"><p>description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>BPF_K</p></td>
<td><p>0x00</p></td>
<td><p>use 32-bit immediate as source operand</p></td>
</tr>
<tr class="row-odd"><td><p>BPF_X</p></td>
<td><p>0x08</p></td>
<td><p>use ‘src_reg’ register as source operand</p></td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>The four MSB bits store the operation code.</p>
<section id="arithmetic-instructions">
<h3><a class="toc-backref" href="#id6"><span class="sectnum">1.3.1</span> Arithmetic instructions</a><a class="headerlink" href="#arithmetic-instructions" title="Permalink to this headline">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">BPF_ALU</span></code> uses 32-bit wide operands while <code class="docutils literal notranslate"><span class="pre">BPF_ALU64</span></code> uses 64-bit wide operands for
otherwise identical operations.
The ‘code’ field encodes the operation as below:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 11%" />
<col style="width: 7%" />
<col style="width: 82%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>code</p></th>
<th class="head"><p>value</p></th>
<th class="head"><p>description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>BPF_ADD</p></td>
<td><p>0x00</p></td>
<td><p>dst += src</p></td>
</tr>
<tr class="row-odd"><td><p>BPF_SUB</p></td>
<td><p>0x10</p></td>
<td><p>dst -= src</p></td>
</tr>
<tr class="row-even"><td><p>BPF_MUL</p></td>
<td><p>0x20</p></td>
<td><p>dst *= src</p></td>
</tr>
<tr class="row-odd"><td><p>BPF_DIV</p></td>
<td><p>0x30</p></td>
<td><p>dst /= src</p></td>
</tr>
<tr class="row-even"><td><p>BPF_OR</p></td>
<td><p>0x40</p></td>
<td><p>dst |= src</p></td>
</tr>
<tr class="row-odd"><td><p>BPF_AND</p></td>
<td><p>0x50</p></td>
<td><p>dst &amp;= src</p></td>
</tr>
<tr class="row-even"><td><p>BPF_LSH</p></td>
<td><p>0x60</p></td>
<td><p>dst &lt;&lt;= src</p></td>
</tr>
<tr class="row-odd"><td><p>BPF_RSH</p></td>
<td><p>0x70</p></td>
<td><p>dst &gt;&gt;= src</p></td>
</tr>
<tr class="row-even"><td><p>BPF_NEG</p></td>
<td><p>0x80</p></td>
<td><p>dst = ~src</p></td>
</tr>
<tr class="row-odd"><td><p>BPF_MOD</p></td>
<td><p>0x90</p></td>
<td><p>dst %= src</p></td>
</tr>
<tr class="row-even"><td><p>BPF_XOR</p></td>
<td><p>0xa0</p></td>
<td><p>dst ^= src</p></td>
</tr>
<tr class="row-odd"><td><p>BPF_MOV</p></td>
<td><p>0xb0</p></td>
<td><p>dst = src</p></td>
</tr>
<tr class="row-even"><td><p>BPF_ARSH</p></td>
<td><p>0xc0</p></td>
<td><p>sign extending shift right</p></td>
</tr>
<tr class="row-odd"><td><p>BPF_END</p></td>
<td><p>0xd0</p></td>
<td><p>byte swap operations (see <a class="reference internal" href="#byte-swap-instructions">Byte swap instructions</a> below)</p></td>
</tr>
</tbody>
</table>
<p><code class="docutils literal notranslate"><span class="pre">BPF_ADD</span> <span class="pre">|</span> <span class="pre">BPF_X</span> <span class="pre">|</span> <span class="pre">BPF_ALU</span></code> means:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>dst_reg = (u32) dst_reg + (u32) src_reg;
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">BPF_ADD</span> <span class="pre">|</span> <span class="pre">BPF_X</span> <span class="pre">|</span> <span class="pre">BPF_ALU64</span></code> means:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>dst_reg = dst_reg + src_reg
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">BPF_XOR</span> <span class="pre">|</span> <span class="pre">BPF_K</span> <span class="pre">|</span> <span class="pre">BPF_ALU</span></code> means:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>dst_reg = (u32) dst_reg ^ (u32) imm32
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">BPF_XOR</span> <span class="pre">|</span> <span class="pre">BPF_K</span> <span class="pre">|</span> <span class="pre">BPF_ALU64</span></code> means:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>dst_reg = dst_reg ^ imm32
</pre></div>
</div>
<section id="byte-swap-instructions">
<h4><a class="toc-backref" href="#id7"><span class="sectnum">1.3.1.1</span> Byte swap instructions</a><a class="headerlink" href="#byte-swap-instructions" title="Permalink to this headline">¶</a></h4>
<p>The byte swap instructions use an instruction class of <code class="docutils literal notranslate"><span class="pre">BPF_ALU</span></code> and a 4-bit
‘code’ field of <code class="docutils literal notranslate"><span class="pre">BPF_END</span></code>.</p>
<p>The byte swap instructions operate on the destination register
only and do not use a separate source register or immediate value.</p>
<p>The 1-bit source operand field in the opcode is used to select what byte
order the operation convert from or to:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 14%" />
<col style="width: 8%" />
<col style="width: 78%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>source</p></th>
<th class="head"><p>value</p></th>
<th class="head"><p>description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>BPF_TO_LE</p></td>
<td><p>0x00</p></td>
<td><p>convert between host byte order and little endian</p></td>
</tr>
<tr class="row-odd"><td><p>BPF_TO_BE</p></td>
<td><p>0x08</p></td>
<td><p>convert between host byte order and big endian</p></td>
</tr>
</tbody>
</table>
<p>The ‘imm’ field encodes the width of the swap operations.  The following widths
are supported: 16, 32 and 64.</p>
<p>Examples:</p>
<p><code class="docutils literal notranslate"><span class="pre">BPF_ALU</span> <span class="pre">|</span> <span class="pre">BPF_TO_LE</span> <span class="pre">|</span> <span class="pre">BPF_END</span></code> with imm = 16 means:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>dst_reg = htole16(dst_reg)
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">BPF_ALU</span> <span class="pre">|</span> <span class="pre">BPF_TO_BE</span> <span class="pre">|</span> <span class="pre">BPF_END</span></code> with imm = 64 means:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>dst_reg = htobe64(dst_reg)
</pre></div>
</div>
</section>
</section>
<section id="jump-instructions">
<h3><a class="toc-backref" href="#id8"><span class="sectnum">1.3.2</span> Jump instructions</a><a class="headerlink" href="#jump-instructions" title="Permalink to this headline">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">BPF_JMP32</span></code> uses 32-bit wide operands while <code class="docutils literal notranslate"><span class="pre">BPF_JMP</span></code> uses 64-bit wide operands for
otherwise identical operations.
The ‘code’ field encodes the operation as below:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 16%" />
<col style="width: 10%" />
<col style="width: 50%" />
<col style="width: 24%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>code</p></th>
<th class="head"><p>value</p></th>
<th class="head"><p>description</p></th>
<th class="head"><p>notes</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>BPF_JA</p></td>
<td><p>0x00</p></td>
<td><p>PC += off</p></td>
<td><p>BPF_JMP only</p></td>
</tr>
<tr class="row-odd"><td><p>BPF_JEQ</p></td>
<td><p>0x10</p></td>
<td><p>PC += off if dst == src</p></td>
<td></td>
</tr>
<tr class="row-even"><td><p>BPF_JGT</p></td>
<td><p>0x20</p></td>
<td><p>PC += off if dst &gt; src</p></td>
<td><p>unsigned</p></td>
</tr>
<tr class="row-odd"><td><p>BPF_JGE</p></td>
<td><p>0x30</p></td>
<td><p>PC += off if dst &gt;= src</p></td>
<td><p>unsigned</p></td>
</tr>
<tr class="row-even"><td><p>BPF_JSET</p></td>
<td><p>0x40</p></td>
<td><p>PC += off if dst &amp; src</p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p>BPF_JNE</p></td>
<td><p>0x50</p></td>
<td><p>PC += off if dst != src</p></td>
<td></td>
</tr>
<tr class="row-even"><td><p>BPF_JSGT</p></td>
<td><p>0x60</p></td>
<td><p>PC += off if dst &gt; src</p></td>
<td><p>signed</p></td>
</tr>
<tr class="row-odd"><td><p>BPF_JSGE</p></td>
<td><p>0x70</p></td>
<td><p>PC += off if dst &gt;= src</p></td>
<td><p>signed</p></td>
</tr>
<tr class="row-even"><td><p>BPF_CALL</p></td>
<td><p>0x80</p></td>
<td><p>function call</p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p>BPF_EXIT</p></td>
<td><p>0x90</p></td>
<td><p>function / program return</p></td>
<td><p>BPF_JMP only</p></td>
</tr>
<tr class="row-even"><td><p>BPF_JLT</p></td>
<td><p>0xa0</p></td>
<td><p>PC += off if dst &lt; src</p></td>
<td><p>unsigned</p></td>
</tr>
<tr class="row-odd"><td><p>BPF_JLE</p></td>
<td><p>0xb0</p></td>
<td><p>PC += off if dst &lt;= src</p></td>
<td><p>unsigned</p></td>
</tr>
<tr class="row-even"><td><p>BPF_JSLT</p></td>
<td><p>0xc0</p></td>
<td><p>PC += off if dst &lt; src</p></td>
<td><p>signed</p></td>
</tr>
<tr class="row-odd"><td><p>BPF_JSLE</p></td>
<td><p>0xd0</p></td>
<td><p>PC += off if dst &lt;= src</p></td>
<td><p>signed</p></td>
</tr>
</tbody>
</table>
<p>The eBPF program needs to store the return value into register R0 before doing a
BPF_EXIT.</p>
</section>
</section>
<section id="load-and-store-instructions">
<h2><a class="toc-backref" href="#id9"><span class="sectnum">1.4</span> Load and store instructions</a><a class="headerlink" href="#load-and-store-instructions" title="Permalink to this headline">¶</a></h2>
<p>For load and store instructions (<code class="docutils literal notranslate"><span class="pre">BPF_LD</span></code>, <code class="docutils literal notranslate"><span class="pre">BPF_LDX</span></code>, <code class="docutils literal notranslate"><span class="pre">BPF_ST</span></code>, and <code class="docutils literal notranslate"><span class="pre">BPF_STX</span></code>), the
8-bit ‘opcode’ field is divided as:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 34%" />
<col style="width: 17%" />
<col style="width: 49%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>3 bits (MSB)</p></th>
<th class="head"><p>2 bits</p></th>
<th class="head"><p>3 bits (LSB)</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>mode</p></td>
<td><p>size</p></td>
<td><p>instruction class</p></td>
</tr>
</tbody>
</table>
<p>The mode modifier is one of:</p>
<blockquote>
<div><table class="docutils align-default">
<colgroup>
<col style="width: 14%" />
<col style="width: 5%" />
<col style="width: 38%" />
<col style="width: 43%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>mode modifier</p></th>
<th class="head"><p>value</p></th>
<th class="head"><p>description</p></th>
<th class="head"><p>reference</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>BPF_IMM</p></td>
<td><p>0x00</p></td>
<td><p>64-bit immediate instructions</p></td>
<td><p><a class="reference internal" href="#bit-immediate-instructions">64-bit immediate instructions</a></p></td>
</tr>
<tr class="row-odd"><td><p>BPF_ABS</p></td>
<td><p>0x20</p></td>
<td><p>legacy BPF packet access (absolute)</p></td>
<td><p><a class="reference internal" href="#legacy-bpf-packet-access-instructions">Legacy BPF Packet access instructions</a></p></td>
</tr>
<tr class="row-even"><td><p>BPF_IND</p></td>
<td><p>0x40</p></td>
<td><p>legacy BPF packet access (indirect)</p></td>
<td><p><a class="reference internal" href="#legacy-bpf-packet-access-instructions">Legacy BPF Packet access instructions</a></p></td>
</tr>
<tr class="row-odd"><td><p>BPF_MEM</p></td>
<td><p>0x60</p></td>
<td><p>regular load and store operations</p></td>
<td><p><a class="reference internal" href="#regular-load-and-store-operations">Regular load and store operations</a></p></td>
</tr>
<tr class="row-even"><td><p>BPF_ATOMIC</p></td>
<td><p>0xc0</p></td>
<td><p>atomic operations</p></td>
<td><p><a class="reference internal" href="#atomic-operations">Atomic operations</a></p></td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>The size modifier is one of:</p>
<blockquote>
<div><table class="docutils align-default">
<colgroup>
<col style="width: 33%" />
<col style="width: 13%" />
<col style="width: 54%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>size modifier</p></th>
<th class="head"><p>value</p></th>
<th class="head"><p>description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>BPF_W</p></td>
<td><p>0x00</p></td>
<td><p>word        (4 bytes)</p></td>
</tr>
<tr class="row-odd"><td><p>BPF_H</p></td>
<td><p>0x08</p></td>
<td><p>half word   (2 bytes)</p></td>
</tr>
<tr class="row-even"><td><p>BPF_B</p></td>
<td><p>0x10</p></td>
<td><p>byte</p></td>
</tr>
<tr class="row-odd"><td><p>BPF_DW</p></td>
<td><p>0x18</p></td>
<td><p>double word (8 bytes)</p></td>
</tr>
</tbody>
</table>
</div></blockquote>
<section id="regular-load-and-store-operations">
<h3><a class="toc-backref" href="#id10"><span class="sectnum">1.4.1</span> Regular load and store operations</a><a class="headerlink" href="#regular-load-and-store-operations" title="Permalink to this headline">¶</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">BPF_MEM</span></code> mode modifier is used to encode regular load and store
instructions that transfer data between a register and memory.</p>
<p><code class="docutils literal notranslate"><span class="pre">BPF_MEM</span> <span class="pre">|</span> <span class="pre">&lt;size&gt;</span> <span class="pre">|</span> <span class="pre">BPF_STX</span></code> means:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>*(size *) (dst_reg + off) = src_reg
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">BPF_MEM</span> <span class="pre">|</span> <span class="pre">&lt;size&gt;</span> <span class="pre">|</span> <span class="pre">BPF_ST</span></code> means:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>*(size *) (dst_reg + off) = imm32
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">BPF_MEM</span> <span class="pre">|</span> <span class="pre">&lt;size&gt;</span> <span class="pre">|</span> <span class="pre">BPF_LDX</span></code> means:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>dst_reg = *(size *) (src_reg + off)
</pre></div>
</div>
<p>Where size is one of: <code class="docutils literal notranslate"><span class="pre">BPF_B</span></code>, <code class="docutils literal notranslate"><span class="pre">BPF_H</span></code>, <code class="docutils literal notranslate"><span class="pre">BPF_W</span></code>, or <code class="docutils literal notranslate"><span class="pre">BPF_DW</span></code>.</p>
</section>
<section id="atomic-operations">
<h3><a class="toc-backref" href="#id11"><span class="sectnum">1.4.2</span> Atomic operations</a><a class="headerlink" href="#atomic-operations" title="Permalink to this headline">¶</a></h3>
<p>Atomic operations are operations that operate on memory and can not be
interrupted or corrupted by other access to the same memory region
by other eBPF programs or means outside of this specification.</p>
<p>All atomic operations supported by eBPF are encoded as store operations
that use the <code class="docutils literal notranslate"><span class="pre">BPF_ATOMIC</span></code> mode modifier as follows:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">BPF_ATOMIC</span> <span class="pre">|</span> <span class="pre">BPF_W</span> <span class="pre">|</span> <span class="pre">BPF_STX</span></code> for 32-bit operations</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">BPF_ATOMIC</span> <span class="pre">|</span> <span class="pre">BPF_DW</span> <span class="pre">|</span> <span class="pre">BPF_STX</span></code> for 64-bit operations</p></li>
<li><p>8-bit and 16-bit wide atomic operations are not supported.</p></li>
</ul>
<p>The ‘imm’ field is used to encode the actual atomic operation.
Simple atomic operation use a subset of the values defined to encode
arithmetic operations in the ‘imm’ field to encode the atomic operation:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 33%" />
<col style="width: 21%" />
<col style="width: 46%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>imm</p></th>
<th class="head"><p>value</p></th>
<th class="head"><p>description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>BPF_ADD</p></td>
<td><p>0x00</p></td>
<td><p>atomic add</p></td>
</tr>
<tr class="row-odd"><td><p>BPF_OR</p></td>
<td><p>0x40</p></td>
<td><p>atomic or</p></td>
</tr>
<tr class="row-even"><td><p>BPF_AND</p></td>
<td><p>0x50</p></td>
<td><p>atomic and</p></td>
</tr>
<tr class="row-odd"><td><p>BPF_XOR</p></td>
<td><p>0xa0</p></td>
<td><p>atomic xor</p></td>
</tr>
</tbody>
</table>
<p><code class="docutils literal notranslate"><span class="pre">BPF_ATOMIC</span> <span class="pre">|</span> <span class="pre">BPF_W</span>&#160; <span class="pre">|</span> <span class="pre">BPF_STX</span></code> with ‘imm’ = BPF_ADD means:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>*(u32 *)(dst_reg + off16) += src_reg
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">BPF_ATOMIC</span> <span class="pre">|</span> <span class="pre">BPF_DW</span> <span class="pre">|</span> <span class="pre">BPF_STX</span></code> with ‘imm’ = BPF ADD means:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>*(u64 *)(dst_reg + off16) += src_reg
</pre></div>
</div>
<p>In addition to the simple atomic operations, there also is a modifier and
two complex atomic operations:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 20%" />
<col style="width: 30%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>imm</p></th>
<th class="head"><p>value</p></th>
<th class="head"><p>description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>BPF_FETCH</p></td>
<td><p>0x01</p></td>
<td><p>modifier: return old value</p></td>
</tr>
<tr class="row-odd"><td><p>BPF_XCHG</p></td>
<td><p>0xe0 | BPF_FETCH</p></td>
<td><p>atomic exchange</p></td>
</tr>
<tr class="row-even"><td><p>BPF_CMPXCHG</p></td>
<td><p>0xf0 | BPF_FETCH</p></td>
<td><p>atomic compare and exchange</p></td>
</tr>
</tbody>
</table>
<p>The <code class="docutils literal notranslate"><span class="pre">BPF_FETCH</span></code> modifier is optional for simple atomic operations, and
always set for the complex atomic operations.  If the <code class="docutils literal notranslate"><span class="pre">BPF_FETCH</span></code> flag
is set, then the operation also overwrites <code class="docutils literal notranslate"><span class="pre">src_reg</span></code> with the value that
was in memory before it was modified.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">BPF_XCHG</span></code> operation atomically exchanges <code class="docutils literal notranslate"><span class="pre">src_reg</span></code> with the value
addressed by <code class="docutils literal notranslate"><span class="pre">dst_reg</span> <span class="pre">+</span> <span class="pre">off</span></code>.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">BPF_CMPXCHG</span></code> operation atomically compares the value addressed by
<code class="docutils literal notranslate"><span class="pre">dst_reg</span> <span class="pre">+</span> <span class="pre">off</span></code> with <code class="docutils literal notranslate"><span class="pre">R0</span></code>. If they match, the value addressed by
<code class="docutils literal notranslate"><span class="pre">dst_reg</span> <span class="pre">+</span> <span class="pre">off</span></code> is replaced with <code class="docutils literal notranslate"><span class="pre">src_reg</span></code>. In either case, the
value that was at <code class="docutils literal notranslate"><span class="pre">dst_reg</span> <span class="pre">+</span> <span class="pre">off</span></code> before the operation is zero-extended
and loaded back to <code class="docutils literal notranslate"><span class="pre">R0</span></code>.</p>
</section>
<section id="bit-immediate-instructions">
<h3><a class="toc-backref" href="#id12"><span class="sectnum">1.4.3</span> 64-bit immediate instructions</a><a class="headerlink" href="#bit-immediate-instructions" title="Permalink to this headline">¶</a></h3>
<p>Instructions with the <code class="docutils literal notranslate"><span class="pre">BPF_IMM</span></code> ‘mode’ modifier use the wide instruction
encoding for an extra imm64 value.</p>
<p>There is currently only one such instruction.</p>
<p><code class="docutils literal notranslate"><span class="pre">BPF_LD</span> <span class="pre">|</span> <span class="pre">BPF_DW</span> <span class="pre">|</span> <span class="pre">BPF_IMM</span></code> means:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>dst_reg = imm64
</pre></div>
</div>
</section>
<section id="legacy-bpf-packet-access-instructions">
<h3><a class="toc-backref" href="#id13"><span class="sectnum">1.4.4</span> Legacy BPF Packet access instructions</a><a class="headerlink" href="#legacy-bpf-packet-access-instructions" title="Permalink to this headline">¶</a></h3>
<p>eBPF previously introduced special instructions for access to packet data that were
carried over from classic BPF. However, these instructions are
deprecated and should no longer be used.</p>
</section>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../index.html">The Linux Kernel</a></h1>



<p class="blurb">6.2.0-rc4-6.2.0-rc4+</p>







<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
  <h3><a href="../index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#"><span class="sectnum">1</span> eBPF Instruction Set Specification, v1.0</a><ul>
<li><a class="reference internal" href="#registers-and-calling-convention"><span class="sectnum">1.1</span> Registers and calling convention</a></li>
<li><a class="reference internal" href="#instruction-encoding"><span class="sectnum">1.2</span> Instruction encoding</a><ul>
<li><a class="reference internal" href="#instruction-classes"><span class="sectnum">1.2.1</span> Instruction classes</a></li>
</ul>
</li>
<li><a class="reference internal" href="#arithmetic-and-jump-instructions"><span class="sectnum">1.3</span> Arithmetic and jump instructions</a><ul>
<li><a class="reference internal" href="#arithmetic-instructions"><span class="sectnum">1.3.1</span> Arithmetic instructions</a><ul>
<li><a class="reference internal" href="#byte-swap-instructions"><span class="sectnum">1.3.1.1</span> Byte swap instructions</a></li>
</ul>
</li>
<li><a class="reference internal" href="#jump-instructions"><span class="sectnum">1.3.2</span> Jump instructions</a></li>
</ul>
</li>
<li><a class="reference internal" href="#load-and-store-instructions"><span class="sectnum">1.4</span> Load and store instructions</a><ul>
<li><a class="reference internal" href="#regular-load-and-store-operations"><span class="sectnum">1.4.1</span> Regular load and store operations</a></li>
<li><a class="reference internal" href="#atomic-operations"><span class="sectnum">1.4.2</span> Atomic operations</a></li>
<li><a class="reference internal" href="#bit-immediate-instructions"><span class="sectnum">1.4.3</span> 64-bit immediate instructions</a></li>
<li><a class="reference internal" href="#legacy-bpf-packet-access-instructions"><span class="sectnum">1.4.4</span> Legacy BPF Packet access instructions</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/bpf/instruction-set.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;The kernel development community.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 2.4.4</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="../_sources/bpf/instruction-set.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>