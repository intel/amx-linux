
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>BPF_MAP_TYPE_CPUMAP &#8212; The Linux Kernel 6.2.0-rc4+ documentation</title>
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="BPF_MAP_TYPE_DEVMAP and BPF_MAP_TYPE_DEVMAP_HASH" href="map_devmap.html" />
    <link rel="prev" title="BPF_MAP_TYPE_CGRP_STORAGE" href="map_cgrp_storage.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="bpf-map-type-cpumap">
<h1>BPF_MAP_TYPE_CPUMAP<a class="headerlink" href="#bpf-map-type-cpumap" title="Permalink to this headline">¶</a></h1>
<div class="admonition note">
<p class="admonition-title">Note</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">BPF_MAP_TYPE_CPUMAP</span></code> was introduced in kernel version 4.15</p></li>
</ul>
</div>
<p>The ‘cpumap’ is primarily used as a backend map for XDP BPF helper
call bpf_redirect_map() and XDP_REDIRECT action, like ‘devmap’.</p>
<p>Unlike devmap which redirects XDP frames out to another NIC device,
this map type redirects raw XDP frames to another CPU.  The remote
CPU will do SKB-allocation and call the normal network stack.</p>
<p>An example use-case for this map type is software based Receive Side Scaling (RSS).</p>
<p>The CPUMAP represents the CPUs in the system indexed as the map-key, and the
map-value is the config setting (per CPUMAP entry). Each CPUMAP entry has a dedicated
kernel thread bound to the given CPU to represent the remote CPU execution unit.</p>
<p>Starting from Linux kernel version 5.9 the CPUMAP can run a second XDP program
on the remote CPU. This allows an XDP program to split its processing across
multiple CPUs. For example, a scenario where the initial CPU (that sees/receives
the packets) needs to do minimal packet processing and the remote CPU (to which
the packet is directed) can afford to spend more cycles processing the frame. The
initial CPU is where the XDP redirect program is executed. The remote CPU
receives raw <code class="docutils literal notranslate"><span class="pre">xdp_frame</span></code> objects.</p>
<section id="usage">
<h2>Usage<a class="headerlink" href="#usage" title="Permalink to this headline">¶</a></h2>
<section id="kernel-bpf">
<h3>Kernel BPF<a class="headerlink" href="#kernel-bpf" title="Permalink to this headline">¶</a></h3>
<section id="bpf-redirect-map">
<h4>bpf_redirect_map()<a class="headerlink" href="#bpf-redirect-map" title="Permalink to this headline">¶</a></h4>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">long</span><span class="w"> </span><span class="n">bpf_redirect_map</span><span class="p">(</span><span class="k">struct</span> <span class="nc">bpf_map</span><span class="w"> </span><span class="o">*</span><span class="n">map</span><span class="p">,</span><span class="w"> </span><span class="n">u32</span><span class="w"> </span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">u64</span><span class="w"> </span><span class="n">flags</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
<p>Redirect the packet to the endpoint referenced by <code class="docutils literal notranslate"><span class="pre">map</span></code> at index <code class="docutils literal notranslate"><span class="pre">key</span></code>.
For <code class="docutils literal notranslate"><span class="pre">BPF_MAP_TYPE_CPUMAP</span></code> this map contains references to CPUs.</p>
<p>The lower two bits of <code class="docutils literal notranslate"><span class="pre">flags</span></code> are used as the return code if the map lookup
fails. This is so that the return value can be one of the XDP program return
codes up to <code class="docutils literal notranslate"><span class="pre">XDP_TX</span></code>, as chosen by the caller.</p>
</section>
</section>
<section id="user-space">
<h3>User space<a class="headerlink" href="#user-space" title="Permalink to this headline">¶</a></h3>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>CPUMAP entries can only be updated/looked up/deleted from user space and not
from an eBPF program. Trying to call these functions from a kernel eBPF
program will result in the program failing to load and a verifier warning.</p>
</div>
<section id="bpf-map-update-elem">
<h4>bpf_map_update_elem()<a class="headerlink" href="#bpf-map-update-elem" title="Permalink to this headline">¶</a></h4>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="nf">bpf_map_update_elem</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="n">__u64</span><span class="w"> </span><span class="n">flags</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<p>CPU entries can be added or updated using the <code class="docutils literal notranslate"><span class="pre">bpf_map_update_elem()</span></code>
helper. This helper replaces existing elements atomically. The <code class="docutils literal notranslate"><span class="pre">value</span></code> parameter
can be <code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">bpf_cpumap_val</span></code>.</p>
<blockquote>
<div><div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">struct</span> <span class="nc">bpf_cpumap_val</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">__u32</span><span class="w"> </span><span class="n">qsize</span><span class="p">;</span><span class="w">  </span><span class="cm">/* queue size to remote target CPU */</span><span class="w"></span>
<span class="w">    </span><span class="k">union</span> <span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kt">int</span><span class="w">   </span><span class="n">fd</span><span class="p">;</span><span class="w"> </span><span class="cm">/* prog fd on map write */</span><span class="w"></span>
<span class="w">        </span><span class="n">__u32</span><span class="w"> </span><span class="n">id</span><span class="p">;</span><span class="w"> </span><span class="cm">/* prog id on map read */</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="n">bpf_prog</span><span class="p">;</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>
</pre></div>
</div>
</div></blockquote>
<dl class="simple">
<dt>The flags argument can be one of the following:</dt><dd><ul class="simple">
<li><p>BPF_ANY: Create a new element or update an existing element.</p></li>
<li><p>BPF_NOEXIST: Create a new element only if it did not exist.</p></li>
<li><p>BPF_EXIST: Update an existing element.</p></li>
</ul>
</dd>
</dl>
</section>
<section id="bpf-map-lookup-elem">
<h4>bpf_map_lookup_elem()<a class="headerlink" href="#bpf-map-lookup-elem" title="Permalink to this headline">¶</a></h4>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="nf">bpf_map_lookup_elem</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">value</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<p>CPU entries can be retrieved using the <code class="docutils literal notranslate"><span class="pre">bpf_map_lookup_elem()</span></code>
helper.</p>
</section>
<section id="bpf-map-delete-elem">
<h4>bpf_map_delete_elem()<a class="headerlink" href="#bpf-map-delete-elem" title="Permalink to this headline">¶</a></h4>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="nf">bpf_map_delete_elem</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">key</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<p>CPU entries can be deleted using the <code class="docutils literal notranslate"><span class="pre">bpf_map_delete_elem()</span></code>
helper. This helper will return 0 on success, or negative error in case of
failure.</p>
</section>
</section>
</section>
<section id="examples">
<h2>Examples<a class="headerlink" href="#examples" title="Permalink to this headline">¶</a></h2>
<section id="kernel">
<h3>Kernel<a class="headerlink" href="#kernel" title="Permalink to this headline">¶</a></h3>
<p>The following code snippet shows how to declare a <code class="docutils literal notranslate"><span class="pre">BPF_MAP_TYPE_CPUMAP</span></code> called
<code class="docutils literal notranslate"><span class="pre">cpu_map</span></code> and how to redirect packets to a remote CPU using a round robin scheme.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">struct</span> <span class="p">{</span><span class="w"></span>
<span class="w">     </span><span class="n">__uint</span><span class="p">(</span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="n">BPF_MAP_TYPE_CPUMAP</span><span class="p">);</span><span class="w"></span>
<span class="w">     </span><span class="n">__type</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">__u32</span><span class="p">);</span><span class="w"></span>
<span class="w">     </span><span class="n">__type</span><span class="p">(</span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span> <span class="nc">bpf_cpumap_val</span><span class="p">);</span><span class="w"></span>
<span class="w">     </span><span class="n">__uint</span><span class="p">(</span><span class="n">max_entries</span><span class="p">,</span><span class="w"> </span><span class="mi">12</span><span class="p">);</span><span class="w"></span>
<span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="n">cpu_map</span><span class="w"> </span><span class="n">SEC</span><span class="p">(</span><span class="s">&quot;.maps&quot;</span><span class="p">);</span><span class="w"></span>

<span class="w"> </span><span class="k">struct</span> <span class="p">{</span><span class="w"></span>
<span class="w">     </span><span class="n">__uint</span><span class="p">(</span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="n">BPF_MAP_TYPE_ARRAY</span><span class="p">);</span><span class="w"></span>
<span class="w">     </span><span class="n">__type</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">__u32</span><span class="p">);</span><span class="w"></span>
<span class="w">     </span><span class="n">__type</span><span class="p">(</span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="n">__u32</span><span class="p">);</span><span class="w"></span>
<span class="w">     </span><span class="n">__uint</span><span class="p">(</span><span class="n">max_entries</span><span class="p">,</span><span class="w"> </span><span class="mi">12</span><span class="p">);</span><span class="w"></span>
<span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="n">cpus_available</span><span class="w"> </span><span class="n">SEC</span><span class="p">(</span><span class="s">&quot;.maps&quot;</span><span class="p">);</span><span class="w"></span>

<span class="w"> </span><span class="k">struct</span> <span class="p">{</span><span class="w"></span>
<span class="w">     </span><span class="n">__uint</span><span class="p">(</span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="n">BPF_MAP_TYPE_PERCPU_ARRAY</span><span class="p">);</span><span class="w"></span>
<span class="w">     </span><span class="n">__type</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">__u32</span><span class="p">);</span><span class="w"></span>
<span class="w">     </span><span class="n">__type</span><span class="p">(</span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="n">__u32</span><span class="p">);</span><span class="w"></span>
<span class="w">     </span><span class="n">__uint</span><span class="p">(</span><span class="n">max_entries</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="n">cpus_iterator</span><span class="w"> </span><span class="n">SEC</span><span class="p">(</span><span class="s">&quot;.maps&quot;</span><span class="p">);</span><span class="w"></span>

<span class="w"> </span><span class="n">SEC</span><span class="p">(</span><span class="s">&quot;xdp&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w"> </span><span class="kt">int</span><span class="w">  </span><span class="n">xdp_redir_cpu_round_robin</span><span class="p">(</span><span class="k">struct</span> <span class="nc">xdp_md</span><span class="w"> </span><span class="o">*</span><span class="n">ctx</span><span class="p">)</span><span class="w"></span>
<span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">     </span><span class="n">__u32</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">     </span><span class="n">__u32</span><span class="w"> </span><span class="n">cpu_dest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">     </span><span class="n">__u32</span><span class="w"> </span><span class="o">*</span><span class="n">cpu_selected</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">cpu_iterator</span><span class="p">;</span><span class="w"></span>
<span class="w">     </span><span class="n">__u32</span><span class="w"> </span><span class="n">cpu_idx</span><span class="p">;</span><span class="w"></span>

<span class="w">     </span><span class="n">cpu_iterator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bpf_map_lookup_elem</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cpus_iterator</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">key</span><span class="p">);</span><span class="w"></span>
<span class="w">     </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">cpu_iterator</span><span class="p">)</span><span class="w"></span>
<span class="w">         </span><span class="k">return</span><span class="w"> </span><span class="n">XDP_ABORTED</span><span class="p">;</span><span class="w"></span>
<span class="w">     </span><span class="n">cpu_idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">cpu_iterator</span><span class="p">;</span><span class="w"></span>

<span class="w">     </span><span class="o">*</span><span class="n">cpu_iterator</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="w">     </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">cpu_iterator</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">bpf_num_possible_cpus</span><span class="p">())</span><span class="w"></span>
<span class="w">         </span><span class="o">*</span><span class="n">cpu_iterator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>

<span class="w">     </span><span class="n">cpu_selected</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bpf_map_lookup_elem</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cpus_available</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">cpu_idx</span><span class="p">);</span><span class="w"></span>
<span class="w">     </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">cpu_selected</span><span class="p">)</span><span class="w"></span>
<span class="w">         </span><span class="k">return</span><span class="w"> </span><span class="n">XDP_ABORTED</span><span class="p">;</span><span class="w"></span>
<span class="w">     </span><span class="n">cpu_dest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">cpu_selected</span><span class="p">;</span><span class="w"></span>

<span class="w">     </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cpu_dest</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">bpf_num_possible_cpus</span><span class="p">())</span><span class="w"></span>
<span class="w">         </span><span class="k">return</span><span class="w"> </span><span class="n">XDP_ABORTED</span><span class="p">;</span><span class="w"></span>

<span class="w">     </span><span class="k">return</span><span class="w"> </span><span class="n">bpf_redirect_map</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cpu_map</span><span class="p">,</span><span class="w"> </span><span class="n">cpu_dest</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w"> </span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="id1">
<h3>User space<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<p>The following code snippet shows how to dynamically set the max_entries for a
CPUMAP to the max number of cpus available on the system.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="nf">set_max_cpu_entries</span><span class="p">(</span><span class="k">struct</span> <span class="nc">bpf_map</span><span class="w"> </span><span class="o">*</span><span class="n">cpu_map</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">bpf_map__set_max_entries</span><span class="p">(</span><span class="n">cpu_map</span><span class="p">,</span><span class="w"> </span><span class="n">libbpf_num_possible_cpus</span><span class="p">())</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Failed to set max entries for cpu_map map: %s&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
</section>
<section id="references">
<h2>References<a class="headerlink" href="#references" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p><a class="reference external" href="https://developers.redhat.com/blog/2021/05/13/receive-side-scaling-rss-with-ebpf-and-cpumap#redirecting_into_a_cpumap">https://developers.redhat.com/blog/2021/05/13/receive-side-scaling-rss-with-ebpf-and-cpumap#redirecting_into_a_cpumap</a></p></li>
</ul>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../index.html">The Linux Kernel</a></h1>



<p class="blurb">6.2.0-rc4-6.2.0-rc4+</p>







<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
  <h3><a href="../index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">BPF_MAP_TYPE_CPUMAP</a><ul>
<li><a class="reference internal" href="#usage">Usage</a><ul>
<li><a class="reference internal" href="#kernel-bpf">Kernel BPF</a><ul>
<li><a class="reference internal" href="#bpf-redirect-map">bpf_redirect_map()</a></li>
</ul>
</li>
<li><a class="reference internal" href="#user-space">User space</a><ul>
<li><a class="reference internal" href="#bpf-map-update-elem">bpf_map_update_elem()</a></li>
<li><a class="reference internal" href="#bpf-map-lookup-elem">bpf_map_lookup_elem()</a></li>
<li><a class="reference internal" href="#bpf-map-delete-elem">bpf_map_delete_elem()</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#examples">Examples</a><ul>
<li><a class="reference internal" href="#kernel">Kernel</a></li>
<li><a class="reference internal" href="#id1">User space</a></li>
</ul>
</li>
<li><a class="reference internal" href="#references">References</a></li>
</ul>
</li>
</ul>

  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/bpf/map_cpumap.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;The kernel development community.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 2.4.4</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="../_sources/bpf/map_cpumap.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>