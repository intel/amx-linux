
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Linux Kernel Makefiles &#8212; The Linux Kernel 6.2.0-rc4+ documentation</title>
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Building External Modules" href="modules.html" />
    <link rel="prev" title="Kconfig make config" href="kconfig.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="linux-kernel-makefiles">
<h1>Linux Kernel Makefiles<a class="headerlink" href="#linux-kernel-makefiles" title="Permalink to this headline">¶</a></h1>
<p>This document describes the Linux kernel Makefiles.</p>
<section id="overview">
<h2>1 Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>The Makefiles have five parts:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Makefile                    the top Makefile.
.config                     the kernel configuration file.
arch/$(SRCARCH)/Makefile    the arch Makefile.
scripts/Makefile.*          common rules etc. for all kbuild Makefiles.
kbuild Makefiles            exist in every subdirectory
</pre></div>
</div>
<p>The top Makefile reads the .config file, which comes from the kernel
configuration process.</p>
<p>The top Makefile is responsible for building two major products: vmlinux
(the resident kernel image) and modules (any module files).
It builds these goals by recursively descending into the subdirectories of
the kernel source tree.
The list of subdirectories which are visited depends upon the kernel
configuration. The top Makefile textually includes an arch Makefile
with the name arch/$(SRCARCH)/Makefile. The arch Makefile supplies
architecture-specific information to the top Makefile.</p>
<p>Each subdirectory has a kbuild Makefile which carries out the commands
passed down from above. The kbuild Makefile uses information from the
.config file to construct various file lists used by kbuild to build
any built-in or modular targets.</p>
<p>scripts/Makefile.* contains all the definitions/rules etc. that
are used to build the kernel based on the kbuild makefiles.</p>
</section>
<section id="who-does-what">
<h2>2 Who does what<a class="headerlink" href="#who-does-what" title="Permalink to this headline">¶</a></h2>
<p>People have four different relationships with the kernel Makefiles.</p>
<p><em>Users</em> are people who build kernels.  These people type commands such as
“make menuconfig” or “make”.  They usually do not read or edit
any kernel Makefiles (or any other source files).</p>
<p><em>Normal developers</em> are people who work on features such as device
drivers, file systems, and network protocols.  These people need to
maintain the kbuild Makefiles for the subsystem they are
working on.  In order to do this effectively, they need some overall
knowledge about the kernel Makefiles, plus detailed knowledge about the
public interface for kbuild.</p>
<p><em>Arch developers</em> are people who work on an entire architecture, such
as sparc or ia64.  Arch developers need to know about the arch Makefile
as well as kbuild Makefiles.</p>
<p><em>Kbuild developers</em> are people who work on the kernel build system itself.
These people need to know about all aspects of the kernel Makefiles.</p>
<p>This document is aimed towards normal developers and arch developers.</p>
</section>
<section id="the-kbuild-files">
<h2>3 The kbuild files<a class="headerlink" href="#the-kbuild-files" title="Permalink to this headline">¶</a></h2>
<p>Most Makefiles within the kernel are kbuild Makefiles that use the
kbuild infrastructure. This chapter introduces the syntax used in the
kbuild makefiles.
The preferred name for the kbuild files are ‘Makefile’ but ‘Kbuild’ can
be used and if both a ‘Makefile’ and a ‘Kbuild’ file exists, then the ‘Kbuild’
file will be used.</p>
<p>Section 3.1 “Goal definitions” is a quick intro; further chapters provide
more details, with real examples.</p>
<section id="goal-definitions">
<h3>3.1 Goal definitions<a class="headerlink" href="#goal-definitions" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><p>Goal definitions are the main part (heart) of the kbuild Makefile.
These lines define the files to be built, any special compilation
options, and any subdirectories to be entered recursively.</p>
<p>The most simple kbuild makefile contains one line:</p>
<p>Example:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>obj-y += foo.o
</pre></div>
</div>
<p>This tells kbuild that there is one object in that directory, named
foo.o. foo.o will be built from foo.c or foo.S.</p>
<p>If foo.o shall be built as a module, the variable obj-m is used.
Therefore the following pattern is often used:</p>
<p>Example:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>obj-$(CONFIG_FOO) += foo.o
</pre></div>
</div>
<p>$(CONFIG_FOO) evaluates to either y (for built-in) or m (for module).
If CONFIG_FOO is neither y nor m, then the file will not be compiled
nor linked.</p>
</div></blockquote>
</section>
<section id="built-in-object-goals-obj-y">
<h3>3.2 Built-in object goals - obj-y<a class="headerlink" href="#built-in-object-goals-obj-y" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><p>The kbuild Makefile specifies object files for vmlinux
in the $(obj-y) lists.  These lists depend on the kernel
configuration.</p>
<p>Kbuild compiles all the $(obj-y) files.  It then calls
“$(AR) rcSTP” to merge these files into one built-in.a file.
This is a thin archive without a symbol table. It will be later
linked into vmlinux by scripts/link-vmlinux.sh</p>
<p>The order of files in $(obj-y) is significant.  Duplicates in
the lists are allowed: the first instance will be linked into
built-in.a and succeeding instances will be ignored.</p>
<p>Link order is significant, because certain functions
(<a class="reference internal" href="../driver-api/basics.html#c.module_init" title="module_init"><code class="xref c c-func docutils literal notranslate"><span class="pre">module_init()</span></code></a> / __initcall) will be called during boot in the
order they appear. So keep in mind that changing the link
order may e.g. change the order in which your SCSI
controllers are detected, and thus your disks are renumbered.</p>
<p>Example:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>#drivers/isdn/i4l/Makefile
# Makefile for the kernel ISDN subsystem and device drivers.
# Each configuration option enables a list of files.
obj-$(CONFIG_ISDN_I4L)         += isdn.o
obj-$(CONFIG_ISDN_PPP_BSDCOMP) += isdn_bsdcomp.o
</pre></div>
</div>
</div></blockquote>
</section>
<section id="loadable-module-goals-obj-m">
<h3>3.3 Loadable module goals - obj-m<a class="headerlink" href="#loadable-module-goals-obj-m" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><p>$(obj-m) specifies object files which are built as loadable
kernel modules.</p>
<p>A module may be built from one source file or several source
files. In the case of one source file, the kbuild makefile
simply adds the file to $(obj-m).</p>
<p>Example:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>#drivers/isdn/i4l/Makefile
obj-$(CONFIG_ISDN_PPP_BSDCOMP) += isdn_bsdcomp.o
</pre></div>
</div>
<p>Note: In this example $(CONFIG_ISDN_PPP_BSDCOMP) evaluates to ‘m’</p>
<p>If a kernel module is built from several source files, you specify
that you want to build a module in the same way as above; however,
kbuild needs to know which object files you want to build your
module from, so you have to tell it by setting a $(&lt;module_name&gt;-y)
variable.</p>
<p>Example:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>#drivers/isdn/i4l/Makefile
obj-$(CONFIG_ISDN_I4L) += isdn.o
isdn-y := isdn_net_lib.o isdn_v110.o isdn_common.o
</pre></div>
</div>
<p>In this example, the module name will be isdn.o. Kbuild will
compile the objects listed in $(isdn-y) and then run
“$(LD) -r” on the list of these files to generate isdn.o.</p>
<p>Due to kbuild recognizing $(&lt;module_name&gt;-y) for composite objects,
you can use the value of a <cite>CONFIG_</cite> symbol to optionally include an
object file as part of a composite object.</p>
<p>Example:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>#fs/ext2/Makefile
obj-$(CONFIG_EXT2_FS) += ext2.o
ext2-y := balloc.o dir.o file.o ialloc.o inode.o ioctl.o \
          namei.o super.o symlink.o
ext2-$(CONFIG_EXT2_FS_XATTR) += xattr.o xattr_user.o \
                                xattr_trusted.o
</pre></div>
</div>
<p>In this example, xattr.o, xattr_user.o and xattr_trusted.o are only
part of the composite object ext2.o if $(CONFIG_EXT2_FS_XATTR)
evaluates to ‘y’.</p>
<p>Note: Of course, when you are building objects into the kernel,
the syntax above will also work. So, if you have CONFIG_EXT2_FS=y,
kbuild will build an ext2.o file for you out of the individual
parts and then link this into built-in.a, as you would expect.</p>
</div></blockquote>
</section>
<section id="library-file-goals-lib-y">
<h3>3.5 Library file goals - lib-y<a class="headerlink" href="#library-file-goals-lib-y" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><p>Objects listed with obj-* are used for modules, or
combined in a built-in.a for that specific directory.
There is also the possibility to list objects that will
be included in a library, lib.a.
All objects listed with lib-y are combined in a single
library for that directory.
Objects that are listed in obj-y and additionally listed in
lib-y will not be included in the library, since they will
be accessible anyway.
For consistency, objects listed in lib-m will be included in lib.a.</p>
<p>Note that the same kbuild makefile may list files to be built-in
and to be part of a library. Therefore the same directory
may contain both a built-in.a and a lib.a file.</p>
<p>Example:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>#arch/x86/lib/Makefile
lib-y    := delay.o
</pre></div>
</div>
<p>This will create a library lib.a based on delay.o. For kbuild to
actually recognize that there is a lib.a being built, the directory
shall be listed in libs-y.</p>
<p>See also “7.4 List directories to visit when descending”.</p>
<p>Use of lib-y is normally restricted to <cite>lib/</cite> and <cite>arch/*/lib</cite>.</p>
</div></blockquote>
</section>
<section id="descending-down-in-directories">
<h3>3.6 Descending down in directories<a class="headerlink" href="#descending-down-in-directories" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><p>A Makefile is only responsible for building objects in its own
directory. Files in subdirectories should be taken care of by
Makefiles in these subdirs. The build system will automatically
invoke make recursively in subdirectories, provided you let it know of
them.</p>
<p>To do so, obj-y and obj-m are used.
ext2 lives in a separate directory, and the Makefile present in fs/
tells kbuild to descend down using the following assignment.</p>
<p>Example:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>#fs/Makefile
obj-$(CONFIG_EXT2_FS) += ext2/
</pre></div>
</div>
<p>If CONFIG_EXT2_FS is set to either ‘y’ (built-in) or ‘m’ (modular)
the corresponding obj- variable will be set, and kbuild will descend
down in the ext2 directory.</p>
<p>Kbuild uses this information not only to decide that it needs to visit
the directory, but also to decide whether or not to link objects from
the directory into vmlinux.</p>
<p>When Kbuild descends into the directory with ‘y’, all built-in objects
from that directory are combined into the built-in.a, which will be
eventually linked into vmlinux.</p>
<p>When Kbuild descends into the directory with ‘m’, in contrast, nothing
from that directory will be linked into vmlinux. If the Makefile in
that directory specifies obj-y, those objects will be left orphan.
It is very likely a bug of the Makefile or of dependencies in Kconfig.</p>
<p>Kbuild also supports dedicated syntax, subdir-y and subdir-m, for
descending into subdirectories. It is a good fit when you know they
do not contain kernel-space objects at all. A typical usage is to let
Kbuild descend into subdirectories to build tools.</p>
<p>Examples:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># scripts/Makefile
subdir-$(CONFIG_GCC_PLUGINS) += gcc-plugins
subdir-$(CONFIG_MODVERSIONS) += genksyms
subdir-$(CONFIG_SECURITY_SELINUX) += selinux
</pre></div>
</div>
<p>Unlike obj-y/m, subdir-y/m does not need the trailing slash since this
syntax is always used for directories.</p>
<p>It is good practice to use a <cite>CONFIG_</cite> variable when assigning directory
names. This allows kbuild to totally skip the directory if the
corresponding <cite>CONFIG_</cite> option is neither ‘y’ nor ‘m’.</p>
</div></blockquote>
</section>
<section id="non-builtin-vmlinux-targets-extra-y">
<h3>3.7 Non-builtin vmlinux targets - extra-y<a class="headerlink" href="#non-builtin-vmlinux-targets-extra-y" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><p>extra-y specifies targets which are needed for building vmlinux,
but not combined into built-in.a.</p>
<p>Examples are:</p>
<ol class="arabic">
<li><p>vmlinux linker script</p>
<blockquote>
<div><p>The linker script for vmlinux is located at
arch/$(SRCARCH)/kernel/vmlinux.lds</p>
</div></blockquote>
</li>
</ol>
<p>Example:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># arch/x86/kernel/Makefile
extra-y += vmlinux.lds
</pre></div>
</div>
<p>$(extra-y) should only contain targets needed for vmlinux.</p>
<p>Kbuild skips extra-y when vmlinux is apparently not a final goal.
(e.g. ‘make modules’, or building external modules)</p>
<p>If you intend to build targets unconditionally, always-y (explained
in the next section) is the correct syntax to use.</p>
</div></blockquote>
</section>
<section id="always-built-goals-always-y">
<h3>3.8 Always built goals - always-y<a class="headerlink" href="#always-built-goals-always-y" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><p>always-y specifies targets which are literally always built when
Kbuild visits the Makefile.</p>
<dl class="simple">
<dt>Example::</dt><dd><p># ./Kbuild
offsets-file := include/generated/asm-offsets.h
always-y += $(offsets-file)</p>
</dd>
</dl>
</div></blockquote>
</section>
<section id="compilation-flags">
<h3>3.9 Compilation flags<a class="headerlink" href="#compilation-flags" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><dl>
<dt>ccflags-y, asflags-y and ldflags-y</dt><dd><p>These three flags apply only to the kbuild makefile in which they
are assigned. They are used for all the normal cc, as and ld
invocations happening during a recursive build.
Note: Flags with the same behaviour were previously named:
EXTRA_CFLAGS, EXTRA_AFLAGS and EXTRA_LDFLAGS.
They are still supported but their usage is deprecated.</p>
<p>ccflags-y specifies options for compiling with $(CC).</p>
<p>Example:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># drivers/acpi/acpica/Makefile
ccflags-y                       := -Os -D_LINUX -DBUILDING_ACPICA
ccflags-$(CONFIG_ACPI_DEBUG)    += -DACPI_DEBUG_OUTPUT
</pre></div>
</div>
<p>This variable is necessary because the top Makefile owns the
variable $(KBUILD_CFLAGS) and uses it for compilation flags for the
entire tree.</p>
<p>asflags-y specifies assembler options.</p>
<p>Example:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>#arch/sparc/kernel/Makefile
asflags-y := -ansi
</pre></div>
</div>
<p>ldflags-y specifies options for linking with $(LD).</p>
<p>Example:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>#arch/cris/boot/compressed/Makefile
ldflags-y += -T $(srctree)/$(src)/decompress_$(arch-y).lds
</pre></div>
</div>
</dd>
<dt>subdir-ccflags-y, subdir-asflags-y</dt><dd><p>The two flags listed above are similar to ccflags-y and asflags-y.
The difference is that the subdir- variants have effect for the kbuild
file where they are present and all subdirectories.
Options specified using subdir-* are added to the commandline before
the options specified using the non-subdir variants.</p>
<p>Example:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>subdir-ccflags-y := -Werror
</pre></div>
</div>
</dd>
<dt>ccflags-remove-y, asflags-remove-y</dt><dd><p>These flags are used to remove particular flags for the compiler,
assembler invocations.</p>
<p>Example:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>ccflags-remove-$(CONFIG_MCOUNT) += -pg
</pre></div>
</div>
</dd>
<dt>CFLAGS_$&#64;, AFLAGS_$&#64;</dt><dd><p>CFLAGS_$&#64; and AFLAGS_$&#64; only apply to commands in current
kbuild makefile.</p>
<p>$(CFLAGS_$&#64;) specifies per-file options for $(CC).  The $&#64;
part has a literal value which specifies the file that it is for.</p>
<p>CFLAGS_$&#64; has the higher priority than ccflags-remove-y; CFLAGS_$&#64;
can re-add compiler flags that were removed by ccflags-remove-y.</p>
<p>Example:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># drivers/scsi/Makefile
CFLAGS_aha152x.o =   -DAHA152X_STAT -DAUTOCONF
</pre></div>
</div>
<p>This line specify compilation flags for aha152x.o.</p>
<p>$(AFLAGS_$&#64;) is a similar feature for source files in assembly
languages.</p>
<p>AFLAGS_$&#64; has the higher priority than asflags-remove-y; AFLAGS_$&#64;
can re-add assembler flags that were removed by asflags-remove-y.</p>
<p>Example:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># arch/arm/kernel/Makefile
AFLAGS_head.o        := -DTEXT_OFFSET=$(TEXT_OFFSET)
AFLAGS_crunch-bits.o := -Wa,-mcpu=ep9312
AFLAGS_iwmmxt.o      := -Wa,-mcpu=iwmmxt
</pre></div>
</div>
</dd>
</dl>
</div></blockquote>
</section>
<section id="dependency-tracking">
<h3>3.10 Dependency tracking<a class="headerlink" href="#dependency-tracking" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><p>Kbuild tracks dependencies on the following:</p>
<ol class="arabic simple">
<li><p>All prerequisite files (both <cite>*.c</cite> and <cite>*.h</cite>)</p></li>
<li><p><cite>CONFIG_</cite> options used in all prerequisite files</p></li>
<li><p>Command-line used to compile target</p></li>
</ol>
<p>Thus, if you change an option to $(CC) all affected files will
be re-compiled.</p>
</div></blockquote>
</section>
<section id="custom-rules">
<h3>3.11 Custom Rules<a class="headerlink" href="#custom-rules" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><p>Custom rules are used when the kbuild infrastructure does
not provide the required support. A typical example is
header files generated during the build process.
Another example are the architecture-specific Makefiles which
need custom rules to prepare boot images etc.</p>
<p>Custom rules are written as normal Make rules.
Kbuild is not executing in the directory where the Makefile is
located, so all custom rules shall use a relative
path to prerequisite files and target files.</p>
<p>Two variables are used when defining custom rules:</p>
<dl>
<dt>$(src)</dt><dd><p>$(src) is a relative path which points to the directory
where the Makefile is located. Always use $(src) when
referring to files located in the src tree.</p>
</dd>
<dt>$(obj)</dt><dd><p>$(obj) is a relative path which points to the directory
where the target is saved. Always use $(obj) when
referring to generated files.</p>
<p>Example:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>#drivers/scsi/Makefile
$(obj)/53c8xx_d.h: $(src)/53c7,8xx.scr $(src)/script_asm.pl
        $(CPP) -DCHIP=810 - &lt; $&lt; | ... $(src)/script_asm.pl
</pre></div>
</div>
<p>This is a custom rule, following the normal syntax
required by make.</p>
<p>The target file depends on two prerequisite files. References
to the target file are prefixed with $(obj), references
to prerequisites are referenced with $(src) (because they are not
generated files).</p>
</dd>
<dt>$(kecho)</dt><dd><p>echoing information to user in a rule is often a good practice
but when execution “make -s” one does not expect to see any output
except for warnings/errors.
To support this kbuild defines $(kecho) which will echo out the
text following $(kecho) to stdout except if “make -s” is used.</p>
</dd>
</dl>
<p>Example:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># arch/arm/Makefile
$(BOOT_TARGETS): vmlinux
        $(Q)$(MAKE) $(build)=$(boot) MACHINE=$(MACHINE) $(boot)/$@
        @$(kecho) &#39;  Kernel: $(boot)/$@ is ready&#39;
</pre></div>
</div>
<p>When kbuild is executing with KBUILD_VERBOSE=0, then only a shorthand
of a command is normally displayed.
To enable this behaviour for custom commands kbuild requires
two variables to be set:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>quiet_cmd_&lt;command&gt;     - what shall be echoed
      cmd_&lt;command&gt;     - the command to execute
</pre></div>
</div>
<p>Example:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># lib/Makefile
quiet_cmd_crc32 = GEN     $@
      cmd_crc32 = $&lt; &gt; $@

$(obj)/crc32table.h: $(obj)/gen_crc32table
        $(call cmd,crc32)
</pre></div>
</div>
<p>When updating the $(obj)/crc32table.h target, the line:</p>
<blockquote>
<div><p>GEN     lib/crc32table.h</p>
</div></blockquote>
<p>will be displayed with “make KBUILD_VERBOSE=0”.</p>
</div></blockquote>
</section>
<section id="command-change-detection">
<h3>3.12 Command change detection<a class="headerlink" href="#command-change-detection" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><p>When the rule is evaluated, timestamps are compared between the target
and its prerequisite files. GNU Make updates the target when any of the
prerequisites is newer than that.</p>
<p>The target should be rebuilt also when the command line has changed
since the last invocation. This is not supported by Make itself, so
Kbuild achieves this by a kind of meta-programming.</p>
<p>if_changed is the macro used for this purpose, in the following form:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>quiet_cmd_&lt;command&gt; = ...
      cmd_&lt;command&gt; = ...

&lt;target&gt;: &lt;source(s)&gt; FORCE
        $(call if_changed,&lt;command&gt;)
</pre></div>
</div>
<p>Any target that utilizes if_changed must be listed in $(targets),
otherwise the command line check will fail, and the target will
always be built.</p>
<p>If the target is already listed in the recognized syntax such as
obj-y/m, lib-y/m, extra-y/m, always-y/m, hostprogs, userprogs, Kbuild
automatically adds it to $(targets). Otherwise, the target must be
explicitly added to $(targets).</p>
<p>Assignments to $(targets) are without $(obj)/ prefix. if_changed may be
used in conjunction with custom rules as defined in “3.11 Custom Rules”.</p>
<p>Note: It is a typical mistake to forget the FORCE prerequisite.
Another common pitfall is that whitespace is sometimes significant; for
instance, the below will fail (note the extra space after the comma):</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>target: source(s) FORCE
</pre></div>
</div>
<p><strong>WRONG!</strong>      $(call if_changed, objcopy)</p>
<dl class="simple">
<dt>Note:</dt><dd><p>if_changed should not be used more than once per target.
It stores the executed command in a corresponding .cmd
file and multiple calls would result in overwrites and
unwanted results when the target is up to date and only the
tests on changed commands trigger execution of commands.</p>
</dd>
</dl>
</div></blockquote>
</section>
<section id="cc-support-functions">
<h3>3.13 $(CC) support functions<a class="headerlink" href="#cc-support-functions" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><blockquote>
<div><blockquote>
<div><p>The kernel may be built with several different versions of
$(CC), each supporting a unique set of features and options.
kbuild provides basic support to check for valid options for $(CC).
$(CC) is usually the gcc compiler, but other alternatives are
available.</p>
</div></blockquote>
<dl>
<dt>as-option</dt><dd><p>as-option is used to check if $(CC) – when used to compile
assembler (<cite>*.S</cite>) files – supports the given option. An optional
second option may be specified if the first option is not supported.</p>
<p>Example:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>#arch/sh/Makefile
cflags-y += $(call as-option,-Wa$(comma)-isa=$(isa-y),)
</pre></div>
</div>
<p>In the above example, cflags-y will be assigned the option
-Wa$(comma)-isa=$(isa-y) if it is supported by $(CC).
The second argument is optional, and if supplied will be used
if first argument is not supported.</p>
</dd>
<dt>as-instr</dt><dd><p>as-instr checks if the assembler reports a specific instruction
and then outputs either option1 or option2
C escapes are supported in the test instruction
Note: as-instr-option uses KBUILD_AFLAGS for assembler options</p>
</dd>
<dt>cc-option</dt><dd><p>cc-option is used to check if $(CC) supports a given option, and if
not supported to use an optional second option.</p>
<p>Example:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>#arch/x86/Makefile
cflags-y += $(call cc-option,-march=pentium-mmx,-march=i586)
</pre></div>
</div>
<p>In the above example, cflags-y will be assigned the option
-march=pentium-mmx if supported by $(CC), otherwise -march=i586.
The second argument to cc-option is optional, and if omitted,
cflags-y will be assigned no value if first option is not supported.
Note: cc-option uses KBUILD_CFLAGS for $(CC) options</p>
</dd>
</dl>
</div></blockquote>
<dl>
<dt>cc-option-yn</dt><dd><blockquote>
<div><p>cc-option-yn is used to check if gcc supports a given option
and return ‘y’ if supported, otherwise ‘n’.</p>
<p>Example:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>#arch/ppc/Makefile
biarch := $(call cc-option-yn, -m32)
aflags-$(biarch) += -a32
cflags-$(biarch) += -m32
</pre></div>
</div>
<p>In the above example, $(biarch) is set to y if $(CC) supports the -m32
option. When $(biarch) equals ‘y’, the expanded variables $(aflags-y)
and $(cflags-y) will be assigned the values -a32 and -m32,
respectively.
Note: cc-option-yn uses KBUILD_CFLAGS for $(CC) options</p>
</div></blockquote>
<dl>
<dt>cc-disable-warning</dt><dd><p>cc-disable-warning checks if gcc supports a given warning and returns
the commandline switch to disable it. This special function is needed,
because gcc 4.4 and later accept any unknown -Wno-* option and only
warn about it if there is another warning in the source file.</p>
<p>Example:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>KBUILD_CFLAGS += $(call cc-disable-warning, unused-but-set-variable)
</pre></div>
</div>
<p>In the above example, -Wno-unused-but-set-variable will be added to
KBUILD_CFLAGS only if gcc really accepts it.</p>
</dd>
<dt>gcc-min-version</dt><dd><p>gcc-min-version tests if the value of $(CONFIG_GCC_VERSION) is greater than
or equal to the provided value and evaluates to y if so.</p>
<p>Example:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>cflags-$(call gcc-min-version, 70100) := -foo
</pre></div>
</div>
<p>In this example, cflags-y will be assigned the value -foo if $(CC) is gcc and
$(CONFIG_GCC_VERSION) is &gt;= 7.1.</p>
</dd>
<dt>clang-min-version</dt><dd><p>clang-min-version tests if the value of $(CONFIG_CLANG_VERSION) is greater
than or equal to the provided value and evaluates to y if so.</p>
<p>Example:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>cflags-$(call clang-min-version, 110000) := -foo
</pre></div>
</div>
<p>In this example, cflags-y will be assigned the value -foo if $(CC) is clang
and $(CONFIG_CLANG_VERSION) is &gt;= 11.0.0.</p>
</dd>
<dt>cc-cross-prefix</dt><dd><p>cc-cross-prefix is used to check if there exists a $(CC) in path with
one of the listed prefixes. The first prefix where there exist a
prefix$(CC) in the PATH is returned - and if no prefix$(CC) is found
then nothing is returned.
Additional prefixes are separated by a single space in the
call of cc-cross-prefix.
This functionality is useful for architecture Makefiles that try
to set CROSS_COMPILE to well-known values but may have several
values to select between.
It is recommended only to try to set CROSS_COMPILE if it is a cross
build (host arch is different from target arch). And if CROSS_COMPILE
is already set then leave it with the old value.</p>
<p>Example:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>#arch/m68k/Makefile
ifneq ($(SUBARCH),$(ARCH))
        ifeq ($(CROSS_COMPILE),)
               CROSS_COMPILE := $(call cc-cross-prefix, m68k-linux-gnu-)
        endif
endif
</pre></div>
</div>
</dd>
</dl>
</dd>
</dl>
</div></blockquote>
</section>
<section id="ld-support-functions">
<h3>3.14 $(LD) support functions<a class="headerlink" href="#ld-support-functions" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><dl>
<dt>ld-option</dt><dd><p>ld-option is used to check if $(LD) supports the supplied option.
ld-option takes two options as arguments.
The second argument is an optional option that can be used if the
first option is not supported by $(LD).</p>
<p>Example:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>#Makefile
LDFLAGS_vmlinux += $(call ld-option, -X)
</pre></div>
</div>
</dd>
</dl>
</div></blockquote>
</section>
<section id="script-invocation">
<h3>3.15 Script invocation<a class="headerlink" href="#script-invocation" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><p>Make rules may invoke scripts to build the kernel. The rules shall
always provide the appropriate interpreter to execute the script. They
shall not rely on the execute bits being set, and shall not invoke the
script directly. For the convenience of manual script invocation, such
as invoking ./scripts/checkpatch.pl, it is recommended to set execute
bits on the scripts nonetheless.</p>
<p>Kbuild provides variables $(CONFIG_SHELL), $(AWK), $(PERL),
and $(PYTHON3) to refer to interpreters for the respective
scripts.</p>
<p>Example:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>#Makefile
cmd_depmod = $(CONFIG_SHELL) $(srctree)/scripts/depmod.sh $(DEPMOD) \
             $(KERNELRELEASE)
</pre></div>
</div>
</div></blockquote>
</section>
</section>
<section id="host-program-support">
<h2>4 Host Program support<a class="headerlink" href="#host-program-support" title="Permalink to this headline">¶</a></h2>
<p>Kbuild supports building executables on the host for use during the
compilation stage.
Two steps are required in order to use a host executable.</p>
<p>The first step is to tell kbuild that a host program exists. This is
done utilising the variable “hostprogs”.</p>
<p>The second step is to add an explicit dependency to the executable.
This can be done in two ways. Either add the dependency in a rule,
or utilise the variable “always-y”.
Both possibilities are described in the following.</p>
<section id="simple-host-program">
<h3>4.1 Simple Host Program<a class="headerlink" href="#simple-host-program" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><p>In some cases there is a need to compile and run a program on the
computer where the build is running.
The following line tells kbuild that the program bin2hex shall be
built on the build host.</p>
<p>Example:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>hostprogs := bin2hex
</pre></div>
</div>
<p>Kbuild assumes in the above example that bin2hex is made from a single
c-source file named bin2hex.c located in the same directory as
the Makefile.</p>
</div></blockquote>
</section>
<section id="composite-host-programs">
<h3>4.2 Composite Host Programs<a class="headerlink" href="#composite-host-programs" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><p>Host programs can be made up based on composite objects.
The syntax used to define composite objects for host programs is
similar to the syntax used for kernel objects.
$(&lt;executable&gt;-objs) lists all objects used to link the final
executable.</p>
<p>Example:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>#scripts/lxdialog/Makefile
hostprogs     := lxdialog
lxdialog-objs := checklist.o lxdialog.o
</pre></div>
</div>
<p>Objects with extension .o are compiled from the corresponding .c
files. In the above example, checklist.c is compiled to checklist.o
and lxdialog.c is compiled to lxdialog.o.</p>
<p>Finally, the two .o files are linked to the executable, lxdialog.
Note: The syntax &lt;executable&gt;-y is not permitted for host-programs.</p>
</div></blockquote>
</section>
<section id="using-c-for-host-programs">
<h3>4.3 Using C++ for host programs<a class="headerlink" href="#using-c-for-host-programs" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><p>kbuild offers support for host programs written in C++. This was
introduced solely to support kconfig, and is not recommended
for general use.</p>
<p>Example:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>#scripts/kconfig/Makefile
hostprogs     := qconf
qconf-cxxobjs := qconf.o
</pre></div>
</div>
<p>In the example above the executable is composed of the C++ file
qconf.cc - identified by $(qconf-cxxobjs).</p>
<p>If qconf is composed of a mixture of .c and .cc files, then an
additional line can be used to identify this.</p>
<p>Example:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>#scripts/kconfig/Makefile
hostprogs     := qconf
qconf-cxxobjs := qconf.o
qconf-objs    := check.o
</pre></div>
</div>
</div></blockquote>
</section>
<section id="using-rust-for-host-programs">
<h3>4.4 Using Rust for host programs<a class="headerlink" href="#using-rust-for-host-programs" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><p>Kbuild offers support for host programs written in Rust. However,
since a Rust toolchain is not mandatory for kernel compilation,
it may only be used in scenarios where Rust is required to be
available (e.g. when  <code class="docutils literal notranslate"><span class="pre">CONFIG_RUST</span></code> is enabled).</p>
<p>Example:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>hostprogs     := target
target-rust   := y
</pre></div>
</div>
<p>Kbuild will compile <code class="docutils literal notranslate"><span class="pre">target</span></code> using <code class="docutils literal notranslate"><span class="pre">target.rs</span></code> as the crate root,
located in the same directory as the <code class="docutils literal notranslate"><span class="pre">Makefile</span></code>. The crate may
consist of several source files (see <code class="docutils literal notranslate"><span class="pre">samples/rust/hostprogs</span></code>).</p>
</div></blockquote>
</section>
<section id="controlling-compiler-options-for-host-programs">
<h3>4.5 Controlling compiler options for host programs<a class="headerlink" href="#controlling-compiler-options-for-host-programs" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><p>When compiling host programs, it is possible to set specific flags.
The programs will always be compiled utilising $(HOSTCC) passed
the options specified in $(KBUILD_HOSTCFLAGS).
To set flags that will take effect for all host programs created
in that Makefile, use the variable HOST_EXTRACFLAGS.</p>
<p>Example:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>#scripts/lxdialog/Makefile
HOST_EXTRACFLAGS += -I/usr/include/ncurses
</pre></div>
</div>
<p>To set specific flags for a single file the following construction
is used:</p>
<p>Example:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>#arch/ppc64/boot/Makefile
HOSTCFLAGS_piggyback.o := -DKERNELBASE=$(KERNELBASE)
</pre></div>
</div>
<p>It is also possible to specify additional options to the linker.</p>
<p>Example:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>#scripts/kconfig/Makefile
HOSTLDLIBS_qconf := -L$(QTDIR)/lib
</pre></div>
</div>
<p>When linking qconf, it will be passed the extra option
“-L$(QTDIR)/lib”.</p>
</div></blockquote>
</section>
<section id="when-host-programs-are-actually-built">
<h3>4.6 When host programs are actually built<a class="headerlink" href="#when-host-programs-are-actually-built" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><p>Kbuild will only build host-programs when they are referenced
as a prerequisite.
This is possible in two ways:</p>
<ol class="arabic simple">
<li><p>List the prerequisite explicitly in a custom rule.</p></li>
</ol>
<p>Example:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>#drivers/pci/Makefile
hostprogs := gen-devlist
$(obj)/devlist.h: $(src)/pci.ids $(obj)/gen-devlist
        ( cd $(obj); ./gen-devlist ) &lt; $&lt;
</pre></div>
</div>
<p>The target $(obj)/devlist.h will not be built before
$(obj)/gen-devlist is updated. Note that references to
the host programs in custom rules must be prefixed with $(obj).</p>
<ol class="arabic simple" start="2">
<li><p>Use always-y</p></li>
</ol>
<p>When there is no suitable custom rule, and the host program
shall be built when a makefile is entered, the always-y
variable shall be used.</p>
<p>Example:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>#scripts/lxdialog/Makefile
hostprogs     := lxdialog
always-y      := $(hostprogs)
</pre></div>
</div>
<p>Kbuild provides the following shorthand for this:</p>
<blockquote>
<div><p>hostprogs-always-y := lxdialog</p>
</div></blockquote>
<p>This will tell kbuild to build lxdialog even if not referenced in
any rule.</p>
</div></blockquote>
</section>
</section>
<section id="userspace-program-support">
<h2>5 Userspace Program support<a class="headerlink" href="#userspace-program-support" title="Permalink to this headline">¶</a></h2>
<p>Just like host programs, Kbuild also supports building userspace executables
for the target architecture (i.e. the same architecture as you are building
the kernel for).</p>
<p>The syntax is quite similar. The difference is to use “userprogs” instead of
“hostprogs”.</p>
<section id="simple-userspace-program">
<h3>5.1 Simple Userspace Program<a class="headerlink" href="#simple-userspace-program" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><p>The following line tells kbuild that the program bpf-direct shall be
built for the target architecture.</p>
<p>Example:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>userprogs := bpf-direct
</pre></div>
</div>
<p>Kbuild assumes in the above example that bpf-direct is made from a
single C source file named bpf-direct.c located in the same directory
as the Makefile.</p>
</div></blockquote>
</section>
<section id="composite-userspace-programs">
<h3>5.2 Composite Userspace Programs<a class="headerlink" href="#composite-userspace-programs" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><p>Userspace programs can be made up based on composite objects.
The syntax used to define composite objects for userspace programs is
similar to the syntax used for kernel objects.
$(&lt;executable&gt;-objs) lists all objects used to link the final
executable.</p>
<p>Example:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>#samples/seccomp/Makefile
userprogs      := bpf-fancy
bpf-fancy-objs := bpf-fancy.o bpf-helper.o
</pre></div>
</div>
<p>Objects with extension .o are compiled from the corresponding .c
files. In the above example, bpf-fancy.c is compiled to bpf-fancy.o
and bpf-helper.c is compiled to bpf-helper.o.</p>
<p>Finally, the two .o files are linked to the executable, bpf-fancy.
Note: The syntax &lt;executable&gt;-y is not permitted for userspace programs.</p>
</div></blockquote>
</section>
<section id="controlling-compiler-options-for-userspace-programs">
<h3>5.3 Controlling compiler options for userspace programs<a class="headerlink" href="#controlling-compiler-options-for-userspace-programs" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><p>When compiling userspace programs, it is possible to set specific flags.
The programs will always be compiled utilising $(CC) passed
the options specified in $(KBUILD_USERCFLAGS).
To set flags that will take effect for all userspace programs created
in that Makefile, use the variable userccflags.</p>
<p>Example:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># samples/seccomp/Makefile
userccflags += -I usr/include
</pre></div>
</div>
<p>To set specific flags for a single file the following construction
is used:</p>
<p>Example:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>bpf-helper-userccflags += -I user/include
</pre></div>
</div>
<p>It is also possible to specify additional options to the linker.</p>
<p>Example:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># net/bpfilter/Makefile
bpfilter_umh-userldflags += -static
</pre></div>
</div>
<p>When linking bpfilter_umh, it will be passed the extra option -static.</p>
<p>From command line, <a class="reference internal" href="kbuild.html#userkbuildflags"><span class="std std-ref">USERCFLAGS and USERLDFLAGS</span></a> will also be used.</p>
</div></blockquote>
</section>
<section id="when-userspace-programs-are-actually-built">
<h3>5.4 When userspace programs are actually built<a class="headerlink" href="#when-userspace-programs-are-actually-built" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><p>Kbuild builds userspace programs only when told to do so.
There are two ways to do this.</p>
<ol class="arabic simple">
<li><p>Add it as the prerequisite of another file</p></li>
</ol>
<p>Example:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>#net/bpfilter/Makefile
userprogs := bpfilter_umh
$(obj)/bpfilter_umh_blob.o: $(obj)/bpfilter_umh
</pre></div>
</div>
<p>$(obj)/bpfilter_umh is built before $(obj)/bpfilter_umh_blob.o</p>
<ol class="arabic simple" start="2">
<li><p>Use always-y</p></li>
</ol>
<p>Example:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>userprogs := binderfs_example
always-y := $(userprogs)
</pre></div>
</div>
<p>Kbuild provides the following shorthand for this:</p>
<blockquote>
<div><p>userprogs-always-y := binderfs_example</p>
</div></blockquote>
<p>This will tell Kbuild to build binderfs_example when it visits this
Makefile.</p>
</div></blockquote>
</section>
</section>
<section id="kbuild-clean-infrastructure">
<h2>6 Kbuild clean infrastructure<a class="headerlink" href="#kbuild-clean-infrastructure" title="Permalink to this headline">¶</a></h2>
<p>“make clean” deletes most generated files in the obj tree where the kernel
is compiled. This includes generated files such as host programs.
Kbuild knows targets listed in $(hostprogs), $(always-y), $(always-m),
$(always-), $(extra-y), $(extra-) and $(targets). They are all deleted
during “make clean”. Files matching the patterns “<em>.[oas]”, “</em>.ko”, plus
some additional files generated by kbuild are deleted all over the kernel
source tree when “make clean” is executed.</p>
<p>Additional files or directories can be specified in kbuild makefiles by use of
$(clean-files).</p>
<blockquote>
<div><p>Example:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>#lib/Makefile
clean-files := crc32table.h
</pre></div>
</div>
</div></blockquote>
<p>When executing “make clean”, the file “crc32table.h” will be deleted.
Kbuild will assume files to be in the same relative directory as the
Makefile, except if prefixed with $(objtree).</p>
<p>To exclude certain files or directories from make clean, use the
$(no-clean-files) variable.</p>
<p>Usually kbuild descends down in subdirectories due to “obj-* := dir/”,
but in the architecture makefiles where the kbuild infrastructure
is not sufficient this sometimes needs to be explicit.</p>
<blockquote>
<div><p>Example:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>#arch/x86/boot/Makefile
subdir- := compressed
</pre></div>
</div>
</div></blockquote>
<p>The above assignment instructs kbuild to descend down in the
directory compressed/ when “make clean” is executed.</p>
<p>Note 1: arch/$(SRCARCH)/Makefile cannot use “subdir-”, because that file is
included in the top level makefile. Instead, arch/$(SRCARCH)/Kbuild can use
“subdir-“.</p>
<p>Note 2: All directories listed in core-y, libs-y, drivers-y and net-y will
be visited during “make clean”.</p>
</section>
<section id="architecture-makefiles">
<h2>7 Architecture Makefiles<a class="headerlink" href="#architecture-makefiles" title="Permalink to this headline">¶</a></h2>
<p>The top level Makefile sets up the environment and does the preparation,
before starting to descend down in the individual directories.
The top level makefile contains the generic part, whereas
arch/$(SRCARCH)/Makefile contains what is required to set up kbuild
for said architecture.
To do so, arch/$(SRCARCH)/Makefile sets up a number of variables and defines
a few targets.</p>
<p>When kbuild executes, the following steps are followed (roughly):</p>
<ol class="arabic simple">
<li><p>Configuration of the kernel =&gt; produce .config</p></li>
<li><p>Store kernel version in include/linux/version.h</p></li>
<li><p>Updating all other prerequisites to the target prepare:
- Additional prerequisites are specified in arch/$(SRCARCH)/Makefile</p></li>
<li><p>Recursively descend down in all directories listed in
init-* core* drivers-* net-* libs-* and build all targets.
- The values of the above variables are expanded in arch/$(SRCARCH)/Makefile.</p></li>
<li><p>All object files are then linked and the resulting file vmlinux is
located at the root of the obj tree.
The very first objects linked are listed in scripts/head-object-list.txt.</p></li>
<li><p>Finally, the architecture-specific part does any required post processing
and builds the final bootimage.
- This includes building boot records
- Preparing initrd images and the like</p></li>
</ol>
<section id="set-variables-to-tweak-the-build-to-the-architecture">
<h3>7.1 Set variables to tweak the build to the architecture<a class="headerlink" href="#set-variables-to-tweak-the-build-to-the-architecture" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><dl>
<dt>KBUILD_LDFLAGS</dt><dd><p>Generic $(LD) options</p>
<p>Flags used for all invocations of the linker.
Often specifying the emulation is sufficient.</p>
<p>Example:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>#arch/s390/Makefile
KBUILD_LDFLAGS         := -m elf_s390
</pre></div>
</div>
<p>Note: ldflags-y can be used to further customise
the flags used. See section 3.7.</p>
</dd>
<dt>LDFLAGS_vmlinux</dt><dd><p>Options for $(LD) when linking vmlinux</p>
<p>LDFLAGS_vmlinux is used to specify additional flags to pass to
the linker when linking the final vmlinux image.
LDFLAGS_vmlinux uses the LDFLAGS_$&#64; support.</p>
<p>Example:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>#arch/x86/Makefile
LDFLAGS_vmlinux := -e stext
</pre></div>
</div>
</dd>
<dt>OBJCOPYFLAGS</dt><dd><p>objcopy flags</p>
<p>When $(call if_changed,objcopy) is used to translate a .o file,
the flags specified in OBJCOPYFLAGS will be used.
$(call if_changed,objcopy) is often used to generate raw binaries on
vmlinux.</p>
<p>Example:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>#arch/s390/Makefile
OBJCOPYFLAGS := -O binary

#arch/s390/boot/Makefile
$(obj)/image: vmlinux FORCE
        $(call if_changed,objcopy)
</pre></div>
</div>
<p>In this example, the binary $(obj)/image is a binary version of
vmlinux. The usage of $(call if_changed,xxx) will be described later.</p>
</dd>
<dt>KBUILD_AFLAGS</dt><dd><p>Assembler flags</p>
<p>Default value - see top level Makefile
Append or modify as required per architecture.</p>
<p>Example:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>#arch/sparc64/Makefile
KBUILD_AFLAGS += -m64 -mcpu=ultrasparc
</pre></div>
</div>
</dd>
<dt>KBUILD_CFLAGS</dt><dd><p>$(CC) compiler flags</p>
<p>Default value - see top level Makefile
Append or modify as required per architecture.</p>
<p>Often, the KBUILD_CFLAGS variable depends on the configuration.</p>
<p>Example:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>#arch/x86/boot/compressed/Makefile
cflags-$(CONFIG_X86_32) := -march=i386
cflags-$(CONFIG_X86_64) := -mcmodel=small
KBUILD_CFLAGS += $(cflags-y)
</pre></div>
</div>
<p>Many arch Makefiles dynamically run the target C compiler to
probe supported options:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>#arch/x86/Makefile

...
cflags-$(CONFIG_MPENTIUMII)     += $(call cc-option,\
                                -march=pentium2,-march=i686)
...
# Disable unit-at-a-time mode ...
KBUILD_CFLAGS += $(call cc-option,-fno-unit-at-a-time)
...
</pre></div>
</div>
<p>The first example utilises the trick that a config option expands
to ‘y’ when selected.</p>
</dd>
<dt>KBUILD_RUSTFLAGS</dt><dd><p>$(RUSTC) compiler flags</p>
<p>Default value - see top level Makefile
Append or modify as required per architecture.</p>
<p>Often, the KBUILD_RUSTFLAGS variable depends on the configuration.</p>
<p>Note that target specification file generation (for <code class="docutils literal notranslate"><span class="pre">--target</span></code>)
is handled in <code class="docutils literal notranslate"><span class="pre">scripts/generate_rust_target.rs</span></code>.</p>
</dd>
<dt>KBUILD_AFLAGS_KERNEL</dt><dd><p>Assembler options specific for built-in</p>
<p>$(KBUILD_AFLAGS_KERNEL) contains extra C compiler flags used to compile
resident kernel code.</p>
</dd>
<dt>KBUILD_AFLAGS_MODULE</dt><dd><p>Assembler options specific for modules</p>
<p>$(KBUILD_AFLAGS_MODULE) is used to add arch-specific options that
are used for assembler.</p>
<p>From commandline AFLAGS_MODULE shall be used (see <a class="reference internal" href="kbuild.html"><span class="doc">Kbuild</span></a>).</p>
</dd>
<dt>KBUILD_CFLAGS_KERNEL</dt><dd><p>$(CC) options specific for built-in</p>
<p>$(KBUILD_CFLAGS_KERNEL) contains extra C compiler flags used to compile
resident kernel code.</p>
</dd>
<dt>KBUILD_CFLAGS_MODULE</dt><dd><p>Options for $(CC) when building modules</p>
<p>$(KBUILD_CFLAGS_MODULE) is used to add arch-specific options that
are used for $(CC).
From commandline CFLAGS_MODULE shall be used (see <a class="reference internal" href="kbuild.html"><span class="doc">Kbuild</span></a>).</p>
</dd>
<dt>KBUILD_RUSTFLAGS_KERNEL</dt><dd><p>$(RUSTC) options specific for built-in</p>
<p>$(KBUILD_RUSTFLAGS_KERNEL) contains extra Rust compiler flags used to
compile resident kernel code.</p>
</dd>
<dt>KBUILD_RUSTFLAGS_MODULE</dt><dd><p>Options for $(RUSTC) when building modules</p>
<p>$(KBUILD_RUSTFLAGS_MODULE) is used to add arch-specific options that
are used for $(RUSTC).
From commandline RUSTFLAGS_MODULE shall be used (see <a class="reference internal" href="kbuild.html"><span class="doc">Kbuild</span></a>).</p>
</dd>
<dt>KBUILD_LDFLAGS_MODULE</dt><dd><p>Options for $(LD) when linking modules</p>
<p>$(KBUILD_LDFLAGS_MODULE) is used to add arch-specific options
used when linking modules. This is often a linker script.</p>
<p>From commandline LDFLAGS_MODULE shall be used (see <a class="reference internal" href="kbuild.html"><span class="doc">Kbuild</span></a>).</p>
</dd>
</dl>
<p>KBUILD_LDS</p>
<blockquote>
<div><p>The linker script with full path. Assigned by the top-level Makefile.</p>
</div></blockquote>
<p>KBUILD_LDS_MODULE</p>
<blockquote>
<div><p>The module linker script with full path. Assigned by the top-level
Makefile and additionally by the arch Makefile.</p>
</div></blockquote>
<p>KBUILD_VMLINUX_OBJS</p>
<blockquote>
<div><p>All object files for vmlinux. They are linked to vmlinux in the same
order as listed in KBUILD_VMLINUX_OBJS.</p>
<p>The objects listed in scripts/head-object-list.txt are exceptions;
they are placed before the other objects.</p>
</div></blockquote>
<p>KBUILD_VMLINUX_LIBS</p>
<blockquote>
<div><p>All .a “lib” files for vmlinux. KBUILD_VMLINUX_OBJS and
KBUILD_VMLINUX_LIBS together specify all the object files used to
link vmlinux.</p>
</div></blockquote>
</div></blockquote>
</section>
<section id="add-prerequisites-to-archheaders">
<h3>7.2 Add prerequisites to archheaders<a class="headerlink" href="#add-prerequisites-to-archheaders" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><p>The archheaders: rule is used to generate header files that
may be installed into user space by “make header_install”.</p>
<p>It is run before “make archprepare” when run on the
architecture itself.</p>
</div></blockquote>
</section>
<section id="add-prerequisites-to-archprepare">
<h3>7.3 Add prerequisites to archprepare<a class="headerlink" href="#add-prerequisites-to-archprepare" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><p>The archprepare: rule is used to list prerequisites that need to be
built before starting to descend down in the subdirectories.
This is usually used for header files containing assembler constants.</p>
<p>Example:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>#arch/arm/Makefile
archprepare: maketools
</pre></div>
</div>
<p>In this example, the file target maketools will be processed
before descending down in the subdirectories.
See also chapter XXX-TODO that describes how kbuild supports
generating offset header files.</p>
</div></blockquote>
</section>
<section id="list-directories-to-visit-when-descending">
<h3>7.4 List directories to visit when descending<a class="headerlink" href="#list-directories-to-visit-when-descending" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><p>An arch Makefile cooperates with the top Makefile to define variables
which specify how to build the vmlinux file.  Note that there is no
corresponding arch-specific section for modules; the module-building
machinery is all architecture-independent.</p>
<p>core-y, libs-y, drivers-y</p>
<blockquote>
<div><p>$(libs-y) lists directories where a lib.a archive can be located.</p>
<p>The rest list directories where a built-in.a object file can be
located.</p>
<p>Then the rest follows in this order:</p>
<blockquote>
<div><p>$(core-y), $(libs-y), $(drivers-y)</p>
</div></blockquote>
<p>The top level Makefile defines values for all generic directories,
and arch/$(SRCARCH)/Makefile only adds architecture-specific
directories.</p>
<p>Example:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># arch/sparc/Makefile
core-y                 += arch/sparc/

libs-y                 += arch/sparc/prom/
libs-y                 += arch/sparc/lib/

drivers-$(CONFIG_PM) += arch/sparc/power/
</pre></div>
</div>
</div></blockquote>
</div></blockquote>
</section>
<section id="architecture-specific-boot-images">
<h3>7.5 Architecture-specific boot images<a class="headerlink" href="#architecture-specific-boot-images" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><p>An arch Makefile specifies goals that take the vmlinux file, compress
it, wrap it in bootstrapping code, and copy the resulting files
somewhere. This includes various kinds of installation commands.
The actual goals are not standardized across architectures.</p>
<p>It is common to locate any additional processing in a boot/
directory below arch/$(SRCARCH)/.</p>
<p>Kbuild does not provide any smart way to support building a
target specified in boot/. Therefore arch/$(SRCARCH)/Makefile shall
call make manually to build a target in boot/.</p>
<p>The recommended approach is to include shortcuts in
arch/$(SRCARCH)/Makefile, and use the full path when calling down
into the arch/$(SRCARCH)/boot/Makefile.</p>
<p>Example:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>#arch/x86/Makefile
boot := arch/x86/boot
bzImage: vmlinux
        $(Q)$(MAKE) $(build)=$(boot) $(boot)/$@
</pre></div>
</div>
<p>“$(Q)$(MAKE) $(build)=&lt;dir&gt;” is the recommended way to invoke
make in a subdirectory.</p>
<p>There are no rules for naming architecture-specific targets,
but executing “make help” will list all relevant targets.
To support this, $(archhelp) must be defined.</p>
<p>Example:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>#arch/x86/Makefile
define archhelp
  echo  &#39;* bzImage      - Compressed kernel image (arch/x86/boot/bzImage)&#39;
endif
</pre></div>
</div>
<p>When make is executed without arguments, the first goal encountered
will be built. In the top level Makefile the first goal present
is all:.
An architecture shall always, per default, build a bootable image.
In “make help”, the default goal is highlighted with a ‘*’.
Add a new prerequisite to all: to select a default goal different
from vmlinux.</p>
<p>Example:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>#arch/x86/Makefile
all: bzImage
</pre></div>
</div>
<p>When “make” is executed without arguments, bzImage will be built.</p>
</div></blockquote>
</section>
<section id="commands-useful-for-building-a-boot-image">
<h3>7.7 Commands useful for building a boot image<a class="headerlink" href="#commands-useful-for-building-a-boot-image" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><p>Kbuild provides a few macros that are useful when building a
boot image.</p>
<dl>
<dt>ld</dt><dd><p>Link target. Often, LDFLAGS_$&#64; is used to set specific options to ld.</p>
<p>Example:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>#arch/x86/boot/Makefile
LDFLAGS_bootsect := -Ttext 0x0 -s --oformat binary
LDFLAGS_setup    := -Ttext 0x0 -s --oformat binary -e begtext

targets += setup setup.o bootsect bootsect.o
$(obj)/setup $(obj)/bootsect: %: %.o FORCE
        $(call if_changed,ld)
</pre></div>
</div>
<p>In this example, there are two possible targets, requiring different
options to the linker. The linker options are specified using the
LDFLAGS_$&#64; syntax - one for each potential target.
$(targets) are assigned all potential targets, by which kbuild knows
the targets and will:</p>
<blockquote>
<div><ol class="arabic simple">
<li><p>check for commandline changes</p></li>
<li><p>delete target during make clean</p></li>
</ol>
</div></blockquote>
<p>The “: %: %.o” part of the prerequisite is a shorthand that
frees us from listing the setup.o and bootsect.o files.</p>
<dl class="simple">
<dt>Note:</dt><dd><p>It is a common mistake to forget the “targets :=” assignment,
resulting in the target file being recompiled for no
obvious reason.</p>
</dd>
</dl>
</dd>
<dt>objcopy</dt><dd><p>Copy binary. Uses OBJCOPYFLAGS usually specified in
arch/$(SRCARCH)/Makefile.
OBJCOPYFLAGS_$&#64; may be used to set additional options.</p>
</dd>
<dt>gzip</dt><dd><p>Compress target. Use maximum compression to compress target.</p>
<p>Example:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>#arch/x86/boot/compressed/Makefile
$(obj)/vmlinux.bin.gz: $(vmlinux.bin.all-y) FORCE
        $(call if_changed,gzip)
</pre></div>
</div>
</dd>
<dt>dtc</dt><dd><p>Create flattened device tree blob object suitable for linking
into vmlinux. Device tree blobs linked into vmlinux are placed
in an init section in the image. Platform code <em>must</em> copy the
blob to non-init memory prior to calling unflatten_device_tree().</p>
<p>To use this command, simply add <cite>*.dtb</cite> into obj-y or targets, or make
some other target depend on <cite>%.dtb</cite></p>
<p>A central rule exists to create <cite>$(obj)/%.dtb</cite> from <cite>$(src)/%.dts</cite>;
architecture Makefiles do no need to explicitly write out that rule.</p>
<p>Example:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>targets += $(dtb-y)
DTC_FLAGS ?= -p 1024
</pre></div>
</div>
</dd>
</dl>
</div></blockquote>
</section>
<section id="preprocessing-linker-scripts">
<h3>7.9 Preprocessing linker scripts<a class="headerlink" href="#preprocessing-linker-scripts" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><p>When the vmlinux image is built, the linker script
arch/$(SRCARCH)/kernel/vmlinux.lds is used.
The script is a preprocessed variant of the file vmlinux.lds.S
located in the same directory.
kbuild knows .lds files and includes a rule <cite>*lds.S</cite> -&gt; <cite>*lds</cite>.</p>
<p>Example:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>#arch/x86/kernel/Makefile
extra-y := vmlinux.lds
</pre></div>
</div>
<p>The assignment to extra-y is used to tell kbuild to build the
target vmlinux.lds.
The assignment to $(CPPFLAGS_vmlinux.lds) tells kbuild to use the
specified options when building the target vmlinux.lds.</p>
<p>When building the <cite>*.lds</cite> target, kbuild uses the variables:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>KBUILD_CPPFLAGS : Set in top-level Makefile
cppflags-y      : May be set in the kbuild makefile
CPPFLAGS_$(@F)  : Target-specific flags.
                Note that the full filename is used in this
                assignment.
</pre></div>
</div>
<p>The kbuild infrastructure for <cite>*lds</cite> files is used in several
architecture-specific files.</p>
</div></blockquote>
</section>
<section id="generic-header-files">
<h3>7.10 Generic header files<a class="headerlink" href="#generic-header-files" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><p>The directory include/asm-generic contains the header files
that may be shared between individual architectures.
The recommended approach how to use a generic header file is
to list the file in the Kbuild file.
See “8.2 generic-y” for further info on syntax etc.</p>
</div></blockquote>
</section>
<section id="post-link-pass">
<h3>7.11 Post-link pass<a class="headerlink" href="#post-link-pass" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><p>If the file arch/xxx/Makefile.postlink exists, this makefile
will be invoked for post-link objects (vmlinux and modules.ko)
for architectures to run post-link passes on. Must also handle
the clean target.</p>
<p>This pass runs after kallsyms generation. If the architecture
needs to modify symbol locations, rather than manipulate the
kallsyms, it may be easier to add another postlink target for
.tmp_vmlinux? targets to be called from link-vmlinux.sh.</p>
<p>For example, powerpc uses this to check relocation sanity of
the linked vmlinux file.</p>
</div></blockquote>
</section>
<section id="kbuild-syntax-for-exported-headers">
<h3>8 Kbuild syntax for exported headers<a class="headerlink" href="#kbuild-syntax-for-exported-headers" title="Permalink to this headline">¶</a></h3>
<p>The kernel includes a set of headers that is exported to userspace.
Many headers can be exported as-is but other headers require a
minimal pre-processing before they are ready for user-space.
The pre-processing does:</p>
<ul class="simple">
<li><p>drop kernel-specific annotations</p></li>
<li><p>drop include of compiler.h</p></li>
<li><p>drop all sections that are kernel internal (guarded by <cite>ifdef __KERNEL__</cite>)</p></li>
</ul>
<p>All headers under include/uapi/, include/generated/uapi/,
arch/&lt;arch&gt;/include/uapi/ and arch/&lt;arch&gt;/include/generated/uapi/
are exported.</p>
<p>A Kbuild file may be defined under arch/&lt;arch&gt;/include/uapi/asm/ and
arch/&lt;arch&gt;/include/asm/ to list asm files coming from asm-generic.
See subsequent chapter for the syntax of the Kbuild file.</p>
</section>
<section id="no-export-headers">
<h3>8.1 no-export-headers<a class="headerlink" href="#no-export-headers" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><p>no-export-headers is essentially used by include/uapi/linux/Kbuild to
avoid exporting specific headers (e.g. kvm.h) on architectures that do
not support it. It should be avoided as much as possible.</p>
</div></blockquote>
</section>
<section id="generic-y">
<h3>8.2 generic-y<a class="headerlink" href="#generic-y" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><p>If an architecture uses a verbatim copy of a header from
include/asm-generic then this is listed in the file
arch/$(SRCARCH)/include/asm/Kbuild like this:</p>
<blockquote>
<div><p>Example:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>#arch/x86/include/asm/Kbuild
generic-y += termios.h
generic-y += rtc.h
</pre></div>
</div>
</div></blockquote>
<p>During the prepare phase of the build a wrapper include
file is generated in the directory:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>arch/$(SRCARCH)/include/generated/asm
</pre></div>
</div>
<p>When a header is exported where the architecture uses
the generic header a similar wrapper is generated as part
of the set of exported headers in the directory:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>usr/include/asm
</pre></div>
</div>
<p>The generated wrapper will in both cases look like the following:</p>
<blockquote>
<div><p>Example: termios.h:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>#include &lt;asm-generic/termios.h&gt;
</pre></div>
</div>
</div></blockquote>
</div></blockquote>
</section>
<section id="generated-y">
<h3>8.3 generated-y<a class="headerlink" href="#generated-y" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><p>If an architecture generates other header files alongside generic-y
wrappers, generated-y specifies them.</p>
<p>This prevents them being treated as stale asm-generic wrappers and
removed.</p>
<blockquote>
<div><p>Example:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>#arch/x86/include/asm/Kbuild
generated-y += syscalls_32.h
</pre></div>
</div>
</div></blockquote>
</div></blockquote>
</section>
<section id="mandatory-y">
<h3>8.4 mandatory-y<a class="headerlink" href="#mandatory-y" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><p>mandatory-y is essentially used by include/(uapi/)asm-generic/Kbuild
to define the minimum set of ASM headers that all architectures must have.</p>
<p>This works like optional generic-y. If a mandatory header is missing
in arch/$(SRCARCH)/include/(uapi/)/asm, Kbuild will automatically
generate a wrapper of the asm-generic one.</p>
</div></blockquote>
</section>
</section>
<section id="kbuild-variables">
<h2>9 Kbuild Variables<a class="headerlink" href="#kbuild-variables" title="Permalink to this headline">¶</a></h2>
<p>The top Makefile exports the following variables:</p>
<blockquote>
<div><dl>
<dt>VERSION, PATCHLEVEL, SUBLEVEL, EXTRAVERSION</dt><dd><p>These variables define the current kernel version.  A few arch
Makefiles actually use these values directly; they should use
$(KERNELRELEASE) instead.</p>
<p>$(VERSION), $(PATCHLEVEL), and $(SUBLEVEL) define the basic
three-part version number, such as “2”, “4”, and “0”.  These three
values are always numeric.</p>
<p>$(EXTRAVERSION) defines an even tinier sublevel for pre-patches
or additional patches.  It is usually some non-numeric string
such as “-pre4”, and is often blank.</p>
</dd>
<dt>KERNELRELEASE</dt><dd><p>$(KERNELRELEASE) is a single string such as “2.4.0-pre4”, suitable
for constructing installation directory names or showing in
version strings.  Some arch Makefiles use it for this purpose.</p>
</dd>
<dt>ARCH</dt><dd><p>This variable defines the target architecture, such as “i386”,
“arm”, or “sparc”. Some kbuild Makefiles test $(ARCH) to
determine which files to compile.</p>
<p>By default, the top Makefile sets $(ARCH) to be the same as the
host system architecture.  For a cross build, a user may
override the value of $(ARCH) on the command line:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>make ARCH=m68k ...
</pre></div>
</div>
</dd>
<dt>SRCARCH</dt><dd><p>This variable specifies the directory in arch/ to build.</p>
<p>ARCH and SRCARCH may not necessarily match. A couple of arch
directories are biarch, that is, a single <cite>arch/*/</cite> directory supports
both 32-bit and 64-bit.</p>
<p>For example, you can pass in ARCH=i386, ARCH=x86_64, or ARCH=x86.
For all of them, SRCARCH=x86 because arch/x86/ supports both i386 and
x86_64.</p>
</dd>
<dt>INSTALL_PATH</dt><dd><p>This variable defines a place for the arch Makefiles to install
the resident kernel image and System.map file.
Use this for architecture-specific install targets.</p>
</dd>
<dt>INSTALL_MOD_PATH, MODLIB</dt><dd><p>$(INSTALL_MOD_PATH) specifies a prefix to $(MODLIB) for module
installation.  This variable is not defined in the Makefile but
may be passed in by the user if desired.</p>
<p>$(MODLIB) specifies the directory for module installation.
The top Makefile defines $(MODLIB) to
$(INSTALL_MOD_PATH)/lib/modules/$(KERNELRELEASE).  The user may
override this value on the command line if desired.</p>
</dd>
<dt>INSTALL_MOD_STRIP</dt><dd><p>If this variable is specified, it will cause modules to be stripped
after they are installed.  If INSTALL_MOD_STRIP is ‘1’, then the
default option –strip-debug will be used.  Otherwise, the
INSTALL_MOD_STRIP value will be used as the option(s) to the strip
command.</p>
</dd>
</dl>
</div></blockquote>
</section>
<section id="makefile-language">
<h2>10 Makefile language<a class="headerlink" href="#makefile-language" title="Permalink to this headline">¶</a></h2>
<p>The kernel Makefiles are designed to be run with GNU Make.  The Makefiles
use only the documented features of GNU Make, but they do use many
GNU extensions.</p>
<p>GNU Make supports elementary list-processing functions.  The kernel
Makefiles use a novel style of list building and manipulation with few
“if” statements.</p>
<p>GNU Make has two assignment operators, “:=” and “=”.  “:=” performs
immediate evaluation of the right-hand side and stores an actual string
into the left-hand side.  “=” is like a formula definition; it stores the
right-hand side in an unevaluated form and then evaluates this form each
time the left-hand side is used.</p>
<p>There are some cases where “=” is appropriate.  Usually, though, “:=”
is the right choice.</p>
</section>
<section id="credits">
<h2>11 Credits<a class="headerlink" href="#credits" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Original version made by Michael Elizabeth Chastain, &lt;<a class="reference external" href="mailto:mec&#37;&#52;&#48;shout&#46;net">mailto:mec<span>&#64;</span>shout<span>&#46;</span>net</a>&gt;</p></li>
<li><p>Updates by Kai Germaschewski &lt;<a class="reference external" href="mailto:kai&#37;&#52;&#48;tp1&#46;ruhr-uni-bochum&#46;de">kai<span>&#64;</span>tp1<span>&#46;</span>ruhr-uni-bochum<span>&#46;</span>de</a>&gt;</p></li>
<li><p>Updates by Sam Ravnborg &lt;<a class="reference external" href="mailto:sam&#37;&#52;&#48;ravnborg&#46;org">sam<span>&#64;</span>ravnborg<span>&#46;</span>org</a>&gt;</p></li>
<li><p>Language QA by Jan Engelhardt &lt;<a class="reference external" href="mailto:jengelh&#37;&#52;&#48;gmx&#46;de">jengelh<span>&#64;</span>gmx<span>&#46;</span>de</a>&gt;</p></li>
</ul>
</section>
<section id="todo">
<h2>12 TODO<a class="headerlink" href="#todo" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Describe how kbuild supports shipped files with _shipped.</p></li>
<li><p>Generating offset header files.</p></li>
<li><p>Add more variables to chapters 7 or 9?</p></li>
</ul>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../index.html">The Linux Kernel</a></h1>



<p class="blurb">6.2.0-rc4-6.2.0-rc4+</p>







<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
  <h3><a href="../index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Linux Kernel Makefiles</a><ul>
<li><a class="reference internal" href="#overview">1 Overview</a></li>
<li><a class="reference internal" href="#who-does-what">2 Who does what</a></li>
<li><a class="reference internal" href="#the-kbuild-files">3 The kbuild files</a><ul>
<li><a class="reference internal" href="#goal-definitions">3.1 Goal definitions</a></li>
<li><a class="reference internal" href="#built-in-object-goals-obj-y">3.2 Built-in object goals - obj-y</a></li>
<li><a class="reference internal" href="#loadable-module-goals-obj-m">3.3 Loadable module goals - obj-m</a></li>
<li><a class="reference internal" href="#library-file-goals-lib-y">3.5 Library file goals - lib-y</a></li>
<li><a class="reference internal" href="#descending-down-in-directories">3.6 Descending down in directories</a></li>
<li><a class="reference internal" href="#non-builtin-vmlinux-targets-extra-y">3.7 Non-builtin vmlinux targets - extra-y</a></li>
<li><a class="reference internal" href="#always-built-goals-always-y">3.8 Always built goals - always-y</a></li>
<li><a class="reference internal" href="#compilation-flags">3.9 Compilation flags</a></li>
<li><a class="reference internal" href="#dependency-tracking">3.10 Dependency tracking</a></li>
<li><a class="reference internal" href="#custom-rules">3.11 Custom Rules</a></li>
<li><a class="reference internal" href="#command-change-detection">3.12 Command change detection</a></li>
<li><a class="reference internal" href="#cc-support-functions">3.13 $(CC) support functions</a></li>
<li><a class="reference internal" href="#ld-support-functions">3.14 $(LD) support functions</a></li>
<li><a class="reference internal" href="#script-invocation">3.15 Script invocation</a></li>
</ul>
</li>
<li><a class="reference internal" href="#host-program-support">4 Host Program support</a><ul>
<li><a class="reference internal" href="#simple-host-program">4.1 Simple Host Program</a></li>
<li><a class="reference internal" href="#composite-host-programs">4.2 Composite Host Programs</a></li>
<li><a class="reference internal" href="#using-c-for-host-programs">4.3 Using C++ for host programs</a></li>
<li><a class="reference internal" href="#using-rust-for-host-programs">4.4 Using Rust for host programs</a></li>
<li><a class="reference internal" href="#controlling-compiler-options-for-host-programs">4.5 Controlling compiler options for host programs</a></li>
<li><a class="reference internal" href="#when-host-programs-are-actually-built">4.6 When host programs are actually built</a></li>
</ul>
</li>
<li><a class="reference internal" href="#userspace-program-support">5 Userspace Program support</a><ul>
<li><a class="reference internal" href="#simple-userspace-program">5.1 Simple Userspace Program</a></li>
<li><a class="reference internal" href="#composite-userspace-programs">5.2 Composite Userspace Programs</a></li>
<li><a class="reference internal" href="#controlling-compiler-options-for-userspace-programs">5.3 Controlling compiler options for userspace programs</a></li>
<li><a class="reference internal" href="#when-userspace-programs-are-actually-built">5.4 When userspace programs are actually built</a></li>
</ul>
</li>
<li><a class="reference internal" href="#kbuild-clean-infrastructure">6 Kbuild clean infrastructure</a></li>
<li><a class="reference internal" href="#architecture-makefiles">7 Architecture Makefiles</a><ul>
<li><a class="reference internal" href="#set-variables-to-tweak-the-build-to-the-architecture">7.1 Set variables to tweak the build to the architecture</a></li>
<li><a class="reference internal" href="#add-prerequisites-to-archheaders">7.2 Add prerequisites to archheaders</a></li>
<li><a class="reference internal" href="#add-prerequisites-to-archprepare">7.3 Add prerequisites to archprepare</a></li>
<li><a class="reference internal" href="#list-directories-to-visit-when-descending">7.4 List directories to visit when descending</a></li>
<li><a class="reference internal" href="#architecture-specific-boot-images">7.5 Architecture-specific boot images</a></li>
<li><a class="reference internal" href="#commands-useful-for-building-a-boot-image">7.7 Commands useful for building a boot image</a></li>
<li><a class="reference internal" href="#preprocessing-linker-scripts">7.9 Preprocessing linker scripts</a></li>
<li><a class="reference internal" href="#generic-header-files">7.10 Generic header files</a></li>
<li><a class="reference internal" href="#post-link-pass">7.11 Post-link pass</a></li>
<li><a class="reference internal" href="#kbuild-syntax-for-exported-headers">8 Kbuild syntax for exported headers</a></li>
<li><a class="reference internal" href="#no-export-headers">8.1 no-export-headers</a></li>
<li><a class="reference internal" href="#generic-y">8.2 generic-y</a></li>
<li><a class="reference internal" href="#generated-y">8.3 generated-y</a></li>
<li><a class="reference internal" href="#mandatory-y">8.4 mandatory-y</a></li>
</ul>
</li>
<li><a class="reference internal" href="#kbuild-variables">9 Kbuild Variables</a></li>
<li><a class="reference internal" href="#makefile-language">10 Makefile language</a></li>
<li><a class="reference internal" href="#credits">11 Credits</a></li>
<li><a class="reference internal" href="#todo">12 TODO</a></li>
</ul>
</li>
</ul>

  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/kbuild/makefiles.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;The kernel development community.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 2.4.4</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="../_sources/kbuild/makefiles.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>