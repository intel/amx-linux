
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Coresight - HW Assisted Tracing on ARM &#8212; The Linux Kernel 6.2.0-rc4+ documentation</title>
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="CoreSight System Configuration Manager" href="coresight-config.html" />
    <link rel="prev" title="CoreSight - ARM Hardware Trace" href="index.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="coresight-hw-assisted-tracing-on-arm">
<h1>Coresight - HW Assisted Tracing on ARM<a class="headerlink" href="#coresight-hw-assisted-tracing-on-arm" title="Permalink to this headline">¶</a></h1>
<blockquote>
<div><dl class="field-list simple">
<dt class="field-odd">Author</dt>
<dd class="field-odd"><p>Mathieu Poirier &lt;<a class="reference external" href="mailto:mathieu&#46;poirier&#37;&#52;&#48;linaro&#46;org">mathieu<span>&#46;</span>poirier<span>&#64;</span>linaro<span>&#46;</span>org</a>&gt;</p>
</dd>
<dt class="field-even">Date</dt>
<dd class="field-even"><p>September 11th, 2014</p>
</dd>
</dl>
</div></blockquote>
<section id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p>Coresight is an umbrella of technologies allowing for the debugging of ARM
based SoC.  It includes solutions for JTAG and HW assisted tracing.  This
document is concerned with the latter.</p>
<p>HW assisted tracing is becoming increasingly useful when dealing with systems
that have many SoCs and other components like GPU and DMA engines.  ARM has
developed a HW assisted tracing solution by means of different components, each
being added to a design at synthesis time to cater to specific tracing needs.
Components are generally categorised as source, link and sinks and are
(usually) discovered using the AMBA bus.</p>
<p>“Sources” generate a compressed stream representing the processor instruction
path based on tracing scenarios as configured by users.  From there the stream
flows through the coresight system (via ATB bus) using links that are connecting
the emanating source to a sink(s).  Sinks serve as endpoints to the coresight
implementation, either storing the compressed stream in a memory buffer or
creating an interface to the outside world where data can be transferred to a
host without fear of filling up the onboard coresight memory buffer.</p>
<p>At typical coresight system would look like this:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span> *****************************************************************
**************************** AMBA AXI  ****************************===||
 *****************************************************************    ||
       ^                    ^                            |            ||
       |                    |                            *            **
    0000000    :::::     0000000    :::::    :::::    @@@@@@@    ||||||||||||
    0 CPU 0&lt;--&gt;: C :     0 CPU 0&lt;--&gt;: C :    : C :    @ STM @    || System ||
 |-&gt;0000000    : T :  |-&gt;0000000    : T :    : T :&lt;---&gt;@@@@@     || Memory ||
 |  #######&lt;--&gt;: I :  |  #######&lt;--&gt;: I :    : I :      @@@&lt;-|   ||||||||||||
 |  # ETM #    :::::  |  # PTM #    :::::    :::::       @   |
 |   #####      ^ ^   |   #####      ^ !      ^ !        .   |   |||||||||
 | |-&gt;###       | !   | |-&gt;###       | !      | !        .   |   || DAP ||
 | |   #        | !   | |   #        | !      | !        .   |   |||||||||
 | |   .        | !   | |   .        | !      | !        .   |      |  |
 | |   .        | !   | |   .        | !      | !        .   |      |  *
 | |   .        | !   | |   .        | !      | !        .   |      | SWD/
 | |   .        | !   | |   .        | !      | !        .   |      | JTAG
 *****************************************************************&lt;-|
*************************** AMBA Debug APB ************************
 *****************************************************************
  |    .          !         .          !        !        .    |
  |    .          *         .          *        *        .    |
 *****************************************************************
******************** Cross Trigger Matrix (CTM) *******************
 *****************************************************************
  |    .     ^              .                            .    |
  |    *     !              *                            *    |
 *****************************************************************
****************** AMBA Advanced Trace Bus (ATB) ******************
 *****************************************************************
  |          !                        ===============         |
  |          *                         ===== F =====&lt;---------|
  |   :::::::::                         ==== U ====
  |--&gt;:: CTI ::&lt;!!                       === N ===
  |   :::::::::  !                        == N ==
  |    ^         *                        == E ==
  |    !  &amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;       IIIIIII         == L ==
  |------&gt;&amp;&amp; ETB &amp;&amp;&lt;......II     I        =======
  |    !  &amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;       II     I           .
  |    !                    I     I          .
  |    !                    I REP I&lt;..........
  |    !                    I     I
  |    !!&gt;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;       II     I           *Source: ARM ltd.
  |------&gt;&amp; TPIU  &amp;&lt;......II    I            DAP = Debug Access Port
          &amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;       IIIIIII            ETM = Embedded Trace Macrocell
              ;                              PTM = Program Trace Macrocell
              ;                              CTI = Cross Trigger Interface
              *                              ETB = Embedded Trace Buffer
         To trace port                       TPIU= Trace Port Interface Unit
                                             SWD = Serial Wire Debug
</pre></div>
</div>
<p>While on target configuration of the components is done via the APB bus,
all trace data are carried out-of-band on the ATB bus.  The CTM provides
a way to aggregate and distribute signals between CoreSight components.</p>
<p>The coresight framework provides a central point to represent, configure and
manage coresight devices on a platform.  This first implementation centers on
the basic tracing functionality, enabling components such ETM/PTM, funnel,
replicator, TMC, TPIU and ETB.  Future work will enable more
intricate IP blocks such as STM and CTI.</p>
</section>
<section id="acronyms-and-classification">
<h2>Acronyms and Classification<a class="headerlink" href="#acronyms-and-classification" title="Permalink to this headline">¶</a></h2>
<p>Acronyms:</p>
<dl class="simple">
<dt>PTM:</dt><dd><p>Program Trace Macrocell</p>
</dd>
<dt>ETM:</dt><dd><p>Embedded Trace Macrocell</p>
</dd>
<dt>STM:</dt><dd><p>System trace Macrocell</p>
</dd>
<dt>ETB:</dt><dd><p>Embedded Trace Buffer</p>
</dd>
<dt>ITM:</dt><dd><p>Instrumentation Trace Macrocell</p>
</dd>
<dt>TPIU:</dt><dd><p>Trace Port Interface Unit</p>
</dd>
<dt>TMC-ETR:</dt><dd><p>Trace Memory Controller, configured as Embedded Trace Router</p>
</dd>
<dt>TMC-ETF:</dt><dd><p>Trace Memory Controller, configured as Embedded Trace FIFO</p>
</dd>
<dt>CTI:</dt><dd><p>Cross Trigger Interface</p>
</dd>
</dl>
<p>Classification:</p>
<dl class="simple">
<dt>Source:</dt><dd><p>ETMv3.x ETMv4, PTMv1.0, PTMv1.1, STM, STM500, ITM</p>
</dd>
<dt>Link:</dt><dd><p>Funnel, replicator (intelligent or not), TMC-ETR</p>
</dd>
<dt>Sinks:</dt><dd><p>ETBv1.0, ETB1.1, TPIU, TMC-ETF</p>
</dd>
<dt>Misc:</dt><dd><p>CTI</p>
</dd>
</dl>
</section>
<section id="device-tree-bindings">
<h2>Device Tree Bindings<a class="headerlink" href="#device-tree-bindings" title="Permalink to this headline">¶</a></h2>
<p>See Documentation/devicetree/bindings/arm/arm,coresight-*.yaml for details.</p>
<p>As of this writing drivers for ITM, STMs and CTIs are not provided but are
expected to be added as the solution matures.</p>
</section>
<section id="framework-and-implementation">
<h2>Framework and implementation<a class="headerlink" href="#framework-and-implementation" title="Permalink to this headline">¶</a></h2>
<p>The coresight framework provides a central point to represent, configure and
manage coresight devices on a platform.  Any coresight compliant device can
register with the framework for as long as they use the right APIs:</p>
<dl class="function">
<dt>
<code class="sig-name descname">struct coresight_device *coresight_register(struct coresight_desc *desc);</code></dt>
<dd></dd></dl>

<dl class="function">
<dt>
<code class="sig-name descname">void coresight_unregister(struct coresight_device *csdev);</code></dt>
<dd></dd></dl>

<p>The registering function is taking a <code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">coresight_desc</span> <span class="pre">*desc</span></code> and
register the device with the core framework. The unregister function takes
a reference to a <code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">coresight_device</span> <span class="pre">*csdev</span></code> obtained at registration time.</p>
<p>If everything goes well during the registration process the new devices will
show up under /sys/bus/coresight/devices, as showns here for a TC2 platform:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>root:~# ls /sys/bus/coresight/devices/
replicator  20030000.tpiu    2201c000.ptm  2203c000.etm  2203e000.etm
20010000.etb         20040000.funnel  2201d000.ptm  2203d000.etm
root:~#
</pre></div>
</div>
<p>The functions take a <code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">coresight_device</span></code>, which looks like this:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>struct coresight_desc {
        enum coresight_dev_type type;
        struct coresight_dev_subtype subtype;
        const struct coresight_ops *ops;
        struct coresight_platform_data *pdata;
        struct device *dev;
        const struct attribute_group **groups;
};
</pre></div>
</div>
<p>The “coresight_dev_type” identifies what the device is, i.e, source link or
sink while the “coresight_dev_subtype” will characterise that type further.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">coresight_ops</span></code> is mandatory and will tell the framework how to
perform base operations related to the components, each component having
a different set of requirement. For that <code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">coresight_ops_sink</span></code>,
<code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">coresight_ops_link</span></code> and <code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">coresight_ops_source</span></code> have been
provided.</p>
<p>The next field <code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">coresight_platform_data</span> <span class="pre">*pdata</span></code> is acquired by calling
<code class="docutils literal notranslate"><span class="pre">of_get_coresight_platform_data()</span></code>, as part of the driver’s _probe routine and
<code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">device</span> <span class="pre">*dev</span></code> gets the device reference embedded in the <code class="docutils literal notranslate"><span class="pre">amba_device</span></code>:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>static int etm_probe(struct amba_device *adev, const struct amba_id *id)
{
 ...
 ...
 drvdata-&gt;dev = &amp;adev-&gt;dev;
 ...
}
</pre></div>
</div>
<p>Specific class of device (source, link, or sink) have generic operations
that can be performed on them (see <code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">coresight_ops</span></code>). The <code class="docutils literal notranslate"><span class="pre">**groups</span></code>
is a list of sysfs entries pertaining to operations
specific to that component only.  “Implementation defined” customisations are
expected to be accessed and controlled using those entries.</p>
</section>
<section id="device-naming-scheme">
<h2>Device Naming scheme<a class="headerlink" href="#device-naming-scheme" title="Permalink to this headline">¶</a></h2>
<p>The devices that appear on the “coresight” bus were named the same as their
parent devices, i.e, the real devices that appears on AMBA bus or the platform bus.
Thus the names were based on the Linux Open Firmware layer naming convention,
which follows the base physical address of the device followed by the device
type. e.g:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>root:~# ls /sys/bus/coresight/devices/
 20010000.etf  20040000.funnel      20100000.stm     22040000.etm
 22140000.etm  230c0000.funnel      23240000.etm     20030000.tpiu
 20070000.etr  20120000.replicator  220c0000.funnel
 23040000.etm  23140000.etm         23340000.etm
</pre></div>
</div>
<p>However, with the introduction of ACPI support, the names of the real
devices are a bit cryptic and non-obvious. Thus, a new naming scheme was
introduced to use more generic names based on the type of the device. The
following rules apply:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>1) Devices that are bound to CPUs, are named based on the CPU logical
   number.

   e.g, ETM bound to CPU0 is named &quot;etm0&quot;

2) All other devices follow a pattern, &quot;&lt;device_type_prefix&gt;N&quot;, where :

      &lt;device_type_prefix&gt;    - A prefix specific to the type of the device
      N                       - a sequential number assigned based on the order
                                of probing.

      e.g, tmc_etf0, tmc_etr0, funnel0, funnel1
</pre></div>
</div>
<p>Thus, with the new scheme the devices could appear as</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>root:~# ls /sys/bus/coresight/devices/
 etm0     etm1     etm2         etm3  etm4      etm5      funnel0
 funnel1  funnel2  replicator0  stm0  tmc_etf0  tmc_etr0  tpiu0
</pre></div>
</div>
<p>Some of the examples below might refer to old naming scheme and some
to the newer scheme, to give a confirmation that what you see on your
system is not unexpected. One must use the “names” as they appear on
the system under specified locations.</p>
</section>
<section id="topology-representation">
<h2>Topology Representation<a class="headerlink" href="#topology-representation" title="Permalink to this headline">¶</a></h2>
<p>Each CoreSight component has a <code class="docutils literal notranslate"><span class="pre">connections</span></code> directory which will contain
links to other CoreSight components. This allows the user to explore the trace
topology and for larger systems, determine the most appropriate sink for a
given source. The connection information can also be used to establish
which CTI devices are connected to a given component. This directory contains a
<code class="docutils literal notranslate"><span class="pre">nr_links</span></code> attribute detailing the number of links in the directory.</p>
<p>For an ETM source, in this case <code class="docutils literal notranslate"><span class="pre">etm0</span></code> on a Juno platform, a typical
arrangement will be:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>linaro-developer:~# ls - l /sys/bus/coresight/devices/etm0/connections
&lt;file details&gt;  cti_cpu0 -&gt; ../../../23020000.cti/cti_cpu0
&lt;file details&gt;  nr_links
&lt;file details&gt;  out:0 -&gt; ../../../230c0000.funnel/funnel2
</pre></div>
</div>
<p>Following the out port to <code class="docutils literal notranslate"><span class="pre">funnel2</span></code>:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>linaro-developer:~# ls -l /sys/bus/coresight/devices/funnel2/connections
&lt;file details&gt; in:0 -&gt; ../../../23040000.etm/etm0
&lt;file details&gt; in:1 -&gt; ../../../23140000.etm/etm3
&lt;file details&gt; in:2 -&gt; ../../../23240000.etm/etm4
&lt;file details&gt; in:3 -&gt; ../../../23340000.etm/etm5
&lt;file details&gt; nr_links
&lt;file details&gt; out:0 -&gt; ../../../20040000.funnel/funnel0
</pre></div>
</div>
<p>And again to <code class="docutils literal notranslate"><span class="pre">funnel0</span></code>:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>linaro-developer:~# ls -l /sys/bus/coresight/devices/funnel0/connections
&lt;file details&gt; in:0 -&gt; ../../../220c0000.funnel/funnel1
&lt;file details&gt; in:1 -&gt; ../../../230c0000.funnel/funnel2
&lt;file details&gt; nr_links
&lt;file details&gt; out:0 -&gt; ../../../20010000.etf/tmc_etf0
</pre></div>
</div>
<p>Finding the first sink <code class="docutils literal notranslate"><span class="pre">tmc_etf0</span></code>. This can be used to collect data
as a sink, or as a link to propagate further along the chain:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>linaro-developer:~# ls -l /sys/bus/coresight/devices/tmc_etf0/connections
&lt;file details&gt; cti_sys0 -&gt; ../../../20020000.cti/cti_sys0
&lt;file details&gt; in:0 -&gt; ../../../20040000.funnel/funnel0
&lt;file details&gt; nr_links
&lt;file details&gt; out:0 -&gt; ../../../20150000.funnel/funnel4
</pre></div>
</div>
<p>via <code class="docutils literal notranslate"><span class="pre">funnel4</span></code>:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>linaro-developer:~# ls -l /sys/bus/coresight/devices/funnel4/connections
&lt;file details&gt; in:0 -&gt; ../../../20010000.etf/tmc_etf0
&lt;file details&gt; in:1 -&gt; ../../../20140000.etf/tmc_etf1
&lt;file details&gt; nr_links
&lt;file details&gt; out:0 -&gt; ../../../20120000.replicator/replicator0
</pre></div>
</div>
<p>and a <code class="docutils literal notranslate"><span class="pre">replicator0</span></code>:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>linaro-developer:~# ls -l /sys/bus/coresight/devices/replicator0/connections
&lt;file details&gt; in:0 -&gt; ../../../20150000.funnel/funnel4
&lt;file details&gt; nr_links
&lt;file details&gt; out:0 -&gt; ../../../20030000.tpiu/tpiu0
&lt;file details&gt; out:1 -&gt; ../../../20070000.etr/tmc_etr0
</pre></div>
</div>
<p>Arriving at the final sink in the chain, <code class="docutils literal notranslate"><span class="pre">tmc_etr0</span></code>:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>linaro-developer:~# ls -l /sys/bus/coresight/devices/tmc_etr0/connections
&lt;file details&gt; cti_sys0 -&gt; ../../../20020000.cti/cti_sys0
&lt;file details&gt; in:0 -&gt; ../../../20120000.replicator/replicator0
&lt;file details&gt; nr_links
</pre></div>
</div>
<p>As described below, when using sysfs it is sufficient to enable a sink and
a source for successful trace. The framework will correctly enable all
intermediate links as required.</p>
<p>Note: <code class="docutils literal notranslate"><span class="pre">cti_sys0</span></code> appears in two of the connections lists above.
CTIs can connect to multiple devices and are arranged in a star topology
via the CTM. See (<a class="reference internal" href="coresight-ect.html"><span class="doc">CoreSight Embedded Cross Trigger (CTI &amp; CTM).</span></a>)
<a class="footnote-reference brackets" href="#fourth" id="id1">4</a> for further details.
Looking at this device we see 4 connections:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>linaro-developer:~# ls -l /sys/bus/coresight/devices/cti_sys0/connections
&lt;file details&gt; nr_links
&lt;file details&gt; stm0 -&gt; ../../../20100000.stm/stm0
&lt;file details&gt; tmc_etf0 -&gt; ../../../20010000.etf/tmc_etf0
&lt;file details&gt; tmc_etr0 -&gt; ../../../20070000.etr/tmc_etr0
&lt;file details&gt; tpiu0 -&gt; ../../../20030000.tpiu/tpiu0
</pre></div>
</div>
</section>
<section id="how-to-use-the-tracer-modules">
<h2>How to use the tracer modules<a class="headerlink" href="#how-to-use-the-tracer-modules" title="Permalink to this headline">¶</a></h2>
<p>There are two ways to use the Coresight framework:</p>
<ol class="arabic simple">
<li><p>using the perf cmd line tools.</p></li>
<li><p>interacting directly with the Coresight devices using the sysFS interface.</p></li>
</ol>
<p>Preference is given to the former as using the sysFS interface
requires a deep understanding of the Coresight HW.  The following sections
provide details on using both methods.</p>
<section id="using-the-sysfs-interface">
<h3>Using the sysFS interface<a class="headerlink" href="#using-the-sysfs-interface" title="Permalink to this headline">¶</a></h3>
<p>Before trace collection can start, a coresight sink needs to be identified.
There is no limit on the amount of sinks (nor sources) that can be enabled at
any given moment.  As a generic operation, all device pertaining to the sink
class will have an “active” entry in sysfs:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>root:/sys/bus/coresight/devices# ls
replicator  20030000.tpiu    2201c000.ptm  2203c000.etm  2203e000.etm
20010000.etb         20040000.funnel  2201d000.ptm  2203d000.etm
root:/sys/bus/coresight/devices# ls 20010000.etb
enable_sink  status  trigger_cntr
root:/sys/bus/coresight/devices# echo 1 &gt; 20010000.etb/enable_sink
root:/sys/bus/coresight/devices# cat 20010000.etb/enable_sink
1
root:/sys/bus/coresight/devices#
</pre></div>
</div>
<p>At boot time the current etm3x driver will configure the first address
comparator with “_stext” and “_etext”, essentially tracing any instruction
that falls within that range.  As such “enabling” a source will immediately
trigger a trace capture:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>root:/sys/bus/coresight/devices# echo 1 &gt; 2201c000.ptm/enable_source
root:/sys/bus/coresight/devices# cat 2201c000.ptm/enable_source
1
root:/sys/bus/coresight/devices# cat 20010000.etb/status
Depth:          0x2000
Status:         0x1
RAM read ptr:   0x0
RAM wrt ptr:    0x19d3   &lt;----- The write pointer is moving
Trigger cnt:    0x0
Control:        0x1
Flush status:   0x0
Flush ctrl:     0x2001
root:/sys/bus/coresight/devices#
</pre></div>
</div>
<p>Trace collection is stopped the same way:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>root:/sys/bus/coresight/devices# echo 0 &gt; 2201c000.ptm/enable_source
root:/sys/bus/coresight/devices#
</pre></div>
</div>
<p>The content of the ETB buffer can be harvested directly from /dev:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>root:/sys/bus/coresight/devices# dd if=/dev/20010000.etb \
of=~/cstrace.bin
64+0 records in
64+0 records out
32768 bytes (33 kB) copied, 0.00125258 s, 26.2 MB/s
root:/sys/bus/coresight/devices#
</pre></div>
</div>
<p>The file cstrace.bin can be decompressed using “ptm2human”, DS-5 or Trace32.</p>
<p>Following is a DS-5 output of an experimental loop that increments a variable up
to a certain value.  The example is simple and yet provides a glimpse of the
wealth of possibilities that coresight provides.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Info                                    Tracing enabled
Instruction     106378866       0x8026B53C      E52DE004        false   PUSH     {lr}
Instruction     0       0x8026B540      E24DD00C        false   SUB      sp,sp,#0xc
Instruction     0       0x8026B544      E3A03000        false   MOV      r3,#0
Instruction     0       0x8026B548      E58D3004        false   STR      r3,[sp,#4]
Instruction     0       0x8026B54C      E59D3004        false   LDR      r3,[sp,#4]
Instruction     0       0x8026B550      E3530004        false   CMP      r3,#4
Instruction     0       0x8026B554      E2833001        false   ADD      r3,r3,#1
Instruction     0       0x8026B558      E58D3004        false   STR      r3,[sp,#4]
Instruction     0       0x8026B55C      DAFFFFFA        true    BLE      {pc}-0x10 ; 0x8026b54c
Timestamp                                       Timestamp: 17106715833
Instruction     319     0x8026B54C      E59D3004        false   LDR      r3,[sp,#4]
Instruction     0       0x8026B550      E3530004        false   CMP      r3,#4
Instruction     0       0x8026B554      E2833001        false   ADD      r3,r3,#1
Instruction     0       0x8026B558      E58D3004        false   STR      r3,[sp,#4]
Instruction     0       0x8026B55C      DAFFFFFA        true    BLE      {pc}-0x10 ; 0x8026b54c
Instruction     9       0x8026B54C      E59D3004        false   LDR      r3,[sp,#4]
Instruction     0       0x8026B550      E3530004        false   CMP      r3,#4
Instruction     0       0x8026B554      E2833001        false   ADD      r3,r3,#1
Instruction     0       0x8026B558      E58D3004        false   STR      r3,[sp,#4]
Instruction     0       0x8026B55C      DAFFFFFA        true    BLE      {pc}-0x10 ; 0x8026b54c
Instruction     7       0x8026B54C      E59D3004        false   LDR      r3,[sp,#4]
Instruction     0       0x8026B550      E3530004        false   CMP      r3,#4
Instruction     0       0x8026B554      E2833001        false   ADD      r3,r3,#1
Instruction     0       0x8026B558      E58D3004        false   STR      r3,[sp,#4]
Instruction     0       0x8026B55C      DAFFFFFA        true    BLE      {pc}-0x10 ; 0x8026b54c
Instruction     7       0x8026B54C      E59D3004        false   LDR      r3,[sp,#4]
Instruction     0       0x8026B550      E3530004        false   CMP      r3,#4
Instruction     0       0x8026B554      E2833001        false   ADD      r3,r3,#1
Instruction     0       0x8026B558      E58D3004        false   STR      r3,[sp,#4]
Instruction     0       0x8026B55C      DAFFFFFA        true    BLE      {pc}-0x10 ; 0x8026b54c
Instruction     10      0x8026B54C      E59D3004        false   LDR      r3,[sp,#4]
Instruction     0       0x8026B550      E3530004        false   CMP      r3,#4
Instruction     0       0x8026B554      E2833001        false   ADD      r3,r3,#1
Instruction     0       0x8026B558      E58D3004        false   STR      r3,[sp,#4]
Instruction     0       0x8026B55C      DAFFFFFA        true    BLE      {pc}-0x10 ; 0x8026b54c
Instruction     6       0x8026B560      EE1D3F30        false   MRC      p15,#0x0,r3,c13,c0,#1
Instruction     0       0x8026B564      E1A0100D        false   MOV      r1,sp
Instruction     0       0x8026B568      E3C12D7F        false   BIC      r2,r1,#0x1fc0
Instruction     0       0x8026B56C      E3C2203F        false   BIC      r2,r2,#0x3f
Instruction     0       0x8026B570      E59D1004        false   LDR      r1,[sp,#4]
Instruction     0       0x8026B574      E59F0010        false   LDR      r0,[pc,#16] ; [0x8026B58C] = 0x80550368
Instruction     0       0x8026B578      E592200C        false   LDR      r2,[r2,#0xc]
Instruction     0       0x8026B57C      E59221D0        false   LDR      r2,[r2,#0x1d0]
Instruction     0       0x8026B580      EB07A4CF        true    BL       {pc}+0x1e9344 ; 0x804548c4
Info                                    Tracing enabled
Instruction     13570831        0x8026B584      E28DD00C        false   ADD      sp,sp,#0xc
Instruction     0       0x8026B588      E8BD8000        true    LDM      sp!,{pc}
Timestamp                                       Timestamp: 17107041535
</pre></div>
</div>
</section>
<section id="using-perf-framework">
<h3>Using perf framework<a class="headerlink" href="#using-perf-framework" title="Permalink to this headline">¶</a></h3>
<p>Coresight tracers are represented using the Perf framework’s Performance
Monitoring Unit (PMU) abstraction.  As such the perf framework takes charge of
controlling when tracing gets enabled based on when the process of interest is
scheduled.  When configured in a system, Coresight PMUs will be listed when
queried by the perf command line tool:</p>
<blockquote>
<div><p><a class="reference external" href="mailto:linaro&#37;&#52;&#48;linaro-nano">linaro<span>&#64;</span>linaro-nano</a>:~$ ./perf list pmu</p>
<blockquote>
<div><p>List of pre-defined events (to be used in -e):</p>
<p>cs_etm//                                    [Kernel PMU event]</p>
</div></blockquote>
<p><a class="reference external" href="mailto:linaro&#37;&#52;&#48;linaro-nano">linaro<span>&#64;</span>linaro-nano</a>:~$</p>
</div></blockquote>
<p>Regardless of the number of tracers available in a system (usually equal to the
amount of processor cores), the “cs_etm” PMU will be listed only once.</p>
<p>A Coresight PMU works the same way as any other PMU, i.e the name of the PMU is
listed along with configuration options within forward slashes ‘/’.  Since a
Coresight system will typically have more than one sink, the name of the sink to
work with needs to be specified as an event option.
On newer kernels the available sinks are listed in sysFS under
($SYSFS)/bus/event_source/devices/cs_etm/sinks/:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>root@localhost:/sys/bus/event_source/devices/cs_etm/sinks# ls
tmc_etf0  tmc_etr0  tpiu0
</pre></div>
</div>
<p>On older kernels, this may need to be found from the list of coresight devices,
available under ($SYSFS)/bus/coresight/devices/:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>root:~# ls /sys/bus/coresight/devices/
 etm0     etm1     etm2         etm3  etm4      etm5      funnel0
 funnel1  funnel2  replicator0  stm0  tmc_etf0  tmc_etr0  tpiu0
root@linaro-nano:~# perf record -e cs_etm/@tmc_etr0/u --per-thread program
</pre></div>
</div>
<p>As mentioned above in section “Device Naming scheme”, the names of the devices could
look different from what is used in the example above. One must use the device names
as it appears under the sysFS.</p>
<p>The syntax within the forward slashes ‘/’ is important.  The ‘&#64;’ character
tells the parser that a sink is about to be specified and that this is the sink
to use for the trace session.</p>
<p>More information on the above and other example on how to use Coresight with
the perf tools can be found in the “HOWTO.md” file of the openCSD gitHub
repository <a class="footnote-reference brackets" href="#third" id="id2">3</a>.</p>
</section>
</section>
<section id="advanced-perf-framework-usage">
<h2>Advanced perf framework usage<a class="headerlink" href="#advanced-perf-framework-usage" title="Permalink to this headline">¶</a></h2>
<section id="autofdo-analysis-using-the-perf-tools">
<h3>AutoFDO analysis using the perf tools<a class="headerlink" href="#autofdo-analysis-using-the-perf-tools" title="Permalink to this headline">¶</a></h3>
<p>perf can be used to record and analyze trace of programs.</p>
<p>Execution can be recorded using ‘perf record’ with the cs_etm event,
specifying the name of the sink to record to, e.g:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>perf record -e cs_etm/@tmc_etr0/u --per-thread
</pre></div>
</div>
<p>The ‘perf report’ and ‘perf script’ commands can be used to analyze execution,
synthesizing instruction and branch events from the instruction trace.
‘perf inject’ can be used to replace the trace data with the synthesized events.
The –itrace option controls the type and frequency of synthesized events
(see perf documentation).</p>
<p>Note that only 64-bit programs are currently supported - further work is
required to support instruction decode of 32-bit Arm programs.</p>
</section>
<section id="tracing-pid">
<h3>Tracing PID<a class="headerlink" href="#tracing-pid" title="Permalink to this headline">¶</a></h3>
<p>The kernel can be built to write the PID value into the PE ContextID registers.
For a kernel running at EL1, the PID is stored in CONTEXTIDR_EL1.  A PE may
implement Arm Virtualization Host Extensions (VHE), which the kernel can
run at EL2 as a virtualisation host; in this case, the PID value is stored in
CONTEXTIDR_EL2.</p>
<p>perf provides PMU formats that program the ETM to insert these values into the
trace data; the PMU formats are defined as below:</p>
<blockquote>
<div><dl class="simple">
<dt>“contextid1”: Available on both EL1 kernel and EL2 kernel.  When the</dt><dd><p>kernel is running at EL1, “contextid1” enables the PID
tracing; when the kernel is running at EL2, this enables
tracing the PID of guest applications.</p>
</dd>
<dt>“contextid2”: Only usable when the kernel is running at EL2.  When</dt><dd><p>selected, enables PID tracing on EL2 kernel.</p>
</dd>
<dt>“contextid”:  Will be an alias for the option that enables PID</dt><dd><p>tracing.  I.e,
contextid == contextid1, on EL1 kernel.
contextid == contextid2, on EL2 kernel.</p>
</dd>
</dl>
</div></blockquote>
<p>perf will always enable PID tracing at the relevant EL, this is accomplished by
automatically enable the “contextid” config - but for EL2 it is possible to make
specific adjustments using configs “contextid1” and “contextid2”, E.g. if a user
wants to trace PIDs for both host and guest, the two configs “contextid1” and
“contextid2” can be set at the same time:</p>
<blockquote>
<div><p>perf record -e cs_etm/contextid1,contextid2/u – vm</p>
</div></blockquote>
</section>
<section id="generating-coverage-files-for-feedback-directed-optimization-autofdo">
<h3>Generating coverage files for Feedback Directed Optimization: AutoFDO<a class="headerlink" href="#generating-coverage-files-for-feedback-directed-optimization-autofdo" title="Permalink to this headline">¶</a></h3>
<p>‘perf inject’ accepts the –itrace option in which case tracing data is
removed and replaced with the synthesized events. e.g.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>perf inject --itrace --strip -i perf.data -o perf.data.new
</pre></div>
</div>
<p>Below is an example of using ARM ETM for autoFDO.  It requires autofdo
(<a class="reference external" href="https://github.com/google/autofdo">https://github.com/google/autofdo</a>) and gcc version 5.  The bubble
sort example is from the AutoFDO tutorial (<a class="reference external" href="https://gcc.gnu.org/wiki/AutoFDO/Tutorial">https://gcc.gnu.org/wiki/AutoFDO/Tutorial</a>).</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ gcc-5 -O3 sort.c -o sort
$ taskset -c 2 ./sort
Bubble sorting array of 30000 elements
5910 ms

$ perf record -e cs_etm/@tmc_etr0/u --per-thread taskset -c 2 ./sort
Bubble sorting array of 30000 elements
12543 ms
[ perf record: Woken up 35 times to write data ]
[ perf record: Captured and wrote 69.640 MB perf.data ]

$ perf inject -i perf.data -o inj.data --itrace=il64 --strip
$ create_gcov --binary=./sort --profile=inj.data --gcov=sort.gcov -gcov_version=1
$ gcc-5 -O3 -fauto-profile=sort.gcov sort.c -o sort_autofdo
$ taskset -c 2 ./sort_autofdo
Bubble sorting array of 30000 elements
5806 ms
</pre></div>
</div>
</section>
<section id="config-option-formats">
<h3>Config option formats<a class="headerlink" href="#config-option-formats" title="Permalink to this headline">¶</a></h3>
<p>The following strings can be provided between // on the perf command line to enable various options.
They are also listed in the folder /sys/bus/event_source/devices/cs_etm/format/</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Option</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>branch_broadcast</p></td>
<td><p>Session local version of the system wide setting:
<a class="reference internal" href="coresight-etm4x-reference.html#coresight-branch-broadcast"><span class="std std-ref">ETM_MODE_BB</span></a></p></td>
</tr>
<tr class="row-odd"><td><p>contextid</p></td>
<td><p>See <a class="reference internal" href="#tracing-pid">Tracing PID</a></p></td>
</tr>
<tr class="row-even"><td><p>contextid1</p></td>
<td><p>See <a class="reference internal" href="#tracing-pid">Tracing PID</a></p></td>
</tr>
<tr class="row-odd"><td><p>contextid2</p></td>
<td><p>See <a class="reference internal" href="#tracing-pid">Tracing PID</a></p></td>
</tr>
<tr class="row-even"><td><p>configid</p></td>
<td><p>Selection for a custom configuration. This is an implementation detail and not used directly,
see <a class="reference internal" href="coresight-config.html#using-configurations-in-perf"><span class="std std-ref">Using Configurations in perf</span></a></p></td>
</tr>
<tr class="row-odd"><td><p>preset</p></td>
<td><p>Override for parameters in a custom configuration, see
<a class="reference internal" href="coresight-config.html#using-configurations-in-perf"><span class="std std-ref">Using Configurations in perf</span></a></p></td>
</tr>
<tr class="row-even"><td><p>sinkid</p></td>
<td><p>Hashed version of the string to select a sink, automatically set when using the &#64; notation.
This is an internal implementation detail and is not used directly, see <a class="reference internal" href="#using-perf-framework">Using perf
framework</a>.</p></td>
</tr>
<tr class="row-odd"><td><p>cycacc</p></td>
<td><p>Session local version of the system wide setting: <a class="reference internal" href="coresight-etm4x-reference.html#coresight-cycle-accurate"><span class="std std-ref">ETMv4_MODE_CYCACC</span></a></p></td>
</tr>
<tr class="row-even"><td><p>retstack</p></td>
<td><p>Session local version of the system wide setting: <a class="reference internal" href="coresight-etm4x-reference.html#coresight-return-stack"><span class="std std-ref">ETM_MODE_RETURNSTACK</span></a></p></td>
</tr>
<tr class="row-odd"><td><p>timestamp</p></td>
<td><p>Session local version of the system wide setting: <a class="reference internal" href="coresight-etm4x-reference.html#coresight-timestamp"><span class="std std-ref">ETMv4_MODE_TIMESTAMP</span></a></p></td>
</tr>
</tbody>
</table>
</section>
</section>
<section id="how-to-use-the-stm-module">
<h2>How to use the STM module<a class="headerlink" href="#how-to-use-the-stm-module" title="Permalink to this headline">¶</a></h2>
<p>Using the System Trace Macrocell module is the same as the tracers - the only
difference is that clients are driving the trace capture rather
than the program flow through the code.</p>
<p>As with any other CoreSight component, specifics about the STM tracer can be
found in sysfs with more information on each entry being found in <a class="footnote-reference brackets" href="#first" id="id3">1</a>:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>root@genericarmv8:~# ls /sys/bus/coresight/devices/stm0
enable_source   hwevent_select  port_enable     subsystem       uevent
hwevent_enable  mgmt            port_select     traceid
root@genericarmv8:~#
</pre></div>
</div>
<p>Like any other source a sink needs to be identified and the STM enabled before
being used:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>root@genericarmv8:~# echo 1 &gt; /sys/bus/coresight/devices/tmc_etf0/enable_sink
root@genericarmv8:~# echo 1 &gt; /sys/bus/coresight/devices/stm0/enable_source
</pre></div>
</div>
<p>From there user space applications can request and use channels using the devfs
interface provided for that purpose by the generic STM API:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>root@genericarmv8:~# ls -l /dev/stm0
crw-------    1 root     root       10,  61 Jan  3 18:11 /dev/stm0
root@genericarmv8:~#
</pre></div>
</div>
<p>Details on how to use the generic STM API can be found here:
- <a class="reference internal" href="../stm.html"><span class="doc">System Trace Module</span></a> <a class="footnote-reference brackets" href="#second" id="id4">2</a>.</p>
</section>
<section id="the-cti-ctm-modules">
<h2>The CTI &amp; CTM Modules<a class="headerlink" href="#the-cti-ctm-modules" title="Permalink to this headline">¶</a></h2>
<p>The CTI (Cross Trigger Interface) provides a set of trigger signals between
individual CTIs and components, and can propagate these between all CTIs via
channels on the CTM (Cross Trigger Matrix).</p>
<p>A separate documentation file is provided to explain the use of these devices.
(<a class="reference internal" href="coresight-ect.html"><span class="doc">CoreSight Embedded Cross Trigger (CTI &amp; CTM).</span></a>) <a class="footnote-reference brackets" href="#fourth" id="id5">4</a>.</p>
</section>
<section id="coresight-system-configuration">
<h2>CoreSight System Configuration<a class="headerlink" href="#coresight-system-configuration" title="Permalink to this headline">¶</a></h2>
<p>CoreSight components can be complex devices with many programming options.
Furthermore, components can be programmed to interact with each other across the
complete system.</p>
<p>A CoreSight System Configuration manager is provided to allow these complex programming
configurations to be selected and used easily from perf and sysfs.</p>
<p>See the separate document for further information.
(<a class="reference internal" href="coresight-config.html"><span class="doc">CoreSight System Configuration Manager</span></a>) <a class="footnote-reference brackets" href="#fifth" id="id6">5</a>.</p>
<dl class="footnote brackets">
<dt class="label" id="first"><span class="brackets"><a class="fn-backref" href="#id3">1</a></span></dt>
<dd><p>Documentation/ABI/testing/sysfs-bus-coresight-devices-stm</p>
</dd>
<dt class="label" id="second"><span class="brackets"><a class="fn-backref" href="#id4">2</a></span></dt>
<dd><p><a class="reference internal" href="../stm.html"><span class="doc">System Trace Module</span></a></p>
</dd>
<dt class="label" id="third"><span class="brackets"><a class="fn-backref" href="#id2">3</a></span></dt>
<dd><p><a class="reference external" href="https://github.com/Linaro/perf-opencsd">https://github.com/Linaro/perf-opencsd</a></p>
</dd>
<dt class="label" id="fourth"><span class="brackets">4</span><span class="fn-backref">(<a href="#id1">1</a>,<a href="#id5">2</a>)</span></dt>
<dd><p><a class="reference internal" href="coresight-ect.html"><span class="doc">CoreSight Embedded Cross Trigger (CTI &amp; CTM).</span></a></p>
</dd>
<dt class="label" id="fifth"><span class="brackets"><a class="fn-backref" href="#id6">5</a></span></dt>
<dd><p><a class="reference internal" href="coresight-config.html"><span class="doc">CoreSight System Configuration Manager</span></a></p>
</dd>
</dl>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">The Linux Kernel</a></h1>



<p class="blurb">6.2.0-rc4-6.2.0-rc4+</p>







<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
  <h3><a href="../../index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Coresight - HW Assisted Tracing on ARM</a><ul>
<li><a class="reference internal" href="#introduction">Introduction</a></li>
<li><a class="reference internal" href="#acronyms-and-classification">Acronyms and Classification</a></li>
<li><a class="reference internal" href="#device-tree-bindings">Device Tree Bindings</a></li>
<li><a class="reference internal" href="#framework-and-implementation">Framework and implementation</a></li>
<li><a class="reference internal" href="#device-naming-scheme">Device Naming scheme</a></li>
<li><a class="reference internal" href="#topology-representation">Topology Representation</a></li>
<li><a class="reference internal" href="#how-to-use-the-tracer-modules">How to use the tracer modules</a><ul>
<li><a class="reference internal" href="#using-the-sysfs-interface">Using the sysFS interface</a></li>
<li><a class="reference internal" href="#using-perf-framework">Using perf framework</a></li>
</ul>
</li>
<li><a class="reference internal" href="#advanced-perf-framework-usage">Advanced perf framework usage</a><ul>
<li><a class="reference internal" href="#autofdo-analysis-using-the-perf-tools">AutoFDO analysis using the perf tools</a></li>
<li><a class="reference internal" href="#tracing-pid">Tracing PID</a></li>
<li><a class="reference internal" href="#generating-coverage-files-for-feedback-directed-optimization-autofdo">Generating coverage files for Feedback Directed Optimization: AutoFDO</a></li>
<li><a class="reference internal" href="#config-option-formats">Config option formats</a></li>
</ul>
</li>
<li><a class="reference internal" href="#how-to-use-the-stm-module">How to use the STM module</a></li>
<li><a class="reference internal" href="#the-cti-ctm-modules">The CTI &amp; CTM Modules</a></li>
<li><a class="reference internal" href="#coresight-system-configuration">CoreSight System Configuration</a></li>
</ul>
</li>
</ul>

  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../../_sources/trace/coresight/coresight.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;The kernel development community.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 2.4.4</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="../../_sources/trace/coresight/coresight.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>