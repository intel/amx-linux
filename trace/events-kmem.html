
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Subsystem Trace Points: kmem &#8212; The Linux Kernel 6.2.0-rc4+ documentation</title>
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Subsystem Trace Points: power" href="events-power.html" />
    <link rel="prev" title="Event Tracing" href="events.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="subsystem-trace-points-kmem">
<h1>Subsystem Trace Points: kmem<a class="headerlink" href="#subsystem-trace-points-kmem" title="Permalink to this headline">¶</a></h1>
<p>The kmem tracing system captures events related to object and page allocation
within the kernel. Broadly speaking there are five major subheadings.</p>
<blockquote>
<div><ul class="simple">
<li><p>Slab allocation of small objects of unknown type (kmalloc)</p></li>
<li><p>Slab allocation of small objects of known type</p></li>
<li><p>Page allocation</p></li>
<li><p>Per-CPU Allocator Activity</p></li>
<li><p>External Fragmentation</p></li>
</ul>
</div></blockquote>
<p>This document describes what each of the tracepoints is and why they
might be useful.</p>
<section id="slab-allocation-of-small-objects-of-unknown-type">
<h2>1. Slab allocation of small objects of unknown type<a class="headerlink" href="#slab-allocation-of-small-objects-of-unknown-type" title="Permalink to this headline">¶</a></h2>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>kmalloc               call_site=%lx ptr=%p bytes_req=%zu bytes_alloc=%zu gfp_flags=%s
kmalloc_node  call_site=%lx ptr=%p bytes_req=%zu bytes_alloc=%zu gfp_flags=%s node=%d
kfree         call_site=%lx ptr=%p
</pre></div>
</div>
<p>Heavy activity for these events may indicate that a specific cache is
justified, particularly if kmalloc slab pages are getting significantly
internal fragmented as a result of the allocation pattern. By correlating
kmalloc with kfree, it may be possible to identify memory leaks and where
the allocation sites were.</p>
</section>
<section id="slab-allocation-of-small-objects-of-known-type">
<h2>2. Slab allocation of small objects of known type<a class="headerlink" href="#slab-allocation-of-small-objects-of-known-type" title="Permalink to this headline">¶</a></h2>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>kmem_cache_alloc      call_site=%lx ptr=%p bytes_req=%zu bytes_alloc=%zu gfp_flags=%s
kmem_cache_alloc_node call_site=%lx ptr=%p bytes_req=%zu bytes_alloc=%zu gfp_flags=%s node=%d
kmem_cache_free               call_site=%lx ptr=%p
</pre></div>
</div>
<p>These events are similar in usage to the kmalloc-related events except that
it is likely easier to pin the event down to a specific cache. At the time
of writing, no information is available on what slab is being allocated from,
but the call_site can usually be used to extrapolate that information.</p>
</section>
<section id="page-allocation">
<h2>3. Page allocation<a class="headerlink" href="#page-allocation" title="Permalink to this headline">¶</a></h2>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>mm_page_alloc           page=%p pfn=%lu order=%d migratetype=%d gfp_flags=%s
mm_page_alloc_zone_locked page=%p pfn=%lu order=%u migratetype=%d cpu=%d percpu_refill=%d
mm_page_free            page=%p pfn=%lu order=%d
mm_page_free_batched    page=%p pfn=%lu order=%d cold=%d
</pre></div>
</div>
<p>These four events deal with page allocation and freeing. mm_page_alloc is
a simple indicator of page allocator activity. Pages may be allocated from
the per-CPU allocator (high performance) or the buddy allocator.</p>
<p>If pages are allocated directly from the buddy allocator, the
mm_page_alloc_zone_locked event is triggered. This event is important as high
amounts of activity imply high activity on the zone-&gt;lock. Taking this lock
impairs performance by disabling interrupts, dirtying cache lines between
CPUs and serialising many CPUs.</p>
<p>When a page is freed directly by the caller, the only mm_page_free event
is triggered. Significant amounts of activity here could indicate that the
callers should be batching their activities.</p>
<p>When pages are freed in batch, the also mm_page_free_batched is triggered.
Broadly speaking, pages are taken off the LRU lock in bulk and
freed in batch with a page list. Significant amounts of activity here could
indicate that the system is under memory pressure and can also indicate
contention on the lruvec-&gt;lru_lock.</p>
</section>
<section id="per-cpu-allocator-activity">
<h2>4. Per-CPU Allocator Activity<a class="headerlink" href="#per-cpu-allocator-activity" title="Permalink to this headline">¶</a></h2>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>mm_page_alloc_zone_locked     page=%p pfn=%lu order=%u migratetype=%d cpu=%d percpu_refill=%d
mm_page_pcpu_drain            page=%p pfn=%lu order=%d cpu=%d migratetype=%d
</pre></div>
</div>
<p>In front of the page allocator is a per-cpu page allocator. It exists only
for order-0 pages, reduces contention on the zone-&gt;lock and reduces the
amount of writing on struct page.</p>
<p>When a per-CPU list is empty or pages of the wrong type are allocated,
the zone-&gt;lock will be taken once and the per-CPU list refilled. The event
triggered is mm_page_alloc_zone_locked for each page allocated with the
event indicating whether it is for a percpu_refill or not.</p>
<p>When the per-CPU list is too full, a number of pages are freed, each one
which triggers a mm_page_pcpu_drain event.</p>
<p>The individual nature of the events is so that pages can be tracked
between allocation and freeing. A number of drain or refill pages that occur
consecutively imply the zone-&gt;lock being taken once. Large amounts of per-CPU
refills and drains could imply an imbalance between CPUs where too much work
is being concentrated in one place. It could also indicate that the per-CPU
lists should be a larger size. Finally, large amounts of refills on one CPU
and drains on another could be a factor in causing large amounts of cache
line bounces due to writes between CPUs and worth investigating if pages
can be allocated and freed on the same CPU through some algorithm change.</p>
</section>
<section id="external-fragmentation">
<h2>5. External Fragmentation<a class="headerlink" href="#external-fragmentation" title="Permalink to this headline">¶</a></h2>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>mm_page_alloc_extfrag         page=%p pfn=%lu alloc_order=%d fallback_order=%d pageblock_order=%d alloc_migratetype=%d fallback_migratetype=%d fragmenting=%d change_ownership=%d
</pre></div>
</div>
<p>External fragmentation affects whether a high-order allocation will be
successful or not. For some types of hardware, this is important although
it is avoided where possible. If the system is using huge pages and needs
to be able to resize the pool over the lifetime of the system, this value
is important.</p>
<p>Large numbers of this event implies that memory is fragmenting and
high-order allocations will start failing at some time in the future. One
means of reducing the occurrence of this event is to increase the size of
min_free_kbytes in increments of 3*pageblock_size*nr_online_nodes where
pageblock_size is usually the size of the default hugepage size.</p>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../index.html">The Linux Kernel</a></h1>



<p class="blurb">6.2.0-rc4-6.2.0-rc4+</p>







<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
  <h3><a href="../index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Subsystem Trace Points: kmem</a><ul>
<li><a class="reference internal" href="#slab-allocation-of-small-objects-of-unknown-type">1. Slab allocation of small objects of unknown type</a></li>
<li><a class="reference internal" href="#slab-allocation-of-small-objects-of-known-type">2. Slab allocation of small objects of known type</a></li>
<li><a class="reference internal" href="#page-allocation">3. Page allocation</a></li>
<li><a class="reference internal" href="#per-cpu-allocator-activity">4. Per-CPU Allocator Activity</a></li>
<li><a class="reference internal" href="#external-fragmentation">5. External Fragmentation</a></li>
</ul>
</li>
</ul>

  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/trace/events-kmem.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;The kernel development community.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 2.4.4</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="../_sources/trace/events-kmem.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>