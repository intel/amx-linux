
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Generic networking statistics for netlink users &#8212; The Linux Kernel 6.2.0-rc4+ documentation</title>
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="The Linux kernel GTP tunneling module" href="gtp.html" />
    <link rel="prev" title="Generic Netlink" href="generic_netlink.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="generic-networking-statistics-for-netlink-users">
<h1>Generic networking statistics for netlink users<a class="headerlink" href="#generic-networking-statistics-for-netlink-users" title="Permalink to this headline">¶</a></h1>
<p>Statistic counters are grouped into structs:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 32%" />
<col style="width: 34%" />
<col style="width: 34%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Struct</p></th>
<th class="head"><p>TLV type</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>gnet_stats_basic</p></td>
<td><p>TCA_STATS_BASIC</p></td>
<td><p>Basic statistics</p></td>
</tr>
<tr class="row-odd"><td><p>gnet_stats_rate_est</p></td>
<td><p>TCA_STATS_RATE_EST</p></td>
<td><p>Rate estimator</p></td>
</tr>
<tr class="row-even"><td><p>gnet_stats_queue</p></td>
<td><p>TCA_STATS_QUEUE</p></td>
<td><p>Queue statistics</p></td>
</tr>
<tr class="row-odd"><td><p>none</p></td>
<td><p>TCA_STATS_APP</p></td>
<td><p>Application specific</p></td>
</tr>
</tbody>
</table>
<section id="collecting">
<h2>Collecting:<a class="headerlink" href="#collecting" title="Permalink to this headline">¶</a></h2>
<p>Declare the statistic structs you need:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>struct mystruct {
        struct gnet_stats_basic bstats;
        struct gnet_stats_queue qstats;
        ...
};
</pre></div>
</div>
<p>Update statistics, in dequeue() methods only, (while owning qdisc-&gt;running):</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>mystruct-&gt;tstats.packet++;
mystruct-&gt;qstats.backlog += skb-&gt;pkt_len;
</pre></div>
</div>
</section>
<section id="export-to-userspace-dump">
<h2>Export to userspace (Dump):<a class="headerlink" href="#export-to-userspace-dump" title="Permalink to this headline">¶</a></h2>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>my_dumping_routine(struct sk_buff *skb, ...)
{
        struct gnet_dump dump;

        if (gnet_stats_start_copy(skb, TCA_STATS2, &amp;mystruct-&gt;lock, &amp;dump,
                                TCA_PAD) &lt; 0)
                goto rtattr_failure;

        if (gnet_stats_copy_basic(&amp;dump, &amp;mystruct-&gt;bstats) &lt; 0 ||
            gnet_stats_copy_queue(&amp;dump, &amp;mystruct-&gt;qstats) &lt; 0 ||
                gnet_stats_copy_app(&amp;dump, &amp;xstats, sizeof(xstats)) &lt; 0)
                goto rtattr_failure;

        if (gnet_stats_finish_copy(&amp;dump) &lt; 0)
                goto rtattr_failure;
        ...
}
</pre></div>
</div>
</section>
<section id="tca-stats-tca-xstats-backward-compatibility">
<h2>TCA_STATS/TCA_XSTATS backward compatibility:<a class="headerlink" href="#tca-stats-tca-xstats-backward-compatibility" title="Permalink to this headline">¶</a></h2>
<p>Prior users of struct tc_stats and xstats can maintain backward
compatibility by calling the compat wrappers to keep providing the
existing TLV types:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>my_dumping_routine(struct sk_buff *skb, ...)
{
    if (gnet_stats_start_copy_compat(skb, TCA_STATS2, TCA_STATS,
                                    TCA_XSTATS, &amp;mystruct-&gt;lock, &amp;dump,
                                    TCA_PAD) &lt; 0)
                goto rtattr_failure;
        ...
}
</pre></div>
</div>
<p>A struct tc_stats will be filled out during gnet_stats_copy_* calls
and appended to the skb. TCA_XSTATS is provided if gnet_stats_copy_app
was called.</p>
</section>
<section id="locking">
<h2>Locking:<a class="headerlink" href="#locking" title="Permalink to this headline">¶</a></h2>
<p>Locks are taken before writing and released once all statistics have
been written. Locks are always released in case of an error. You
are responsible for making sure that the lock is initialized.</p>
</section>
<section id="rate-estimator">
<h2>Rate Estimator:<a class="headerlink" href="#rate-estimator" title="Permalink to this headline">¶</a></h2>
<ol class="arabic simple" start="0">
<li><p>Prepare an estimator attribute. Most likely this would be in user
space. The value of this TLV should contain a tc_estimator structure.
As usual, such a TLV needs to be 32 bit aligned and therefore the
length needs to be appropriately set, etc. The estimator interval
and ewma log need to be converted to the appropriate values.
tc_estimator.c::tc_setup_estimator() is advisable to be used as the
conversion routine. It does a few clever things. It takes a time
interval in microsecs, a time constant also in microsecs and a struct
tc_estimator to  be populated. The returned tc_estimator can be
transported to the kernel.  Transfer such a structure in a TLV of type
TCA_RATE to your code in the kernel.</p></li>
</ol>
<p>In the kernel when setting up:</p>
<ol class="arabic">
<li><p>make sure you have basic stats and rate stats setup first.</p></li>
<li><p>make sure you have initialized stats lock that is used to setup such
stats.</p></li>
<li><p>Now initialize a new estimator:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>int ret = gen_new_estimator(my_basicstats,my_rate_est_stats,
    mystats_lock, attr_with_tcestimator_struct);

if ret == 0
    success
else
    failed
</pre></div>
</div>
</li>
</ol>
<p>From now on, every time you dump my_rate_est_stats it will contain
up-to-date info.</p>
<p>Once you are done, call gen_kill_estimator(my_basicstats,
my_rate_est_stats) Make sure that my_basicstats and my_rate_est_stats
are still valid (i.e still exist) at the time of making this call.</p>
</section>
<section id="authors">
<h2>Authors:<a class="headerlink" href="#authors" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Thomas Graf &lt;<a class="reference external" href="mailto:tgraf&#37;&#52;&#48;suug&#46;ch">tgraf<span>&#64;</span>suug<span>&#46;</span>ch</a>&gt;</p></li>
<li><p>Jamal Hadi Salim &lt;<a class="reference external" href="mailto:hadi&#37;&#52;&#48;cyberus&#46;ca">hadi<span>&#64;</span>cyberus<span>&#46;</span>ca</a>&gt;</p></li>
</ul>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../index.html">The Linux Kernel</a></h1>



<p class="blurb">6.2.0-rc4-6.2.0-rc4+</p>







<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
  <h3><a href="../index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Generic networking statistics for netlink users</a><ul>
<li><a class="reference internal" href="#collecting">Collecting:</a></li>
<li><a class="reference internal" href="#export-to-userspace-dump">Export to userspace (Dump):</a></li>
<li><a class="reference internal" href="#tca-stats-tca-xstats-backward-compatibility">TCA_STATS/TCA_XSTATS backward compatibility:</a></li>
<li><a class="reference internal" href="#locking">Locking:</a></li>
<li><a class="reference internal" href="#rate-estimator">Rate Estimator:</a></li>
<li><a class="reference internal" href="#authors">Authors:</a></li>
</ul>
</li>
</ul>

  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/networking/gen_stats.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;The kernel development community.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 2.4.4</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="../_sources/networking/gen_stats.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>