
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Net DIM - Generic Network Dynamic Interrupt Moderation &#8212; The Linux Kernel 6.2.0-rc4+ documentation</title>
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="NET_FAILOVER" href="net_failover.html" />
    <link rel="prev" title="FAILOVER" href="failover.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="net-dim-generic-network-dynamic-interrupt-moderation">
<h1><a class="toc-backref" href="#id1">Net DIM - Generic Network Dynamic Interrupt Moderation</a><a class="headerlink" href="#net-dim-generic-network-dynamic-interrupt-moderation" title="Permalink to this headline">¶</a></h1>
<dl class="field-list simple">
<dt class="field-odd">Author</dt>
<dd class="field-odd"><p>Tal Gilboa &lt;<a class="reference external" href="mailto:talgi&#37;&#52;&#48;mellanox&#46;com">talgi<span>&#64;</span>mellanox<span>&#46;</span>com</a>&gt;</p>
</dd>
</dl>
<div class="contents topic" id="contents">
<p class="topic-title">Contents</p>
<ul class="simple">
<li><p><a class="reference internal" href="#net-dim-generic-network-dynamic-interrupt-moderation" id="id1">Net DIM - Generic Network Dynamic Interrupt Moderation</a></p>
<ul>
<li><p><a class="reference internal" href="#assumptions" id="id2">Assumptions</a></p></li>
<li><p><a class="reference internal" href="#introduction" id="id3">Introduction</a></p></li>
<li><p><a class="reference internal" href="#net-dim-algorithm" id="id4">Net DIM Algorithm</a></p></li>
<li><p><a class="reference internal" href="#registering-a-network-device-to-dim" id="id5">Registering a Network Device to DIM</a></p></li>
<li><p><a class="reference internal" href="#example" id="id6">Example</a></p></li>
<li><p><a class="reference internal" href="#dynamic-interrupt-moderation-dim-library-api" id="id7">Dynamic Interrupt Moderation (DIM) library API</a></p></li>
</ul>
</li>
</ul>
</div>
<section id="assumptions">
<h2><a class="toc-backref" href="#id2">Assumptions</a><a class="headerlink" href="#assumptions" title="Permalink to this headline">¶</a></h2>
<p>This document assumes the reader has basic knowledge in network drivers
and in general interrupt moderation.</p>
</section>
<section id="introduction">
<h2><a class="toc-backref" href="#id3">Introduction</a><a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p>Dynamic Interrupt Moderation (DIM) (in networking) refers to changing the
interrupt moderation configuration of a channel in order to optimize packet
processing. The mechanism includes an algorithm which decides if and how to
change moderation parameters for a channel, usually by performing an analysis on
runtime data sampled from the system. Net DIM is such a mechanism. In each
iteration of the algorithm, it analyses a given sample of the data, compares it
to the previous sample and if required, it can decide to change some of the
interrupt moderation configuration fields. The data sample is composed of data
bandwidth, the number of packets and the number of events. The time between
samples is also measured. Net DIM compares the current and the previous data and
returns an adjusted interrupt moderation configuration object. In some cases,
the algorithm might decide not to change anything. The configuration fields are
the minimum duration (microseconds) allowed between events and the maximum
number of wanted packets per event. The Net DIM algorithm ascribes importance to
increase bandwidth over reducing interrupt rate.</p>
</section>
<section id="net-dim-algorithm">
<h2><a class="toc-backref" href="#id4">Net DIM Algorithm</a><a class="headerlink" href="#net-dim-algorithm" title="Permalink to this headline">¶</a></h2>
<p>Each iteration of the Net DIM algorithm follows these steps:</p>
<ol class="arabic simple">
<li><p>Calculates new data sample.</p></li>
<li><p>Compares it to previous sample.</p></li>
<li><p>Makes a decision - suggests interrupt moderation configuration fields.</p></li>
<li><p>Applies a schedule work function, which applies suggested configuration.</p></li>
</ol>
<p>The first two steps are straightforward, both the new and the previous data are
supplied by the driver registered to Net DIM. The previous data is the new data
supplied to the previous iteration. The comparison step checks the difference
between the new and previous data and decides on the result of the last step.
A step would result as “better” if bandwidth increases and as “worse” if
bandwidth reduces. If there is no change in bandwidth, the packet rate is
compared in a similar fashion - increase == “better” and decrease == “worse”.
In case there is no change in the packet rate as well, the interrupt rate is
compared. Here the algorithm tries to optimize for lower interrupt rate so an
increase in the interrupt rate is considered “worse” and a decrease is
considered “better”. Step #2 has an optimization for avoiding false results: it
only considers a difference between samples as valid if it is greater than a
certain percentage. Also, since Net DIM does not measure anything by itself, it
assumes the data provided by the driver is valid.</p>
<p>Step #3 decides on the suggested configuration based on the result from step #2
and the internal state of the algorithm. The states reflect the “direction” of
the algorithm: is it going left (reducing moderation), right (increasing
moderation) or standing still. Another optimization is that if a decision
to stay still is made multiple times, the interval between iterations of the
algorithm would increase in order to reduce calculation overhead. Also, after
“parking” on one of the most left or most right decisions, the algorithm may
decide to verify this decision by taking a step in the other direction. This is
done in order to avoid getting stuck in a “deep sleep” scenario. Once a
decision is made, an interrupt moderation configuration is selected from
the predefined profiles.</p>
<p>The last step is to notify the registered driver that it should apply the
suggested configuration. This is done by scheduling a work function, defined by
the Net DIM API and provided by the registered driver.</p>
<p>As you can see, Net DIM itself does not actively interact with the system. It
would have trouble making the correct decisions if the wrong data is supplied to
it and it would be useless if the work function would not apply the suggested
configuration. This does, however, allow the registered driver some room for
manoeuvre as it may provide partial data or ignore the algorithm suggestion
under some conditions.</p>
</section>
<section id="registering-a-network-device-to-dim">
<h2><a class="toc-backref" href="#id5">Registering a Network Device to DIM</a><a class="headerlink" href="#registering-a-network-device-to-dim" title="Permalink to this headline">¶</a></h2>
<p>Net DIM API exposes the main function <a class="reference internal" href="#c.net_dim" title="net_dim"><code class="xref c c-func docutils literal notranslate"><span class="pre">net_dim()</span></code></a>.
This function is the entry point to the Net
DIM algorithm and has to be called every time the driver would like to check if
it should change interrupt moderation parameters. The driver should provide two
data structures: <a class="reference internal" href="#c.dim" title="dim"><code class="xref c c-type docutils literal notranslate"><span class="pre">struct</span> <span class="pre">dim</span></code></a> and
<a class="reference internal" href="#c.dim_sample" title="dim_sample"><code class="xref c c-type docutils literal notranslate"><span class="pre">struct</span> <span class="pre">dim_sample</span></code></a>. <a class="reference internal" href="#c.dim" title="dim"><code class="xref c c-type docutils literal notranslate"><span class="pre">struct</span> <span class="pre">dim</span></code></a>
describes the state of DIM for a specific object (RX queue, TX queue,
other queues, etc.). This includes the current selected profile, previous data
samples, the callback function provided by the driver and more.
<a class="reference internal" href="#c.dim_sample" title="dim_sample"><code class="xref c c-type docutils literal notranslate"><span class="pre">struct</span> <span class="pre">dim_sample</span></code></a> describes a data sample,
which will be compared to the data sample stored in <a class="reference internal" href="#c.dim" title="dim"><code class="xref c c-type docutils literal notranslate"><span class="pre">struct</span> <span class="pre">dim</span></code></a>
in order to decide on the algorithm’s next
step. The sample should include bytes, packets and interrupts, measured by
the driver.</p>
<p>In order to use Net DIM from a networking driver, the driver needs to call the
main <a class="reference internal" href="#c.net_dim" title="net_dim"><code class="xref c c-func docutils literal notranslate"><span class="pre">net_dim()</span></code></a> function. The recommended method is to call <a class="reference internal" href="#c.net_dim" title="net_dim"><code class="xref c c-func docutils literal notranslate"><span class="pre">net_dim()</span></code></a> on each
interrupt. Since Net DIM has a built-in moderation and it might decide to skip
iterations under certain conditions, there is no need to moderate the <a class="reference internal" href="#c.net_dim" title="net_dim"><code class="xref c c-func docutils literal notranslate"><span class="pre">net_dim()</span></code></a>
calls as well. As mentioned above, the driver needs to provide an object of type
<a class="reference internal" href="#c.dim" title="dim"><code class="xref c c-type docutils literal notranslate"><span class="pre">struct</span> <span class="pre">dim</span></code></a> to the <a class="reference internal" href="#c.net_dim" title="net_dim"><code class="xref c c-func docutils literal notranslate"><span class="pre">net_dim()</span></code></a> function call. It is advised for
each entity using Net DIM to hold a <a class="reference internal" href="#c.dim" title="dim"><code class="xref c c-type docutils literal notranslate"><span class="pre">struct</span> <span class="pre">dim</span></code></a> as part of its
data structure and use it as the main Net DIM API object.
The <a class="reference internal" href="#c.dim_sample" title="dim_sample"><code class="xref c c-type docutils literal notranslate"><span class="pre">struct</span> <span class="pre">dim_sample</span></code></a> should hold the latest
bytes, packets and interrupts count. No need to perform any calculations, just
include the raw data.</p>
<p>The <a class="reference internal" href="#c.net_dim" title="net_dim"><code class="xref c c-func docutils literal notranslate"><span class="pre">net_dim()</span></code></a> call itself does not return anything. Instead Net DIM relies on
the driver to provide a callback function, which is called when the algorithm
decides to make a change in the interrupt moderation parameters. This callback
will be scheduled and run in a separate thread in order not to add overhead to
the data flow. After the work is done, Net DIM algorithm needs to be set to
the proper state in order to move to the next iteration.</p>
</section>
<section id="example">
<h2><a class="toc-backref" href="#id6">Example</a><a class="headerlink" href="#example" title="Permalink to this headline">¶</a></h2>
<p>The following code demonstrates how to register a driver to Net DIM. The actual
usage is not complete but it should make the outline of the usage clear.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;linux/dim.h&gt;</span><span class="cp"></span>

<span class="cm">/* Callback for net DIM to schedule on a decision to change moderation */</span><span class="w"></span>
<span class="kt">void</span><span class="w"> </span><span class="nf">my_driver_do_dim_work</span><span class="p">(</span><span class="k">struct</span> <span class="nc">work_struct</span><span class="w"> </span><span class="o">*</span><span class="n">work</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="cm">/* Get struct dim from struct work_struct */</span><span class="w"></span>
<span class="w">      </span><span class="k">struct</span> <span class="nc">dim</span><span class="w"> </span><span class="o">*</span><span class="n">dim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span> <span class="nc">dim</span><span class="p">,</span><span class="w"></span>
<span class="w">                                     </span><span class="n">work</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="cm">/* Do interrupt moderation related stuff */</span><span class="w"></span>
<span class="w">      </span><span class="p">...</span><span class="w"></span>

<span class="w">      </span><span class="cm">/* Signal net DIM work is done and it should move to next iteration */</span><span class="w"></span>
<span class="w">      </span><span class="n">dim</span><span class="o">-&gt;</span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DIM_START_MEASURE</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="cm">/* My driver&#39;s interrupt handler */</span><span class="w"></span>
<span class="kt">int</span><span class="w"> </span><span class="nf">my_driver_handle_interrupt</span><span class="p">(</span><span class="k">struct</span> <span class="nc">my_driver_entity</span><span class="w"> </span><span class="o">*</span><span class="n">my_entity</span><span class="p">,</span><span class="w"> </span><span class="p">...)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="p">...</span><span class="w"></span>
<span class="w">      </span><span class="cm">/* A struct to hold current measured data */</span><span class="w"></span>
<span class="w">      </span><span class="k">struct</span> <span class="nc">dim_sample</span><span class="w"> </span><span class="n">dim_sample</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">...</span><span class="w"></span>
<span class="w">      </span><span class="cm">/* Initiate data sample struct with current data */</span><span class="w"></span>
<span class="w">      </span><span class="n">dim_update_sample</span><span class="p">(</span><span class="n">my_entity</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">,</span><span class="w"></span>
<span class="w">                        </span><span class="n">my_entity</span><span class="o">-&gt;</span><span class="n">packets</span><span class="p">,</span><span class="w"></span>
<span class="w">                        </span><span class="n">my_entity</span><span class="o">-&gt;</span><span class="n">bytes</span><span class="p">,</span><span class="w"></span>
<span class="w">                        </span><span class="o">&amp;</span><span class="n">dim_sample</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="cm">/* Call net DIM */</span><span class="w"></span>
<span class="w">      </span><span class="n">net_dim</span><span class="p">(</span><span class="o">&amp;</span><span class="n">my_entity</span><span class="o">-&gt;</span><span class="n">dim</span><span class="p">,</span><span class="w"> </span><span class="n">dim_sample</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="p">...</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="cm">/* My entity&#39;s initialization function (my_entity was already allocated) */</span><span class="w"></span>
<span class="kt">int</span><span class="w"> </span><span class="nf">my_driver_init_my_entity</span><span class="p">(</span><span class="k">struct</span> <span class="nc">my_driver_entity</span><span class="w"> </span><span class="o">*</span><span class="n">my_entity</span><span class="p">,</span><span class="w"> </span><span class="p">...)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="p">...</span><span class="w"></span>
<span class="w">      </span><span class="cm">/* Initiate struct work_struct with my driver&#39;s callback function */</span><span class="w"></span>
<span class="w">      </span><span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">my_entity</span><span class="o">-&gt;</span><span class="n">dim</span><span class="p">.</span><span class="n">work</span><span class="p">,</span><span class="w"> </span><span class="n">my_driver_do_dim_work</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="p">...</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="dynamic-interrupt-moderation-dim-library-api">
<h2><a class="toc-backref" href="#id7">Dynamic Interrupt Moderation (DIM) library API</a><a class="headerlink" href="#dynamic-interrupt-moderation-dim-library-api" title="Permalink to this headline">¶</a></h2>
<dl class="type">
<dt id="c.dim_cq_moder">
struct <code class="sig-name descname">dim_cq_moder</code><a class="headerlink" href="#c.dim_cq_moder" title="Permalink to this definition">¶</a></dt>
<dd><p>Structure for CQ moderation values. Used for communications between DIM and its consumer.</p>
</dd></dl>

<div class="kernelindent docutils container">
<p><strong>Definition</strong>:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>struct dim_cq_moder {
    u16 usec;
    u16 pkts;
    u16 comps;
    u8 cq_period_mode;
};
</pre></div>
</div>
<p><strong>Members</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">usec</span></code></dt><dd><p>CQ timer suggestion (by DIM)</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">pkts</span></code></dt><dd><p>CQ packet counter suggestion (by DIM)</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">comps</span></code></dt><dd><p>Completion counter</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">cq_period_mode</span></code></dt><dd><p>CQ period count mode (from CQE/EQE)</p>
</dd>
</dl>
</div>
<dl class="type">
<dt id="c.dim_sample">
struct <code class="sig-name descname">dim_sample</code><a class="headerlink" href="#c.dim_sample" title="Permalink to this definition">¶</a></dt>
<dd><p>Structure for DIM sample data. Used for communications between DIM and its consumer.</p>
</dd></dl>

<div class="kernelindent docutils container">
<p><strong>Definition</strong>:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>struct dim_sample {
    ktime_t time;
    u32 pkt_ctr;
    u32 byte_ctr;
    u16 event_ctr;
    u32 comp_ctr;
};
</pre></div>
</div>
<p><strong>Members</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">time</span></code></dt><dd><p>Sample timestamp</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">pkt_ctr</span></code></dt><dd><p>Number of packets</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">byte_ctr</span></code></dt><dd><p>Number of bytes</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">event_ctr</span></code></dt><dd><p>Number of events</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">comp_ctr</span></code></dt><dd><p>Current completion counter</p>
</dd>
</dl>
</div>
<dl class="type">
<dt id="c.dim_stats">
struct <code class="sig-name descname">dim_stats</code><a class="headerlink" href="#c.dim_stats" title="Permalink to this definition">¶</a></dt>
<dd><p>Structure for DIM stats. Used for holding current measured rates.</p>
</dd></dl>

<div class="kernelindent docutils container">
<p><strong>Definition</strong>:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>struct dim_stats {
    int ppms;
    int bpms;
    int epms;
    int cpms;
    int cpe_ratio;
};
</pre></div>
</div>
<p><strong>Members</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">ppms</span></code></dt><dd><p>Packets per msec</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">bpms</span></code></dt><dd><p>Bytes per msec</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">epms</span></code></dt><dd><p>Events per msec</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">cpms</span></code></dt><dd><p>Completions per msec</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">cpe_ratio</span></code></dt><dd><p>Ratio of completions to events</p>
</dd>
</dl>
</div>
<dl class="type">
<dt id="c.dim">
struct <code class="sig-name descname">dim</code><a class="headerlink" href="#c.dim" title="Permalink to this definition">¶</a></dt>
<dd><p>Main structure for dynamic interrupt moderation (DIM). Used for holding all information about a specific DIM instance.</p>
</dd></dl>

<div class="kernelindent docutils container">
<p><strong>Definition</strong>:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>struct dim {
    u8 state;
    struct dim_stats prev_stats;
    struct dim_sample start_sample;
    struct dim_sample measuring_sample;
    struct work_struct work;
    void *priv;
    u8 profile_ix;
    u8 mode;
    u8 tune_state;
    u8 steps_right;
    u8 steps_left;
    u8 tired;
};
</pre></div>
</div>
<p><strong>Members</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">state</span></code></dt><dd><p>Algorithm state (see below)</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">prev_stats</span></code></dt><dd><p>Measured rates from previous iteration (for comparison)</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">start_sample</span></code></dt><dd><p>Sampled data at start of current iteration</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">measuring_sample</span></code></dt><dd><p>A <a class="reference internal" href="#c.dim_sample" title="dim_sample"><code class="xref c c-type docutils literal notranslate"><span class="pre">dim_sample</span></code></a> that is used to update the current events</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">work</span></code></dt><dd><p>Work to perform on action required</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">priv</span></code></dt><dd><p>A pointer to the struct that points to dim</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">profile_ix</span></code></dt><dd><p>Current moderation profile</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">mode</span></code></dt><dd><p>CQ period count mode</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">tune_state</span></code></dt><dd><p>Algorithm tuning state (see below)</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">steps_right</span></code></dt><dd><p>Number of steps taken towards higher moderation</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">steps_left</span></code></dt><dd><p>Number of steps taken towards lower moderation</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">tired</span></code></dt><dd><p>Parking depth counter</p>
</dd>
</dl>
</div>
<dl class="type">
<dt id="c.dim_cq_period_mode">
enum <code class="sig-name descname">dim_cq_period_mode</code><a class="headerlink" href="#c.dim_cq_period_mode" title="Permalink to this definition">¶</a></dt>
<dd><p>Modes for CQ period count</p>
</dd></dl>

<div class="kernelindent docutils container">
<p><strong>Constants</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">DIM_CQ_PERIOD_MODE_START_FROM_EQE</span></code></dt><dd><p>Start counting from EQE</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">DIM_CQ_PERIOD_MODE_START_FROM_CQE</span></code></dt><dd><p>Start counting from CQE (implies timer reset)</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">DIM_CQ_PERIOD_NUM_MODES</span></code></dt><dd><p>Number of modes</p>
</dd>
</dl>
</div>
<dl class="type">
<dt id="c.dim_state">
enum <code class="sig-name descname">dim_state</code><a class="headerlink" href="#c.dim_state" title="Permalink to this definition">¶</a></dt>
<dd><p>DIM algorithm states</p>
</dd></dl>

<div class="kernelindent docutils container">
<p><strong>Constants</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">DIM_START_MEASURE</span></code></dt><dd><p>This is the first iteration (also after applying a new profile)</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">DIM_MEASURE_IN_PROGRESS</span></code></dt><dd><p>Algorithm is already in progress - check if
need to perform an action</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">DIM_APPLY_NEW_PROFILE</span></code></dt><dd><p>DIM consumer is currently applying a profile - no need to measure</p>
</dd>
</dl>
</div>
<p><strong>Description</strong></p>
<p>These will determine if the algorithm is in a valid state to start an iteration.</p>
<dl class="type">
<dt id="c.dim_tune_state">
enum <code class="sig-name descname">dim_tune_state</code><a class="headerlink" href="#c.dim_tune_state" title="Permalink to this definition">¶</a></dt>
<dd><p>DIM algorithm tune states</p>
</dd></dl>

<div class="kernelindent docutils container">
<p><strong>Constants</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">DIM_PARKING_ON_TOP</span></code></dt><dd><p>Algorithm found a local top point - exit on significant difference</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">DIM_PARKING_TIRED</span></code></dt><dd><p>Algorithm found a deep top point - don’t exit if tired &gt; 0</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">DIM_GOING_RIGHT</span></code></dt><dd><p>Algorithm is currently trying higher moderation levels</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">DIM_GOING_LEFT</span></code></dt><dd><p>Algorithm is currently trying lower moderation levels</p>
</dd>
</dl>
</div>
<p><strong>Description</strong></p>
<p>These will determine which action the algorithm should perform.</p>
<dl class="type">
<dt id="c.dim_stats_state">
enum <code class="sig-name descname">dim_stats_state</code><a class="headerlink" href="#c.dim_stats_state" title="Permalink to this definition">¶</a></dt>
<dd><p>DIM algorithm statistics states</p>
</dd></dl>

<div class="kernelindent docutils container">
<p><strong>Constants</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">DIM_STATS_WORSE</span></code></dt><dd><p>Current iteration shows worse performance than before</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">DIM_STATS_SAME</span></code></dt><dd><p>Current iteration shows same performance than before</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">DIM_STATS_BETTER</span></code></dt><dd><p>Current iteration shows better performance than before</p>
</dd>
</dl>
</div>
<p><strong>Description</strong></p>
<p>These will determine the verdict of current iteration.</p>
<dl class="type">
<dt id="c.dim_step_result">
enum <code class="sig-name descname">dim_step_result</code><a class="headerlink" href="#c.dim_step_result" title="Permalink to this definition">¶</a></dt>
<dd><p>DIM algorithm step results</p>
</dd></dl>

<div class="kernelindent docutils container">
<p><strong>Constants</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">DIM_STEPPED</span></code></dt><dd><p>Performed a regular step</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">DIM_TOO_TIRED</span></code></dt><dd><p>Same kind of step was done multiple times - should go to
tired parking</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">DIM_ON_EDGE</span></code></dt><dd><p>Stepped to the most left/right profile</p>
</dd>
</dl>
</div>
<p><strong>Description</strong></p>
<p>These describe the result of a step.</p>
<dl class="function">
<dt id="c.dim_on_top">
bool <code class="sig-name descname">dim_on_top</code><span class="sig-paren">(</span>struct <a class="reference internal" href="#c.dim" title="dim">dim</a><em> *dim</em><span class="sig-paren">)</span><a class="headerlink" href="#c.dim_on_top" title="Permalink to this definition">¶</a></dt>
<dd><p>check if current state is a good place to stop (top location)</p>
</dd></dl>

<div class="kernelindent docutils container">
<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">dim</span> <span class="pre">*dim</span></code></dt><dd><p>DIM context</p>
</dd>
</dl>
<p><strong>Description</strong></p>
<p>Check if current profile is a good place to park at.
This will result in reducing the DIM checks frequency as we assume we
shouldn’t probably change profiles, unless traffic pattern wasn’t changed.</p>
</div>
<dl class="function">
<dt id="c.dim_turn">
void <code class="sig-name descname">dim_turn</code><span class="sig-paren">(</span>struct <a class="reference internal" href="#c.dim" title="dim">dim</a><em> *dim</em><span class="sig-paren">)</span><a class="headerlink" href="#c.dim_turn" title="Permalink to this definition">¶</a></dt>
<dd><p>change profile altering direction</p>
</dd></dl>

<div class="kernelindent docutils container">
<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">dim</span> <span class="pre">*dim</span></code></dt><dd><p>DIM context</p>
</dd>
</dl>
<p><strong>Description</strong></p>
<p>Go left if we were going right and vice-versa.
Do nothing if currently parking.</p>
</div>
<dl class="function">
<dt id="c.dim_park_on_top">
void <code class="sig-name descname">dim_park_on_top</code><span class="sig-paren">(</span>struct <a class="reference internal" href="#c.dim" title="dim">dim</a><em> *dim</em><span class="sig-paren">)</span><a class="headerlink" href="#c.dim_park_on_top" title="Permalink to this definition">¶</a></dt>
<dd><p>enter a parking state on a top location</p>
</dd></dl>

<div class="kernelindent docutils container">
<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">dim</span> <span class="pre">*dim</span></code></dt><dd><p>DIM context</p>
</dd>
</dl>
<p><strong>Description</strong></p>
<p>Enter parking state.
Clear all movement history.</p>
</div>
<dl class="function">
<dt id="c.dim_park_tired">
void <code class="sig-name descname">dim_park_tired</code><span class="sig-paren">(</span>struct <a class="reference internal" href="#c.dim" title="dim">dim</a><em> *dim</em><span class="sig-paren">)</span><a class="headerlink" href="#c.dim_park_tired" title="Permalink to this definition">¶</a></dt>
<dd><p>enter a tired parking state</p>
</dd></dl>

<div class="kernelindent docutils container">
<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">dim</span> <span class="pre">*dim</span></code></dt><dd><p>DIM context</p>
</dd>
</dl>
<p><strong>Description</strong></p>
<p>Enter parking state.
Clear all movement history and cause DIM checks frequency to reduce.</p>
</div>
<dl class="function">
<dt id="c.dim_calc_stats">
void <code class="sig-name descname">dim_calc_stats</code><span class="sig-paren">(</span>struct <a class="reference internal" href="#c.dim_sample" title="dim_sample">dim_sample</a><em> *start</em>, struct <a class="reference internal" href="#c.dim_sample" title="dim_sample">dim_sample</a><em> *end</em>, struct <a class="reference internal" href="#c.dim_stats" title="dim_stats">dim_stats</a><em> *curr_stats</em><span class="sig-paren">)</span><a class="headerlink" href="#c.dim_calc_stats" title="Permalink to this definition">¶</a></dt>
<dd><p>calculate the difference between two samples</p>
</dd></dl>

<div class="kernelindent docutils container">
<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">dim_sample</span> <span class="pre">*start</span></code></dt><dd><p>start sample</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">dim_sample</span> <span class="pre">*end</span></code></dt><dd><p>end sample</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">dim_stats</span> <span class="pre">*curr_stats</span></code></dt><dd><p>delta between samples</p>
</dd>
</dl>
<p><strong>Description</strong></p>
<p>Calculate the delta between two samples (in data rates).
Takes into consideration counter wrap-around.</p>
</div>
<dl class="function">
<dt id="c.dim_update_sample">
void <code class="sig-name descname">dim_update_sample</code><span class="sig-paren">(</span>u16<em> event_ctr</em>, u64<em> packets</em>, u64<em> bytes</em>, struct <a class="reference internal" href="#c.dim_sample" title="dim_sample">dim_sample</a><em> *s</em><span class="sig-paren">)</span><a class="headerlink" href="#c.dim_update_sample" title="Permalink to this definition">¶</a></dt>
<dd><p>set a sample’s fields with given values</p>
</dd></dl>

<div class="kernelindent docutils container">
<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">u16</span> <span class="pre">event_ctr</span></code></dt><dd><p>number of events to set</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">u64</span> <span class="pre">packets</span></code></dt><dd><p>number of packets to set</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">u64</span> <span class="pre">bytes</span></code></dt><dd><p>number of bytes to set</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">dim_sample</span> <span class="pre">*s</span></code></dt><dd><p>DIM sample</p>
</dd>
</dl>
</div>
<dl class="function">
<dt id="c.dim_update_sample_with_comps">
void <code class="sig-name descname">dim_update_sample_with_comps</code><span class="sig-paren">(</span>u16<em> event_ctr</em>, u64<em> packets</em>, u64<em> bytes</em>, u64<em> comps</em>, struct <a class="reference internal" href="#c.dim_sample" title="dim_sample">dim_sample</a><em> *s</em><span class="sig-paren">)</span><a class="headerlink" href="#c.dim_update_sample_with_comps" title="Permalink to this definition">¶</a></dt>
<dd><p>set a sample’s fields with given values including the completion parameter</p>
</dd></dl>

<div class="kernelindent docutils container">
<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">u16</span> <span class="pre">event_ctr</span></code></dt><dd><p>number of events to set</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">u64</span> <span class="pre">packets</span></code></dt><dd><p>number of packets to set</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">u64</span> <span class="pre">bytes</span></code></dt><dd><p>number of bytes to set</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">u64</span> <span class="pre">comps</span></code></dt><dd><p>number of completions to set</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">dim_sample</span> <span class="pre">*s</span></code></dt><dd><p>DIM sample</p>
</dd>
</dl>
</div>
<dl class="function">
<dt id="c.net_dim_get_rx_moderation">
struct <a class="reference internal" href="#c.dim_cq_moder" title="dim_cq_moder">dim_cq_moder</a> <code class="sig-name descname">net_dim_get_rx_moderation</code><span class="sig-paren">(</span>u8<em> cq_period_mode</em>, int<em> ix</em><span class="sig-paren">)</span><a class="headerlink" href="#c.net_dim_get_rx_moderation" title="Permalink to this definition">¶</a></dt>
<dd><p>provide a CQ moderation object for the given RX profile</p>
</dd></dl>

<div class="kernelindent docutils container">
<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">u8</span> <span class="pre">cq_period_mode</span></code></dt><dd><p>CQ period mode</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">int</span> <span class="pre">ix</span></code></dt><dd><p>Profile index</p>
</dd>
</dl>
</div>
<dl class="function">
<dt id="c.net_dim_get_def_rx_moderation">
struct <a class="reference internal" href="#c.dim_cq_moder" title="dim_cq_moder">dim_cq_moder</a> <code class="sig-name descname">net_dim_get_def_rx_moderation</code><span class="sig-paren">(</span>u8<em> cq_period_mode</em><span class="sig-paren">)</span><a class="headerlink" href="#c.net_dim_get_def_rx_moderation" title="Permalink to this definition">¶</a></dt>
<dd><p>provide the default RX moderation</p>
</dd></dl>

<div class="kernelindent docutils container">
<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">u8</span> <span class="pre">cq_period_mode</span></code></dt><dd><p>CQ period mode</p>
</dd>
</dl>
</div>
<dl class="function">
<dt id="c.net_dim_get_tx_moderation">
struct <a class="reference internal" href="#c.dim_cq_moder" title="dim_cq_moder">dim_cq_moder</a> <code class="sig-name descname">net_dim_get_tx_moderation</code><span class="sig-paren">(</span>u8<em> cq_period_mode</em>, int<em> ix</em><span class="sig-paren">)</span><a class="headerlink" href="#c.net_dim_get_tx_moderation" title="Permalink to this definition">¶</a></dt>
<dd><p>provide a CQ moderation object for the given TX profile</p>
</dd></dl>

<div class="kernelindent docutils container">
<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">u8</span> <span class="pre">cq_period_mode</span></code></dt><dd><p>CQ period mode</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">int</span> <span class="pre">ix</span></code></dt><dd><p>Profile index</p>
</dd>
</dl>
</div>
<dl class="function">
<dt id="c.net_dim_get_def_tx_moderation">
struct <a class="reference internal" href="#c.dim_cq_moder" title="dim_cq_moder">dim_cq_moder</a> <code class="sig-name descname">net_dim_get_def_tx_moderation</code><span class="sig-paren">(</span>u8<em> cq_period_mode</em><span class="sig-paren">)</span><a class="headerlink" href="#c.net_dim_get_def_tx_moderation" title="Permalink to this definition">¶</a></dt>
<dd><p>provide the default TX moderation</p>
</dd></dl>

<div class="kernelindent docutils container">
<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">u8</span> <span class="pre">cq_period_mode</span></code></dt><dd><p>CQ period mode</p>
</dd>
</dl>
</div>
<dl class="function">
<dt id="c.net_dim">
void <code class="sig-name descname">net_dim</code><span class="sig-paren">(</span>struct <a class="reference internal" href="#c.dim" title="dim">dim</a><em> *dim</em>, struct <a class="reference internal" href="#c.dim_sample" title="dim_sample">dim_sample</a><em> end_sample</em><span class="sig-paren">)</span><a class="headerlink" href="#c.net_dim" title="Permalink to this definition">¶</a></dt>
<dd><p>main DIM algorithm entry point</p>
</dd></dl>

<div class="kernelindent docutils container">
<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">dim</span> <span class="pre">*dim</span></code></dt><dd><p>DIM instance information</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">dim_sample</span> <span class="pre">end_sample</span></code></dt><dd><p>Current data measurement</p>
</dd>
</dl>
<p><strong>Description</strong></p>
<p>Called by the consumer.
This is the main logic of the algorithm, where data is processed in order
to decide on next required action.</p>
</div>
<dl class="function">
<dt id="c.rdma_dim">
void <code class="sig-name descname">rdma_dim</code><span class="sig-paren">(</span>struct <a class="reference internal" href="#c.dim" title="dim">dim</a><em> *dim</em>, u64<em> completions</em><span class="sig-paren">)</span><a class="headerlink" href="#c.rdma_dim" title="Permalink to this definition">¶</a></dt>
<dd><p>Runs the adaptive moderation.</p>
</dd></dl>

<div class="kernelindent docutils container">
<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">dim</span> <span class="pre">*dim</span></code></dt><dd><p>The moderation struct.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">u64</span> <span class="pre">completions</span></code></dt><dd><p>The number of completions collected in this round.</p>
</dd>
</dl>
<p><strong>Description</strong></p>
<p>Each call to rdma_dim takes the latest amount of completions that
have been collected and counts them as a new event.
Once enough events have been collected the algorithm decides a new
moderation level.</p>
</div>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../index.html">The Linux Kernel</a></h1>



<p class="blurb">6.2.0-rc4-6.2.0-rc4+</p>







<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
  <h3><a href="../index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Net DIM - Generic Network Dynamic Interrupt Moderation</a><ul>
<li><a class="reference internal" href="#assumptions">Assumptions</a></li>
<li><a class="reference internal" href="#introduction">Introduction</a></li>
<li><a class="reference internal" href="#net-dim-algorithm">Net DIM Algorithm</a></li>
<li><a class="reference internal" href="#registering-a-network-device-to-dim">Registering a Network Device to DIM</a></li>
<li><a class="reference internal" href="#example">Example</a></li>
<li><a class="reference internal" href="#dynamic-interrupt-moderation-dim-library-api">Dynamic Interrupt Moderation (DIM) library API</a></li>
</ul>
</li>
</ul>

  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/networking/net_dim.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;The kernel development community.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 2.4.4</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="../_sources/networking/net_dim.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>