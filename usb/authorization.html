
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Authorizing (or not) your USB devices to connect to the system &#8212; The Linux Kernel 6.2.0-rc4+ documentation</title>
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="ChipIdea Highspeed Dual Role Controller Driver" href="chipidea.html" />
    <link rel="prev" title="Linux ACM driver v0.16" href="acm.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="authorizing-or-not-your-usb-devices-to-connect-to-the-system">
<h1>Authorizing (or not) your USB devices to connect to the system<a class="headerlink" href="#authorizing-or-not-your-usb-devices-to-connect-to-the-system" title="Permalink to this headline">¶</a></h1>
<p>Copyright (C) 2007 Inaky Perez-Gonzalez &lt;<a class="reference external" href="mailto:inaky&#37;&#52;&#48;linux&#46;intel&#46;com">inaky<span>&#64;</span>linux<span>&#46;</span>intel<span>&#46;</span>com</a>&gt; Intel Corporation</p>
<p>This feature allows you to control if a USB device can be used (or
not) in a system. This feature will allow you to implement a lock-down
of USB devices, fully controlled by user space.</p>
<p>As of now, when a USB device is connected it is configured and
its interfaces are immediately made available to the users.  With this
modification, only if root authorizes the device to be configured will
then it be possible to use it.</p>
<section id="usage">
<h2>Usage<a class="headerlink" href="#usage" title="Permalink to this headline">¶</a></h2>
<p>Authorize a device to connect:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ echo 1 &gt; /sys/bus/usb/devices/DEVICE/authorized
</pre></div>
</div>
<p>De-authorize a device:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ echo 0 &gt; /sys/bus/usb/devices/DEVICE/authorized
</pre></div>
</div>
<p>Set new devices connected to hostX to be deauthorized by default (ie:
lock down):</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ echo 0 &gt; /sys/bus/usb/devices/usbX/authorized_default
</pre></div>
</div>
<p>Remove the lock down:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ echo 1 &gt; /sys/bus/usb/devices/usbX/authorized_default
</pre></div>
</div>
<p>By default, Wired USB devices are authorized by default to
connect. Wireless USB hosts deauthorize by default all new connected
devices (this is so because we need to do an authentication phase
before authorizing). Writing “2” to the authorized_default attribute
causes kernel to only authorize by default devices connected to internal
USB ports.</p>
<section id="example-system-lockdown-lame">
<h3>Example system lockdown (lame)<a class="headerlink" href="#example-system-lockdown-lame" title="Permalink to this headline">¶</a></h3>
<p>Imagine you want to implement a lockdown so only devices of type XYZ
can be connected (for example, it is a kiosk machine with a visible
USB port):</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>boot up
rc.local -&gt;

 for host in /sys/bus/usb/devices/usb*
 do
    echo 0 &gt; $host/authorized_default
 done
</pre></div>
</div>
<p>Hookup an script to udev, for new USB devices:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>if device_is_my_type $DEV
then
  echo 1 &gt; $device_path/authorized
done
</pre></div>
</div>
<p>Now, device_is_my_type() is where the juice for a lockdown is. Just
checking if the class, type and protocol match something is the worse
security verification you can make (or the best, for someone willing
to break it). If you need something secure, use crypto and Certificate
Authentication or stuff like that. Something simple for an storage key
could be:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>function device_is_my_type()
{
  echo 1 &gt; authorized          # temporarily authorize it
                               # FIXME: make sure none can mount it
  mount DEVICENODE /mntpoint
  sum=$(md5sum /mntpoint/.signature)
  if [ $sum = $(cat /etc/lockdown/keysum) ]
  then
       echo &quot;We are good, connected&quot;
       umount /mntpoint
       # Other stuff so others can use it
  else
       echo 0 &gt; authorized
  fi
}
</pre></div>
</div>
<p>Of course, this is lame, you’d want to do a real certificate
verification stuff with PKI, so you don’t depend on a shared secret,
etc, but you get the idea. Anybody with access to a device gadget kit
can fake descriptors and device info. Don’t trust that. You are
welcome.</p>
</section>
<section id="interface-authorization">
<h3>Interface authorization<a class="headerlink" href="#interface-authorization" title="Permalink to this headline">¶</a></h3>
<p>There is a similar approach to allow or deny specific USB interfaces.
That allows to block only a subset of an USB device.</p>
<p>Authorize an interface:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ echo 1 &gt; /sys/bus/usb/devices/INTERFACE/authorized
</pre></div>
</div>
<p>Deauthorize an interface:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ echo 0 &gt; /sys/bus/usb/devices/INTERFACE/authorized
</pre></div>
</div>
<p>The default value for new interfaces
on a particular USB bus can be changed, too.</p>
<p>Allow interfaces per default:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ echo 1 &gt; /sys/bus/usb/devices/usbX/interface_authorized_default
</pre></div>
</div>
<p>Deny interfaces per default:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ echo 0 &gt; /sys/bus/usb/devices/usbX/interface_authorized_default
</pre></div>
</div>
<p>Per default the interface_authorized_default bit is 1.
So all interfaces would authorized per default.</p>
<dl class="simple">
<dt>Note:</dt><dd><p>If a deauthorized interface will be authorized so the driver probing must
be triggered manually by writing INTERFACE to /sys/bus/usb/drivers_probe</p>
</dd>
</dl>
<p>For drivers that need multiple interfaces all needed interfaces should be
authorized first. After that the drivers should be probed.
This avoids side effects.</p>
</section>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../index.html">The Linux Kernel</a></h1>



<p class="blurb">6.2.0-rc4-6.2.0-rc4+</p>







<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
  <h3><a href="../index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Authorizing (or not) your USB devices to connect to the system</a><ul>
<li><a class="reference internal" href="#usage">Usage</a><ul>
<li><a class="reference internal" href="#example-system-lockdown-lame">Example system lockdown (lame)</a></li>
<li><a class="reference internal" href="#interface-authorization">Interface authorization</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/usb/authorization.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;The kernel development community.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 2.4.4</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="../_sources/usb/authorization.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>